<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICN Game Notation Validator</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --primary-color: #4a90e2;
            --secondary-color: #252526;
            --border-color: #333;
            --accent-color: #569cd6;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
        }
        
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .upload-section {
            background-color: var(--secondary-color);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: border-color 0.3s;
        }
        
        .upload-section:hover {
            border-color: var(--primary-color);
        }
        
        .upload-section.drag-over {
            border-color: var(--accent-color);
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        .file-label:hover {
            background-color: var(--accent-color);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            font-size: 1em;
        }
        
        button:hover {
            background-color: var(--accent-color);
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .progress-section {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background-color: var(--bg-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .summary-section {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
        }
        
        .stat-card h3 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-color);
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 0;
        }
        
        .stat-value.success {
            color: var(--success-color);
        }
        
        .stat-value.error {
            color: var(--danger-color);
        }
        
        .stat-value.warning {
            color: var(--warning-color);
        }
        
        .details-section {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .error-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .error-item {
            background-color: var(--bg-color);
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .error-item.icnconverter {
            border-left-color: var(--warning-color);
        }
        
        .error-item.formulator {
            border-left-color: var(--danger-color);
        }
        
        .error-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .error-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        
        .error-type.icnconverter {
            background-color: var(--warning-color);
            color: var(--bg-color);
        }
        
        .error-type.formulator {
            background-color: var(--danger-color);
            color: white;
        }
        
        .error-message {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }
        
        .variant-stats {
            margin-top: 1rem;
        }
        
        .variant-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: var(--bg-color);
            border-radius: 4px;
        }
        
        .variant-name {
            font-weight: bold;
        }
        
        .variant-errors {
            color: var(--danger-color);
        }
        
        pre {
            background-color: #111;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }
        
        .log-section {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .log-output {
            max-height: 300px;
            overflow-y: auto;
            background-color: #111;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #222;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry.error {
            color: var(--danger-color);
        }
        
        .log-entry.success {
            color: var(--success-color);
        }
        
        .log-entry.info {
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ICN Game Notation Validator</h1>
        <p>This tool validates JSON files containing Infinite Chess Notation (ICN) game data. Upload a JSON file to check if all game notations are valid and can be successfully converted and formulated.</p>
        
        <div class="upload-section" id="upload-section">
            <h2>Upload JSON File</h2>
            <p>Click to select or drag and drop a JSON file containing an array of game notations</p>
            <label for="file-input" class="file-label">Choose File</label>
            <input type="file" id="file-input" accept=".json">
            <p id="file-name" style="margin-top: 1rem; color: var(--accent-color);"></p>
        </div>
        
        <div style="text-align: center; margin-bottom: 2rem;">
            <button id="validate-btn" disabled>Validate Games</button>
        </div>
        
        <div class="progress-section" id="progress-section">
            <h2>Processing...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
            <p id="progress-text">Processing game 0 of 0</p>
        </div>
        
        <div class="summary-section" id="summary-section">
            <h2>Validation Summary</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <h3>Total Games</h3>
                    <p class="stat-value" id="total-games">0</p>
                </div>
                <div class="stat-card">
                    <h3>Successful</h3>
                    <p class="stat-value success" id="successful-games">0</p>
                </div>
                <div class="stat-card">
                    <h3>ICN Converter Errors</h3>
                    <p class="stat-value warning" id="icnconverter-errors">0</p>
                </div>
                <div class="stat-card">
                    <h3>Formulator Errors</h3>
                    <p class="stat-value error" id="formulator-errors">0</p>
                </div>
            </div>
        </div>
        
        <div class="details-section" id="variant-section" style="display: none;">
            <h2>Errors by Variant</h2>
            <div class="variant-stats" id="variant-stats"></div>
        </div>
        
        <div class="details-section" id="errors-section" style="display: none;">
            <h2>Error Details</h2>
            <div class="error-list" id="error-list"></div>
        </div>
        
        <div class="log-section">
            <h2>Activity Log</h2>
            <div class="log-output" id="log-output"></div>
        </div>
    </div>

    <script type="module">
        // Import the necessary modules from the source code
        // Note: This assumes the tool is being served via the dev server or has access to the built files
        
        let gamesData = null;
        let icnconverter = null;
        let gameformulator = null;
        
        // Load the required modules
        async function loadModules() {
            try {
                addLog('Loading required modules...', 'info');
                
                // Try to load from the built distribution
                try {
                    const icnModule = await import('../dist/shared/chess/logic/icn/icnconverter.js');
                    icnconverter = icnModule.default;
                    addLog('✓ ICN converter module loaded', 'success');
                } catch (e) {
                    addLog('⚠ Could not load ICN converter from dist, trying source...', 'info');
                    const icnModule = await import('../src/shared/chess/logic/icn/icnconverter.ts');
                    icnconverter = icnModule.default;
                    addLog('✓ ICN converter module loaded from source', 'success');
                }
                
                try {
                    const gameformulatorModule = await import('../dist/client/scripts/esm/game/chess/gameformulator.js');
                    gameformulator = gameformulatorModule.default;
                    addLog('✓ Game formulator module loaded', 'success');
                } catch (e) {
                    addLog('⚠ Could not load game formulator from dist, trying source...', 'info');
                    const gameformulatorModule = await import('../src/client/scripts/esm/game/chess/gameformulator.ts');
                    gameformulator = gameformulatorModule.default;
                    addLog('✓ Game formulator module loaded from source', 'success');
                }
                
                addLog('All modules loaded successfully!', 'success');
                return true;
            } catch (error) {
                addLog(`✗ Error loading modules: ${error.message}`, 'error');
                addLog('Make sure the project is built (npm run build) or the dev server is running (npm run dev)', 'error');
                return false;
            }
        }
        
        // Initialize the tool
        loadModules().then(success => {
            if (!success) {
                document.getElementById('upload-section').innerHTML += 
                    '<p style="color: var(--danger-color); margin-top: 1rem;">Failed to load required modules. Please ensure the project is built or the dev server is running.</p>';
            }
        });
        
        // File upload handling
        const fileInput = document.getElementById('file-input');
        const fileName = document.getElementById('file-name');
        const validateBtn = document.getElementById('validate-btn');
        const uploadSection = document.getElementById('upload-section');
        
        fileInput.addEventListener('change', handleFileSelect);
        validateBtn.addEventListener('click', validateGames);
        
        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('drag-over');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });
        
        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = `Selected: ${file.name}`;
                addLog(`File selected: ${file.name}`, 'info');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        gamesData = JSON.parse(e.target.result);
                        if (!Array.isArray(gamesData)) {
                            throw new Error('JSON file must contain an array of game notations');
                        }
                        addLog(`✓ Loaded ${gamesData.length} game notation(s)`, 'success');
                        validateBtn.disabled = false;
                    } catch (error) {
                        addLog(`✗ Error parsing JSON: ${error.message}`, 'error');
                        fileName.textContent += ' (Invalid JSON)';
                        gamesData = null;
                        validateBtn.disabled = true;
                    }
                };
                reader.readAsText(file);
            }
        }
        
        async function validateGames() {
            if (!gamesData || !icnconverter || !gameformulator) {
                addLog('✗ Cannot validate: missing data or modules', 'error');
                return;
            }
            
            validateBtn.disabled = true;
            
            const results = {
                total: gamesData.length,
                successful: 0,
                icnconverterErrors: 0,
                formulatorErrors: 0,
                errors: [],
                variantErrors: {}
            };
            
            // Show progress section
            const progressSection = document.getElementById('progress-section');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            progressSection.style.display = 'block';
            
            addLog(`Starting validation of ${results.total} games...`, 'info');
            
            for (let i = 0; i < gamesData.length; i++) {
                const gameICN = gamesData[i];
                const progress = ((i + 1) / results.total * 100).toFixed(1);
                
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
                progressText.textContent = `Processing game ${i + 1} of ${results.total}`;
                
                try {
                    // Step 1: Convert ICN to long format
                    let longFormat;
                    try {
                        longFormat = icnconverter.ShortToLong_Format(gameICN);
                    } catch (error) {
                        results.icnconverterErrors++;
                        results.errors.push({
                            gameIndex: i + 1,
                            phase: 'icnconverter',
                            error: error.message,
                            icn: gameICN.substring(0, 100) + (gameICN.length > 100 ? '...' : '')
                        });
                        continue;
                    }
                    
                    // Extract variant from metadata for error tracking
                    const variant = longFormat.metadata?.Variant || 'Unknown';
                    
                    // Step 2: Formulate the game
                    try {
                        const game = gameformulator.formulateGame(longFormat);
                        results.successful++;
                    } catch (error) {
                        results.formulatorErrors++;
                        results.errors.push({
                            gameIndex: i + 1,
                            phase: 'formulator',
                            error: error.message,
                            variant: variant,
                            icn: gameICN.substring(0, 100) + (gameICN.length > 100 ? '...' : '')
                        });
                        
                        // Track errors by variant
                        if (!results.variantErrors[variant]) {
                            results.variantErrors[variant] = 0;
                        }
                        results.variantErrors[variant]++;
                    }
                } catch (error) {
                    // Unexpected error
                    addLog(`✗ Unexpected error processing game ${i + 1}: ${error.message}`, 'error');
                    results.formulatorErrors++;
                    results.errors.push({
                        gameIndex: i + 1,
                        phase: 'unknown',
                        error: error.message,
                        icn: gameICN.substring(0, 100) + (gameICN.length > 100 ? '...' : '')
                    });
                }
                
                // Allow UI to update
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            // Hide progress, show results
            progressSection.style.display = 'none';
            displayResults(results);
            validateBtn.disabled = false;
            
            addLog(`✓ Validation complete: ${results.successful}/${results.total} successful`, 
                   results.successful === results.total ? 'success' : 'error');
        }
        
        function displayResults(results) {
            // Update summary
            document.getElementById('total-games').textContent = results.total;
            document.getElementById('successful-games').textContent = results.successful;
            document.getElementById('icnconverter-errors').textContent = results.icnconverterErrors;
            document.getElementById('formulator-errors').textContent = results.formulatorErrors;
            document.getElementById('summary-section').style.display = 'block';
            
            // Display variant errors
            if (Object.keys(results.variantErrors).length > 0) {
                const variantStats = document.getElementById('variant-stats');
                variantStats.innerHTML = '';
                
                const sortedVariants = Object.entries(results.variantErrors)
                    .sort((a, b) => b[1] - a[1]);
                
                for (const [variant, count] of sortedVariants) {
                    const variantItem = document.createElement('div');
                    variantItem.className = 'variant-item';
                    variantItem.innerHTML = `
                        <span class="variant-name">${variant}</span>
                        <span class="variant-errors">${count} error(s)</span>
                    `;
                    variantStats.appendChild(variantItem);
                }
                
                document.getElementById('variant-section').style.display = 'block';
            }
            
            // Display error details
            if (results.errors.length > 0) {
                const errorList = document.getElementById('error-list');
                errorList.innerHTML = '';
                
                for (const error of results.errors) {
                    const errorItem = document.createElement('div');
                    errorItem.className = `error-item ${error.phase}`;
                    errorItem.innerHTML = `
                        <div class="error-header">
                            <span>Game #${error.gameIndex}${error.variant ? ` - ${error.variant}` : ''}</span>
                            <span class="error-type ${error.phase}">${error.phase}</span>
                        </div>
                        <div class="error-message">${error.error}</div>
                        <details style="margin-top: 0.5rem;">
                            <summary style="cursor: pointer; color: var(--accent-color);">View ICN snippet</summary>
                            <div class="error-message" style="margin-top: 0.5rem;">${error.icn}</div>
                        </details>
                    `;
                    errorList.appendChild(errorItem);
                }
                
                document.getElementById('errors-section').style.display = 'block';
            }
        }
        
        function addLog(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    </script>
</body>
</html>
