"use strict";const animation=function(){const e=.01,t=80,o=[];function n(e,t){e.captured?sound.playSound_capture(e.dist,t):sound.playSound_move(e.dist,t),e.soundPlayed=!0}function i(t,o){const n=movement.getBoardPos(),i=movement.getBoardScale(),r=(t[0]-n[0]-board.gsquareCenter())*i,a=(t[1]-n[1]-board.gsquareCenter())*i,s=r+1*i,c=a+1*i,[l,u,d,m]=o;return[r,a,e,l,u,d,m,r,c,e,l,u,d,m,s,a,e,l,u,d,m,s,a,e,l,u,d,m,r,c,e,l,u,d,m,s,c,e,l,u,d,m]}function r(t,o,n){const i=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:r,texStartY:a,texEndX:s,texEndY:c}=bufferdata.getTexDataOfType(o,i),l=movement.getBoardPos(),u=movement.getBoardScale(),d=(n[0]-l[0]-board.gsquareCenter())*u,m=(n[1]-l[1]-board.gsquareCenter())*u,p=d+1*u,g=m+1*u,{r:f,g:h,b:v,a:P}=options.getColorOfType(o),b=bufferdata.getDataQuad_ColorTexture3D(d,m,p,g,e,r,a,s,c,f,h,v,P);t.push(...b)}return Object.freeze({animatePiece:function(e,i,r,a,s=!0){s&&function(){for(const e of o)clearTimeout(e.soundTimeoutID),e.soundPlayed||n(e,!0);o.length=0}();let c=math.chebyshevDistance(i,r);const l=c>t,u=l?t:c,d={startTime:performance.now(),soundPlayed:!1,type:e,startCoords:i,endCoords:r,captured:a,dist:c,distIsGreater:l,duration:150+6*u},m=d.duration-100;d.soundTimeoutID=setTimeout(n,m,d),o.push(d)},update:function(){if(0!==o.length){main.renderThisFrame();for(let e=o.length-1;e>=0;e--){const t=o[e];performance.now()-t.startTime>t.duration&&o.splice(e,1)}}},renderTransparentSquares:function(){if(0===o.length)return;(function(){const e=[],t=[0,0,0,0];for(const n of o)e.push(...i(n.endCoords,t));return buffermodel.createModel_Colored(new Float32Array(e),3,"TRIANGLES")})().render()},renderPieces:function(){if(0===o.length)return;(function(){const e=[];for(const n of o){const o=(performance.now()-n.startTime)/n.duration,i=-.5*Math.cos(o*Math.PI)+.5;let a=n.endCoords[0]-n.startCoords[0],s=n.endCoords[1]-n.startCoords[1];const c=n.dist;let l,u;if(n.distIsGreater){const e=o<.5,r=e?1:-1,d=e?i:1-i,m=t/c;a*=m,s*=m;const p=e?n.startCoords:n.endCoords,g=a*d*r,f=s*d*r;l=p[0]+g,u=p[1]+f}else{const e=a*i,t=s*i;l=n.startCoords[0]+e,u=n.startCoords[1]+t}const d=[l,u];n.captured&&r(e,n.captured.type,n.captured.coords),r(e,n.type,d)}return buffermodel.createModel_ColorTextured(new Float32Array(e),3,"TRIANGLES",pieces.getSpritesheet())})().render()}})}(),area=function(){const e=.03,t=.2,o=1.4,n=10;function i(e,t){if(!e)return console.error("Cannot calculate area from an undefined coords list.");if(0===e.length)return console.error("Cannot calculate area from an empty coords list.");let o=math.getBoxFromCoordsList(e);return t&&(o=math.mergeBoundingBoxes(o,t)),r(o)}function r(o){if(!o)return console.error("Cannot calculate area from an undefined box.");const i=function(o){if(!o)return console.error("Cannot apply padding to an undefined box."),o;const i=math.deepCopyObject(o),r=camera.getPIXEL_HEIGHT_OF_TOP_NAV(),c=camera.getPIXEL_HEIGHT_OF_BOTTOM_NAV(),l=r+c,u=camera.getCanvasHeightVirtualPixels()-l,d=board.gsquareCenter();i.left-=d,i.right+=1-d,i.bottom-=d,i.top+=1-d;let m=math.deepCopyObject(i),p=a(m);if(n<=0)return console.error("iterationsToRecalcPadding must be greater than 0!"),i;for(let o=0;o<n;o++){let o=p<movement.getScale_When1TileIs1Pixel_Virtual()?t:e;const n=camera.getCanvasWidthVirtualPixels()*o,r=u*o+c;m=s(i,math.convertPixelsToWorldSpace_Virtual(n)/p,math.convertPixelsToWorldSpace_Virtual(r)/p),p=a(m)}return m}(o);return function(e){if(!e)return console.error("Cannot calculate area from an undefined box.");const t=(e.right-e.left)/2,o=(e.top-e.bottom)/2,n=e.left+t,i=e.bottom+o,r=[n,i],s=a(e);return e=math.getBoundingBoxOfBoard(r,s,camera.getScreenBoundingBox()),{coords:r,scale:s,boundingBox:e}}(i)}function a(e){if(!e)return console.log("Cannot calc scale to match sides of an undefined box.");const t=(e.right-e.left)/2,n=(e.top-e.bottom)/2,i=camera.getScreenBoundingBox(!1).right/t,r=camera.getScreenBoundingBox(!1).top/n;let a=i<r?i:r;return a>o&&(a=o),a}function s(e,t,o){return{left:e.left-t,right:e.right+t,bottom:e.bottom-o,top:e.top+o}}function c(e){if(!e)return console.error("Cannot init teleport from an undefined box.");l(r(e))}function l(e,t){if(!e)return console.error("Cannot init teleport from an undefined area.");const o=e.boundingBox,n=movement.getBoardPos(),r=e.coords,a=board.gboundingBox();let s;e.scale<movement.getBoardScale()?math.boxContainsSquare(o,n)||(s=i([n],o)):math.boxContainsSquare(a,r)||(s=i([r],a));const c=s?{endCoords:s.coords,endScale:s.scale}:void 0,l={endCoords:e.coords,endScale:e.scale};c?transition.teleport(c,l,t):transition.teleport(l,null,t)}return Object.freeze({calculateFromCoordsList:i,calculateFromUnpaddedBox:r,getAreaOfAllPieces:function(e){return e?e.startSnapshot.box?r(e.startSnapshot.box):console.error("Cannot get area of all pieces when gamefile has no startSnapshot.box property!"):console.error("Cannot get the area of all pieces of an undefined game.")},initStartingAreaBox:function(e){const t=e.startSnapshot.position,o=gamefileutility.getCoordsOfAllPiecesByKey(t),n=math.getBoxFromCoordsList(o);e.startSnapshot.box=n},initTelFromUnpaddedBox:c,initTelFromCoordsList:function(e){if(!e)return console.error("Cannot init teleport from an undefined coords list.");if(0===e.length)return console.error("Cannot init teleport from an empty coords list.");c(math.getBoxFromCoordsList(e))},initTelFromArea:l})}(),arrows=function(){const e=.6;let t,o,n,i,r=1,a=!1;function s(o,i,r,s,c,l,u,d){const m=s/2,p=math.convertCoordToWorldSpace(o),g=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:f,texStartY:h,texEndX:v,texEndY:P}=bufferdata.getTexDataOfType(i,g),b=r.includes("right")?-c:r.includes("left")?c:0,y="top"===r?-c-l:"bottom"===r?c+u:"topright"===r?-c:r.includes("bottom")?c:"topleft"===r?-c:0;p[0]+=b,p[1]+=y;const w=p[0]-m,C=p[1]-m,k=w+s,T=C+s,{r:S,g:M,b:E}=options.getColorOfType(i);let B=e;const x=input.getMouseWorldLocation(),I=input.getTouchClickedWorld()?input.getTouchClickedWorld()[0]:x[0],D=input.getTouchClickedWorld()?input.getTouchClickedWorld()[1]:x[1];if(I>w&&I<k&&D>C&&D<T&&(B=1,a=!0,input.isMouseDown_Left()||input.getTouchClicked())){let e,t=movement.getBoardPos();e="right"===r||"left"===r?[d[0],t[1]]:"top"===r||"bottom"===r?[t[0],d[1]]:[d[0],d[1]],transition.panTel(t,e),input.isMouseDown_Left()&&input.removeMouseDown_Left()}const R=bufferdata.getDataQuad_ColorTexture(w,C,k,T,f,h,v,P,S,M,E,B);t.push(...R);const F=1*m,L=.3*m,O=function(e,t,o){const n=t*Math.PI/180,i=e.map((e=>{const t=Math.cos(n),i=Math.sin(n),r=e[0]*t-e[1]*i,a=e[0]*i+e[1]*t;return[r+o[0],a+o[1]]}));return i}([[F,-L],[F,+L],[F+L,0]],"top"===r?90:"left"===r?180:"bottom"===r?270:"topright"===r?45:"topleft"===r?135:"bottomleft"===r?225:"bottomright"===r?315:0,p);for(let e=0;e<O.length;e++){const t=O[e];n.push(t[0],t[1],0,0,0,B)}}return Object.freeze({getMode:function(){return r},update:function(){if(0===r)return;o=void 0;const e=2*camera.getScreenBoundingBox(!1).right/camera.canvas.width*camera.getPixelDensity()*10;if(movement.getBoardScale()<e)return;i=void 0,t=[],n=[],a=!1;const c=perspective.getEnabled()?math.generatePerspectiveBoundingBox(18):board.gboundingBox(),l=perspective.getEnabled()?math.generatePerspectiveBoundingBox(17):board.gboundingBoxFloat(),u={},d={},m={},p={},g={},f={},h={},v={};let P=perspective.getEnabled()?0:math.convertPixelsToWorldSpace_Virtual(camera.getPIXEL_HEIGHT_OF_TOP_NAV()),b=perspective.getEnabled()?0:math.convertPixelsToWorldSpace_Virtual(camera.getPIXEL_HEIGHT_OF_BOTTOM_NAV());if(perspective.getIsViewingBlackPerspective()&&!perspective.getEnabled()){const e=P;P=b,b=e}let y=math.deepCopyObject(l);perspective.getEnabled()||(y.top-=math.convertWorldSpaceToGrid(P),y.bottom+=math.convertWorldSpaceToGrid(b)),gamefileutility.forEachPieceInPiecesByType((function(e,t){if(!t)return;if(math.boxContainsSquare(c,t))return;const o=t[0],n=t[1];if(n>c.bottom&&n<c.top){o>c.right?u[n]?o<u[n].coords[0]&&(u[n]={type:e,coords:t}):u[n]={type:e,coords:t}:d[n]?o>d[n].coords[0]&&(d[n]={type:e,coords:t}):d[n]={type:e,coords:t}}if(o>c.left&&o<c.right){n>c.top?m[o]?n<m[o].coords[1]&&(m[o]={type:e,coords:t}):m[o]={type:e,coords:t}:p[o]?n>p[o].coords[1]&&(p[o]={type:e,coords:t}):p[o]={type:e,coords:t}}{const i=math.getUpDiagonalFromCoords(t),r=[y.left,y.top],a=[y.right,y.bottom],s=math.getUpDiagonalFromCoords(r),c=math.getUpDiagonalFromCoords(a);if(i<s&&i>c){n>y.top||o>y.right?g[i]?o<g[i].coords[0]&&(g[i]={type:e,coords:t}):g[i]={type:e,coords:t}:f[i]?o>f[i].coords[0]&&(f[i]={type:e,coords:t}):f[i]={type:e,coords:t}}}{const i=math.getDownDiagonalFromCoords(t),r=[y.left,y.bottom],a=[y.right,y.top],s=math.getDownDiagonalFromCoords(r),c=math.getDownDiagonalFromCoords(a);if(i>s&&i<c){n>y.top||o<y.left?v[i]?o>v[i].coords[0]&&(v[i]={type:e,coords:t}):v[i]={type:e,coords:t}:h[i]?o<h[i].coords[0]&&(h[i]={type:e,coords:t}):h[i]={type:e,coords:t}}}}),game.getGamefile().ourPieces),function(e,t,o,n,i,a,s,c){if(1!==r)return;const l=game.getGamefile();function u(e,t){for(const o in e){const n=e[o].type;d(l,n,t)||delete e[o]}}function d(e,t,o){return null!=legalmoves.getPieceMoveset(e,t)[o]}u(e,"horizontal"),u(t,"horizontal"),u(o,"vertical"),u(n,"vertical"),u(i,"diagonalUp"),u(a,"diagonalUp"),u(s,"diagonalDown"),u(c,"diagonalDown")}(u,d,m,p,g,f,h,v);const w=movement.getBoardScale(),C=.65*w;let k=C/2+.15*w;function T(e,t,o){for(const n in e){const i=e[n];if("voidsN"===i.type)continue;s(t?[i.coords[0],l[o]]:[l[o],i.coords[1]],i.type,o,C,k,P,b,i.coords)}}function S(e,t,o,n){for(const i in e){const r=e[i];if("voidsN"===r.type)continue;const a=t(r.coords);s(math.getIntersectionEntryTile(o,a,y,n),r.type,n,C,k,P,b,r.coords)}}perspective.getEnabled()&&(k=0),T(u,!1,"right"),T(d,!1,"left"),T(m,!0,"top"),T(p,!0,"bottom"),S(g,math.getUpDiagonalFromCoords,1,"topright"),S(f,math.getUpDiagonalFromCoords,1,"bottomleft"),S(h,math.getDownDiagonalFromCoords,-1,"bottomright"),S(v,math.getDownDiagonalFromCoords,-1,"topleft"),0!==t.length&&(o=buffermodel.createModel_ColorTextured(new Float32Array(t),2,"TRIANGLES",pieces.getSpritesheet()),i=buffermodel.createModel_Colored(new Float32Array(n),2,"TRIANGLES"))},setMode:function(e){r=e},renderThem:function(){0!==r&&null!=o&&(o.render(),i.render())},isMouseHovering:function(){return a}})}(),backcompatible=Object.freeze({getLongformatInNewNotation:function(e){if(!function(e){return e.variant||e.promotionRanks||e.moves&&movesscript.areMovesIn2DFormat(e.moves)}(e))return e;const t={},{pawnDoublePush:o,castleWith:n}=e.gameRules?e.gameRules:{};if(t.metadata={},e.variant&&(t.metadata.Variant=e.variant),t.turn="white",t.fullMove=1,e.startingPosition&&(t.startingPosition=e.startingPosition,t.specialRights=formatconverter.generateSpecialRights(e.startingPosition,o,n)),e.moves?.length>0){const o={},n=movesscript.convertMovesTo1DFormat(e.moves,o);t.turn=o.turn;const i={next_move:"white"===t.turn?"w":"b",fullmove:t.fullMove,make_new_lines:!1,compact_moves:2},r=formatconverter.longToShortMoves(n,i).split("|");t.moves=r}if(e.promotionRanks&&(e.gameRules?e.gameRules.promotionRanks=e.promotionRanks:e.gameRules={promotionRanks:e.promotionRanks}),e.gameRules){const o={};if(e.gameRules.slideLimit&&"Infinity"!==e.gameRules.slideLimit&&(o.slideLimit=e.gameRules.slideLimit),e.gameRules.winConditions){const t={white:[],black:[]};for(const o in e.gameRules.winConditions){const n=e.gameRules.winConditions[o];"both"!==n&&"white"!==n||t.white.push(o),"both"!==n&&"black"!==n||t.black.push(o)}o.winConditions=t}e.promotionRanks&&(o.promotionRanks=[e.promotionRanks[1],e.promotionRanks[0]],o.promotionsAllowed=variant.getPromotionsAllowed(e.startingPosition,o.promotionRanks)),t.gameRules=o}return console.log("longformat after converting to new format:"),console.log(math.deepCopyObject(t)),t}}),board=function(){let e,t,o;const n=.5;let i,r,a,s,c,l,u,d;const m=-.01;let p,g;function f(){!function(){if(perspective.isMouseLocked())return;if(perspective.getEnabled())return a=void 0,void(s=void 0);const e=b();a=e.tile_Float,s=e.tile_Int}(),function(){if(!perspective.isMouseLocked())return;const e=math.convertWorldSpaceToCoords(input.getMouseWorldLocation());a=e,s=[Math.floor(e[0]+n),Math.floor(e[1]+n)]}()}function h(){const e=options.isDebugModeOn()?camera.getScreenBoundingBox(!0):camera.getScreenBoundingBox(!1),t=.5*camera.canvas.height/e.top/camera.getPixelDensity();r=t*movement.getBoardScale()}function v(){c={},l={};for(let e=0;e<input.getTouchHelds().length;e++){const t=input.getTouchHelds()[e],o=P(t.x,t.y);c[t.id]=o.tile_Float,l[t.id]=o.tile_Int}}function P(e,t){const o=perspective.getIsViewingBlackPerspective()?-1:1,i=movement.getBoardPos(),a=o*e/r+i[0],s=o*t/r+i[1];return{tile_Float:[a,s],tile_Int:[Math.floor(a+n),Math.floor(s+n)]}}function b(){const e=input.getMouseWorldLocation(),t=math.convertWorldSpaceToCoords(e);return{tile_Float:t,tile_Int:[Math.floor(t[0]+n),Math.floor(t[1]+n)]}}function y(e){return{left:Math.floor(e.left+n),right:Math.ceil(e.right-1+n),bottom:Math.floor(e.bottom+n),top:Math.ceil(e.top-1+n)}}function w(){g||E();const e=perspective.getEnabled(),t=perspective.distToRenderBoard,o=camera.getScreenBoundingBox(!1),n=e?-t:o.left,r=e?t:o.right,a=e?-t:o.bottom,s=e?t:o.top,c=perspective.getEnabled()?m:0,[l,u,d,p]=g,f=bufferdata.getDataQuad_Color3D(n,a,r,s,c,l,u,d,p),h=new Float32Array(f);i=buffermodel.createModel_Colored(h,3,"TRIANGLES")}function C(){if(movement.isScaleLess1Pixel_Physical())return;const o=function(){const o=movement.getBoardScale(),i=2*o,r=perspective.getEnabled(),a=perspective.distToRenderBoard,s=r?-a:camera.getScreenBoundingBox(!1).left,c=r?a:camera.getScreenBoundingBox(!1).right,l=r?-a:camera.getScreenBoundingBox(!1).bottom,u=r?a:camera.getScreenBoundingBox(!1).top,d=movement.getBoardPos();let g=(d[0]+n+s/o)%2/2-.001,f=(d[1]+n+l/o)%2/2-.001,h=g+(c-s)/i,v=f+(u-l)/i;const[P,b,y,w]=p,C=perspective.getEnabled()?m:0,k=[],T=bufferdata.getDataQuad_ColorTexture3D(s,l,c,u,C,g,f,h,v,P,b,y,w);k.push(...T);const S=perspective.getEnabled()?t:e;return buffermodel.createModel_ColorTextured(new Float32Array(k),3,"TRIANGLES",S)}();i.render(),o.render()}function k(e,t){null!=e[t]&&(options.themes[options.gtheme()][t]=e[t])}function T(e,t){null!=e[t]&&(options.themes[options.gtheme()][t]=e[t],options.themes[options.gtheme()].useColoredPieces=!0)}function S(){E(),function(){const e=(p[0]+g[0])/2,t=(p[1]+g[1])/2,o=(p[2]+g[2])/2,n=.27,i=e-n,r=t-n,a=o-n;webgl.setClearColor([i,r,a])}(),function(){const e=(p[0]+g[0])/2,t=(p[1]+g[1])/2,o=(p[2]+g[2])/2;let n=255,i=255,r=255;if(!options.isThemeDefault()){const a=.6;n=255*(1-(1-e)*(1-a)),i=255*(1-(1-t)*(1-a)),r=255*(1-(1-o)*(1-a))}style.setNavStyle(`\n\n            .navigation {\n                background: linear-gradient(to top, rgba(${n}, ${i}, ${r}, 0.104), rgba(${n}, ${i}, ${r}, 0.552), rgba(${n}, ${i}, ${r}, 0.216));\n            }\n\n            .footer {\n                background: linear-gradient(to bottom, rgba(${n}, ${i}, ${r}, 0.307), rgba(${n}, ${i}, ${r}, 1), rgba(${n}, ${i}, ${r}, 0.84));\n            }\n        `)}()}function M(e,t){main.renderThisFrame(),p=e,g=t,w()}function E(){p=options.getDefaultTiles(!0),g=options.getDefaultTiles(!1),w(),main.renderThisFrame()}function B(o,i){const r=o*movement.getBoardScale(),a=2*r,s=perspective.getEnabled(),c=perspective.distToRenderBoard,l=s?-c:camera.getScreenBoundingBox(!1).left,u=s?c:camera.getScreenBoundingBox(!1).right,d=s?-c:camera.getScreenBoundingBox(!1).bottom,f=s?c:camera.getScreenBoundingBox(!1).top,h=movement.getBoardPos();let v=((h[0]+n)/o+l/r)%2/2-.001,P=((h[1]+n)/o+d/r)%2/2-.001;const b=(u-l)/a;if((camera.getScreenBoundingBox(!1).right-camera.getScreenBoundingBox(!1).left)/a>camera.canvas.width/2)return;let y=v+b,w=P+(f-d)/a;const C=v+.5,k=y+.5,T=perspective.getEnabled()?m:0;let[S,M,E,B]=p;B*=i;let[x,I,D,R]=g;R*=i;const F=[],L=bufferdata.getDataQuad_ColorTexture3D(l,d,u,f,T,v,P,y,w,S,M,E,B);F.push(...L);const O=bufferdata.getDataQuad_ColorTexture3D(l,d,u,f,T,C,P,k,w,x,I,D,R);F.push(...O);const _=perspective.getEnabled()?t:e;buffermodel.createModel_ColorTextured(new Float32Array(F),3,"TRIANGLES",_).render()}return Object.freeze({gsquareCenter:function(){return n},initTextures:function(){e=texture.loadTexture("tiles",{useMipmaps:!1}),t=texture.loadTexture("tiles256",{useMipmaps:!1}),o=texture.loadTexture("tilesGrey78",{useMipmaps:!1})},gtileWidth_Pixels:function(){return r},recalcVariables:function(){h(),f(),v(),u=math.getBoundingBoxOfBoard(movement.getBoardPos(),movement.getBoardScale(),camera.getScreenBoundingBox()),d=y(u)},gtile_MouseOver_Float:function(){return a},isOffsetOutOfRangeOfRegenRange:function(e,t){const o=movement.getBoardPos(),n=Math.abs(o[0]-e[0]),i=Math.abs(o[1]-e[1]);return n>t||i>t},gpositionFingerOver:function(e){return{id:e,x:c[e][0],y:c[e][1]}},initDarkTilesModel:w,gtile_MouseOver_Int:function(){return s},recalcTileWidth_Pixels:h,gtileCoordsOver:P,roundAwayBoundingBox:y,gboundingBox:function(){return math.deepCopyObject(d)},changeTheme:function(e){e.whiteTiles&&(options.themes[options.gtheme()].whiteTiles=e.whiteTiles),e.darkTiles&&(options.themes[options.gtheme()].darkTiles=e.darkTiles),k(e,"whiteTiles"),k(e,"darkTiles"),k(e,"selectedPieceHighlightColor"),k(e,"legalMovesHighlightColor"),k(e,"lastMoveHighlightColor"),k(e,"checkHighlightColor"),k(e,"useColoredPieces"),T(e,"whitePiecesColor"),T(e,"blackPiecesColor"),T(e,"neutralPiecesColor"),S(),piecesmodel.regenModel(game.getGamefile(),options.getPieceRegenColorArgs()),highlights.regenModel()},gboundingBoxFloat:function(){return math.deepCopyObject(u)},updateTheme:S,resetColor:E,glimitToDampScale:function(){return 1e-5},darkenColor:function(){const e=options.getDefaultTiles(!0),t=options.getDefaultTiles(!1),o=.09;M([e[0]-o,e[1]-o,e[2]-o,1],[t[0]-o,t[1]-o,t[2]-o,1])},render:function(){webgl.executeWithDepthFunc_ALWAYS((()=>{!function(){const e=camera.getZFar()/Math.SQRT2,t=perspective.getEnabled()?m:0,o=camera.getPosition(!0)[2],n=(p[0]+g[0])/2,i=(p[1]+g[1])/2,r=(p[2]+g[2])/2,a=(p[3]+g[3])/2,s=bufferdata.getDataBoxTunnel(-e,-e,o,e,e,t,n,i,r,a);s.push(...bufferdata.getDataQuad_Color3D(-e,-e,e,e,t,n,i,r,a));buffermodel.createModel_Colored(new Float32Array(s),3,"TRIANGLES").render()}(),C(),function(){const e=-math.getBaseLog10(movement.getBoardScale()),t=.5;if(e<t)return;const o=3,n=6;let i=Math.floor((e-t)/o)*o+t;const r=3*(i-t)/o+3,a=.7;let s=Math.pow(10,r),c=(i-e)/n,l=a*Math.pow(-.5*Math.cos(2*c*Math.PI)+.5,.7);if(B(s,l),i-=o,i<0)return;s/=Math.pow(10,3),c=(i-e)/n,l=a*(-.5*Math.cos(2*c*Math.PI)+.5),B(s,l)}()}))},getTileMouseOver:b,recalcTile_MouseCrosshairOver:f,recalcTiles_FingersOver:v})}(),browsersupport=Object.freeze({checkBrowserSupport:function(){}}),bufferdata=function(){function e(e){const t=movement.getBoardPos(),o=movement.getBoardScale(),n=(e[0]-board.gsquareCenter()-t[0])*o,i=(e[1]-board.gsquareCenter()-t[1])*o;return{startX:n,startY:i,endX:n+o,endY:i+o}}function t(e,t){const o=t[0]-board.gsquareCenter()-e[0],n=t[1]-board.gsquareCenter()-e[1];return{startX:o,startY:n,endX:o+1,endY:n+1}}function o(e){const t=movement.getBoardPos(),o=movement.getBoardScale(),n=(e.left-t[0]-board.gsquareCenter())*o,i=(e.right-t[0]+1-board.gsquareCenter())*o;return{startX:n,startY:(e.bottom-t[1]-board.gsquareCenter())*o,endX:i,endY:(e.top-t[1]+1-board.gsquareCenter())*o}}function n(e,t=1){const o=pieces.getSpritesheetDataTexLocation(e),n=pieces.getSpritesheetDataPieceWidth(),i=o[0],r=o[1];return 1===t?{texStartX:i,texStartY:r,texEndX:i+n,texEndY:r+n}:{texStartX:i+n,texStartY:r+n,texEndX:i,texEndY:r}}function i(e,t,o,n,i,r,a,s){return[e,t,i,r,a,s,e,n,i,r,a,s,o,t,i,r,a,s,o,t,i,r,a,s,e,n,i,r,a,s,o,n,i,r,a,s]}function r(e,t,o,n,i,r,a,s,c){return[e,t,i,r,a,s,c,e,n,i,r,a,s,c,o,t,i,r,a,s,c,o,t,i,r,a,s,c,e,n,i,r,a,s,c,o,n,i,r,a,s,c]}function a(e,t,o,n,i,r,a,s,c,l,u,d){return[e,t,i,r,c,l,u,d,e,n,i,s,c,l,u,d,o,t,a,r,c,l,u,d,o,t,a,r,c,l,u,d,e,n,i,s,c,l,u,d,o,n,a,s,c,l,u,d]}function s(e,t,o,n,i,r,a,s,c,l,u,d,m){return[e,t,i,r,a,l,u,d,m,e,n,i,r,c,l,u,d,m,o,t,i,s,a,l,u,d,m,o,t,i,s,a,l,u,d,m,e,n,i,r,c,l,u,d,m,o,n,i,s,c,l,u,d,m]}function c(e,t,o,n,i,r,a,s){return[e,t,i,r,a,s,e,n,i,r,a,s,o,n,i,r,a,s,o,t,i,r,a,s]}return Object.freeze({getCoordDataOfTile:e,getCoordDataOfTile_WithOffset:t,getCoordDataOfTileBoundingBox:o,getTexDataOfType:n,getDataQuad_Color:i,getDataQuad_Color3D:r,getDataQuad_Texture:function(e,t,o,n,i,r,a,s){return[e,t,i,r,e,n,i,s,o,t,a,r,o,t,a,r,e,n,i,s,o,n,a,s]},getDataQuad_Texture3D:function(e,t,o,n,i,r,a,s,c){return[e,t,i,r,a,e,n,i,r,c,o,t,i,s,a,o,t,i,s,a,e,n,i,r,c,o,n,i,s,c]},getDataQuad_ColorTexture:a,getDataQuad_ColorTexture3D:s,getDataRect:c,getDataCircle:function(e,t,o,n,i,r,a,s){if(null==s)return console.error("Cannot get data of circle with no specified resolution!");if(s<3)return console.error("Resolution must be 3+ to get data of a circle.");const c=[];for(let l=0;l<s;l++){const u=l/s*2*Math.PI,d=e+o*Math.cos(u),m=t+o*Math.sin(u);c.push(d,m,n,i,r,a)}return c},getDataBoxTunnel:function(e,t,o,n,i,r,a,s,c,l){return[e,t,o,a,s,c,l,e,t,r,a,s,c,l,n,t,o,a,s,c,l,n,t,o,a,s,c,l,e,t,r,a,s,c,l,n,t,r,a,s,c,l,n,t,o,a,s,c,l,n,t,r,a,s,c,l,n,i,o,a,s,c,l,n,i,o,a,s,c,l,n,t,r,a,s,c,l,n,i,r,a,s,c,l,n,i,o,a,s,c,l,n,i,r,a,s,c,l,e,i,o,a,s,c,l,e,i,o,a,s,c,l,n,i,r,a,s,c,l,e,i,r,a,s,c,l,e,i,o,a,s,c,l,e,i,r,a,s,c,l,e,t,o,a,s,c,l,e,t,o,a,s,c,l,e,i,r,a,s,c,l,e,t,r,a,s,c,l]},getDataCircle3D:function(e,t,o,n,i,r,a,s,c){if(i<3)return console.error("Resolution must be 3+ to get data of a circle.");const l=[];for(let u=0;u<i;u++){const d=u/i*2*Math.PI,m=(u+1)/i*2*Math.PI,p=e,g=t,f=e+n*Math.cos(d),h=t+n*Math.sin(d),v=e+n*Math.cos(m),P=t+n*Math.sin(m);l.push(p,g,o,r,a,s,c),l.push(f,h,o,r,a,s,c),l.push(v,P,o,r,a,s,c)}return l},getModelCircle3D:function(e,t,o,n,i,r,a,s,c){if(i<3)return console.error("Resolution must be 3+ to get data of a fuzz ball.");const l=[e,t,o,r,a,s,c];for(let u=0;u<=i;u++){const d=u/i*2*Math.PI,m=e+n*Math.cos(d),p=t+n*Math.sin(d);l.push(m,p,o,r,a,s,c)}return buffermodel.createModel_Colored(new Float32Array(l),3,"TRIANGLE_FAN")},getDataFuzzBall3D:function(e,t,o,n,i,r,a,s,c,l,u,d,m){if(i<3)return console.error("Resolution must be 3+ to get data of a fuzz ball.");const p=[e,t,o,r,a,s,c];for(let r=0;r<=i;r++){const a=r/i*2*Math.PI,s=e+n*Math.cos(a),c=t+n*Math.sin(a);p.push(s,c,o,l,u,d,m)}return p},getDataRingSolid:function(e,t,o,n,i,r,a,s,c){if(i<3)return console.error("Resolution must be 3+ to get data of a ring.");const l=[];for(let u=0;u<i;u++){const d=u/i*2*Math.PI,m=(u+1)/i*2*Math.PI,p=e+o*Math.cos(d),g=t+o*Math.sin(d),f=e+n*Math.cos(d),h=t+n*Math.sin(d),v=e+o*Math.cos(m),P=t+o*Math.sin(m),b=e+n*Math.cos(m),y=t+n*Math.sin(m);l.push(p,g,r,a,s,c,f,h,r,a,s,c,v,P,r,a,s,c,f,h,r,a,s,c,b,y,r,a,s,c,v,P,r,a,s,c)}return l},getDataRing3D:function(e,t,o,n,i,r,a,s,c,l,u,d,m,p){if(r<3)return console.error("Resolution must be 3+ to get data of a ring.");const g=[];for(let f=0;f<r;f++){const h=f/r*2*Math.PI,v=(f+1)/r*2*Math.PI,P=e+n*Math.cos(h),b=t+n*Math.sin(h),y=e+i*Math.cos(h),w=t+i*Math.sin(h),C=e+n*Math.cos(v),k=t+n*Math.sin(v),T=e+i*Math.cos(v),S=t+i*Math.sin(v);g.push(P,b,o,a,s,c,l,y,w,o,u,d,m,p,C,k,o,a,s,c,l,y,w,o,u,d,m,p,T,S,o,u,d,m,p,C,k,o,a,s,c,l)}return g},getModelRing3D:function(e,t,o,n,i,r,a,s,c,l,u,d,m,p){if(r<3)return console.error("Resolution must be 3+ to get model of a ring.");const g=[];for(let f=0;f<=r;f++){const h=f/r*2*Math.PI,v=e+n*Math.cos(h),P=t+n*Math.sin(h),b=e+i*Math.cos(h),y=t+i*Math.sin(h);g.push(v,P,o,a,s,c,l),g.push(b,y,o,u,d,m,p)}return buffermodel.createModel_Colored(new Float32Array(g),3,"TRIANGLE_STRIP")},getDataQuad_Color_FromCoord:function(t,o){const{startX:n,startY:r,endX:a,endY:s}=e(t),[c,l,u,d]=o;return i(n,r,a,s,c,l,u,d)},getDataQuad_Color_FromCoord_WithOffset:function(e,o,n){const{startX:r,startY:a,endX:s,endY:c}=t(e,o),[l,u,d,m]=n;return i(r,a,s,c,l,u,d,m)},getDataQuad_Color3D_FromCoord:function(t,o,n){const{startX:i,startY:a,endX:s,endY:c}=e(t),[l,u,d,m]=n;return r(i,a,s,c,o,l,u,d,m)},getDataQuad_Color3D_FromCoord_WithOffset:function(e,o,n,i){const{startX:a,startY:s,endX:c,endY:l}=t(e,o),[u,d,m,p]=i;return r(a,s,c,l,n,u,d,m,p)},getDataQuad_ColorTexture_FromCoordAndType:function(t,o,i){const r=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:s,texStartY:c,texEndX:l,texEndY:u}=n(o,r),{startX:d,startY:m,endX:p,endY:g}=e(t),{r:f,g:h,b:v,a:P}=i;return a(d,m,p,g,s,c,l,u,f,h,v,P)},getDataQuad_ColorTexture3D_FromCoordAndType:function(t,o,i,r){const a=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:c,texStartY:l,texEndX:u,texEndY:d}=n(i,a),{startX:m,startY:p,endX:g,endY:f}=e(t),{r:h,g:v,b:P,a:b}=r;return s(m,p,g,f,o,c,l,u,d,h,v,P,b)},getDataQuad_ColorTexture_FromPositionWidthType:function(e,t,o,i,r){const s=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:c,texStartY:l,texEndX:u,texEndY:d}=n(i,s),m=o/2,p=e-m,g=e+m,f=t-m,h=t+m,{r:v,g:P,b:b,a:y}=r;return a(p,f,g,h,c,l,u,d,v,P,b,y)},getDataRect_FromTileBoundingBox:function(e,t){const{startX:n,startY:i,endX:r,endY:a}=o(e),[s,l,u,d]=t;return c(n,i,r,a,s,l,u,d)},rotateDataTexture:function(e,t=1){const o=e.slice(),n=pieces.getSpritesheetDataPieceWidth()*t;return o[2]+=n,o[3]+=n,o[6]+=n,o[7]-=n,o[10]-=n,o[11]+=n,o[14]-=n,o[15]+=n,o[18]+=n,o[19]-=n,o[22]-=n,o[23]-=n,o},rotateDataColorTexture:function(e,t=1){const o=e.slice(),n=pieces.getSpritesheetDataPieceWidth()*t;return o[2]+=n,o[3]+=n,o[10]+=n,o[11]-=n,o[18]-=n,o[19]+=n,o[26]-=n,o[27]+=n,o[34]+=n,o[35]-=n,o[42]-=n,o[43]-=n,o}})}(),buffermodel=function(){function e(e,o,n,i){return function(r,a,s){gl.useProgram(e.program),gl.bindBuffer(gl.ARRAY_BUFFER,r);const c=a*s;let l=0;if(t(e.attribLocations.vertexPosition,c,o,l),l+=o*s,n){const o=2;t(e.attribLocations.textureCoord,c,o,l),l+=o*s}if(i){const o=4;t(e.attribLocations.vertexColor,c,o,l),l+=o*s}gl.bindBuffer(gl.ARRAY_BUFFER,null)}}function t(e,t,o,n){const i=gl.FLOAT;gl.vertexAttribPointer(e,o,i,!1,t,n),gl.enableVertexAttribArray(e)}function o(e,t,o){const n=function(e){if(Array.isArray(e))return"array";if(e instanceof Float32Array)return"matrix";if("number"==typeof e)return"number";console.error(`Unsupported uniform value type ${typeof e}.`)}(o),i=function(e,t){switch(e){case"array":return function(e){const t=e.length;return t>4||0===t?console.error(`Unsupported array length ${t} for uniform value.`):`uniform${t}fv`}(t);case"matrix":return function(e){const t=e.length;switch(t){case 4:return"uniformMatrix2fv";case 9:return"uniformMatrix3fv";case 16:return"uniformMatrix4fv";default:console.error(`Unsupported matrix size ${t} for uniform value.`)}}(t);case"number":return"uniform1i";default:console.error(`Unsupported uniform type ${e}.`)}}(n,o);if("matrix"===n){const n=!1;return gl[i](e.uniformLocations[t],n,o)}gl[i](e.uniformLocations[t],o)}return Object.freeze({validRenderModes:["TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN","POINTS","LINE_LOOP","LINE_STRIP","LINES"],DRAW_HINT:"STATIC_DRAW",createModel_Textured:function(t,o,n,i){if(o<2||o>3)return console.error(`Unsupported numPositionComponents ${o}`);if(null==i)return console.error("Cannot create a textured buffer model without a texture!");const r=o+2,a=e(shaders.programs.textureProgram,o,!0,!1);return new BufferModel(shaders.programs.textureProgram,t,r,n,i,a)},createModel_Colored:function(t,o,n){if(o<2||o>3)return console.error(`Unsupported numPositionComponents ${o}`);const i=o+4,r=e(shaders.programs.colorProgram,o,!1,!0);return new BufferModel(shaders.programs.colorProgram,t,i,n,void 0,r)},createModel_ColorTextured:function(t,o,n,i){if(o<2||o>3)return console.error(`Unsupported numPositionComponents ${o}`);if(null==i)return console.error("Cannot create a textured buffer model without a texture!");const r=o+6,a=e(shaders.programs.coloredTextureProgram,o,!0,!0);return new BufferModel(shaders.programs.coloredTextureProgram,t,r,n,i,a)},createModel_TintTextured:function(t,o,n,i){if(o<2||o>3)return console.error(`Unsupported numPositionComponents ${o}`);if(null==i)return console.error("Cannot create a tinted textured buffer model without a texture!");const r=o+2,a=e(shaders.programs.tintedTextureProgram,o,!0,!1);return new BufferModel(shaders.programs.tintedTextureProgram,t,r,n,i,a)},renderPreppedModel:function(e,t=[0,0,0],n=[1,1,1],i,r,a,s={}){const c=mat4.create();mat4.scale(c,c,n),mat4.translate(c,c,t),gl.uniformMatrix4fv(e.uniformLocations.worldMatrix,gl.FALSE,c);for(const t in s)o(e,t,s[t]);a&&gl.bindTexture(gl.TEXTURE_2D,a),gl.drawArrays(gl[r],0,i),a&&gl.bindTexture(gl.TEXTURE_2D,null)}})}();function BufferModel(e,t,o,n,i,r){if(!math.isFloat32Array(t))return console.error("Cannot create a buffer model without a Float32Array!");if(t.length%o!=0)return console.error("Data length is not divisible by stride when generating a buffer model! Perhaps did you pass in the wrong numPositionComponents, or use the wrong constructor?");if(!buffermodel.validRenderModes.includes(n))return console.error(`Mode "${n}" is not an accepted value!`);this.data=t;const a=t.length/o;let s=i;const c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c),gl.bufferData(gl.ARRAY_BUFFER,t,gl[buffermodel.DRAW_HINT]),gl.bindBuffer(gl.ARRAY_BUFFER,null),this.updateBuffer=function(){gl.bindBuffer(gl.ARRAY_BUFFER,c),gl.bufferSubData(gl.ARRAY_BUFFER,0,t),gl.bindBuffer(gl.ARRAY_BUFFER,null)},this.updateBufferIndices=function(e,o){if(e+o-1>t.length-1)return console.error("Cannot update buffer indices when they overflow the data.");const n=e*t.BYTES_PER_ELEMENT;gl.bindBuffer(gl.ARRAY_BUFFER,c),gl.bufferSubData(gl.ARRAY_BUFFER,n,t.subarray(e,e+o)),gl.bindBuffer(gl.ARRAY_BUFFER,null)},this.deleteBuffer=function(){gl.deleteBuffer(c)},this.render=function(i,l,u){r(c,o,t.BYTES_PER_ELEMENT),buffermodel.renderPreppedModel(e,i,l,a,n,s,u)},this.getMode=function(){return n},this.getStride=function(){return o},s&&(this.changeTexture=function(e){s=e})}const camera=function(){const e=[0,0,12],t=[0,0,18];let o=90*Math.PI/180;const n=1,i=1500*Math.SQRT2,r=40,a=window.devicePixelRatio;let s,c,l,u,d,m,p,g,f,h,v=document.getElementById("game");function P(o){return math.deepCopyObject(!o&&options.isDebugModeOn()?t:e)}function b(){l=window.innerWidth,u=window.innerHeight-r,v.width=l*a,v.height=u*a,gl.viewport(0,0,v.width,v.height),y(),m=gl.canvas.clientWidth/gl.canvas.clientHeight,function(){let n=e[2];const i=o/2;let r=Math.tan(i)*n,a=r*m;p={left:-a,right:a,bottom:-r,top:r},n=t[2],r=Math.tan(i)*n,a=r*m,g={left:-a,right:a,bottom:-r,top:r}}(),game.updateVariablesAfterScreenResize(),miniimage.recalcWidthWorld(),function(){mat4.perspective(f,o,m,n,i);for(const e in shaders.programs){const t=shaders.programs[e],o=t.uniformLocations.projectionMatrix;null!=o&&(gl.useProgram(t.program),gl.uniformMatrix4fv(o,gl.FALSE,f))}}()}function y(){s=options.gnavigationVisible()?window.innerWidth>700?84:window.innerWidth>550?.12*window.innerWidth:window.innerWidth>368?66:.179*window.innerWidth:0,c=options.gnavigationVisible()?84:0,main.renderThisFrame(),stats.updateStatsCSS()}function w(e){const t=mat4.create(),o=P();mat4.lookAt(t,o,[0,0,0],[0,1,0]),e||perspective.applyRotations(t),h=t,C()}function C(){for(const e in shaders.programs){const t=shaders.programs[e],o=t.uniformLocations.viewMatrix;null!=o&&(gl.useProgram(t.program),gl.uniformMatrix4fv(o,!1,h))}}return Object.freeze({getPosition:P,getPixelDensity:function(){return a},getPIXEL_HEIGHT_OF_TOP_NAV:function(){return s},getPIXEL_HEIGHT_OF_BOTTOM_NAV:function(){return c},canvas:v,getCanvasWidthVirtualPixels:function(){return l},getCanvasHeightVirtualPixels:function(){return u},getCanvasRect:function(){return math.deepCopyObject(d)},getScreenBoundingBox:function(e){return math.deepCopyObject(e?g:p)},getViewMatrix:function(){return math.copyFloat32Array(h)},init:function(){f=mat4.create(),b(),w(),d=v.getBoundingClientRect()},updatePIXEL_HEIGHT_OF_NAVS:y,setViewMatrix:function(e){h=e,C()},onScreenResize:function(){b(),perspective.initCrosshairModel(),main.renderThisFrame()},onPositionChange:function(){w()},initViewMatrix:w,getZFar:function(){return i}})}(),checkdetection=function(){function e(e,n,i,r){if(!e)throw new Error("Cannot detect if a square of an undefined game is being attacked!");if(!n)return!1;if("white"!==i&&"black"!==i)throw new Error(`Cannot detect if an opponent is attacking the square of the team of color ${i}!`);let a=!1;return function(e,t,n,i){const r=e.vicinity;for(let a in r){const s=r[a],c=math.getCoordsFromKey(a),l=[t[0]+c[0],t[1]+c[1]],u=math.getKeyFromCoords(l),d=e.piecesOrganizedByKey[u];if(!d)continue;if(n===math.getPieceColorFromType(d))continue;const m=math.trimWorBFromType(d);if(s.includes(m))return i&&o(i,{coords:l,slidingCheck:!1}),!0}return!1}(e,n,i,r)&&(a=!0),function(e,t,n,i){const r="white"===n?1:-1;for(let a=-1;a<=1;a+=2){const s=[t[0]-a,t[1]+r];let c=math.getKeyFromCoords(s);const l=e.piecesOrganizedByKey[c];if(!l)continue;if(n===math.getPieceColorFromType(l))continue;if(l.startsWith("pawns"))return i&&o(i,{coords:s,slidingCheck:!1}),!0}return!1}(e,n,i,r)&&(a=!0),function(e,o,n,i){let r=!1;const a=e.piecesOrganizedByRow[o[1]];t(e,a,"horizontal",o,n,i)&&(r=!0);const s=e.piecesOrganizedByColumn[o[0]];t(e,s,"vertical",o,n,i)&&(r=!0);let c=math.getUpDiagonalFromCoords(o),l=e.piecesOrganizedByUpDiagonal[c];t(e,l,"diagonalup",o,n,i)&&(r=!0);c=math.getDownDiagonalFromCoords(o),l=e.piecesOrganizedByDownDiagonal[c],t(e,l,"diagonaldown",o,n,i)&&(r=!0);return r}(e,n,i,r)&&(a=!0),a}function t(e,t,n,i,r,a){if(!t)return!1;for(let s=0;s<t.length;s++){const c=t[s],l=math.getPieceColorFromType(c.type);if(r===l)continue;if("neutral"===l)continue;const u=legalmoves.getPieceMoveset(e,c.type),d="vertical"===n,m="horizontal"===n?u.horizontal:"vertical"===n?u.vertical:"diagonalup"===n?u.diagonalUp:u.diagonalDown,p=legalmoves.slide_CalcLegalLimit(t,d,m,c.coords,l);if(!p)continue;if(legalmoves.doesSlideMovesetContainSquare(p,d,i))return a&&o(a,{coords:c.coords,slidingCheck:!0}),!0}return!1}function o(e,t){for(let o=0;o<e.length;o++){const n=e[o];if(math.areCoordsEqual(n.coords,t.coords))return void(t.slidingCheck&&(n.slidingCheck=!0))}e.push(t)}function n(e,t,o,n){const i={type:t.type,startCoords:math.deepCopyObject(t.coords),endCoords:movepiece.stripSpecialMoveTagsFromCoords(o)};return specialdetect.transferSpecialFlags_FromCoordsToMove(o,i),movepiece.simulateMove(e,i,n).isCheck}return Object.freeze({detectCheck:function(t,o,n){if(!t)throw new Error("Cannot detect check of an undefined game!");if("white"!==o&&"black"!==o)throw new Error(`Cannot detect check of the team of color ${o}!`);if(null!=n&&0!==n.length)throw new Error(`Attackers parameter must be an empty array []! Received: ${JSON.stringify(n)}`);const i=gamefileutility.getRoyalCoords(t,o),r=[];for(let a=0;a<i.length;a++){const s=i[a];e(t,s,o,n)&&r.push(s)}return r.length>0&&r},removeMovesThatPutYouInCheck:function(e,o,i,r){wincondition.isOpponentUsingWinCondition(e,"checkmate")&&(function(e,o,n,i){if(!(o.horizontal||o.vertical||o.diagonalUp||o.diagonalDown))return;const r=gamefileutility.getJumpingRoyalCoords(e,i);if(0===r.length)return;if(function(e,t,o,n){if(!e.inCheck)return!1;const i=e.attackers.length;if(0===i)throw new Error("We are in check, but there is no specified attacker!");const r=e.attackers[0];i>1||!legalmoves.checkIfMoveLegal(t,n,r.coords,{ignoreIndividualMoves:!0})||t.individual.push(r.coords);const a=math.chebyshevDistance(n,r.coords);if(!r.slidingCheck||1===a)return s(),!0;return function(e,t,o,n){let i;i=e[1]===t[1]?"horizontal":e[0]===t[0]?"vertical":e[0]>t[0]&&e[1]>t[1]||t[0]>e[0]&&t[1]>e[1]?"diagonalUp":"diagonalDown";const r=math.getUpDiagonalFromCoords(n),a=math.getDownDiagonalFromCoords(n);function s(e,t,i,r){(e>t&&e<i||e>i&&e<t)&&legalmoves.checkIfMoveLegal(o,n,r,{ignoreIndividualMoves:!0})&&o.individual.push(r)}if("horizontal"===i){if(o.vertical){const o=[n[0],e[1]];s(n[0],e[0],t[0],o)}if(o.diagonalUp){const o=-r+e[1],n=[o,e[1]];s(o,e[0],t[0],n)}if(o.diagonalDown){const o=a-e[1],n=[o,e[1]];s(o,e[0],t[0],n)}}else if("vertical"===i){if(o.horizontal){const o=[e[0],n[1]];s(n[1],e[1],t[1],o)}if(o.diagonalUp){const o=r+e[0],n=[e[0],o];s(o,e[1],t[1],n)}if(o.diagonalDown){const o=a-e[0],n=[e[0],o];s(o,e[1],t[1],n)}}else if("diagonalUp"===i){if(o.vertical){const o=n[0]-e[0],i=e[1]+o,r=[n[0],i];s(n[0],e[0],t[0],r)}if(o.horizontal){const o=n[1]-e[1],i=[e[0]+o,n[1]];s(n[1],e[1],t[1],i)}e:if(o.diagonalDown){const o=(a-math.getUpDiagonalFromCoords(e))/2;if(!Number.isInteger(o))break e;const n=[o,a-o];s(o,e[0],t[0],n)}}else{if(o.vertical){const o=n[0]-e[0],i=e[1]-o,r=[n[0],i];s(n[0],e[0],t[0],r)}if(o.horizontal){const o=n[1]-e[1],i=[e[0]-o,n[1]];s(n[1],e[1],t[1],i)}e:if(o.diagonalUp){const o=(math.getDownDiagonalFromCoords(e)-r)/2;if(!Number.isInteger(o))break e;const n=[o,o+r];s(o,e[0],t[0],n)}}}(o[0],r.coords,t,n),s(),!0;function s(){t.vertical=void 0,t.horizontal=void 0,t.diagonalUp=void 0,t.diagonalDown=void 0}}(e,o,r,n.coords))return;r.forEach((r=>{!function(e,o,n,i,r){const a=i.coords,s=n[1]===a[1],c=n[0]===a[0],l=math.getUpDiagonalFromCoords(n),u=math.getUpDiagonalFromCoords(a),d=l===u,m=math.getDownDiagonalFromCoords(n),p=math.getDownDiagonalFromCoords(a),g=m===p;if(!(s||c||d||g))return;const f=math.deepCopyObject(i);if(movepiece.deletePiece(e,i,{updateData:!1}),s){t(e,e.piecesOrganizedByRow[n[1]],"horizontal",n,r,[])&&(o.vertical=void 0,o.diagonalUp=void 0,o.diagonalDown=void 0)}else if(c){t(e,e.piecesOrganizedByColumn[n[0]],"vertical",n,r,[])&&(o.horizontal=void 0,o.diagonalUp=void 0,o.diagonalDown=void 0)}else if(d){const i=math.getUpDiagonalFromCoords(n);t(e,e.piecesOrganizedByUpDiagonal[i],"diagonalup",n,r,[])&&(o.horizontal=void 0,o.vertical=void 0,o.diagonalDown=void 0)}else{const i=math.getDownDiagonalFromCoords(n);t(e,e.piecesOrganizedByDownDiagonal[i],"diagonaldown",n,r,[])&&(o.horizontal=void 0,o.vertical=void 0,o.diagonalUp=void 0)}movepiece.addPiece(e,f.type,f.coords,f.index,{updateData:!1})}(e,o,r,n,i)}))}(e,o,i,r),function(e,t,o,i){if(!t)return;for(let r=t.length-1;r>=0;r--){n(e,o,t[r],i)&&t.splice(r,1)}}(e,o.individual,i,r))},doesMovePutInCheck:n,detectCheckmateOrDraw:function(e){if(function(e){const t=e.moves,o={},n={};let i=0,r=t.length-1;for(;r>=0;){const e=t[r];if(e.captured||e.type.startsWith("pawns"))break;const a=e.endCoords;let s=`${a[0]},${a[1]},${e.type}`;n[s]?delete n[s]:o[s]=!0;const c=e.startCoords;s=`${c[0]},${c[1]},${e.type}`,o[s]?delete o[s]:n[s]=!0;const l=Object.keys(o),u=Object.keys(n);if(0===l.length&&0===u.length&&(i++,2===i))break;r--}return 2===i}(e))return"draw repetition";const t=e.whosTurn,o="white"===t?pieces.white:pieces.black;for(let t=0;t<o.length;t++){const n=o[t],i=e.ourPieces[n];for(let t=0;t<i.length;t++){const o=i[t];if(!o)continue;const r={type:n,coords:o,index:gamefileutility.getPieceIndexByTypeAndCoords(e,n,o)},a=legalmoves.calculate(e,r);if(legalmoves.hasAtleast1Move(a))return!1}}const n=wincondition.isOpponentUsingWinCondition(e,"checkmate");return e.inCheck&&n?"white"===t?"black checkmate":"white checkmate":"draw stalemate"}})}(),checkhighlight=Object.freeze({render:function(){game.getGamefile().inCheck&&function(e){const t=-.005,o=options.getDefaultCheckHighlightColor(),n=[];for(let i=0;i<e.length;i++){const r=e[i],a=math.convertCoordToWorldSpace(r),s=a[0],c=a[1],l=.65*movement.getBoardScale(),u=.3*movement.getBoardScale(),d=20,m=bufferdata.getDataCircle3D(s,c,t,u,d,...o),p=bufferdata.getDataRing3D(s,c,t,u,l,d,...o,o[0],o[1],o[2],0);n.push(...m),n.push(...p)}return buffermodel.createModel_Colored(new Float32Array(n),3,"TRIANGLES")}(game.getGamefile().inCheck).render()}}),clock=function(){const e=document.getElementById("timer-white"),t=document.getElementById("timer-black"),o=document.getElementById("timer-container-white"),n=document.getElementById("timer-container-black");let i;const r={minutes:void 0,millis:void 0,increment:void 0},a={white:void 0,black:void 0};let s,c,l,u;const d={whiteNotified:!1,blackNotified:!1,timeoutID:void 0,timeToStartFromEnd:65615,clockMinsRequiredToUse:2},m={drum:{timeoutID:void 0},tick:{sound:void 0,timeoutID:void 0,timeToStartFromEnd:15625,fadeInDuration:300,fadeOutDuration:100},ticking:{sound:void 0,timeoutID:void 0,timeToStartFromEnd:10380,fadeInDuration:300,fadeOutDuration:100}};function p(o,n,i){const r=game.getGamefile();s=r.whosTurn,a.white=o,a.black=n,u=i;const d=Date.now();if(l=d,i){const e=i-d;a[s]=e}c="white"===s?a.white:a.black,v(),f("white"===s?t:e),movesscript.isGameResignable(r)&&!r.gameConclusion&&(b(),w())}function g(){c=void 0,l=void 0,u=void 0,s=void 0,clearTimeout(d.timeoutID),clearTimeout(m.ticking.timeoutID),clearTimeout(m.tick.timeoutID),clearTimeout(m.drum.timeoutID),m.ticking.sound?.fadeOut(m.ticking.fadeOutDuration),m.tick.sound?.fadeOut(m.tick.fadeOutDuration)}function f(e){e.style.outline=""}function h(e,t){const o=t/(60*r.minutes*1e3),n=1-o;let i=0,a=0,s=0;if(o>1+1/3)a=1,s=1;else if(o>1){a=1,s=3*(o-1)}else if(n<.5){i=2*n,a=1}else if(n<.75){i=1,a=1-.5*(4*(n-.5))}else{i=1,a=.5-.5*(4*(n-.75))}e.style.outline=`3px solid rgb(${255*i},${255*a},${255*s})`}function v(){const o=P(a.white),n=P(a.black);e.textContent=o,t.textContent=n}function P(e){let t=Math.ceil(e/1e3),o=0;for(;t>=60;)t-=60,o++;return t<0&&(t=0),`${o.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}function b(){if(r.minutes<d.clockMinsRequiredToUse)return;if(clearTimeout(d.timeoutID),onlinegame.areInOnlineGame()&&s!==onlinegame.getOurColor())return;if("white"===s&&d.whiteNotified||"black"===s&&d.blackNotified)return;const e=c-d.timeToStartFromEnd;d.timeoutID=setTimeout(y,e)}function y(){sound.playSound_tick({volume:.07}),"white"===s?d.whiteNotified=!0:"black"===s?d.blackNotified=!0:console.error("Cannot set white/lowtimeNotif.blackNotified when colorTicking is undefined")}function w(){const e=Date.now();!function(e){if(clearTimeout(m.drum.timeoutID),onlinegame.areInOnlineGame()&&s!==onlinegame.getOurColor()||!u)return;const t=u-e-1e4;let o=t,n=10;if(o<0){const e=1e3*-Math.floor(o/1e3);o+=e,n-=e/1e3}m.drum.timeoutID=setTimeout(C,o,n)}(e),function(e){if(clearTimeout(m.ticking.timeoutID),m.ticking.sound?.fadeOut(m.ticking.fadeOutDuration),onlinegame.areInOnlineGame()&&s!==onlinegame.getOurColor()||!u)return;if(l<1e4)return;const t=u-m.ticking.timeToStartFromEnd-e;if(t>0)m.ticking.timeoutID=setTimeout(k,t);else{k(-t)}}(e),function(e){if(clearTimeout(m.tick.timeoutID),m.tick.sound?.fadeOut(m.tick.fadeOutDuration),onlinegame.areInOnlineGame()&&s!==onlinegame.getOurColor()||!u)return;const t=u-m.tick.timeToStartFromEnd-e;if(t>0)m.tick.timeoutID=setTimeout(T,t);else{T(-t)}}(e)}function C(e){if(!e)return console.error("Cannot play drum without secsRemaining");sound.playSound_drum();if(u-Date.now()<1500)return;const t=e-1;if(0===t)return;const o=u-Date.now()-1e3*t;m.drum.timeoutID=setTimeout(C,o,t)}function k(e){m.ticking.sound=sound.playSound_ticking({fadeInDuration:m.ticking.fadeInDuration,offset:e})}function T(e){m.tick.sound=sound.playSound_tick({volume:.07,fadeInDuration:m.tick.fadeInDuration,offset:e})}return Object.freeze({set:function(e,t){if(!game.getGamefile())return console.error("Game must be initialized before starting the clocks.");const s=function(e){const[t,o]=e.split("+").map((e=>+e));return{minutes:t,increment:o}}(e);if(r.minutes=s.minutes,r.millis=math.minutesToMillis(r.minutes),r.increment=s.increment,i=0===r.minutes&&void 0===r.increment,i)return style.hideElement(o),void style.hideElement(n);style.revealElement(o),style.revealElement(n),t?p(t.timerWhite,t.timerBlack,t.timeNextPlayerLosesAt):(a.white=r.millis,a.black=r.millis),v()},edit:p,stop:g,reset:function(){g(),i=void 0,r.minutes=void 0,r.millis=void 0,r.increment=void 0,a.white=void 0,a.black=void 0,d.whiteNotified=!1,d.blackNotified=!1,m.drum.timeoutID=void 0,m.tick.sound=void 0,m.ticking.sound=void 0,m.tick.timeoutID=void 0,m.ticking.timeoutID=void 0,f(e),f(t)},update:function(){const o=game.getGamefile();if(i||o.gameConclusion||!movesscript.isGameResignable(o)||null==l)return;"white"===s?h(e,a.white):h(t,a.black);const n=Date.now()-l;"white"===s?a.white=Math.ceil(c-n):a.black=Math.ceil(c-n),v(),onlinegame.areInOnlineGame()||(a.white<=0?(o.gameConclusion="black time",gamefileutility.concludeGame(game.getGamefile())):a.black<=0&&(o.gameConclusion="white time",gamefileutility.concludeGame(game.getGamefile())))},push:function(){if(onlinegame.areInOnlineGame())return;if(i)return;const o=game.getGamefile();movesscript.isGameResignable(o)&&(a[s]+=math.secondsToMillis(r.increment),s=s?math.getOppositeColor(s):o.startSnapshot.turn,c=a[s],l=Date.now(),u=l+c,b(),w(),f("white"===s?t:e))},getClockFromKey:function(e){if("0"===e)return"No Clock";const t=e.split("+");return`${t[0]}m+${t[1]}s`},isClockValueInfinite:function(e){return"0"===e},printClocks:function(){console.log(`White time: ${a.white}`),console.log(`Black time: ${a.black}`),console.log(`timeRemainAtTurnStart: ${c}`),console.log(`timeAtTurnStart: ${l}`)}})}(),coin=function(){const e=["xxg","cxhg","dvsi","wnnh","bsfvl","bciph","xwui","lprd","bxksd","brsvd","bnesg","beeud","wst","bqvoe","qmch","jshi","yqyg","rtja","bjohd","lrql","oyqo","bqxv","btqta","bdanl","bjwxi","byhah","zyrk","pdya","vpka","uqxd","tgrk","egzd","bqdhi","gcvh","osae","btrua","bclih","plgh","bfmsl","bsxza"],t="jdhagkleioqcfmnzxyptsuvrw";function o(e){let o=0,n=1,i=e.startsWith("b");i&&(e=e.substring(1));const r=function(e,t){const o=e.length,n=-t%o;return e.slice(n)+e.slice(0,n)}(e,-3);for(let e=r.length-1;e>=0;e--){o+=t.indexOf(r[e])*n,n*=25}return o/=3,i?-o:o}return Object.freeze({appDat:function(t,n,i,r){const{texStartX:a,texStartY:s,texEndX:c,texEndY:l}=bufferdata.getTexDataOfType("yellow");for(let u=0;u<e.length;u+=2){const d=[o(e[u]),o(e[u+1])],m=bufferdata.getCoordDataOfTile_WithOffset(t.mesh.offset,d),p=m.startX,g=m.startY,f=m.endX,h=m.endY,v=1,P=1,b=1,y=1,w=r?bufferdata.getDataQuad_ColorTexture(p,g,f,h,a,s,c,l,v,P,b,y):bufferdata.getDataQuad_Texture(p,g,f,h,a,s,c,l);for(let e=0;e<w.length;e++)i.data32[n]=w[e],i.data64[n]=w[e],n++}return n},getCoinCount:function(){return e.length/2}})}(),copypastegame=function(){const e=["White","Black","Clock","Rated"];return Object.freeze({callbackCopy:function(e){e=e||window.event;const t=game.getGamefile(),o=t.metadata.Variant,n=function(e){let t={};const o=math.deepCopyObject(e.gameRules);t.metadata=e.metadata,t.turn=e.startSnapshot.turn,t.enpassant=e.startSnapshot.enpassant,o.moveRule&&(t.moveRule=`${e.startSnapshot.moveRuleState}/${o.moveRule}`);delete o.moveRule,t.fullMove=e.startSnapshot.fullMove,t.startingPosition=e.startSnapshot.positionString,t.moves=e.moves,t.gameRules=o;0;return t}(t),i=!("Omega^2"===o||"Omega^3"===o||"Omega^4"===o),r=formatconverter.LongToShort_Format(n,{compact_moves:1,make_new_lines:!1,specifyPosition:i});main.copyToClipboard(r),statustext.showStatus("Copied game to clipboard!")},callbackPaste:async function(t){if(t=t||window.event,onlinegame.areInOnlineGame()&&!onlinegame.getIsPrivate())return statustext.showStatus("Cannot paste game in a public match!");if(onlinegame.areInOnlineGame()&&onlinegame.getIsPrivate()&&game.getGamefile().moves.length>0)return statustext.showStatus("Cannot paste game after moves are made!");let o,n;try{o=await navigator.clipboard.readText()}catch(e){const t="Clipboard permission denied. This might be your browser.";return statustext.showStatus(t+"\n"+e,!0)}try{n=JSON.parse(o)}catch(e){try{n=formatconverter.ShortToLong_Format(o,!0,!0)}catch(e){return console.error(e),void statustext.showStatus("Clipboard is not in valid ICN notation.",!0)}}n=backcompatible.getLongformatInNewNotation(n),function(e){e.metadata||(e.metadata={});e.turn||(e.turn="white");e.fullMove||(e.fullMove=1);if(!e.startingPosition&&!e.metadata.Variant)return statustext.showStatus("Game needs to specify either the 'Variant' metadata, or 'startingPosition' property.",!0),!1;e.startingPosition&&!e.specialRights&&(e.specialRights={});e.gameRules||(e.gameRules=variant.getBareMinimumGameRules());return e.gameRules.winConditions=e.gameRules.winConditions||variant.getDefaultWinConditions(),!!function(e){for(let t=0;t<e.white.length;t++){const o=e.white[t];if(!wincondition.validWinConditions.includes(o))return statustext.showStatus(`White has an invalid win condition "${o}".`,!0),!1}for(let t=0;t<e.black.length;t++){const o=e.black[t];if(!wincondition.validWinConditions.includes(o))return statustext.showStatus(`Black has an invalid win condition "${o}".`,!0),!1}return!0}(e.gameRules.winConditions)&&(e.gameRules.promotionRanks=e.gameRules.promotionRanks||null,e.gameRules.promotionsAllowed=e.gameRules.promotionsAllowed||{white:[],black:[]},!0)}(n)&&function(t){if(console.log("Pasting game..."),!function(e){if(void 0!==e.slideLimit&&"number"!=typeof e.slideLimit)return statustext.showStatus(`slideLimit gamerule must be a number. Received "${e.slideLimit}"`,!0),!1;return!0}(t.gameRules))return;const o=game.getGamefile().metadata;e.forEach((e=>{t.metadata[e]=o[e]})),(t.shortposition||t.startingPosition)&&(t.metadata.Date=o.Date);delete t.metadata.Result,delete t.metadata.Condition;const n={turn:t.turn,fullMove:t.fullMove,enpassant:t.enpassant,moveRule:t.moveRule,positionString:t.shortposition,startingPosition:t.startingPosition,specialRights:t.specialRights,gameRules:t.gameRules};if(onlinegame.areInOnlineGame()&&onlinegame.getIsPrivate()){const e=onlinegame.getGameID();localstorage.saveItem(e,n)}const i=new gamefile(t.metadata,{moves:t.moves,variantOptions:n}),r=onlinegame.getIsPrivate()?" Pasting a game in a private match will cause a desync if your opponent doesn't do the same!":"";let a=!1;if(i.startSnapshot.pieceCount>=gamefileutility.pieceCountToDisableCheckmate){a=!0,statustext.showStatus(`Piece count ${i.startSnapshot.pieceCount} exceeded ${gamefileutility.pieceCountToDisableCheckmate}! Changed checkmate win conditions to royalcapture, and toggled off icon rendering. Hit 'P' to re-enable (not recommended).${r}`,!1,1.5);const e=i.gameRules.winConditions.white.includes("checkmate"),t=i.gameRules.winConditions.black.includes("checkmate");e&&(math.removeObjectFromArray(i.gameRules.winConditions.white,"checkmate",!0),i.gameRules.winConditions.white.push("royalcapture")),t&&(math.removeObjectFromArray(i.gameRules.winConditions.black,"checkmate",!0),i.gameRules.winConditions.black.push("royalcapture"))}if(!a){const e=`Loaded game from clipboard!${r}`;statustext.showStatus(e)}game.unloadGame(),game.loadGamefile(i),console.log("Loaded game!")}(n)}})}(),formatconverter=function(){const e={kingsW:"K",kingsB:"k",pawnsW:"P",pawnsB:"p",knightsW:"N",knightsB:"n",bishopsW:"B",bishopsB:"b",rooksW:"R",rooksB:"r",queensW:"Q",queensB:"q",amazonsW:"AM",amazonsB:"am",hawksW:"HA",hawksB:"ha",chancellorsW:"CH",chancellorsB:"ch",archbishopsW:"AR",archbishopsB:"ar",guardsW:"GU",guardsB:"gu",camelsW:"CA",camelsB:"ca",giraffesW:"GI",giraffesB:"gi",zebrasW:"ZE",zebrasB:"ze",centaursW:"CE",centaursB:"ce",royalQueensW:"RQ",royalQueensB:"rq",royalCentaursW:"RC",royalCentaursB:"rc",obstaclesN:"ob",voidsN:"vo"};const t=function(e){let t={};for(let o in e)t[e[o]]=o;return t}(e);function o(t){if(!e[t])throw new Error("Unknown piece type detected: "+t);return e[t]}function n(e){if(!t[e])throw new Error("Unknown piece abbreviation detected: "+e);return t[e]}function i(e){try{JSON.parse(e)}catch(e){return!1}return!0}function r(e,{next_move:t,fullmove:n,make_new_lines:i,compact_moves:r}){if("string"==typeof e[0])return e.join("|");let a="";for(let s=0;s<e.length;s++){let c=e[s];"w"==t&&0==r?(a+=i||0==s?"":" ",a+=n.toString()+". "):a+=0==r?0==s?n.toString()+".   ...   | ":" | ":0==s?"":"|",a+=!c.type||0!=r&&1!=r?"":o(c.type),a+=c.startCoords.toString(),a+=0==r?" ":"",a+=!c.captured||0!=r&&1!=r?">":"x",a+=0==r?" ":"",a+=c.endCoords.toString(),a+=0==r?" ":"",c.promotion&&(a+=0==r||1==r?"=":"",a+=o(c.promotion)),!c.mate||0!=r&&1!=r?!c.check||0!=r&&1!=r||(a+="+"):a+="#",a=a.trimEnd(),"w"==t?t="b":(t="w",n+=1,s!=e.length-1&&0==r&&(a+=i?"\n":" |"))}return a.trimEnd()}function a(e){const t=[];for(e.replace(/[\!\?=]/g,"");e.indexOf("{")>-1;){let t=e.indexOf("{"),o=e.indexOf("}");if(-1==o)throw new Error("Unclosed { found.");e=e.slice(0,t)+"|"+e.slice(o+1)}if(!(e=e.match(/[a-zA-Z]*-?[0-9]+,-?[0-9]+[\s]*(x|>)+[\s]*-?[0-9]+,-?[0-9]+[^\|\.0-9]*/g)))return t;for(let o=0;o<e.length;o++){let n=e[o].match(/-?[0-9]+,-?[0-9]+/g),i=n[0],r=n[1],a=e[o].lastIndexOf(r)+r.length,s=e[o].slice(a).trimStart().trimEnd(),c=/[a-zA-Z]+/.test(s)?s.match(/[a-zA-Z]+/):"";t.push(`${i}>${r}${c}`)}return t}function s(e,t={}){let n="";if(!e)return n;for(let i in e)t[i]?n+=`${o(e[i])}${i}+|`:n+=`${o(e[i])}${i}|`;return 0!=n.length&&(n=n.slice(0,-1)),n}function c(e,t,o){const n={},i={},r={};for(const a in e){const s=e[a];t&&s.startsWith("pawns")?n[a]=!0:o&&s.startsWith("kings")?(n[a]=!0,i[a]=u(s)):o&&s.startsWith(o)&&(r[a]=u(s))}if(0===Object.keys(i).length)return n;e:for(const e in r){const t=l(e);for(const o in i){const a=l(o);if(t[1]!==a[1])continue;if(r[e]!==i[o])continue;if(!(Math.abs(t[0]-a[0])<3)){n[e]=!0;continue e}}}return n}function l(e){return e.split(",").map(Number)}function u(e){if(e.endsWith("W"))return"white";if(e.endsWith("B"))return"black";if(e.endsWith("N"))return"neutral";throw new Error(`Cannot get color of piece with type "${e}"!`)}function d(e){const t={},o={},i=/[a-zA-Z]/,r=e.length-1;let a=0,s=0;for(;a<r;){let c=e[a],l=1;for(;;){let t=e[a+l];if(!i.test(t))break;c+=t,l++}if(s=e.slice(a).search(/\+|\|/),-1!=s)if("+"==e[a+s]){let i=e.slice(a+l,a+s);t[i]=n(c),o[i]=!0,a+=s+2}else t[e.slice(a+l,a+s)]=n(c),a+=s+1;else if("+"==e.slice(-1)){let i=e.slice(a+l,-1);t[i]=n(c),o[i]=!0,a=r}else t[e.slice(a+l)]=n(c),a=r}return{startingPosition:t,specialRights:o}}function m(e){if("object"!=typeof e)return e;let t=Array.isArray(e)?[]:{};for(let o in e){const n=e[o];t[o]=m(n)}return t}return Object.freeze({LongToShort_Format:function(e,{compact_moves:t=0,make_new_lines:n=!0,specifyPosition:i=!0}={}){let a="",c=n?"\n":" ";for(let t in e.metadata)null!=e.metadata[t]&&(a+=`[${t}: ${e.metadata[t]}]${c}`);e.metadata&&(a+=c);let l="w";"black"==e.turn?(a+="b ",l="b"):"white"==e.turn&&(a+="w ",l="w"),e.enpassant&&(a+=`${e.enpassant.toString()} `),e.moveRule&&(a+=`${e.moveRule.toString()} `);let u=1;if(e.fullMove&&(a+=`${e.fullMove.toString()} `,u=parseInt(e.fullMove)),e.gameRules&&e.gameRules.promotionRanks){if(a+="(",null!=e.gameRules.promotionRanks[0]){let t=e.gameRules.promotionsAllowed?e.gameRules.promotionsAllowed.white:null;if(a+=e.gameRules.promotionRanks[0],t&&!(4==t.length&&t.includes("rooks")&&t.includes("queens")&&t.includes("bishops")&&t.includes("knights"))){a+=";";for(let e of t)a+=`${o(e+"W")},`;a=a.slice(0,-1)}}if(a+="|",null!=e.gameRules.promotionRanks[1]){let t=e.gameRules.promotionsAllowed?e.gameRules.promotionsAllowed.black:null;if(a+=e.gameRules.promotionRanks[1],t&&!(4==t.length&&t.includes("rooks")&&t.includes("queens")&&t.includes("bishops")&&t.includes("knights"))){a+=";";for(let e of t)a+=`${o(e+"B")},`;a=a.slice(0,-1)}}a+=") "}if(e.gameRules&&e.gameRules.winConditions){let t=e.gameRules.winConditions.white,o=e.gameRules.winConditions.black;if(t&&o){let e=!0;if(t.length==o.length)for(let n=0;n<t.length;n++){let i=!1;for(let e=0;e<o.length;e++)if(t[n]==o[e]){i=!0;break}i||(e=!1)}else e=!1;e?(t.length>1||"checkmate"!==t[0])&&(a+=`${t.toString()} `):a+=`(${t.toString()}|${o.toString()}) `}}const d={};let m=!1;for(const t in e.gameRules)"promotionRanks"!==t&&"promotionsAllowed"!==t&&"winConditions"!==t&&(d[t]=e.gameRules[t],m=!0);return m&&(a+=`${JSON.stringify(d)} `),i&&(a+="string"!=typeof e.startingPosition?s(e.startingPosition,e.specialRights):e.startingPosition,e.moves&&(a+=`${c}${c}`)),e.moves&&(a+=r(e.moves,{next_move:l,fullmove:u,compact_moves:t,make_new_lines:n})),a},ShortToLong_Format:function(e){let t={gameRules:{}},o={};for(;e.indexOf("[")>-1;){let t=e.indexOf("["),n=e.indexOf("]");if(-1==n)throw new Error("Unclosed [ detected");let i=e.slice(t+1,n);e=`${e.slice(0,t)}${e.slice(n+1)}`;let r=i.indexOf(": ");r>-1?o[i.slice(0,r)]=i.slice(r+2):o[i]=""}for(t.metadata=o;""!=e;){if(/\s/.test(e[0])){e=e.slice(1);continue}let o=e.search(/\s/);-1==o&&(o=e.length);let r=e.slice(0,o),s=e.slice(o,o+1);if(e=e.slice(o+1),t.turn||!/^(w|b)$/.test(r))if(t.enpassant||!/^(-?[0-9]+,-?[0-9]+)$/.test(r))if(t.moveRule||!/^([0-9]+\/[0-9]+)$/.test(r))if(t.fullMove||!/^([0-9]+)$/.test(r))if(!/^\(((()|([^\(\)\|]*\|)-?[0-9]+)|(\|\)$))/.test(r)||t.gameRules.promotionRanks)if(!/^(\(?[a-zA-z][^0-9]*)$/.test(r)||t.gameRules.winConditions)if("{"!==r[0])if(t.startingPosition||!/^([a-zA-z]+-?[0-9]+,-?[0-9]+\+?($|\|))/.test(r)){if(/^(([0-9]+\.)|([a-zA-Z]*-?[0-9]+,-?[0-9]+[\s]*(x|>)+))/.test(r)){const o=a((r+"  "+e).trimEnd());return o.length>0&&(t.moves=o),t.gameRules.winConditions||(t.gameRules.winConditions={white:["checkmate"],black:["checkmate"]}),t}}else{const{startingPosition:e,specialRights:o}=d(r);t.specialRights=o,t.startingPosition=e,t.shortposition=r}else{for(r+=s;!i(r);){if(""==e)throw new Error("Extra optional arguments not in JSON format");let t=e.search(/\s/);-1==t&&(t=e.length),r+=e.slice(0,t+1),e=e.slice(t+1)}let o=JSON.parse(r);for(let e in o)t.gameRules[e]=o[e]}else{t.gameRules.winConditions={},r=r.replace(/[\(\)]/g,"").split("|"),1==r.length&&r.push(r[0]);for(let e=0;e<2;e++){let o=0==e?"white":"black";t.gameRules.winConditions[o]=[];for(let n of r[e].split(","))t.gameRules.winConditions[o].push(n)}}else{if(r=r.replace(/[\(\)]+/g,"").split("|"),2!==r.length)throw new Error("Promotion ranks needs exactly 2 values");t.gameRules.promotionRanks=[],t.gameRules.promotionsAllowed={white:[],black:[]};for(let e=0;e<2;e++){let o=0==e?"white":"black";if(""!=r[e]&&null!=r[e]){let i=-1==r[e].indexOf(";")?parseInt(r[e]):parseInt(r[e].split(";")[0]);if(isNaN(i))throw new Error("Promotion rank is NaN");if(t.gameRules.promotionRanks.push(i),r[e]=r[e].split(";"),1==r[e].length)t.gameRules.promotionsAllowed[o]=["queens","rooks","bishops","knights"];else{t.gameRules.promotionsAllowed[o]=[];for(let i of r[e][1].split(","))t.gameRules.promotionsAllowed[o].push(n(i).slice(0,-1))}}else t.gameRules.promotionRanks.push(void 0)}}else t.fullMove=parseInt(r);else t.moveRule=r;else t.enpassant=[parseInt(r.split(",")[0]),parseInt(r.split(",")[1])];else t.turn="b"==r?"black":"white"}return t.gameRules.winConditions||(t.gameRules.winConditions={white:["checkmate"],black:["checkmate"]}),t},GameToPosition:function(e,t=0,o=!1){if("string"==typeof e.startingPosition)throw new Error("startingPosition must be in json format!");if(!e.moves||0===e.moves.length)return e;let n=o?e:m(e),i=n.enpassant?n.enpassant:"";for(let e=0;e<Math.min(t,n.moves.length);e++){let t=n.moves[e];n.turn?("black"==n.turn&&n.fullMove&&(n.fullMove+=1),n.turn="black"==n.turn?"white":"black"):"B"==t.type.slice(-1)&&n.fullMove&&(n.fullMove+=1);let o=t.startCoords.toString(),r=t.endCoords.toString();if(t.promotion?n.startingPosition[r]=`${t.promotion}`:n.startingPosition[r]=`${n.startingPosition[o]}`,delete n.startingPosition[o],n.specialRights&&(delete n.specialRights[o],delete n.specialRights[r]),n.moveRule){let e=n.moveRule.indexOf("/");t.captured||"pawns"==t.type.slice(0,-1)?n.moveRule=`0/${n.moveRule.slice(e+1)}`:n.moveRule=`${(parseInt(n.moveRule.slice(0,e))+1).toString()}/${n.moveRule.slice(e+1)}`}if(t.enpassant&&(delete n.startingPosition[i],n.specialRights&&delete n.specialRights[i]),"pawns"==t.type.slice(0,-1)&&Math.abs(t.startCoords[1]-t.endCoords[1])>1?n.enpassant=[t.endCoords[0],Math.round(.5*(t.startCoords[1]+t.endCoords[1]))]:delete n.enpassant,t.castle){let e=t.castle.coord[0].toString()+","+t.castle.coord[1].toString();n.startingPosition[`${(parseInt(t.endCoords[0])-t.castle.dir).toString()},${t.endCoords[1].toString()}`]=`${n.startingPosition[e]}`,delete n.startingPosition[e],n.specialRights&&delete n.specialRights[e]}i=r}return delete n.moves,n.moves=[],n},LongToShort_CompactMove:function(e){let t=e.promotion?o(e.promotion):"";return`${e.startCoords.toString()}>${e.endCoords.toString()}${t}`},ShortToLong_CompactMove:function(e){let t=e.match(/-?[0-9]+,-?[0-9]+/g);if(2!==t.length)throw new Error(`Short move does not contain 2 valid coordinates: ${JSON.stringify(t)}`);t=t.map((e=>l(e))),t.forEach((e=>{if(!isFinite(e[0]))throw new Error(`Move coordinate must not be Infinite. coords: ${e}`);if(!isFinite(e[1]))throw new Error(`Move coordinate must not be Infinite. coords: ${e}`)}));let o=/[a-zA-Z]+/.test(e)?n(e.match(/[a-zA-Z]+/)):"",i={compact:e};return i.startCoords=t[0],i.endCoords=t[1],""!=o&&(i.promotion=o),i},LongToShort_Position:s,LongToShort_Position_FromGamerules:function(e,t,o){return s(e,c(e,t,o))},getStartingPositionAndSpecialRightsFromShortPosition:d,generateSpecialRights:c,convertShortMovesToLong:a,longToShortMoves:r})}(),game=function(){let e;return Object.freeze({getGamefile:function(){return e},init:function(){board.initTextures(),pieces.initSpritesheet(),pieces.initSpritesheetData(),guititle.open(),board.recalcTileWidth_Pixels()},updateVariablesAfterScreenResize:function(){board.initDarkTilesModel(),movement.setScale_When1TileIs1Pixel_Physical(2*camera.getScreenBoundingBox(!1).right/camera.canvas.width),movement.setScale_When1TileIs1Pixel_Virtual(movement.getScale_When1TileIs1Pixel_Physical()*camera.getPixelDensity())},update:function(){input.isKeyDown("`")&&options.toggleDeveloperMode(),input.isKeyDown("m")&&options.toggleFPS(),game.getGamefile()?.mesh.locked&&input.isKeyDown("z")&&main.sforceCalc(!0),gui.getScreen().includes("title")?(movement.panBoard(),invites.update()):function(){input.isKeyDown("1")&&options.toggleEM();input.isKeyDown("escape")&&guipause.toggle();input.isKeyDown("tab")&&guipause.callback_TogglePointers();input.isKeyDown("r")&&piecesmodel.regenModel(game.getGamefile(),options.getPieceRegenColorArgs(),!0);input.isKeyDown("n")&&options.toggleNavigationBar();if(clock.update(),miniimage.testIfToggled(),animation.update(),guipause.areWePaused()&&!onlinegame.areInOnlineGame())return;if(movement.recalcPosition(),transition.update(),board.recalcVariables(),movesscript.update(),arrows.update(),selection.update(),miniimage.genModel(),highlightline.genModel(),movement.updateNavControls(),guipause.areWePaused())return;movement.dragBoard()}(),onlinegame.update(),guinavigation.updateElement_Coords()},render:function(){board.render(),function(){if(gui.getScreen().includes("title"))return;input.renderMouse(),webgl.executeWithDepthFunc_ALWAYS((()=>{highlights.render(),highlightline.render()})),animation.renderTransparentSquares(),pieces.renderPiecesInGame(e),animation.renderPieces(),webgl.executeWithDepthFunc_ALWAYS((()=>{promotionlines.render(),selection.renderGhostPiece(),arrows.renderThem(),perspective.renderCrosshair()}))}()},loadGamefile:function(t){if(e)return console.error("Must unloadGame() before loading a new one!");e=t,t.startSnapshot.pieceCount>=gamefileutility.pieceCountToDisableCheckmate?(miniimage.disable(),arrows.setMode(0)):miniimage.enable(),guipromotion.initUI(e.gameRules.promotionsAllowed),piecesmodel.regenModel(game.getGamefile(),options.getPieceRegenColorArgs()),main.enableForceRender(),guinavigation.update_MoveButtons(),guigameinfo.updateWhosTurn(e),e.gameConclusion&&gamefileutility.concludeGame(e,e.gameConclusion)},unloadGame:function(){e.mesh.terminateIfGenerating(),e=void 0,selection.unselectPiece(),transition.eraseTelHist(),board.updateTheme()}})}();function gamefile(e,{moves:t=[],variantOptions:o,gameConclusion:n}={}){this.metadata={Variant:void 0,Version:void 0,White:void 0,Black:void 0,Clock:void 0,Date:void 0,Result:void 0,Condition:void 0},this.startSnapshot={position:void 0,positionString:void 0,specialRights:void 0,enpassant:void 0,moveRuleState:void 0,fullMove:void 0,turn:void 0,pieceCount:void 0,box:void 0},this.gameRules={winConditions:void 0,promotionRanks:void 0,promotionsAllowed:{white:void 0,black:void 0},slideLimit:void 0},this.ourPieces=void 0,this.piecesOrganizedByKey=void 0,this.piecesOrganizedByKey=void 0,this.piecesOrganizedByRow=void 0,this.piecesOrganizedByColumn=void 0,this.piecesOrganizedByUpDiagonal=void 0,this.piecesOrganizedByDownDiagonal=void 0,this.mesh={data64:void 0,data32:void 0,rotatedData64:void 0,rotatedData32:void 0,model:void 0,rotatedModel:void 0,usingColoredTextures:void 0,stride:void 0,offset:void 0,isGenerating:0,locked:0,terminateIfGenerating:()=>{this.mesh.isGenerating&&(this.mesh.terminate=!0)},terminate:!1},this.voidMesh={data64:void 0,data32:void 0,model:void 0},this.pieceMovesets=void 0,this.vicinity=void 0,this.specialDetects=void 0,this.specialMoves=void 0,this.specialUndos=void 0,math.copyPropertiesToObject(e,this.metadata),variant.setupVariant(this,e,o),this.moveRuleState=this.gameRules.moveRule?this.startSnapshot.moveRuleState:void 0,area.initStartingAreaBox(this),this.moves=[],this.moveIndex=-1,this.enpassant=math.deepCopyObject(this.startSnapshot.enpassant),this.specialRights=math.deepCopyObject(this.startSnapshot.specialRights),this.whosTurn=this.startSnapshot.turn,this.inCheck=void 0,this.attackers=void 0,this.checksGiven=void 0,this.ourPieces=organizedlines.buildStateFromKeyList(this.startSnapshot.position),this.startSnapshot.pieceCount=gamefileutility.getPieceCountOfGame(this),organizedlines.initOrganizedPieceLists(this,{apphendUndefineds:!1}),movepiece.makeAllMovesInGame(this,t),this.gameConclusion=n||this.gameConclusion,organizedlines.addMoreUndefineds(this,{regenModel:!1})}const gamefileutility=function(){function e(e,t,o,n){if(!t)return console.log("Cannot iterate through each piece in an undefined typeList!");for(let o=0;o<pieces.white.length;o++){const i=pieces.white[o],r=pieces.black[o],a=t[i],s=t[r];if(a)for(let t=0;t<a.length;t++)e(i,a[t],n);if(s)for(let t=0;t<s.length;t++)e(r,s[t],n)}for(let i=0;i<pieces.neutral.length;i++){const r=pieces.neutral[i];if(o&&r.startsWith("voids"))continue;const a=t[r];if(a)for(let t=0;t<a.length;t++)e(r,a[t],n)}}function t(e,t,{ignoreNeutrals:o,ignoreVoids:n}={}){if(!t)return console.log("Cannot iterate through each piece in an undefined keys-state!");if(o)for(let o in t){const n=t[o];n.endsWith("N")||e(n,math.getCoordsFromKey(o))}if(n)for(let o in t){const n=t[o];n.startsWith("voids")||e(n,math.getCoordsFromKey(o))}else for(let o in t){e(t[o],math.getCoordsFromKey(o))}}function o(e,t,o){const n=e.ourPieces[t];if(!n)return console.error("Cannot find piece index. Type array doesn't exist.");for(let e=0;e<n.length;e++){const t=n[e];if(t&&math.areCoordsEqual_noValidate(t,o))return e}console.error("Unable to find index of piece!")}function n(e,t){const o=math.getKeyFromCoords(t);return e.piecesOrganizedByKey[o]}function i(e,t=e.gameConclusion,{requestRemovalFromActiveGames:o=!0}={}){e.gameConclusion=t,o&&onlinegame.requestRemovalFromPlayersInActiveGames(),wincondition.isGameConclusionDecisive(e.gameConclusion)&&movesscript.flagLastMoveAsMate(e),clock.stop(),main.renderThisFrame(),board.darkenColor(),guigameinfo.gameEnd(e.gameConclusion),onlinegame.cancelAFKTimer(),onlinegame.cancelFlashTabTimer(),onlinegame.cancelMoveSound(),onlinegame.resetServerRestarting(),onlinegame.deleteCustomVariantOptions();const n=.65;if(onlinegame.areInOnlineGame())e.gameConclusion.includes(onlinegame.getOurColor())?sound.playSound_win(n):e.gameConclusion.includes("draw")||e.gameConclusion.includes("aborted")?sound.playSound_draw(n):sound.playSound_loss(n);else{e.gameConclusion.includes("draw")?sound.playSound_draw(n):sound.playSound_win(n);const{victor:o,condition:i}=wincondition.getVictorAndConditionFromGameConclusion(t);e.metadata.Condition=math.capitalizeFirstLetter(i),e.metadata.Result="white"===o?"1-0":"black"===o?"0-1":"0.5-0.5"}selection.unselectPiece(),guipause.changeTextOfMainMenuButton(),function(e){if(!e.gameConclusion)return console.error("Cannot set conclusion metadata when game isn't over yet.");const t=wincondition.getVictorAndConditionFromGameConclusion(e.gameConclusion),o=math.capitalizeFirstLetter(t.condition);e.metadata.Condition=o;const n=t.victor;if(!n)return;e.metadata.Result="white"===n?"1-0":"black"===n?"0-1":"0.5-0.5"}(e)}return Object.freeze({pieceCountToDisableCheckmate:5e4,forEachPieceInGame:function(t,o,n){return t?t.ourPieces?void e(o,t.ourPieces,n,t):console.error("Cannot iterate through every piece of game when there's no piece list."):console.log("Cannot iterate through each piece in an undefined game!")},forEachPieceInPiecesByType:e,forEachPieceInKeysState:t,deleteIndexFromPieceList:function(e,t){e[t]=void 0;const o=math.binarySearch_findSplitPoint(e.undefineds,t);e.undefineds.splice(o,0,t)},getPieceIndexByTypeAndCoords:o,getPieceTypeAtCoords:n,getPieceAtCoords:function(e,t){const i=n(e,t);if(!i)return;return{type:i,index:o(e,i,t),coords:t}},getPieceAtCoords_noIndex:function(e,t){const o=n(e,t);if(o)return{type:o,coords:t}},getPieceFromTypeAndCoords:function(e,t,n){return{type:t,coords:n,index:o(e,t,n)}},updateGameConclusion:function(e,{concludeGameIfOver:t=!0,simulated:o=!1}={}){e.gameConclusion=wincondition.getGameConclusion(e),!o&&t&&e.gameConclusion&&!onlinegame.areInOnlineGame()&&i(e)},concludeGame:i,getJumpingRoyalCoords:function(e,t){const o=e.ourPieces,n=pieces.jumpingRoyals,i=[];if("white"===t)for(let e=0;e<n.length;e++){const t=n[e]+"W";if(!o[t])return console.error(`Cannot fetch jumping royal coords when list ${t} is undefined!`);o[t].forEach((e=>{e&&i.push(e)}))}else if("black"===t)for(let e=0;e<n.length;e++){const t=n[e]+"B";if(!o[t])return console.error(`Cannot fetch jumping royal coords when list ${t} is undefined!`);o[t].forEach((e=>{e&&i.push(e)}))}else console.error(`Cannot get jumping royal coords from a side with color ${t}!`);return i},getCountOfTypesFromPiecesByType:function(e,t,o){const n=math.getWorBFromColor(o);let i=0;for(let o=0;o<t.length;o++){const r=t[o]+n;if(!e[r])return console.error(`Cannot fetch royal count of type ${r} when the list is undefined!`);let a=e[r].length;e[r].undefineds&&(a-=e[r].undefineds.length),i+=a}return i},getCoordsOfAllPieces:function(t){const o=[];return e((function(e,t){t&&o.push(t)}),t.ourPieces),o},getCoordsOfAllPiecesByKey:function(e){const o=[];return t((function(e,t){o.push(t)}),e),o},getPieceCount:function(e){let t=0;return pieces.forEachPieceType((function(o){t+=e[o].length})),t},getPieceCountOfColorFromPiecesByType:function(e,t){let o=0;return pieces.forEachPieceTypeOfColor(t,(function(t){const n=e[t];for(let e=0;e<n.length;e++){n[e]&&o++}})),o},calcPieceIndexInAllPieces:function(e,t){const o=t.type,n=t.index;let i=0,r=!1;return pieces.forEachPieceType((function(t){if(r)return;if(t.startsWith("voids"))return;const a=e.ourPieces[t];if(t===o)return i+=n,void(r=!0);i+=a.length})),r?i:console.error(`Could not find piece type ${t.type} with index ${t.index} when calculating its index in all the pieces!`)},getRoyalCoords:function(e,t){const o=pieces.royals,n=math.getWorBFromColor(t),i=e.ourPieces,r=[];for(let e=0;e<o.length;e++){const t=o[e]+n,a=i[t];if(!a)return console.error(`Cannot fetch royal coords of type ${t} when the list is undefined!`);for(let e=0;e<a.length;e++){const t=a[e];t&&r.push(t)}}return r},getRoyalCountOfColor:function(e,t){const o=pieces.royals,n=math.getWorBFromColor(t);let i=0;for(const t in e){const r=e[t];if(!math.getPieceColorFromType(r).endsWith(n))return;const a=math.trimWorBFromType(r);o.includes(a)&&i++}return i},getPieceCountOfGame:function(e){if(!e.ourPieces)return console.error("Cannot count pieces, ourPieces is not defined");let t=0;for(const o in e.ourPieces){const n=e.ourPieces[o];t+=n.length,n.undefineds&&(t-=n.undefineds.length)}return t},getWhosTurnAtMoveIndex:function(e,t){let o=Math.abs(t%2);return"black"===e.startSnapshot.turn&&o++,1===o?"white":"black"}})}(),mat4=function(){var e=1e-6,t="undefined"!=typeof Float32Array?Float32Array:Array;function o(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function n(e,t,o){var n=t[0],i=t[1],r=t[2],a=t[3],s=t[4],c=t[5],l=t[6],u=t[7],d=t[8],m=t[9],p=t[10],g=t[11],f=t[12],h=t[13],v=t[14],P=t[15],b=o[0],y=o[1],w=o[2],C=o[3];return e[0]=b*n+y*s+w*d+C*f,e[1]=b*i+y*c+w*m+C*h,e[2]=b*r+y*l+w*p+C*v,e[3]=b*a+y*u+w*g+C*P,b=o[4],y=o[5],w=o[6],C=o[7],e[4]=b*n+y*s+w*d+C*f,e[5]=b*i+y*c+w*m+C*h,e[6]=b*r+y*l+w*p+C*v,e[7]=b*a+y*u+w*g+C*P,b=o[8],y=o[9],w=o[10],C=o[11],e[8]=b*n+y*s+w*d+C*f,e[9]=b*i+y*c+w*m+C*h,e[10]=b*r+y*l+w*p+C*v,e[11]=b*a+y*u+w*g+C*P,b=o[12],y=o[13],w=o[14],C=o[15],e[12]=b*n+y*s+w*d+C*f,e[13]=b*i+y*c+w*m+C*h,e[14]=b*r+y*l+w*p+C*v,e[15]=b*a+y*u+w*g+C*P,e}function i(e,t,o){var n=t[0],i=t[1],r=t[2],a=t[3],s=n+n,c=i+i,l=r+r,u=n*s,d=n*c,m=n*l,p=i*c,g=i*l,f=r*l,h=a*s,v=a*c,P=a*l;return e[0]=1-(p+f),e[1]=d+P,e[2]=m-v,e[3]=0,e[4]=d-P,e[5]=1-(u+f),e[6]=g+h,e[7]=0,e[8]=m+v,e[9]=g-h,e[10]=1-(u+p),e[11]=0,e[12]=o[0],e[13]=o[1],e[14]=o[2],e[15]=1,e}function r(e,t){var o=t[0],n=t[1],i=t[2],r=t[4],a=t[5],s=t[6],c=t[8],l=t[9],u=t[10];return e[0]=Math.hypot(o,n,i),e[1]=Math.hypot(r,a,s),e[2]=Math.hypot(c,l,u),e}function a(e,t,o,n,i){var r=1/Math.tan(t/2);if(e[0]=r/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0){var a=1/(n-i);e[10]=(i+n)*a,e[14]=2*i*n*a}else e[10]=-1,e[14]=-2*n;return e}var s=a;function c(e,t,o,n,i,r,a){var s=1/(t-o),c=1/(n-i),l=1/(r-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+o)*s,e[13]=(i+n)*c,e[14]=(a+r)*l,e[15]=1,e}var l=c;function u(e,t,o){return e[0]=t[0]-o[0],e[1]=t[1]-o[1],e[2]=t[2]-o[2],e[3]=t[3]-o[3],e[4]=t[4]-o[4],e[5]=t[5]-o[5],e[6]=t[6]-o[6],e[7]=t[7]-o[7],e[8]=t[8]-o[8],e[9]=t[9]-o[9],e[10]=t[10]-o[10],e[11]=t[11]-o[11],e[12]=t[12]-o[12],e[13]=t[13]-o[13],e[14]=t[14]-o[14],e[15]=t[15]-o[15],e}var d=n,m=u;return Object.freeze({__proto__:null,create:function(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},clone:function(e){var o=new t(16);return o[0]=e[0],o[1]=e[1],o[2]=e[2],o[3]=e[3],o[4]=e[4],o[5]=e[5],o[6]=e[6],o[7]=e[7],o[8]=e[8],o[9]=e[9],o[10]=e[10],o[11]=e[11],o[12]=e[12],o[13]=e[13],o[14]=e[14],o[15]=e[15],o},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},fromValues:function(e,o,n,i,r,a,s,c,l,u,d,m,p,g,f,h){var v=new t(16);return v[0]=e,v[1]=o,v[2]=n,v[3]=i,v[4]=r,v[5]=a,v[6]=s,v[7]=c,v[8]=l,v[9]=u,v[10]=d,v[11]=m,v[12]=p,v[13]=g,v[14]=f,v[15]=h,v},set:function(e,t,o,n,i,r,a,s,c,l,u,d,m,p,g,f,h){return e[0]=t,e[1]=o,e[2]=n,e[3]=i,e[4]=r,e[5]=a,e[6]=s,e[7]=c,e[8]=l,e[9]=u,e[10]=d,e[11]=m,e[12]=p,e[13]=g,e[14]=f,e[15]=h,e},identity:o,transpose:function(e,t){if(e===t){var o=t[1],n=t[2],i=t[3],r=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=o,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=r,e[11]=t[14],e[12]=i,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},invert:function(e,t){var o=t[0],n=t[1],i=t[2],r=t[3],a=t[4],s=t[5],c=t[6],l=t[7],u=t[8],d=t[9],m=t[10],p=t[11],g=t[12],f=t[13],h=t[14],v=t[15],P=o*s-n*a,b=o*c-i*a,y=o*l-r*a,w=n*c-i*s,C=n*l-r*s,k=i*l-r*c,T=u*f-d*g,S=u*h-m*g,M=u*v-p*g,E=d*h-m*f,B=d*v-p*f,x=m*v-p*h,I=P*x-b*B+y*E+w*M-C*S+k*T;return I?(I=1/I,e[0]=(s*x-c*B+l*E)*I,e[1]=(i*B-n*x-r*E)*I,e[2]=(f*k-h*C+v*w)*I,e[3]=(m*C-d*k-p*w)*I,e[4]=(c*M-a*x-l*S)*I,e[5]=(o*x-i*M+r*S)*I,e[6]=(h*y-g*k-v*b)*I,e[7]=(u*k-m*y+p*b)*I,e[8]=(a*B-s*M+l*T)*I,e[9]=(n*M-o*B-r*T)*I,e[10]=(g*C-f*y+v*P)*I,e[11]=(d*y-u*C-p*P)*I,e[12]=(s*S-a*E-c*T)*I,e[13]=(o*E-n*S+i*T)*I,e[14]=(f*b-g*w-h*P)*I,e[15]=(u*w-d*b+m*P)*I,e):null},adjoint:function(e,t){var o=t[0],n=t[1],i=t[2],r=t[3],a=t[4],s=t[5],c=t[6],l=t[7],u=t[8],d=t[9],m=t[10],p=t[11],g=t[12],f=t[13],h=t[14],v=t[15],P=o*s-n*a,b=o*c-i*a,y=o*l-r*a,w=n*c-i*s,C=n*l-r*s,k=i*l-r*c,T=u*f-d*g,S=u*h-m*g,M=u*v-p*g,E=d*h-m*f,B=d*v-p*f,x=m*v-p*h;return e[0]=s*x-c*B+l*E,e[1]=i*B-n*x-r*E,e[2]=f*k-h*C+v*w,e[3]=m*C-d*k-p*w,e[4]=c*M-a*x-l*S,e[5]=o*x-i*M+r*S,e[6]=h*y-g*k-v*b,e[7]=u*k-m*y+p*b,e[8]=a*B-s*M+l*T,e[9]=n*M-o*B-r*T,e[10]=g*C-f*y+v*P,e[11]=d*y-u*C-p*P,e[12]=s*S-a*E-c*T,e[13]=o*E-n*S+i*T,e[14]=f*b-g*w-h*P,e[15]=u*w-d*b+m*P,e},determinant:function(e){var t=e[0],o=e[1],n=e[2],i=e[3],r=e[4],a=e[5],s=e[6],c=e[7],l=e[8],u=e[9],d=e[10],m=e[11],p=e[12],g=e[13],f=e[14],h=t*a-o*r,v=t*s-n*r,P=o*s-n*a,b=l*g-u*p,y=l*f-d*p,w=u*f-d*g;return c*(t*w-o*y+n*b)-i*(r*w-a*y+s*b)+e[15]*(l*P-u*v+d*h)-m*(p*P-g*v+f*h)},multiply:n,translate:function(e,t,o){var n,i,r,a,s,c,l,u,d,m,p,g,f=o[0],h=o[1],v=o[2];return t===e?(e[12]=t[0]*f+t[4]*h+t[8]*v+t[12],e[13]=t[1]*f+t[5]*h+t[9]*v+t[13],e[14]=t[2]*f+t[6]*h+t[10]*v+t[14],e[15]=t[3]*f+t[7]*h+t[11]*v+t[15]):(n=t[0],i=t[1],r=t[2],a=t[3],s=t[4],c=t[5],l=t[6],u=t[7],d=t[8],m=t[9],p=t[10],g=t[11],e[0]=n,e[1]=i,e[2]=r,e[3]=a,e[4]=s,e[5]=c,e[6]=l,e[7]=u,e[8]=d,e[9]=m,e[10]=p,e[11]=g,e[12]=n*f+s*h+d*v+t[12],e[13]=i*f+c*h+m*v+t[13],e[14]=r*f+l*h+p*v+t[14],e[15]=a*f+u*h+g*v+t[15]),e},scale:function(e,t,o){var n=o[0],i=o[1],r=o[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},rotate:function(t,o,n,i){var r,a,s,c,l,u,d,m,p,g,f,h,v,P,b,y,w,C,k,T,S,M,E,B,x=i[0],I=i[1],D=i[2],R=Math.hypot(x,I,D);return R<e?null:(x*=R=1/R,I*=R,D*=R,r=Math.sin(n),s=1-(a=Math.cos(n)),c=o[0],l=o[1],u=o[2],d=o[3],m=o[4],p=o[5],g=o[6],f=o[7],h=o[8],v=o[9],P=o[10],b=o[11],y=x*x*s+a,w=I*x*s+D*r,C=D*x*s-I*r,k=x*I*s-D*r,T=I*I*s+a,S=D*I*s+x*r,M=x*D*s+I*r,E=I*D*s-x*r,B=D*D*s+a,t[0]=c*y+m*w+h*C,t[1]=l*y+p*w+v*C,t[2]=u*y+g*w+P*C,t[3]=d*y+f*w+b*C,t[4]=c*k+m*T+h*S,t[5]=l*k+p*T+v*S,t[6]=u*k+g*T+P*S,t[7]=d*k+f*T+b*S,t[8]=c*M+m*E+h*B,t[9]=l*M+p*E+v*B,t[10]=u*M+g*E+P*B,t[11]=d*M+f*E+b*B,o!==t&&(t[12]=o[12],t[13]=o[13],t[14]=o[14],t[15]=o[15]),t)},rotateX:function(e,t,o){var n=Math.sin(o),i=Math.cos(o),r=t[4],a=t[5],s=t[6],c=t[7],l=t[8],u=t[9],d=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*i+l*n,e[5]=a*i+u*n,e[6]=s*i+d*n,e[7]=c*i+m*n,e[8]=l*i-r*n,e[9]=u*i-a*n,e[10]=d*i-s*n,e[11]=m*i-c*n,e},rotateY:function(e,t,o){var n=Math.sin(o),i=Math.cos(o),r=t[0],a=t[1],s=t[2],c=t[3],l=t[8],u=t[9],d=t[10],m=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i-l*n,e[1]=a*i-u*n,e[2]=s*i-d*n,e[3]=c*i-m*n,e[8]=r*n+l*i,e[9]=a*n+u*i,e[10]=s*n+d*i,e[11]=c*n+m*i,e},rotateZ:function(e,t,o){var n=Math.sin(o),i=Math.cos(o),r=t[0],a=t[1],s=t[2],c=t[3],l=t[4],u=t[5],d=t[6],m=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i+l*n,e[1]=a*i+u*n,e[2]=s*i+d*n,e[3]=c*i+m*n,e[4]=l*i-r*n,e[5]=u*i-a*n,e[6]=d*i-s*n,e[7]=m*i-c*n,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotation:function(t,o,n){var i,r,a,s=n[0],c=n[1],l=n[2],u=Math.hypot(s,c,l);return u<e?null:(s*=u=1/u,c*=u,l*=u,i=Math.sin(o),a=1-(r=Math.cos(o)),t[0]=s*s*a+r,t[1]=c*s*a+l*i,t[2]=l*s*a-c*i,t[3]=0,t[4]=s*c*a-l*i,t[5]=c*c*a+r,t[6]=l*c*a+s*i,t[7]=0,t[8]=s*l*a+c*i,t[9]=c*l*a-s*i,t[10]=l*l*a+r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromXRotation:function(e,t){var o=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=o,e[7]=0,e[8]=0,e[9]=-o,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var o=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-o,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=o,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var o=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=o,e[2]=0,e[3]=0,e[4]=-o,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotationTranslation:i,fromQuat2:function(e,o){var n=new t(3),r=-o[0],a=-o[1],s=-o[2],c=o[3],l=o[4],u=o[5],d=o[6],m=o[7],p=r*r+a*a+s*s+c*c;return p>0?(n[0]=2*(l*c+m*r+u*s-d*a)/p,n[1]=2*(u*c+m*a+d*r-l*s)/p,n[2]=2*(d*c+m*s+l*a-u*r)/p):(n[0]=2*(l*c+m*r+u*s-d*a),n[1]=2*(u*c+m*a+d*r-l*s),n[2]=2*(d*c+m*s+l*a-u*r)),i(e,o,n),e},getTranslation:function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},getScaling:r,getRotation:function(e,o){var n=new t(3);r(n,o);var i=1/n[0],a=1/n[1],s=1/n[2],c=o[0]*i,l=o[1]*a,u=o[2]*s,d=o[4]*i,m=o[5]*a,p=o[6]*s,g=o[8]*i,f=o[9]*a,h=o[10]*s,v=c+m+h,P=0;return v>0?(P=2*Math.sqrt(v+1),e[3]=.25*P,e[0]=(p-f)/P,e[1]=(g-u)/P,e[2]=(l-d)/P):c>m&&c>h?(P=2*Math.sqrt(1+c-m-h),e[3]=(p-f)/P,e[0]=.25*P,e[1]=(l+d)/P,e[2]=(g+u)/P):m>h?(P=2*Math.sqrt(1+m-c-h),e[3]=(g-u)/P,e[0]=(l+d)/P,e[1]=.25*P,e[2]=(p+f)/P):(P=2*Math.sqrt(1+h-c-m),e[3]=(l-d)/P,e[0]=(g+u)/P,e[1]=(p+f)/P,e[2]=.25*P),e},decompose:function(e,t,o,n){t[0]=n[12],t[1]=n[13],t[2]=n[14];var i=n[0],r=n[1],a=n[2],s=n[4],c=n[5],l=n[6],u=n[8],d=n[9],m=n[10];o[0]=Math.hypot(i,r,a),o[1]=Math.hypot(s,c,l),o[2]=Math.hypot(u,d,m);var p=1/o[0],g=1/o[1],f=1/o[2],h=i*p,v=r*g,P=a*f,b=s*p,y=c*g,w=l*f,C=u*p,k=d*g,T=m*f,S=h+y+T,M=0;return S>0?(M=2*Math.sqrt(S+1),e[3]=.25*M,e[0]=(w-k)/M,e[1]=(C-P)/M,e[2]=(v-b)/M):h>y&&h>T?(M=2*Math.sqrt(1+h-y-T),e[3]=(w-k)/M,e[0]=.25*M,e[1]=(v+b)/M,e[2]=(C+P)/M):y>T?(M=2*Math.sqrt(1+y-h-T),e[3]=(C-P)/M,e[0]=(v+b)/M,e[1]=.25*M,e[2]=(w+k)/M):(M=2*Math.sqrt(1+T-h-y),e[3]=(v-b)/M,e[0]=(C+P)/M,e[1]=(w+k)/M,e[2]=.25*M),e},fromRotationTranslationScale:function(e,t,o,n){var i=t[0],r=t[1],a=t[2],s=t[3],c=i+i,l=r+r,u=a+a,d=i*c,m=i*l,p=i*u,g=r*l,f=r*u,h=a*u,v=s*c,P=s*l,b=s*u,y=n[0],w=n[1],C=n[2];return e[0]=(1-(g+h))*y,e[1]=(m+b)*y,e[2]=(p-P)*y,e[3]=0,e[4]=(m-b)*w,e[5]=(1-(d+h))*w,e[6]=(f+v)*w,e[7]=0,e[8]=(p+P)*C,e[9]=(f-v)*C,e[10]=(1-(d+g))*C,e[11]=0,e[12]=o[0],e[13]=o[1],e[14]=o[2],e[15]=1,e},fromRotationTranslationScaleOrigin:function(e,t,o,n,i){var r=t[0],a=t[1],s=t[2],c=t[3],l=r+r,u=a+a,d=s+s,m=r*l,p=r*u,g=r*d,f=a*u,h=a*d,v=s*d,P=c*l,b=c*u,y=c*d,w=n[0],C=n[1],k=n[2],T=i[0],S=i[1],M=i[2],E=(1-(f+v))*w,B=(p+y)*w,x=(g-b)*w,I=(p-y)*C,D=(1-(m+v))*C,R=(h+P)*C,F=(g+b)*k,L=(h-P)*k,O=(1-(m+f))*k;return e[0]=E,e[1]=B,e[2]=x,e[3]=0,e[4]=I,e[5]=D,e[6]=R,e[7]=0,e[8]=F,e[9]=L,e[10]=O,e[11]=0,e[12]=o[0]+T-(E*T+I*S+F*M),e[13]=o[1]+S-(B*T+D*S+L*M),e[14]=o[2]+M-(x*T+R*S+O*M),e[15]=1,e},fromQuat:function(e,t){var o=t[0],n=t[1],i=t[2],r=t[3],a=o+o,s=n+n,c=i+i,l=o*a,u=n*a,d=n*s,m=i*a,p=i*s,g=i*c,f=r*a,h=r*s,v=r*c;return e[0]=1-d-g,e[1]=u+v,e[2]=m-h,e[3]=0,e[4]=u-v,e[5]=1-l-g,e[6]=p+f,e[7]=0,e[8]=m+h,e[9]=p-f,e[10]=1-l-d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,o,n,i,r,a){var s=1/(o-t),c=1/(i-n),l=1/(r-a);return e[0]=2*r*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*r*c,e[6]=0,e[7]=0,e[8]=(o+t)*s,e[9]=(i+n)*c,e[10]=(a+r)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*r*2*l,e[15]=0,e},perspectiveNO:a,perspective:s,perspectiveZO:function(e,t,o,n,i){var r=1/Math.tan(t/2);if(e[0]=r/o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0){var a=1/(n-i);e[10]=i*a,e[14]=i*n*a}else e[10]=-1,e[14]=-n;return e},perspectiveFromFieldOfView:function(e,t,o,n){var i=Math.tan(t.upDegrees*Math.PI/180),r=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),c=2/(a+s),l=2/(i+r);return e[0]=c,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=-(a-s)*c*.5,e[9]=(i-r)*l*.5,e[10]=n/(o-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*o/(o-n),e[15]=0,e},orthoNO:c,ortho:l,orthoZO:function(e,t,o,n,i,r,a){var s=1/(t-o),c=1/(n-i),l=1/(r-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=l,e[11]=0,e[12]=(t+o)*s,e[13]=(i+n)*c,e[14]=r*l,e[15]=1,e},lookAt:function(t,n,i,r){var a,s,c,l,u,d,m,p,g,f,h=n[0],v=n[1],P=n[2],b=r[0],y=r[1],w=r[2],C=i[0],k=i[1],T=i[2];return Math.abs(h-C)<e&&Math.abs(v-k)<e&&Math.abs(P-T)<e?o(t):(m=h-C,p=v-k,g=P-T,a=y*(g*=f=1/Math.hypot(m,p,g))-w*(p*=f),s=w*(m*=f)-b*g,c=b*p-y*m,(f=Math.hypot(a,s,c))?(a*=f=1/f,s*=f,c*=f):(a=0,s=0,c=0),l=p*c-g*s,u=g*a-m*c,d=m*s-p*a,(f=Math.hypot(l,u,d))?(l*=f=1/f,u*=f,d*=f):(l=0,u=0,d=0),t[0]=a,t[1]=l,t[2]=m,t[3]=0,t[4]=s,t[5]=u,t[6]=p,t[7]=0,t[8]=c,t[9]=d,t[10]=g,t[11]=0,t[12]=-(a*h+s*v+c*P),t[13]=-(l*h+u*v+d*P),t[14]=-(m*h+p*v+g*P),t[15]=1,t)},targetTo:function(e,t,o,n){var i=t[0],r=t[1],a=t[2],s=n[0],c=n[1],l=n[2],u=i-o[0],d=r-o[1],m=a-o[2],p=u*u+d*d+m*m;p>0&&(u*=p=1/Math.sqrt(p),d*=p,m*=p);var g=c*m-l*d,f=l*u-s*m,h=s*d-c*u;return(p=g*g+f*f+h*h)>0&&(g*=p=1/Math.sqrt(p),f*=p,h*=p),e[0]=g,e[1]=f,e[2]=h,e[3]=0,e[4]=d*h-m*f,e[5]=m*g-u*h,e[6]=u*f-d*g,e[7]=0,e[8]=u,e[9]=d,e[10]=m,e[11]=0,e[12]=i,e[13]=r,e[14]=a,e[15]=1,e},str:function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},add:function(e,t,o){return e[0]=t[0]+o[0],e[1]=t[1]+o[1],e[2]=t[2]+o[2],e[3]=t[3]+o[3],e[4]=t[4]+o[4],e[5]=t[5]+o[5],e[6]=t[6]+o[6],e[7]=t[7]+o[7],e[8]=t[8]+o[8],e[9]=t[9]+o[9],e[10]=t[10]+o[10],e[11]=t[11]+o[11],e[12]=t[12]+o[12],e[13]=t[13]+o[13],e[14]=t[14]+o[14],e[15]=t[15]+o[15],e},subtract:u,multiplyScalar:function(e,t,o){return e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e[3]=t[3]*o,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12]*o,e[13]=t[13]*o,e[14]=t[14]*o,e[15]=t[15]*o,e},multiplyScalarAndAdd:function(e,t,o,n){return e[0]=t[0]+o[0]*n,e[1]=t[1]+o[1]*n,e[2]=t[2]+o[2]*n,e[3]=t[3]+o[3]*n,e[4]=t[4]+o[4]*n,e[5]=t[5]+o[5]*n,e[6]=t[6]+o[6]*n,e[7]=t[7]+o[7]*n,e[8]=t[8]+o[8]*n,e[9]=t[9]+o[9]*n,e[10]=t[10]+o[10]*n,e[11]=t[11]+o[11]*n,e[12]=t[12]+o[12]*n,e[13]=t[13]+o[13]*n,e[14]=t[14]+o[14]*n,e[15]=t[15]+o[15]*n,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},equals:function(t,o){var n=t[0],i=t[1],r=t[2],a=t[3],s=t[4],c=t[5],l=t[6],u=t[7],d=t[8],m=t[9],p=t[10],g=t[11],f=t[12],h=t[13],v=t[14],P=t[15],b=o[0],y=o[1],w=o[2],C=o[3],k=o[4],T=o[5],S=o[6],M=o[7],E=o[8],B=o[9],x=o[10],I=o[11],D=o[12],R=o[13],F=o[14],L=o[15];return Math.abs(n-b)<=e*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(i-y)<=e*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(r-w)<=e*Math.max(1,Math.abs(r),Math.abs(w))&&Math.abs(a-C)<=e*Math.max(1,Math.abs(a),Math.abs(C))&&Math.abs(s-k)<=e*Math.max(1,Math.abs(s),Math.abs(k))&&Math.abs(c-T)<=e*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(l-S)<=e*Math.max(1,Math.abs(l),Math.abs(S))&&Math.abs(u-M)<=e*Math.max(1,Math.abs(u),Math.abs(M))&&Math.abs(d-E)<=e*Math.max(1,Math.abs(d),Math.abs(E))&&Math.abs(m-B)<=e*Math.max(1,Math.abs(m),Math.abs(B))&&Math.abs(p-x)<=e*Math.max(1,Math.abs(p),Math.abs(x))&&Math.abs(g-I)<=e*Math.max(1,Math.abs(g),Math.abs(I))&&Math.abs(f-D)<=e*Math.max(1,Math.abs(f),Math.abs(D))&&Math.abs(h-R)<=e*Math.max(1,Math.abs(h),Math.abs(R))&&Math.abs(v-F)<=e*Math.max(1,Math.abs(v),Math.abs(F))&&Math.abs(P-L)<=e*Math.max(1,Math.abs(P),Math.abs(L))},mul:d,sub:m})}(),gui=function(){let e="";const t=document.getElementById("overlay");return t.addEventListener("click",(function(e){if(e=e||window.event,!guipromotion.isUIOpen())return;selection.unselectPiece(),main.renderThisFrame()})),Object.freeze({fadeInOverlay1s:function(){style.fadeIn1s(t)},getScreen:function(){return e},setScreen:function(t){e=t},callback_featurePlanned:function(e){e=e||window.event,statustext.showStatus("This feature is planned!")},makeOverlayUnselectable:function(){t.classList.add("unselectable")},makeOverlaySelectable:function(){t.classList.remove("unselectable")}})}(),guigameinfo=function(){const e=document.getElementById("whosturn"),t=document.getElementById("dot"),o=document.getElementById("playerwhite"),n=document.getElementById("playerblack");return Object.freeze({open:function(){game.getGamefile().gameConclusion||style.revealElement(t)},hidePlayerNames:function(){style.hideElement(o),style.hideElement(n)},revealPlayerNames:function(e){const t=e.metadata.White,i=e.metadata.Black;o.textContent=onlinegame.areWeColor("white")&&"(Guest)"===t?"(You)":t,n.textContent=onlinegame.areWeColor("black")&&"(Guest)"===i?"(You)":i,style.revealElement(o),style.revealElement(n)},updateWhosTurn:function(o){const n=o.whosTurn;if("white"!==n&&"black"!==n)throw new Error(`Cannot set the document element text showing whos turn it is when color is neither white nor black! ${n}`);let i="";if(onlinegame.areInOnlineGame()){i=onlinegame.isItOurTurn(o)?"Your move":"Their move"}else i="white"===n?"White to move":"Black to move";e.textContent=i,style.revealElement(t),"white"===n?(t.classList.remove("dotblack"),t.classList.add("dotwhite")):(t.classList.remove("dotwhite"),t.classList.add("dotblack"))},gameEnd:function(o){const{victor:n,condition:i}=wincondition.getVictorAndConditionFromGameConclusion(o);style.hideElement(t),onlinegame.areInOnlineGame()?onlinegame.areWeColor(n)?e.textContent="checkmate"===i?"You win by checkmate!":"time"===i?"You win on time!":"resignation"===i?"You win by resignation!":"disconnect"===i?"You win by abandonment!":"royalcapture"===i?"You win by royal capture!":"allroyalscaptured"===i?"You win by all royals captured!":"allpiecescaptured"===i?"You win by all pieces captured!":"threecheck"===i?"You win by three-check!":"koth"===i?"You win by king of the hill!":"You win!":e.textContent="draw"===n?"stalemate"===i?"Draw by stalemate!":"repetition"===i?"Draw by repetition!":"moverule"===i?`Draw by the ${game.getGamefile().gameRules.moveRule/2}-move-rule!`:"Draw!":"aborted"===i?"Game aborted.":"checkmate"===i?"You lose by checkmate!":"time"===i?"You lose on time!":"resignation"===i?"You lose by resignation!":"disconnect"===i?"You lose by abandonment!":"royalcapture"===i?"You lose by royal capture!":"allroyalscaptured"===i?"You lose by all royals captured!":"allpiecescaptured"===i?"You lose by all pieces captured!":"threecheck"===i?"You lose by three-check!":"koth"===i?"You lose by king of the hill!":"You lose!":"checkmate"===i?e.textContent="white"===n?"White wins by checkmate!":"black"===n?"Black wins by checkmate!":"This is a bug, please report. Game ended by checkmate.":"time"===i?e.textContent="white"===n?"White wins on time!":"black"===n?"Black wins on time!":"This is a bug, please report. Game ended on time.":"royalcapture"===i?e.textContent="white"===n?"White wins by royal capture!":"black"===n?"Black wins by royal capture!":"This is a bug, please report. Game ended by royal capture.":"allroyalscaptured"===i?e.textContent="white"===n?"White wins by all royals captured!":"black"===n?"Black wins by all royals captured!":"This is a bug, please report. Game ended by all royals captured.":"allpiecescaptured"===i?e.textContent="white"===n?"White wins by all pieces captured!":"black"===n?"Black wins by all pieces captured!":"This is a bug, please report. Game ended by all pieces captured.":"threecheck"===i?e.textContent="white"===n?"White wins by three-check!":"black"===n?"Black wins by three-check!":"This is a bug, please report. Game ended by three-check.":"koth"===i?e.textContent="white"===n?"White wins by king of the hill!":"black"===n?"Black wins by king of the hill!":"This is a bug, please report. Game ended by king of the hill.":"stalemate"===i?e.textContent="Draw by stalemate!":"repetition"===i?e.textContent="Draw by repetition!":"moverule"===i?e.textContent=`Draw by the ${game.getGamefile().gameRules.moveRule/2}-move-rule!`:(e.textContent="This is a bug, please report!",console.error(`Game conclusion: "${o}"\nVictor: ${n}\nCondition: ${i}`))}})}(),guiguide=function(){const e=document.getElementById("guide"),t=document.getElementById("guide-back"),o=document.getElementById("fairy-pieces"),n=document.getElementById("fairy-card"),i=document.getElementById("fairy-back"),r=document.getElementById("fairy-forward");let a=0,s=7;function c(){style.hideElement(e),t.removeEventListener("click",l),i.removeEventListener("click",u),r.removeEventListener("click",d)}function l(){c(),guititle.open()}function u(e){e=e||window.event,0!==a&&(m(),a--,p(),g())}function d(e){e=e||window.event,a!==s&&(m(),a++,p(),g())}function m(){const e=o.querySelectorAll("img")[a];style.hideElement(e);const t=n.querySelectorAll(".fairy-card-desc")[a];style.hideElement(t)}function p(){const e=o.querySelectorAll("img")[a];style.revealElement(e);const t=n.querySelectorAll(".fairy-card-desc")[a];style.revealElement(t)}function g(){0===a?i.classList.add("opacity-0_25"):i.classList.remove("opacity-0_25"),a===s?r.classList.add("opacity-0_25"):r.classList.remove("opacity-0_25")}return Object.freeze({open:function(){style.revealElement(e),t.addEventListener("click",l),i.addEventListener("click",u),r.addEventListener("click",d),e.querySelectorAll("img").forEach((e=>{e.src||(e.src=e.getAttribute("data-src"))}))},close:c})}(),guiloading=function(){const e=document.getElementById("loading-animation");document.getElementById("loading-text");return Object.freeze({closeAnimation:function(){style.fadeIn1s(camera.canvas),gui.fadeInOverlay1s(),setTimeout(style.hideElement,1e3,e)}})}(),guinavigation=function(){const e=document.getElementById("recenter"),t=document.getElementById("expand"),o=document.getElementById("back"),n=document.getElementById("navigation"),i=document.getElementById("x"),r=document.getElementById("y"),a=document.getElementById("move-left"),s=document.getElementById("move-right"),c=document.getElementById("pause"),l=250,u=40;let d,m,p,g,f=20,h=0,v=!1,P=!1,b=!1;function y(e){e=e||window.event,transition.telToPrevTel()}function w(e){e=e||window.event;const t=gamefileutility.getCoordsOfAllPieces(game.getGamefile());area.initTelFromCoordsList(t)}function C(e){e=e||window.event;const t=game.getGamefile().startSnapshot.box;if(!t)return console.error("Cannot recenter when the bounding box of the starting position is undefined!");area.initTelFromUnpaddedBox(t)}function k(e){e=e||window.event,b||S()&&(h=Date.now(),movesscript.rewindMove())}function T(e){e=e||window.event,S()&&(h=Date.now(),movesscript.forwardMove())}function S(){return Date.now()-h>=f}function M(){const e=movesscript.isDecrementingLegal(game.getGamefile()),t=movesscript.isIncrementingLegal(game.getGamefile());e?a.classList.remove("opacity-0_5"):a.classList.add("opacity-0_5"),t?s.classList.remove("opacity-0_5"):s.classList.add("opacity-0_5")}function E(e){e=e||window.event,guipause.open()}function B(){d=setTimeout((()=>{m=setInterval((()=>{k()}),u)}),l)}function x(){clearTimeout(d),clearInterval(m)}function I(){clearTimeout(d),clearInterval(m)}function D(){p=setTimeout((()=>{g=setInterval((()=>{T()}),u)}),l)}function R(){clearTimeout(p),clearInterval(g)}function F(){clearTimeout(p),clearInterval(g)}function L(){v=!0,d=setTimeout((()=>{v&&(m=setInterval((()=>{k()}),u))}),l)}function O(e){if(e=e||window.event,!v)return;const t=e.touches[0],o=a.getBoundingClientRect();t.clientX>o.left&&t.clientX<o.right&&t.clientY>o.top&&t.clientY<o.bottom||(v=!1,clearTimeout(d),clearInterval(m))}function _(){v=!1,clearTimeout(d),clearInterval(m)}function W(){P=!0,p=setTimeout((()=>{P&&(g=setInterval((()=>{T()}),u))}),l)}function A(e){if(e=e||window.event,!P)return;const t=e.touches[0],o=s.getBoundingClientRect();t.clientX>o.left&&t.clientX<o.right&&t.clientY>o.top&&t.clientY<o.bottom||(P=!1,clearTimeout(p),clearInterval(g))}function G(){P=!1,clearTimeout(p),clearInterval(g)}let N=0;return Object.freeze({open:function(){style.revealElement(n),n.addEventListener("mousedown",input.doIgnoreMouseDown),n.addEventListener("touchstart",input.doIgnoreMouseDown),e.addEventListener("click",C),t.addEventListener("click",w),o.addEventListener("click",y),a.addEventListener("click",k),a.addEventListener("mousedown",B),a.addEventListener("mouseleave",x),a.addEventListener("mouseup",I),a.addEventListener("touchstart",L),a.addEventListener("touchmove",O),a.addEventListener("touchend",_),a.addEventListener("touchcancel",_),s.addEventListener("click",T),s.addEventListener("mousedown",D),s.addEventListener("mouseleave",R),s.addEventListener("mouseup",F),s.addEventListener("touchstart",W),s.addEventListener("touchmove",A),s.addEventListener("touchend",G),s.addEventListener("touchcancel",G),c.addEventListener("click",E),M()},close:function(){style.hideElement(n),n.removeEventListener("mousedown",input.doIgnoreMouseDown),n.removeEventListener("touchstart",input.doIgnoreMouseDown),e.removeEventListener("click",C),t.removeEventListener("click",w),o.removeEventListener("click",y),a.removeEventListener("click",k),a.removeEventListener("mousedown",B),a.removeEventListener("mouseleave",x),a.removeEventListener("mouseup",I),a.removeEventListener("touchstart",L),a.removeEventListener("touchmove",O),a.removeEventListener("touchend",_),a.removeEventListener("touchcancel",_),s.removeEventListener("click",T),s.removeEventListener("mousedown",D),s.removeEventListener("mouseleave",R),s.removeEventListener("mouseup",F),s.removeEventListener("touchstart",W),s.removeEventListener("touchmove",A),s.removeEventListener("touchend",G),s.removeEventListener("touchcancel",G),o.removeEventListener("click",E)},updateElement_Coords:function(){const e=movement.getBoardPos();i.textContent=board.gtile_MouseOver_Int()?board.gtile_MouseOver_Int()[0]:Math.floor(e[0]+board.gsquareCenter()),r.textContent=board.gtile_MouseOver_Int()?board.gtile_MouseOver_Int()[1]:Math.floor(e[1]+board.gsquareCenter())},update_MoveButtons:M,callback_Pause:E,lockRewind:function(){b=!0,N++,setTimeout((()=>{N--,N>0||(b=!1)}),750)},isRewindButtonLocked:function(){return b}})}(),guipause=function(){let e=!1;const t=document.getElementById("pauseUI"),o=document.getElementById("resume"),n=document.getElementById("togglepointers"),i=document.getElementById("copygame"),r=document.getElementById("pastegame"),a=document.getElementById("mainmenu"),s=document.getElementById("toggleperspective");function c(){e=!0,l(),function(){const e=game.getGamefile().moves,t=e.length,o=onlinegame.getIsPrivate()&&(0===t||1===e[0].length&&null==e[0][0]);onlinegame.areInOnlineGame()&&!o?r.classList.add("opacity-0_5"):r.classList.remove("opacity-0_5")}(),style.revealElement(t),o.addEventListener("click",u),n.addEventListener("click",m),i.addEventListener("click",copypastegame.callbackCopy),r.addEventListener("click",copypastegame.callbackPaste),a.addEventListener("click",d),s.addEventListener("click",p)}function l(){if(e)return!onlinegame.areInOnlineGame()||game.getGamefile().gameConclusion?a.textContent="Main Menu":movesscript.isGameResignable(game.getGamefile())?a.textContent="Resign Game":a.textContent="Abort Game"}function u(c){e&&(c=c||window.event,e=!1,style.hideElement(t),o.removeEventListener("click",u),n.removeEventListener("click",m),i.removeEventListener("click",copypastegame.callbackCopy),r.removeEventListener("click",copypastegame.callbackPaste),a.removeEventListener("click",d),s.removeEventListener("click",p),main.renderThisFrame())}async function d(e){e=e||window.event,onlinegame.onMainMenuPress(),onlinegame.closeOnlineGame(),u(),game.unloadGame(),clock.reset(),guinavigation.close(),guititle.open()}function m(t){t=t||window.event,main.renderThisFrame();let o=arrows.getMode();o++,o>2&&(o=0),arrows.setMode(o);const i=0===o?"Arrows: Off":1===o?"Arrows: Defense":"Arrows: All";n.textContent=i,e||statustext.showStatus("Toggled "+i)}function p(e){e=e||window.event,perspective.toggle()}return Object.freeze({areWePaused:function(){return e},gelement_perspective:function(){return s},open:c,toggle:function(){e?u():c()},changeTextOfMainMenuButton:l,callback_Resume:u,callback_TogglePointers:m})}(),guiplay=function(){const e=document.getElementById("discord-credits-links"),t=document.getElementById("play-selection"),o=document.getElementById("play-name"),n=document.getElementById("play-back"),i=document.getElementById("online"),r=document.getElementById("local"),a=document.getElementById("computer"),s=document.getElementById("create-invite"),c=document.getElementById("option-card-color"),l=document.getElementById("option-card-private"),u=document.getElementById("option-card-rated"),d=document.getElementById("option-variant"),m=document.getElementById("option-clock"),p=document.getElementById("option-color"),g=document.getElementById("option-private"),f=document.getElementById("option-rated"),h=document.getElementById("join-private"),v=document.getElementById("invite-code"),P=document.getElementById("copy-button"),b=document.getElementById("join-button"),y=document.getElementById("textbox-private");let w;const C=5,k=12;function T(){style.hideElement(t),style.hideElement(e),n.removeEventListener("click",M),i.removeEventListener("click",E),r.removeEventListener("click",B),a.removeEventListener("click",gui.callback_featurePlanned),s.removeEventListener("click",x),p.removeEventListener("change",I),m.removeEventListener("change",I),b.removeEventListener("click",D),P.removeEventListener("click",F),y.removeEventListener("keyup",R),websocket.unsubFromInvites()}function S(e){if(w=e,"online"===e){o.textContent="Play - Online",i.classList.add("selected"),r.classList.remove("selected"),i.classList.remove("not-selected"),r.classList.add("not-selected"),s.textContent="Create Invite",c.classList.remove("hidden"),u.classList.remove("hidden"),l.classList.remove("hidden");const e=localstorage.loadItem("clock_online");m.selectedIndex=null!=e?e:C,h.classList.remove("hidden")}else if("local"===e){guiplay.setElement_CreateInviteEnabled(!0),invites.cancel(),o.textContent="Play - Local",i.classList.remove("selected"),r.classList.add("selected"),i.classList.add("not-selected"),r.classList.remove("not-selected"),s.textContent="Start Game",c.classList.add("hidden"),u.classList.add("hidden"),l.classList.add("hidden");const e=localstorage.loadItem("clock_local");m.selectedIndex=null!=e?e:k,h.classList.add("hidden"),v.classList.add("hidden")}}function M(e){e=e||window.event,T(),guititle.open()}function E(e){e=e||window.event,S("online")}function B(e){e=e||window.event,S("local")}function x(e){e=e||window.event;const t={variant:d.value,clock:m.value,color:p.value,rated:f.value,publicity:g.value};"local"===w?(T(),function(e){gui.setScreen("game local");const t=clock.isClockValueInfinite(e.clock),o={metadata:{Variant:e.variant,Clock:t?"Infinite":e.clock}};W(o),clock.set(e.clock),guigameinfo.hidePlayerNames()}(t)):"online"===w&&(invites.doWeHave()?invites.cancel(void 0,!0):invites.create(t))}function I(e){if(e=e||window.event,function(e){const t=w;localstorage.saveItem(`clock_${t}`,e,math.getTotalMilliseconds({days:7}))}(m.selectedIndex),"online"!==w)return;const t=m.value,o=p.value;f.disabled="0"===t||"Random"!==o}function D(e){e=e||window.event;const t=y.value.toLowerCase();if(5!==t.length)return statustext.showStatus("Invite code needs to be 5 digits.");b.disabled=!0;invites.accept(t,!0)}function R(e){13===(e=e||window.event).keyCode?b.disabled||D(e):b.disabled=!1}function F(e){if(e=e||window.event,!w.includes("online"))return;if(!invites.doWeHave())return;const t=invites.gelement_iCodeCode().textContent;main.copyToClipboard(t),statustext.showStatus("Copied invite code to clipboard.")}function L(e){(e=e||window.event).target.classList.add("hover")}function O(e){(e=e||window.event).target.classList.remove("hover")}function _(e){e=e||window.event,invites.click(e.currentTarget)}function W(e){console.log("Loading game with game options:"),console.log(e),main.renderThisFrame(),movement.eraseMomentum(),options.disableEM(),e.metadata.Date=e.metadata.Date||math.getUTCDateTime();const t=new gamefile(e.metadata,{moves:e.moves,variantOptions:e.variantOptions,gameConclusion:e.gameConclusion});game.loadGamefile(t);const o=area.calculateFromUnpaddedBox(t.startSnapshot.box);movement.setPositionToArea(o,"pidough"),options.setNavigationBar(!0),sound.playSound_gamestart()}return Object.freeze({getElement_joinPrivate:function(){return h},getElement_inviteCode:function(){return v},getModeSelected:function(){return w},open:function(){gui.setScreen("title play"),style.revealElement(t),style.revealElement(e),S("online"),n.addEventListener("click",M),i.addEventListener("click",E),r.addEventListener("click",B),a.addEventListener("click",gui.callback_featurePlanned),s.addEventListener("click",x),p.addEventListener("change",I),m.addEventListener("change",I),b.addEventListener("click",D),P.addEventListener("click",F),y.addEventListener("keyup",R),invites.subscribeToInvites()},close:T,startOnlineGame:function(e){gui.setScreen("game online"),onlinegame.setColorAndGameID(e),e.variantOptions=function(){if(!onlinegame.getIsPrivate())return;const e=onlinegame.getGameID();return null==e?console.error("Can't generate variant options when reloading private custom game because gameID isn't defined yet."):localstorage.loadItem(e)}(),W(e),onlinegame.initOnlineGame(e),clock.set(e.clock,{timerWhite:e.timerWhite,timerBlack:e.timerBlack,timeNextPlayerLosesAt:e.timeNextPlayerLosesAt}),guigameinfo.revealPlayerNames(e)},setElement_CreateInviteEnabled:function(e){s.disabled=!e},setElement_CreateInviteTextContent:function(e){s.textContent=e},initListeners_Invites:function(){document.querySelectorAll(".invite").forEach((e=>{e.addEventListener("mouseenter",L),e.addEventListener("mouseleave",O),e.addEventListener("click",_)}))},closeListeners_Invites:function(){document.querySelectorAll(".invite").forEach((e=>{e.removeEventListener("mouseenter",L),e.removeEventListener("mouseleave",O),e.removeEventListener("click",_)}))},onPlayPage:function(){return"title play"===gui.getScreen()}})}(),guipromotion=function(){const e=document.getElementById("promote"),t=document.getElementById("promotewhite"),o=document.getElementById("promoteblack"),n=document.getElementById("amazonsW"),i=document.getElementById("queensW"),r=document.getElementById("knightridersW"),a=document.getElementById("chancellorsW"),s=document.getElementById("archbishopsW"),c=document.getElementById("rooksW"),l=document.getElementById("bishopsW"),u=document.getElementById("rosesW"),d=document.getElementById("hawksW"),m=document.getElementById("giraffesW"),p=document.getElementById("zebrasW"),g=document.getElementById("camelsW"),f=document.getElementById("centaursW"),h=document.getElementById("knightsW"),v=document.getElementById("guardsW"),P=document.getElementById("amazonsB"),b=document.getElementById("queensB"),y=document.getElementById("knightridersB"),w=document.getElementById("chancellorsB"),C=document.getElementById("archbishopsB"),k=document.getElementById("rooksB"),T=document.getElementById("bishopsB"),S=document.getElementById("rosesB"),M=document.getElementById("hawksB"),E=document.getElementById("giraffesB"),B=document.getElementById("zebrasB"),x=document.getElementById("camelsB"),I=document.getElementById("centaursB"),D=document.getElementById("knightsB"),R=document.getElementById("guardsB");let F=!1;function L(){F=!1,style.hideElement(e),n.removeEventListener("click",O),i.removeEventListener("click",O),r.removeEventListener("click",O),a.removeEventListener("click",O),s.removeEventListener("click",O),c.removeEventListener("click",O),l.removeEventListener("click",O),u.removeEventListener("click",O),d.removeEventListener("click",O),m.removeEventListener("click",O),p.removeEventListener("click",O),g.removeEventListener("click",O),f.removeEventListener("click",O),h.removeEventListener("click",O),v.removeEventListener("click",O),P.removeEventListener("click",O),b.removeEventListener("click",O),y.removeEventListener("click",O),w.removeEventListener("click",O),C.removeEventListener("click",O),k.removeEventListener("click",O),T.removeEventListener("click",O),S.removeEventListener("click",O),M.removeEventListener("click",O),E.removeEventListener("click",O),B.removeEventListener("click",O),x.removeEventListener("click",O),I.removeEventListener("click",O),D.removeEventListener("click",O),R.removeEventListener("click",O)}function O(e){const t=(e=e||window.event).srcElement.classList[1];selection.promoteToType(t),L()}return Object.freeze({isUIOpen:function(){return F},open:function(L){F=!0,style.revealElement(e),"white"===L?(style.hideElement(o),style.revealElement(t)):(style.hideElement(t),style.revealElement(o)),n.addEventListener("click",O),i.addEventListener("click",O),r.addEventListener("click",O),a.addEventListener("click",O),s.addEventListener("click",O),c.addEventListener("click",O),l.addEventListener("click",O),u.addEventListener("click",O),d.addEventListener("click",O),m.addEventListener("click",O),p.addEventListener("click",O),g.addEventListener("click",O),f.addEventListener("click",O),h.addEventListener("click",O),v.addEventListener("click",O),P.addEventListener("click",O),b.addEventListener("click",O),y.addEventListener("click",O),w.addEventListener("click",O),C.addEventListener("click",O),k.addEventListener("click",O),T.addEventListener("click",O),S.addEventListener("click",O),M.addEventListener("click",O),E.addEventListener("click",O),B.addEventListener("click",O),x.addEventListener("click",O),I.addEventListener("click",O),D.addEventListener("click",O),R.addEventListener("click",O),perspective.unlockMouse()},close:L,initUI:function(e){const t=e.white,o=e.black;t.includes("amazons")?style.revealElement(n):style.hideElement(n),t.includes("queens")?style.revealElement(i):style.hideElement(i),t.includes("knightriders")?style.revealElement(r):style.hideElement(r),t.includes("chancellors")?style.revealElement(a):style.hideElement(a),t.includes("archbishops")?style.revealElement(s):style.hideElement(s),t.includes("rooks")?style.revealElement(c):style.hideElement(c),t.includes("bishops")?style.revealElement(l):style.hideElement(l),t.includes("roses")?style.revealElement(u):style.hideElement(u),t.includes("hawks")?style.revealElement(d):style.hideElement(d),t.includes("giraffes")?style.revealElement(m):style.hideElement(m),t.includes("zebras")?style.revealElement(p):style.hideElement(p),t.includes("camels")?style.revealElement(g):style.hideElement(g),t.includes("centaurs")?style.revealElement(f):style.hideElement(f),t.includes("knights")?style.revealElement(h):style.hideElement(h),t.includes("guards")?style.revealElement(v):style.hideElement(v),o.includes("amazons")?style.revealElement(P):style.hideElement(P),o.includes("queens")?style.revealElement(b):style.hideElement(b),o.includes("knightriders")?style.revealElement(y):style.hideElement(y),o.includes("chancellors")?style.revealElement(w):style.hideElement(w),o.includes("archbishops")?style.revealElement(C):style.hideElement(C),o.includes("rooks")?style.revealElement(k):style.hideElement(k),o.includes("bishops")?style.revealElement(T):style.hideElement(T),o.includes("roses")?style.revealElement(S):style.hideElement(S),o.includes("hawks")?style.revealElement(M):style.hideElement(M),o.includes("giraffes")?style.revealElement(E):style.hideElement(E),o.includes("zebras")?style.revealElement(B):style.hideElement(B),o.includes("camels")?style.revealElement(x):style.hideElement(x),o.includes("centaurs")?style.revealElement(I):style.hideElement(I),o.includes("knights")?style.revealElement(D):style.hideElement(D),o.includes("guards")?style.revealElement(R):style.hideElement(R)}})}(),guititle=function(){const e=document.getElementById("title"),t=document.getElementById("play"),o=document.getElementById("rules"),n=document.getElementById("board-editor"),i=document.getElementById("discord-credits-links");function r(){t.removeEventListener("click",a),o.removeEventListener("click",s),n.removeEventListener("click",gui.callback_featurePlanned),style.hideElement(e),style.hideElement(i)}function a(e){e=e||window.event,r(),guiplay.open()}function s(e){e=e||window.event,r(),guiguide.open()}return Object.freeze({boardVel:.6,open:function(){perspective.disable(),gui.getScreen()?.includes("title")||movement.randomizePanVelDir(),gui.setScreen("title"),movement.setBoardScale(1.8,"pidough"),style.revealElement(e),style.revealElement(i),t.addEventListener("click",a),o.addEventListener("click",s),n.addEventListener("click",gui.callback_featurePlanned)},close:r})}(),highlightline=function(){let e,t;function o(e,t,o,n){const[i,r,a,s]=n;e.push(t[0],t[1],i,r,a,s,o[0],o[1],i,r,a,s)}function n(e,t,o){return!o&&e[0]<t[0]||o&&e[0]>t[0]?t:e}function i(e,t,o,n){const i=(n?t[1]:t[0])-e[0],r=o?i:-i;return[e[0]+i,e[1]+r]}return Object.freeze({genModel:function(){if(!movement.isScaleLess1Pixel_Virtual())return;if(!selection.isAPieceSelected())return;const r=[],a=math.deepCopyObject(selection.getLegalMovesOfSelectedPiece()),s=selection.getPieceSelected().coords,c=math.convertCoordToWorldSpace(s),l=math.deepCopyObject(options.getDefaultLegalMoveHighlight());l[3]=1;const u=miniimage.gwidthWorld()/2,d=[];if(a.horizontal){const e=math.convertCoordToWorldSpace_ClampEdge([a.horizontal[0],s[1]]),t=math.convertCoordToWorldSpace_ClampEdge([a.horizontal[1],s[1]]);o(r,e,t,l);const n=math.closestPointOnLine(e,t,input.getMouseWorldLocation());n.moveset=a.horizontal,n.direction="horizontal",n.distance<=u&&d.push(n)}if(a.vertical){const e=math.convertCoordToWorldSpace_ClampEdge([s[0],a.vertical[0]]),t=math.convertCoordToWorldSpace_ClampEdge([s[0],a.vertical[1]]);o(r,e,t,l);const n=math.closestPointOnLine(e,t,input.getMouseWorldLocation());n.moveset=a.vertical,n.direction="vertical",n.distance<=u&&d.push(n)}const m=perspective.distToRenderBoard;let p=perspective.getEnabled()?{left:-m,right:m,bottom:-m,top:m}:camera.getScreenBoundingBox(!1);e:if(a.diagonalUp){const e=math.getUpDiagonalFromCoords(c);let t=math.getIntersectionEntryTile(1,e,p,"bottomleft");if(!t)break e;const m=i(s,a.diagonalUp,!0,!1);t=n(t,math.convertCoordToWorldSpace(m),!1);let g=math.getIntersectionEntryTile(1,e,p,"topright");const f=i(s,a.diagonalUp,!0,!0);g=n(g,math.convertCoordToWorldSpace(f),!0),o(r,t,g,l);const h=math.closestPointOnLine(t,g,input.getMouseWorldLocation());h.moveset=a.diagonalUp,h.direction="diagonalup",h.distance<=u&&d.push(h)}e:if(a.diagonalDown){const e=math.getDownDiagonalFromCoords(c);let t=math.getIntersectionEntryTile(-1,e,p,"topleft");if(!t)break e;const m=i(s,a.diagonalDown,!1,!1);t=n(t,math.convertCoordToWorldSpace(m),!1);let g=math.getIntersectionEntryTile(-1,e,p,"bottomright");const f=i(s,a.diagonalDown,!1,!0);g=n(g,math.convertCoordToWorldSpace(f),!0),o(r,t,g,l);const h=math.closestPointOnLine(t,g,input.getMouseWorldLocation());h.moveset=a.diagonalDown,h.direction="diagonaldown",h.distance<=u&&d.push(h)}if(e=buffermodel.createModel_Colored(new Float32Array(r),2,"LINES"),t=void 0,miniimage.isHovering())return;let g=d[0];for(let e=1;e<d.length;e++){const t=d[e];t.distance<g.distance&&(g=t)}if(!g)return;const f=[],h=selection.getPieceSelected().type,v=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:P,texStartY:b,texEndX:y,texEndY:w}=bufferdata.getTexDataOfType(h,v),C=miniimage.gwidthWorld()/2,k=g.coords[0]-C,T=g.coords[1]-C,S=k+miniimage.gwidthWorld(),M=T+miniimage.gwidthWorld(),{r:E,g:B,b:x}=options.getColorOfType(h),I=bufferdata.getDataQuad_ColorTexture(k,T,S,M,P,b,y,w,E,B,x,1);if(f.push(...I),t=buffermodel.createModel_ColorTextured(new Float32Array(f),2,"TRIANGLES",pieces.getSpritesheet()),!input.isMouseDown_Left()&&!input.getTouchClicked())return;const D=g.moveset;let R,F,L;if(p=perspective.getEnabled()?math.generatePerspectiveBoundingBox(50):board.gboundingBox(),"horizontal"===g.direction)D[0]===-1/0&&(D[0]=p.left),D[1]===1/0&&(D[1]=p.right),R=[D[0],s[1]],F=[D[1],s[1]];else if("vertical"===g.direction)D[0]===-1/0&&(D[0]=p.bottom),D[1]===1/0&&(D[1]=p.top),R=[s[0],D[0]],F=[s[0],D[1]];else if("diagonalup"===g.direction){const e=math.getUpDiagonalFromCoords(s),t=math.getIntersectionEntryTile(1,e,p,"bottomleft"),o=math.getIntersectionEntryTile(1,e,p,"topright");R=D[0]===-1/0?t:[D[0],s[1]-(s[0]-D[0])],F=D[1]===1/0?o:[D[1],s[1]+D[1]-s[0]]}else{const e=math.getDownDiagonalFromCoords(s),t=math.getIntersectionEntryTile(-1,e,p,"topleft"),o=math.getIntersectionEntryTile(-1,e,p,"bottomright");R=D[0]===-1/0?t:[D[0],s[1]+s[0]-D[0]],F=D[1]===1/0?o:[D[1],s[1]-(D[1]-s[0])]}if(input.getTouchClicked()){L=board.getTileMouseOver().tile_Int}else L=board.gtile_MouseOver_Int();const O={endCoords:math.closestPointOnLine(R,F,L).coords,endScale:1};transition.teleport(O)},render:function(){movement.isScaleLess1Pixel_Virtual()&&selection.isAPieceSelected()&&(e?(e.render(),t&&t.render()):console.log("No highlightline model to render!"))}})}(),highlights=function(){const e=1e4;let t;const o=4,n=2;let i,r,a;const s=-.01;function c(){if(!selection.isAPieceSelected())return;main.renderThisFrame(),a=math.roundPointToNearestGridpoint(movement.getBoardPos(),e),i=[];const c=function(){const e=options.getDefaultSelectedPieceHighlight();return bufferdata.getDataQuad_Color3D_FromCoord_WithOffset(a,selection.getPieceSelected().coords,s,e)}();i.push(...c);const u=function(){const e=selection.getLegalMovesOfSelectedPiece().individual,t=options.getDefaultLegalMoveHighlight(),o=[],n=e?e.length:0;for(let i=0;i<n;i++)o.push(...bufferdata.getDataQuad_Color3D_FromCoord_WithOffset(a,e[i],s,t));return o}();i.push(...u),function(){const[e,i]=perspective.getEnabled()?function(){let e=2*perspective.viewRange*n;return[e,e]}():function(){let e=board.gboundingBox().right-board.gboundingBox().left+1,t=board.gboundingBox().top-board.gboundingBox().bottom+1,n=e*o,i=t*o;const r=camera.canvas.width*o;if(n>r){const e=r/n;n*=e,i*=e}return[n,i]}(),r=e/2,a=i/2,s=movement.getBoardPos(),c=Math.ceil(s[0]-r),l=Math.floor(s[0]+r),u=Math.ceil(s[1]-a),d=Math.floor(s[1]+a);t={left:c,right:l,bottom:u,top:d}}(),function(){const e=selection.getPieceSelected().coords,o=options.getDefaultLegalMoveHighlight(),[n,r,c,u]=o;(function(e,t,o){const n=selection.getLegalMovesOfSelectedPiece();if(!n.horizontal)return;const[r,c,l,u]=options.getDefaultLegalMoveHighlight();let d=n.horizontal[0]-board.gsquareCenter();d<t-board.gsquareCenter()&&(d=t-board.gsquareCenter());let m=d-a[0],p=e[1]-board.gsquareCenter()-a[1],g=e[0]-board.gsquareCenter()-a[0],f=p+1;i.push(...bufferdata.getDataQuad_Color3D(m,p,g,f,s,r,c,l,u)),d=n.horizontal[1]+1-board.gsquareCenter(),d>o+1-board.gsquareCenter()&&(d=o+1-board.gsquareCenter());m=d-a[0],p=e[1]-board.gsquareCenter()-a[1],g=e[0]+1-board.gsquareCenter()-a[0],f=p+1,i.push(...bufferdata.getDataQuad_Color3D(m,p,g,f,s,r,c,l,u))})(e,t.left,t.right),function(e,t,o){const n=selection.getLegalMovesOfSelectedPiece();if(!n.vertical)return;const[r,c,l,u]=options.getDefaultLegalMoveHighlight();let d=n.vertical[0]-board.gsquareCenter();d<t-board.gsquareCenter()&&(d=t-board.gsquareCenter());let m=d-a[1],p=e[0]-board.gsquareCenter()-a[0],g=e[1]-board.gsquareCenter()-a[1],f=p+1;i.push(...bufferdata.getDataQuad_Color3D(p,m,f,g,s,r,c,l,u)),d=n.vertical[1]+1-board.gsquareCenter(),d>o+1-board.gsquareCenter()&&(d=o+1-board.gsquareCenter());m=d-a[1],p=e[0]-board.gsquareCenter()-a[0],g=e[1]+1-board.gsquareCenter()-a[1],f=p+1,i.push(...bufferdata.getDataQuad_Color3D(p,m,f,g,s,r,c,l,u))}(e,t.bottom,t.top),function(e,t,o,n,i,r){const s=selection.getLegalMovesOfSelectedPiece();if(!s.diagonalUp)return;const c=math.getUpDiagonalFromCoords(e),u=math.getIntersectionEntryTile(1,c,t,"bottomleft"),d=math.getIntersectionEntryTile(1,c,t,"topright");if(!u)return;{let t=d,c=u;t[0]>e[0]-1&&(t=[e[0]-1,e[1]-1]);let m=s.diagonalUp[0];c[0]<m&&(c[0]=m,c[1]=t[1]+m-t[0]);let p=t[0]-c[0]+1;p<0&&(p=0),l(p,t[0]-board.gsquareCenter()+1-a[0],t[1]-board.gsquareCenter()+1-a[1],-1,-1,o,n,i,r)}{let t=u,c=d;t[0]<e[0]+1&&(t=[e[0]+1,e[1]+1]);let m=s.diagonalUp[1];c[0]>m&&(c[0]=m,c[1]=t[1]+m-t[0]);let p=c[0]-t[0]+1;p<0&&(p=0),l(p,t[0]-board.gsquareCenter()-a[0],t[1]-board.gsquareCenter()-a[1],1,1,o,n,i,r)}}(e,t,n,r,c,u),function(e,t,o,n,i,r){const s=selection.getLegalMovesOfSelectedPiece();if(!s.diagonalDown)return;const c=math.getDownDiagonalFromCoords(e),u=math.getIntersectionEntryTile(-1,c,t,"topleft"),d=math.getIntersectionEntryTile(-1,c,t,"bottomright");if(!u)return;{let t=d,c=u;t[0]>e[0]-1&&(t=[e[0]-1,e[1]+1]);let m=s.diagonalDown[0];c[0]<m&&(c[0]=m,c[1]=t[1]+t[0]-m);let p=t[0]-c[0]+1;p<0&&(p=0),l(p,t[0]-board.gsquareCenter()+1-a[0],t[1]-board.gsquareCenter()-a[1],-1,1,o,n,i,r)}{let t=u,c=d;t[0]<e[0]+1&&(t=[e[0]+1,e[1]-1]);let m=s.diagonalDown[1];c[0]>m&&(c[0]=m,c[1]=t[1]+m-t[0]);let p=c[0]-t[0]+1;p<0&&(p=0),l(p,t[0]-board.gsquareCenter()-a[0],t[1]-board.gsquareCenter()+1-a[1],1,-1,o,n,i,r)}}(e,t,n,r,c,u)}(),r=buffermodel.createModel_Colored(new Float32Array(i),3,"TRIANGLES")}function l(e,t,o,n,r,a,c,l,u){for(let d=0;d<e;d++){const e=t+n,d=o+r;i.push(...bufferdata.getDataQuad_Color3D(t,o,e,d,s,a,c,l,u)),t=e,o=d}}return Object.freeze({render:function(){movement.isScaleLess1Pixel_Virtual()||(function(){const e=movesscript.getCurrentMove(game.getGamefile());if(!e)return;const t=options.getDefaultLastMoveHighlightColor(),o=[];o.push(...bufferdata.getDataQuad_Color3D_FromCoord(e.startCoords,s,t)),o.push(...bufferdata.getDataQuad_Color3D_FromCoord(e.endCoords,s,t));const n=buffermodel.createModel_Colored(new Float32Array(o),3,"TRIANGLES");n.render()}(),checkhighlight.render(),function(){if(!selection.isAPieceSelected())return;(function(){const e=perspective.getEnabled()?function(){const e=movement.getBoardPos(),t=e[0],o=e[1],n=perspective.viewRange,i=t-n,r=t+n,a=o-n,s=o+n;return{left:i,right:r,bottom:a,top:s}}():board.gboundingBox(),n=e.right-e.left+1,i=t.right-t.left+1;return n*o*o<i&&!perspective.getEnabled()||!math.boxContainsBox(t,e)})()&&c();const e=movement.getBoardPos(),n=[-e[0]+a[0],-e[1]+a[1],0],i=movement.getBoardScale(),s=[i,i,1];r.render(n,s),options.isDebugModeOn()&&function(){const e=[1,0,1,1],o=bufferdata.getDataRect_FromTileBoundingBox(t,e),n=buffermodel.createModel_Colored(new Float32Array(o),2,"LINE_LOOP");n.render()}()}())},regenModel:c})}(),input=function(){const e=document.getElementById("overlay");let t=[],o=[],n=!1;const i=.12;let r,a,s,c,l,u,d=[],m=[],p=[],g=[],f=0,h=!1,v=.4,P=10,b=[0,0],y=!0,w=[0,0],C=!1,k=!0;const T=.4;function S(){return y}function M(e){const t=e.clientX-camera.getCanvasRect().left,o=-(e.clientY-camera.getCanvasRect().top);return[t-camera.canvas.width/camera.getPixelDensity()/2,o+camera.canvas.height/camera.getPixelDensity()/2]}function E(e){const t=(e=e||window.event).changedTouches;for(let e=0;e<t.length;e++){if(x(t[e].identifier),C)return;if(t[e].identifier===a?.id){(new Date).getTime()/1e3-r<i&&(n=!0)}}}function B(e,t){for(let n=0;n<o.length;n++){const i=o[n];i.id===e&&(i.changeInX+=t[0]-i.x,i.changeInY+=t[1]-i.y,i.x=t[0],i.y=t[1])}}function x(e){for(let t=0;t<o.length;t++){if(o[t].id===e){o.splice(t,1);break}}for(let o=0;o<t.length;o++){if(t[o].id===e){t.splice(o,1);break}}}function I(){h||guipause.areWePaused()||perspective.getEnabled()&&!perspective.isMouseLocked()||(c=(new Date).getTime()/1e3,l=math.convertWorldSpaceToCoords_Rounded(w),u=b)}function D(){if(!c)return;if(!k)return;if((new Date).getTime()/1e3-c>v)return;const e=b[0]-u[0],t=b[1]-u[1];Math.hypot(e,t)>P||(h=!0)}function R(){perspective.isMouseLocked()||(input.isMouseSupported()||input.isMouseDown_Left()?function(){const e=perspective.getIsViewingBlackPerspective()?-1:1,t=camera.getCanvasWidthVirtualPixels()/2,o=camera.getCanvasHeightVirtualPixels()/2,n=options.isDebugModeOn()?camera.getScreenBoundingBox(!0):camera.getScreenBoundingBox(!1),i=e*b[0]/t*n.right,r=e*b[1]/o*n.top;w=[i,r]}():function(){if(selection.isAPieceSelected()&&movement.isScaleLess1Pixel_Virtual())return;w=[0,0]}())}function F(){if(!perspective.isMouseLocked())return;const e=Math.PI/180*perspective.getRotX(),t=Math.PI/180*perspective.getRotZ(),o=-Math.tan(e)*camera.getPosition()[2],n=o*Math.sin(t),i=o*Math.cos(t);w=[n,i]}function L(e){f+=e.deltaY}function O(e){const t=e.button;d.push(t),-1===m.indexOf(t)&&m.push(t)}function _(e){const t=m.indexOf(e.button);-1!==t&&m.splice(t,1)}function W(){return t.length>0}function A(e){e.changeInX=0,e.changeInY=0}return Object.freeze({getTouchHelds:function(){return o},atleast1TouchDown:W,getTouchClicked:function(){return n},isMouseDown_Left:function(){return d.includes(0)},removeMouseDown_Left:function(){math.removeObjectFromArray(d,0)},getTouchClickedTile:function(){return a},getTouchClickedWorld:function(){return s},isMouseHeld_Left:function(){return m.includes(0)},isKeyDown:function(e){return p.includes(e)},atleast1KeyHeld:function(){return g.length>0},isKeyHeld:function(e){return g.includes(e)},getMouseWheel:function(){return f},getMouseClickedTile:function(){return l},getMouseClicked:function(){return h},getMousePos:function(){return[b[0],b[1]]},getMouseMoved:S,doIgnoreMouseDown:function(e){C=!0},isMouseSupported:function(){return k},initListeners:function(){window.addEventListener("resize",(()=>{camera.onScreenResize()})),e.addEventListener("touchstart",(e=>{perspective.getEnabled()||("string"==typeof(e=e||window.event).target.className&&e.target.className.includes("button"),"overlay"===e.target.id&&e.preventDefault(),C||(function(e){for(let n=0;n<e.length;n++){const i=e[n],r=M(i),a={id:i.identifier,x:r[0],y:r[1],changeInX:0,changeInY:0};t.push(a),o.push(a)}}(e.changedTouches),R(),board.recalcTiles_FingersOver(),function(){if(1===o.length&&!n){r=(new Date).getTime()/1e3;const e=board.gtileCoordsOver(o[0].x,o[0].y).tile_Int;a={id:o[0].id,x:e[0],y:e[1]};const t=perspective.getIsViewingBlackPerspective()?-1:1;s=[t*math.convertPixelsToWorldSpace_Virtual(o[0].x),t*math.convertPixelsToWorldSpace_Virtual(o[0].y)]}}()))})),e.addEventListener("touchmove",(e=>{if(perspective.getEnabled())return;const t=(e=e||window.event).changedTouches;for(let e=0;e<t.length;e++){const o=t[e],n=M(o);B(o.identifier,n)}R()})),e.addEventListener("touchend",E),e.addEventListener("touchcancel",E),window.addEventListener("mousemove",(e=>{e=e||window.event,!guipause.areWePaused()&&(0!==arrows.getMode()||movement.isScaleLess1Pixel_Virtual()||selection.isAPieceSelected()||perspective.getEnabled())&&main.renderThisFrame();const t=M(e);b=t,y=!0,R(),F(),perspective.update(e.movementX,e.movementY)})),e.addEventListener("wheel",(e=>{L(e=e||window.event)})),document.addEventListener("wheel",(e=>{e=e||window.event,perspective.getEnabled()&&perspective.isMouseLocked()&&L(e)})),e.addEventListener("mousedown",(e=>{e=e||window.event,n=!1,s=void 0,C||("overlay"===e.target.id&&e.preventDefault(),O(e),R(),F(),board.recalcTile_MouseCrosshairOver(),0===e.button&&I())})),document.addEventListener("mousedown",(e=>{e=e||window.event,perspective.getEnabled()&&perspective.isMouseLocked()&&(O(e),0===e.button&&I())})),e.addEventListener("mouseup",(e=>{_(e=e||window.event),setTimeout(perspective.relockMouse,1),0===e.button&&D()})),document.addEventListener("mouseup",(e=>{e=e||window.event,perspective.getEnabled()&&perspective.isMouseLocked()&&(_(e),D())})),document.addEventListener("keydown",(e=>{const t=(e=e||window.event).key.toLowerCase();p.push(t),-1===g.indexOf(t)&&g.push(t),"Tab"===e.key&&e.preventDefault()})),document.addEventListener("keyup",(e=>{e=e||window.event;const t=g.indexOf(e.key.toLowerCase());-1!==t&&g.splice(t,1)})),e.addEventListener("contextmenu",(e=>{"overlay"===(e=e||window.event).target.id&&e.preventDefault()})),function(){if(window.matchMedia("(pointer: fine)").matches)return;k=!1,console.log("Mouse is not supported on this device. Disabling perspective mode."),guipause.gelement_perspective().classList.add("opacity-0_5")}()},resetKeyEvents:function(){t=[],n=!1,d=[],f=0,h=!1,p=[],y=!1,C=!1},touchHeldsIncludesID:function(e){for(let t=0;t<o.length;t++)if(o[t].id===e)return!0;return!1},getTouchHeldByID:function(e){for(let t=0;t<o.length;t++)if(o[t].id===e)return o[t];console.log("touchHelds does not contain desired touch object!")},getMouseWorldLocation:function(){return[w[0],w[1]]},atleast1InputThisFrame:function(){return S()||W()||o.length>0||p.length>0},renderMouse:function(){if(k)return;if(!selection.isAPieceSelected())return;if(!movement.isScaleLess1Pixel_Virtual())return;const[e,t]=w,o=math.convertPixelsToWorldSpace_Virtual(0),n=math.convertPixelsToWorldSpace_Virtual(6.5),i=bufferdata.getDataRingSolid(e,t,o,n,32,0,0,0,.5),r=new Float32Array(i);buffermodel.createModel_Colored(r,2,"TRIANGLES").render()},moveMouse:function(e,t){if(!selection.isAPieceSelected()||!movement.isScaleLess1Pixel_Virtual())return A(e),void(t&&A(t));let o=math.convertPixelsToWorldSpace_Virtual(e.changeInX),n=math.convertPixelsToWorldSpace_Virtual(e.changeInY);if(t){o=(o+math.convertPixelsToWorldSpace_Virtual(t.changeInX))/2,n=(n+math.convertPixelsToWorldSpace_Virtual(t.changeInY))/2,A(t)}const i=onlinegame.areInOnlineGame()&&onlinegame.areWeColor("black")?-1:1;w[0]-=.5*o*i,w[1]-=.5*n*i,A(e),function(){const e=camera.getScreenBoundingBox().right*T,t=Math.hypot(w[0],w[1]);if(t<e)return;const o=e/t;w[0]*=o,w[1]*=o}()}})}(),invites=function(){const e=document.getElementById("invites"),t=document.getElementById("our-invite");let o,n,i=!1;const r=document.getElementById("join-existing"),a=document.getElementById("invite-code-code");function s(e=n,t=!1){if(!i)return;if(!e)return statustext.showStatus("Cannot cancel invite of undefined ID.",!0);c(),guiplay.setElement_CreateInviteEnabled(!1);const o=setTimeout((()=>{guiplay.setElement_CreateInviteEnabled(!0)}));websocket.sendmessage("invites","cancelinvite",e,t,(()=>{guiplay.setElement_CreateInviteEnabled(!0),clearTimeout(o)}))}function c(){localstorage.deleteItem("invite-tag")}const l=(()=>{const e={};let t={};return function(o){let n=!1;const i={};o.forEach((o=>{const r=o.name,a=o.id;i[a]=!0,t[a]||e[r]||d(o)||(e[r]=!0,setTimeout((()=>{delete e[r]}),1e4),n||(input.isMouseSupported()?sound.playSound_base():sound.playSound_viola_c3(),n=!0))})),t=i}})();function u({recentUsersInLastList:r=!1}={}){guiplay.closeListeners_Invites(),t.innerHTML="",e.innerHTML="",o=void 0,i=!1,n=void 0,r&&l([])}function d(e){if(validation.getMember()===e.name)return!0;const t=localstorage.loadItem("invite-tag");return!!t&&e.tag===t}function m(e,t,o){const n=document.createElement("div");for(let t=0;t<e.length;t++)n.classList.add(e[t]);return t&&(n.textContent=t),o&&(n.id=o),n}function p(e,t){const o={id:e,isPrivate:t};websocket.sendmessage("invites","acceptinvite",o,!0)}function g(){"online"===guiplay.getModeSelected()&&(i?guiplay.setElement_CreateInviteTextContent("Cancel Invite"):guiplay.setElement_CreateInviteTextContent("Create Invite"))}function f(e){null!=e&&(r.textContent=`Join Existing - Active Games: ${e}`)}return Object.freeze({gelement_iCodeCode:function(){return a},onmessage:function(r){switch(r.action){case"inviteslist":!function(r){if(!r)return;o=r;const s=i;let c=!1;u();let p,f=!1;n=void 0;for(let o=0;o<r.length;o++){const i=r[o],a=!f&&d(i);a&&(f=!0,n=i.id,s||(sound.playSound_marimba(),c=!0));const l=["invite","button"],u="private"===i.publicity;u&&(p=i.id),a&&!u?l.push("ours"):a&&u&&l.push("private");const g=m(l,void 0,i.id),h=m(["invite-child"],a?"(You)":i.name);g.appendChild(h);const v=m(["invite-child"],i.variant);g.appendChild(v);const P=m(["invite-child"],clock.getClockFromKey(i.clock));g.appendChild(P);const b=m(["invite-child"],a?"White"===i.color?"You're: White":"Black"===i.color?"You're: Black":"Random":"White"===i.color?"You're: Black":"Black"===i.color?"You're: White":"Random");g.appendChild(b);const y=m(["invite-child"],i.rated);g.appendChild(y);const w=m(["invite-child","accept"],a?"Cancel":"Accept");g.appendChild(w);const C=a?t:e;C.appendChild(g,C)}c||l(r);i=f,g(),function(e){if("local"===guiplay.getModeSelected())return;if(!i)return guiplay.getElement_joinPrivate().classList.remove("hidden"),void guiplay.getElement_inviteCode().classList.add("hidden");if(e)return guiplay.getElement_joinPrivate().classList.add("hidden"),guiplay.getElement_inviteCode().classList.remove("hidden"),void(a.textContent=e.toUpperCase());guiplay.getElement_joinPrivate().classList.remove("hidden"),guiplay.getElement_inviteCode().classList.add("hidden")}(p),guiplay.initListeners_Invites()}(r.value.invitesList),f(r.value.currentGameCount);break;case"gamecount":f(r.value);break;default:statustext.showStatus(`Unknown action ${r.action} received from the server in the invites subscription!`,!0)}},update:function(){guiplay.onPlayPage()&&loadbalancer.gisHibernating()&&statustext.showStatus("Move the mouse to reconnect.",!1,.1)},create:function(e){if(i)return console.error("We already have an existing invite, can't create more.");!function(e){const t=math.generateID(8);localstorage.saveItem("invite-tag",t),e.tag=t}(e),guiplay.setElement_CreateInviteEnabled(!1);const t=setTimeout((()=>{guiplay.setElement_CreateInviteEnabled(!0)}));websocket.sendmessage("invites","createinvite",e,!0,(()=>{guiplay.setElement_CreateInviteEnabled(!0),clearTimeout(t)}))},cancel:s,clear:u,accept:p,click:function(e){const t=e.querySelectorAll(".accept")[0].textContent;if("Cancel"===t)s(e.id,!0);else{if("Accept"!==t)return console.error(`Unknown command ${t} when clicking invite.`);p(e.id)}},doWeHave:function(){return i},clearIfOnPlayPage:function(){guiplay.onPlayPage()&&(u(),g())},unsubIfWeNotHave:function(){i||websocket.unsubFromInvites()},deleteInviteTagInLocalStorage:c,subscribeToInvites:async function(e){if(!guiplay.onPlayPage())return;const t=websocket.getSubs();!e&&t.invites||(t.invites=!0,websocket.sendmessage("general","sub","invites"))}})}(),legalmoves=function(){function e(e,t){t=math.trimWorBFromType(t);const o=e.pieceMovesets[t];return o?o():{}}function t(e,t,o,n,i){if(!o)return;const r=t?1:0,a=[o[0]+n[r],o[1]+n[r]];for(let t=0;t<e.length;t++){const o=e[t],s=o.coords[r],c=i===math.getPieceColorFromType(o.type),l="voidsN"===o.type;if(s<n[r]){const e=c||l?s+1:s;e>a[0]&&(a[0]=e)}else if(s>n[r]){const e=c||l?s-1:s;e<a[1]&&(a[1]=e)}}return a}return Object.freeze({genVicinity:function(t){const o={};if(!t.pieceMovesets)return console.error("Cannot generate vicinity before pieceMovesets is initialized.");for(let n=0;n<pieces.white.length;n++){const i=pieces.white[n],r=e(t,i).individual;for(let e=0;e<r.length;e++){const t=r[e],n=math.getKeyFromCoords(t);o[n]||(o[n]=[]);const a=math.trimWorBFromType(i);o[n].includes(a)||o[n].push(a)}}return o},getPieceMoveset:e,calculate:function(o,n,{onlyCalcSpecials:i=!1}={}){if(null==n.index)throw new Error("To calculate a piece's legal moves, we must have the index property.");const r=n.coords,a=n.type,s=math.trimWorBFromType(a),c=math.getPieceColorFromType(a);if(c!==o.whosTurn&&!options.getEM())return{individual:[]};const l=e(o,a);let u,d,m,p,g=[];if(!i){!function(e,t){if(!e)return;e.forEach((e=>{e[0]+=t[0],e[1]+=t[1]}))}(l.individual,r),g=function(e,t,o){if(!t)return;for(let n=t.length-1;n>=0;n--){const i=t[n],r=gamefileutility.getPieceTypeAtCoords(e,i);if(!r)continue;o!==math.getPieceColorFromType(r)&&"voidsN"!==r||t.splice(n,1)}return t}(o,l.individual,c);let e=r[1];u=t(o.piecesOrganizedByRow[e],!1,l.horizontal,r,c),e=r[0],d=t(o.piecesOrganizedByColumn[e],!0,l.vertical,r,c),e=math.getUpDiagonalFromCoords(r),m=t(o.piecesOrganizedByUpDiagonal[e],!1,l.diagonalUp,r,c),e=math.getDownDiagonalFromCoords(r),p=t(o.piecesOrganizedByDownDiagonal[e],!1,l.diagonalDown,r,c)}o.specialDetects[s]&&o.specialDetects[s](o,r,c,g);let f={individual:g,horizontal:u,vertical:d,diagonalUp:m,diagonalDown:p};return c===o.whosTurn&&checkdetection.removeMovesThatPutYouInCheck(o,f,n,c),f},checkIfMoveLegal:function(e,t,o,{ignoreIndividualMoves:n}={}){if(math.areCoordsEqual(t,o))return!1;if(!n){const t=e.individual,n=t?t.length:0;for(let e=0;e<n;e++){const n=t[e];if(math.areCoordsEqual(o,n))return specialdetect.transferSpecialFlags_FromCoordsToCoords(n,o),!0}}const i=e.horizontal;if(i&&o[1]==t[1]&&o[0]>=i[0]&&o[0]<=i[1])return!0;const r=e.vertical;if(r&&o[0]==t[0]&&o[1]>=r[0]&&o[1]<=r[1])return!0;const a=e.diagonalUp;let s=math.getUpDiagonalFromCoords(t),c=math.getUpDiagonalFromCoords(o);if(a&&s==c&&o[0]>=a[0]&&o[0]<=a[1])return!0;const l=e.diagonalDown;return s=math.getDownDiagonalFromCoords(t),c=math.getDownDiagonalFromCoords(o),!!(l&&s==c&&o[0]>=l[0]&&o[0]<=l[1])},doesSlideMovesetContainSquare:function(e,t,o){const n=t?o[1]:o[0];return!(n<e[0])&&!(n>e[1])},hasAtleast1Move:function(e){if(e.individual.length>0)return!0;if(t(e.horizontal))return!0;if(t(e.vertical))return!0;if(t(e.diagonalUp))return!0;if(t(e.diagonalDown))return!0;function t(e){return!!e&&e[1]-e[0]>0}return!1},slide_CalcLegalLimit:t,isOpponentsMoveLegal:function(e,t,o){if(!t)return console.log("Opponents move is illegal because it is not defined. There was likely an error in converting it to long format."),"Move is not defined. Probably an error in converting it to long format.";const n=math.deepCopyObject(t),i=math.deepCopyObject(e.inCheck),r=math.deepCopyObject(e.attackers),a=e.moveIndex;movepiece.forwardToFront(e,{flipTurn:!1,animateLastMove:!1,updateData:!1,updateProperties:!1,simulated:!0});const s=gamefileutility.getPieceAtCoords(e,n.startCoords);if(!s)return console.log(`Opponent's move is illegal because no piece exists at the startCoords. Move: ${JSON.stringify(n)}`),l("No piece exists at start coords.");if(math.getPieceColorFromType(s.type)!==e.whosTurn)return console.log(`Opponent's move is illegal because you can't move a non-friendly piece. Move: ${JSON.stringify(n)}`),l("Can't move a non-friendly piece.");if(n.promotion){if(!s.type.startsWith("pawns"))return console.log(`Opponent's move is illegal because you can't promote a non-pawn. Move: ${JSON.stringify(n)}`),l("Can't promote a non-pawn.");const t=math.getPieceColorFromType(n.promotion);if(e.whosTurn!==t)return console.log(`Opponent's move is illegal because they promoted to the opposite color. Move: ${JSON.stringify(n)}`),l("Can't promote to opposite color.");const o=math.trimWorBFromType(n.promotion);if(!e.gameRules.promotionsAllowed[e.whosTurn].includes(o))return console.log(`Opponent's move is illegal because the specified promotion is illegal. Move: ${JSON.stringify(n)}`),l("Specified promotion is illegal.")}else if(specialdetect.isPawnPromotion(e,s.type,n.endCoords))return console.log(`Opponent's move is illegal because they didn't promote at the promotion line. Move: ${JSON.stringify(n)}`),l("Didn't promote when moved to promotion line.");const c=legalmoves.calculate(e,s);if(!legalmoves.checkIfMoveLegal(c,n.startCoords,n.endCoords))return console.log(`Opponent's move is illegal because the destination coords are illegal. Move: ${JSON.stringify(n)}`),l(`Destination coordinates are illegal. inCheck: ${JSON.stringify(e.inCheck)}. attackers: ${JSON.stringify(e.attackers)}. originalMoveIndex: ${a}. inCheckB4Forwarding: ${i}. attackersB4Forwarding: ${JSON.stringify(r)}`);if(!1===o||wincondition.isGameConclusionDecisive(o)){const t=math.getPieceColorFromType(s.type),i=movepiece.simulateMove(e,n,t,{doGameOverChecks:!0});if(i.gameConclusion!==o)return console.log(`Opponent's move is illegal because gameConclusion doesn't match. Should be "${i.gameConclusion}", received "${o}". Their move: ${JSON.stringify(n)}`),l(`Game conclusion isn't correct. Received: ${o}. Should be ${i.gameConclusion}`)}return movepiece.rewindGameToIndex(e,a,{removeMove:!1,updateData:!1}),!0;function l(t){return movepiece.rewindGameToIndex(e,a,{removeMove:!1,updateData:!1}),t}}})}(),loadbalancer=function(){let e,t,o=0,n=0;const i=1e3,r=[];let a=0,s=0,c=0,l=0,u=1,d=1;let m=!1;const p={normal:3e4,dev:2e3};let g,f=!1;const h=36e5;let v,P=!0,b=!0;let y;function w(){clearTimeout(v),v=setTimeout(k,h)}function C(){m=!0,g=void 0}function k(){if(invites.doWeHave())return w();f=!0,v=void 0,websocket.unsubFromInvites()}return window.addEventListener("focus",(()=>{P=!0})),window.addEventListener("blur",(function(){P=!1})),document.addEventListener("visibilitychange",(function(){document.hidden?(b=!1,y=setTimeout(invites.cancel,18e5)):(b=!0,clearTimeout(y),y=void 0,onlinegame.cancelMoveSound())})),Object.freeze({getRunTime:function(){return e},getDeltaTime:function(){return t},update:function(n){!function(n){e=n,t=(e-o)/1e3,o=e}(n),r.push(e),function(){const t=e-i,o=math.binarySearch_findValue(r,t);r.splice(0,o)}(),a=1e3*r.length/i,stats.updateFPS(a),function(){if(a<=s)return;s=a,c=1e3/s}(),input.atleast1InputThisFrame()&&(m=!1,f=!1,clearTimeout(g),g=setTimeout(C,main.devBuild?p.dev:p.normal),w(),invites.subscribeToInvites())},getLongTaskTime:function(){return l},timeAnimationFrame:function(){n=performance.now()-e,function(){l=c-n-d;const e=n*u;l=Math.max(l,e),l=Math.min(l,c)}()},refreshPeriod:1e3,refreshPeriodAFK:5e3,stayConnectedPeriod:5e3,gisAFK:function(){return m},gisHibernating:function(){return f},isPageHidden:function(){return!b}})}(),localstorage=function(){const e=!1;function t(e){const t=localStorage.getItem(e);if(null==t)return;let n;try{n=JSON.parse(t)}catch(t){return void o(e)}if(!function(e){if(null==e.expires)return console.log(`Local storage item was in an old format. Deleting it! Value: ${JSON.stringify(e)}}`),!0;return Date.now()>=e.expires}(n))return n.value;o(e)}function o(t){e&&console.log(`Deleting local storage item with key '${t}!'`),localStorage.removeItem(t)}return Object.freeze({saveItem:function(t,o,n=864e5){e&&console.log(`Saving key to local storage: ${t}`);const i={value:o,expires:Date.now()+n},r=JSON.stringify(i);localStorage.setItem(t,r)},loadItem:t,deleteItem:o,eraseExpiredItems:function(){const e=Object.keys(localStorage);e.length>0&&console.log(`Items in local storage: ${JSON.stringify(e)}`);for(const o of e)t(o)},eraseAll:function(){console.log("Erasing ALL items in local storage...");const e=Object.keys(localStorage);for(const t of e)o(t)}})}(),main=function(){let e=!0,t=!1,o=!1;return Object.freeze({GAME_VERSION:"1.3.3.1",devBuild:0,videoMode:!1,gforceCalc:function(){return o},renderThisFrame:function(){e=!0},enableForceRender:function(){t=!0},sforceCalc:function(e){o=e},start:function(){guiloading.closeAnimation(),webgl.init(),shaders.initPrograms(),camera.init(),browsersupport.checkBrowserSupport(),game.init(),input.initListeners(),window.addEventListener("beforeunload",(function(e){e=e||window.event,websocket.closeSocket(),validation.deleteToken(),invites.deleteInviteTagInLocalStorage(),localstorage.eraseExpiredItems()})),onlinegame.askServerIfWeAreInGame(),localstorage.eraseExpiredItems(),function(){const e=document.querySelectorAll("img[data-src]"),t=new IntersectionObserver(((e,t)=>{e.forEach((e=>{if(!e.isIntersecting)return;const o=e.target;o.src||(console.log("skipping"),o.src=o.getAttribute("data-src"),o.removeAttribute("data-src")),t.unobserve(o)}))}),{rootMargin:"0px 0px 50px 0px",threshold:.01});e.forEach((e=>{t.observe(e)}))}(),function(){const o=function(n){loadbalancer.update(n),game.update(),function(){t&&(e=!0);if(!e)return;t=!1,webgl.clearScreen(),game.render(),e=!1}(),input.resetKeyEvents(),loadbalancer.timeAnimationFrame(),requestAnimationFrame(o)};requestAnimationFrame(o)}()},copyToClipboard:function(e){navigator.clipboard.writeText(e).then((()=>{console.log("Copied to clipboard")})).catch((e=>{console.error("Failed to copy to clipboard",e)}))},sleep:function(e){return new Promise((t=>setTimeout(t,e)))}})}();function a(e,t){if(!e)throw new Error("Cannot log an object without a message");console.log(e),console.log(math.deepCopyObject(t))}function b(){console.error("Generic error")}const math=function(){function e(e,t){return e?t?(t[0]<e.left?e.left=t[0]:t[0]>e.right&&(e.right=t[0]),void(t[1]<e.bottom?e.bottom=t[1]:t[1]>e.top&&(e.top=t[1]))):console.error("Undefined coords shouldn't be passed into math.expandBoxToContainSquare()!"):console.error("Cannot expand an undefined box to fit a square!")}function t(e,t){const o=t[0]-e[0],n=t[1]-e[1];return Math.hypot(o,n)}function o(e){let t="";const o="0123456789abcdefghijklmnopqrstuvwxyz";for(let n=0;n<e;n++)t+=o.charAt(36*Math.random());return t}return Object.freeze({isPowerOfTwo:function(e){return 0==(e&e-1)},getXYComponents_FromAngle:function(e){return[Math.cos(e),Math.sin(e)]},removeObjectFromArray:function(e,t){const o=e.indexOf(t);if(-1===o)throw new Error(`Could not delete object from array, not found! Array: ${JSON.stringify(e)}. Object: ${t}`);e.splice(o,1)},roundPointToNearestGridpoint:function(e,t){return[Math.round(e[0]/t)*t,Math.round(e[1]/t)*t]},boxContainsBox:function(e,t){return!(t.left<e.left)&&(!(t.right>e.right)&&(!(t.bottom<e.bottom)&&!(t.top>e.top)))},boxContainsSquare:function(e,t){return t||console.log("We need a square to test if it's within this box!"),"number"!=typeof t[0]&&console.log("Square is of the wrong data type!"),!(t[0]<e.left)&&(!(t[0]>e.right)&&(!(t[1]<e.bottom)&&!(t[1]>e.top)))},getUpDiagonalFromCoords:function(e){return-e[0]+e[1]},getDownDiagonalFromCoords:function(e){return e[0]+e[1]},deepCopyObject:function e(t){if("object"!=typeof t||null===t)return t;let o=Array.isArray(t)?[]:{};for(let n in t){const i=t[n];o[n]=e(i)}return o},getKeyFromCoords:function(e){return`${e[0]},${e[1]}`},getCoordsFromKey:function(e){return e.split(",").map(Number)},isOrthogonalDistanceGreaterThanValue:function(e,t,o){const n=Math.abs(t[0]-e[0]),i=Math.abs(t[1]-e[1]);return n>o||i>o},getBaseLog10:function(e){return Math.log(e)/Math.log(10)},convertWorldSpaceToCoords:function(e){const t=movement.getBoardPos(),o=movement.getBoardScale();return[e[0]/o+t[0],e[1]/o+t[1]]},convertWorldSpaceToCoords_Rounded:function(e){const t=movement.getBoardPos(),o=movement.getBoardScale(),n=e[0]/o+t[0],i=e[1]/o+t[1],r=board.gsquareCenter();return[Math.floor(n+r),Math.floor(i+r)]},convertCoordToWorldSpace:function(e,t=movement.getBoardPos(),o=movement.getBoardScale()){return[(e[0]-t[0]+.5-board.gsquareCenter())*o,(e[1]-t[1]+.5-board.gsquareCenter())*o]},convertCoordToWorldSpace_ClampEdge:function(e){const t=movement.getBoardPos(),o=movement.getBoardScale();let n=(e[0]-t[0]+.5-board.gsquareCenter())*o,i=(e[1]-t[1]+.5-board.gsquareCenter())*o;const r=perspective.getEnabled(),a=perspective.distToRenderBoard,s=r?{left:-a,right:a,bottom:-a,top:a}:camera.getScreenBoundingBox(!1);return n<s.left?n=r?-perspective.distToRenderBoard:camera.getScreenBoundingBox(!1).left:n>s.right&&(n=r?perspective.distToRenderBoard:camera.getScreenBoundingBox(!1).right),i<s.bottom?i=r?-perspective.distToRenderBoard:camera.getScreenBoundingBox(!1).bottom:i>s.top&&(i=r?perspective.distToRenderBoard:camera.getScreenBoundingBox(!1).top),[n,i]},closestPointOnLine:function(e,o,n){let i,r;const a=o[0]-e[0],s=o[1]-e[1];if(0===a){let t=n[1];t<e[1]?t=e[1]:t>o[1]&&(t=o[1]),i=[e[0],t]}else{const t=s/a,r=e[1]-t*e[0],c=(t*(n[1]-r)+n[0])/(t*t+1),l=t*c+r;i=c<e[0]?e:c>o[0]?o:[c,l]}return r=t(i,n),{coords:i,distance:r}},getBoundingBoxOfBoard:function(e=movement.getBoardPos(),t=movement.getBoardScale()){const o=camera.getScreenBoundingBox().right/t,n=e[0]-o,i=e[0]+o,r=camera.getScreenBoundingBox().top/t;return{left:n,right:i,bottom:e[1]-r,top:e[1]+r}},convertPixelsToWorldSpace_Virtual:function(e){return e/camera.getCanvasHeightVirtualPixels()*(camera.getScreenBoundingBox(!1).top-camera.getScreenBoundingBox(!1).bottom)},convertWorldSpaceToPixels_Virtual:function(e){return e/(camera.getScreenBoundingBox(!1).top-camera.getScreenBoundingBox(!1).bottom)*camera.getCanvasHeightVirtualPixels()},getIntersectionEntryTile:function(e,t,o,n){const{left:i,right:r,top:a,bottom:s}=o;if(n.endsWith("left")){const o=i*e+t;if(o>=s&&o<=a)return[i,o]}if(n.startsWith("bottom")){const o=(s-t)*e;if(o>=i&&o<=r)return[o,s]}if(n.endsWith("right")){const o=r*e+t;if(o>=s&&o<=a)return[r,o]}if(n.startsWith("top")){const o=(a-t)*e;if(o>=i&&o<=r)return[o,a]}},convertWorldSpaceToGrid:function(e){return e/movement.getBoardScale()},euclideanDistance:t,manhattanDistance:function(e,t){return Math.abs(e[0]-t[0])+Math.abs(e[1]-t[1])},chebyshevDistance:function(e,t){const o=Math.abs(e[0]-t[0]),n=Math.abs(e[1]-t[1]);return Math.max(o,n)},generateID:o,generateNumbID:function(e){const t=Math.random(),o=10**e;return Math.floor(t*o)},toRadians:function(e){return e*(Math.PI/180)},generatePerspectiveBoundingBox:function(e){const t=movement.getBoardPos(),o=e/movement.getBoardScale();return{left:t[0]-o,right:t[0]+o,bottom:t[1]-o,top:t[1]+o}},areCoordsEqual:function(e,t){return!(!t||!t)&&(e[0]===t[0]&&e[1]===t[1])},areCoordsEqual_noValidate:function(e,t){return e[0]===t[0]&&e[1]===t[1]},binarySearch_findSplitPoint:function(e,t){if(null==t)throw new Error(`Cannot binary search when value is null! ${t}`);let o=0,n=e.length-1;for(;o<=n;){const i=Math.floor((o+n)/2),r=e[i];if(t<r)n=i-1;else if(t>r)o=i+1;else if(r===t)throw new`Cannot find split point of sortedArray when it already contains the value! ${t}. List: ${JSON.stringify(e)}`}return o},binarySearch_findValue:function(e,t){if(null==t)return console.error(`Cannot binary search when value is null! ${t}`);let o=0,n=e.length-1;for(;o<=n;){const i=Math.floor((o+n)/2),r=e[i];if(t<r)n=i-1;else if(t>r)o=i+1;else if(r===t)return i}return o},deleteValueFromOrganizedArray:function(e,t){let o=0,n=e.length-1;for(;o<=n;){const i=Math.floor((o+n)/2),r=e[i];if(t===r)return e.splice(i,1),i;t<r?n=i-1:t>r&&(o=i+1)}},copyCoords:function(e){return[e[0],e[1]]},roundAwayFromZero:function(e){return e>0?Math.ceil(e):Math.floor(e)},getPieceColorFromType:function(e){if(e.endsWith("W"))return"white";if(e.endsWith("B"))return"black";if(e.endsWith("N"))return"neutral";throw new Error(`Cannot get the color of piece with type ${pieceType}`)},getOppositeColor:function(e){if("white"===e)return"black";if("black"===e)return"white";throw new Error(`Cannot return the opposite color of color ${e}!`)},getWorBFromType:function(e){return e.charAt(e.length-1)},getWorBFromColor:function(e){if("white"===e)return"W";if("black"===e)return"B";if("neutral"===e)return"N";throw new Error(`Cannot return WorB from strange color ${e}!`)},trimWorBFromType:function(e){return e.slice(0,-1)},isFloat32Array:function(e){return e instanceof Float32Array},PseudoRandomGenerator:function(e){const t=2491057,o=8388607;let n=e;this.nextInt=function(){const e=(16807*n+t)%o;return n=e,e},this.nextFloat=function(){const e=(16807*n+t)%o;return n=e,e/o}},decimalToPercent:function(e){return Math.round(100*e).toString()+"%"},copyPropertiesToObject:function(e,t){const o=Object.keys(e);for(let n=0;n<o.length;n++){const i=o[n];t[i]=e[i]}},copyFloat32Array:function(e){if(!(e&&e instanceof Float32Array))throw new Error("Invalid input: must be a Float32Array");const t=new Float32Array(e.length);for(let o=0;o<e.length;o++)t[o]=e[o];return t},mergeBoundingBoxes:function(e,t){return e&&t?{left:e.left<t.left?e.left:t.left,right:e.right>t.right?e.right:t.right,bottom:e.bottom<t.bottom?e.bottom:t.bottom,top:e.top>t.top?e.top:t.top}:console.error("Cannot merge 2 bounding boxes when 1+ isn't defined.")},getBoxFromCoordsList:function(t){if(null==t)return console.error("Coords not specified when calculating the bounding box of a coordinate list!");if(0===t.length)return console.error("Cannot calculate the bounding box of 0 coordinates!");const o={},n=t.shift();o.left=n[0],o.right=n[0],o.bottom=n[1],o.top=n[1];for(const n of t)e(o,n);return o},expandBoxToContainSquare:e,isJson:function(e){try{JSON.parse(e)}catch(e){return!1}return!0},invertObj:function(e){let t={};for(let o in e)t[e[o]]=o;return t},getUTCDateTime:function(e){const t=e?new Date(e):new Date;return`${t.getUTCFullYear()}/${("0"+(t.getUTCMonth()+1)).slice(-2)}/${("0"+t.getUTCDate()).slice(-2)} ${("0"+t.getUTCHours()).slice(-2)}:${("0"+t.getUTCMinutes()).slice(-2)}:${("0"+t.getUTCSeconds()).slice(-2)}`},getUTCTimestamp:function(e){const[t,o]=e.split(" "),[n,i,r]=t.split("/").map((e=>parseInt(e,10))),[a,s,c]=o.split(":").map((e=>parseInt(e,10)));return new Date(Date.UTC(n,i-1,r,a,s,c)).getTime()},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},minutesToMillis:function(e){return 60*e*1e3},secondsToMillis:function(e){return 1e3*e},getTotalMilliseconds:function(e){const t={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:2592e6,years:31536e6};let o=0;for(const n in e)t[n]&&(o+=e[n]*t[n]);return o},genUniqueID:function(e,t){let n;do{n=o(e)}while(null!=t[n]);return n}})}(),miniimage=function(){let e;const t=.6;let o,n=[],i=[],r=!1,a=!1;function s(){if(r=!1,!movement.isScaleLess1Pixel_Virtual())return;if(a)return;n=[],i=[],null==e&&console.error("widthWorld is not defined yet");const s=e/2,c=movement.getBoardPos(),l=movement.getBoardScale();pieces.forEachPieceType((function(o){const a=game.getGamefile().ourPieces[o];if(!a)return;const u=perspective.getIsViewingBlackPerspective()?-1:1,{texStartX:d,texStartY:m,texEndX:p,texEndY:g}=bufferdata.getTexDataOfType(o,u),{r:f,g:h,b:v}=options.getColorOfType(o);for(let o=0;o<a.length;o++){const u=a[o];if(!u)continue;const P=(u[0]-c[0])*l-s,b=(u[1]-c[1])*l-s,y=P+e,w=b+e;let C=t;const k=input.getTouchClicked()?input.getTouchClickedWorld():input.getMouseWorldLocation(),T=k[0],S=k[1];T>P&&T<y&&S>b&&S<w&&(C=1,r=!0,(input.isMouseDown_Left()||input.getTouchClicked())&&i.push(u));const M=bufferdata.getDataQuad_ColorTexture(P,b,y,w,d,m,p,g,f,h,v,C);n.push(...M)}}),{ignoreVoids:!0});const u=new Float32Array(n);if(o=buffermodel.createModel_ColorTextured(u,2,"TRIANGLES",pieces.getSpritesheet()),i.length>0){const e=area.calculateFromCoordsList(i),t={endCoords:e.coords,endScale:e.scale};transition.teleport(t),input.getTouchClicked()||input.removeMouseDown_Left()}}return Object.freeze({gwidthWorld:function(){return e},gopacity:function(){return t},isHovering:function(){return r},isDisabled:function(){return a},testIfToggled:function(){input.isKeyDown("p")&&(a=!a,main.renderThisFrame(),a?statustext.showStatus("Toggled off icon rendering."):statustext.showStatus("Toggled on icon rendering."))},genModel:s,render:function(){movement.isScaleLess1Pixel_Virtual()&&(a||(o||s(),webgl.executeWithDepthFunc_ALWAYS((()=>{o.render()}))))},enable:function(){a=!1},disable:function(){a=!0},recalcWidthWorld:function(){e=math.convertPixelsToWorldSpace_Virtual(36)}})}(),movement=function(){const e=50;let t=11;const o=6,n=1,i=20,r=.03,a=2.5,s="pidough";let c,l,u,d,m,p,g,f=[0,0],h=[0,0],v=1,P=0,b=0,y=!1,w=!1;function C(e,t){return t!==s?e:Array.isArray(e)?isNaN(e[0])||isNaN(e[1])?console.error(`Cannot set position to ${e}!`):(f=e,void main.renderThisFrame()):console.error(`New position must be an array! ${e}`)}function k(e,t){return t!==s?(main.devBuild&&console.error("Incorrect pass"),e):isNaN(e)?console.error(`Cannot set scale to ${e}!`):e<=0?(console.error(`Cannot set scale to ${e}!!`),console.trace()):(v=e,v>i&&(v=i,P=0),y=v<p,w=v<g,void main.renderThisFrame())}function T(){loadbalancer.gisAFK()||0===h[0]&&0===h[1]||(main.renderThisFrame(),f[0]+=loadbalancer.getDeltaTime()*h[0]/v,f[1]+=loadbalancer.getDeltaTime()*h[1]/v)}function S(){h=[0,0]}function M(e){1===e?l=board.gpositionFingerOver(input.getTouchHelds()[0].id):u=board.gpositionFingerOver(input.getTouchHelds()[1].id)}function E(){M(2),d=v;const e=input.getTouchHeldByID(l.id),t=input.getTouchHeldByID(u.id),o=e.x-t.x,n=e.y-t.y;m=Math.hypot(o,n)}function B(t){const o=-perspective.getRotZ()+t,n=math.toRadians(o),i=math.getXYComponents_FromAngle(n);h[0]+=loadbalancer.getDeltaTime()*e*i[0],h[1]+=loadbalancer.getDeltaTime()*e*i[1]}function x(){if(0===h[0]&&0===h[1])return;const t=Math.hypot(...h),o=(t-loadbalancer.getDeltaTime()*e)/t;o<0?h=[0,0]:(h[0]*=o,h[1]*=o)}function I(){0!==P&&(P>0?(P-=loadbalancer.getDeltaTime()*o,P<0&&(P=0)):(P+=loadbalancer.getDeltaTime()*o,P>0&&(P=0)))}return Object.freeze({getScale_When1TileIs1Pixel_Physical:function(){return p},setScale_When1TileIs1Pixel_Physical:function(e){p=e},getScale_When1TileIs1Pixel_Virtual:function(){return g},setScale_When1TileIs1Pixel_Virtual:function(e){g=e},setPanVelCap:function(e){main.devBuild&&(t=e)},isScaleLess1Pixel_Physical:function(){return y},isScaleLess1Pixel_Virtual:function(){return w},getBoardPos:function(){return math.copyCoords(f)},setBoardPos:C,getBoardScale:function(){return v},setBoardScale:k,recalcPosition:function(){transition.areWeTeleporting()||(T(),function(){if(0===P)return;const e=P>0||v>board.glimitToDampScale()?1:v/board.glimitToDampScale();main.renderThisFrame();k(v*(1+loadbalancer.getDeltaTime()*P*e),s)}())},panBoard:T,updateNavControls:function(){if(function(){if(0===b)return;if(1===b)return void(input.isMouseHeld_Left()||(b=0));if(0!==input.getTouchHelds().length)return;b=0,u=void 0}(),!transition.areWeTeleporting()){if(guipromotion.isUIOpen())return x(),void I();!function(){if(perspective.getEnabled())return;0===b?input.isMouseDown_Left()?function(){b=1;const e=board.gtile_MouseOver_Float();c=[e[0],e[1]],S()}():input.getTouchHelds().length>0&&function(){b=2,S();M(1),input.getTouchHelds().length>1&&E()}():2===b&&function(){const e=input.getTouchHelds().length;if(void 0===u){if(1===e)l.id!==input.getTouchHelds()[0].id&&M(1);else if(e>1){input.touchHeldsIncludesID(l.id)||M(1),E()}}else if(1===e)M(1),u=void 0;else if(e>1){const e=input.touchHeldsIncludesID(l.id),t=input.touchHeldsIncludesID(u.id);if(!e||!t){M(1),E()}}}()}(),function(){if(0!==b)return;let e=!1;input.atleast1KeyHeld()&&(input.isKeyHeld("d")&&(e=!0,B(0)),input.isKeyHeld("a")&&(e=!0,B(180)),input.isKeyHeld("w")&&(e=!0,B(90)),input.isKeyHeld("s")&&(e=!0,B(-90)));if(e){const e=Math.hypot(...h),o=t/e;o<1&&(h[0]*=o,h[1]*=o)}else x()}(),function(){let e=!1;input.isKeyHeld(" ")&&(e=!0,P-=loadbalancer.getDeltaTime()*o,P<-n&&(P=-n));input.isKeyHeld("shift")&&(e=!0,P+=loadbalancer.getDeltaTime()*o,P>n&&(P=n));e||I();0!==input.getMouseWheel()&&(P-=r*input.getMouseWheel(),P>a?P=a:P<-a&&(P=-a))}()}},randomizePanVelDir:function(){const e=2*Math.random()*Math.PI,t=math.getXYComponents_FromAngle(e);h[0]=t[0]*guititle.boardVel,h[1]=t[1]*guititle.boardVel},dragBoard:function(){1==b?function(){main.renderThisFrame();const e=perspective.getIsViewingBlackPerspective()?-1:1,t=c[0]-e*input.getMousePos()[0]/board.gtileWidth_Pixels(),o=c[1]-e*input.getMousePos()[1]/board.gtileWidth_Pixels();f=[t,o]}():2==b&&function(){main.renderThisFrame();const e=perspective.getIsViewingBlackPerspective()?-1:1;if(void 0===u){const t=input.getTouchHelds()[0],o=l.x-e*t.x/board.gtileWidth_Pixels(),n=l.y-e*t.y/board.gtileWidth_Pixels();return input.moveMouse(t),void(f=[o,n])}const t=u.x-l.x,o=u.y-l.y,n=l.x+t/2,i=l.y+o/2,r=input.getTouchHeldByID(l.id),a=input.getTouchHeldByID(u.id),c=a.x-r.x,p=a.y-r.y,g=r.x+c/2,h=r.y+p/2,v=n-e*(g/board.gtileWidth_Pixels()),P=i-e*(h/board.gtileWidth_Pixels());f=[v,P];const b=[r.x,r.y],y=[a.x,a.y];let w=math.euclideanDistance(b,y)/m;if(d<board.glimitToDampScale()&&w<1){w=(w-1)*(d/board.glimitToDampScale())+1}k(d*w,s),input.moveMouse(r,a)}()},eraseMomentum:function(){h=[0,0],P=0},setPositionToArea:function(e,t){e||console.error("Cannot set position to an undefined area."),C(math.copyCoords(e.coords),t),k(e.scale,t)}})}(),movepiece=function(){function e(e,o,{flipTurn:a=!0,recordMove:s=!0,pushClock:c=!0,doGameOverChecks:l=!0,concludeGameIfOver:u=!0,animate:d=!0,updateData:m=!0,updateProperties:p=!0,simulated:g=!1}={}){const f=gamefileutility.getPieceAtCoords(e,o.startCoords);if(!f)throw new Error(`Cannot make move because no piece exists at coords ${o.startCoords}.`);o.type=f.type;const h=math.trimWorBFromType(o.type);let v;!function(e,t,o,{simulated:n=!1}={}){const i=null!=t.rewindInfo,r=t.rewindInfo||{};n&&t.promotion&&(r.pawnIndex=o);if(!i){r.inCheck=math.deepCopyObject(e.inCheck),e.attackers&&(r.attackers=math.deepCopyObject(e.attackers)),e.enpassant&&(r.enpassant=e.enpassant),null!=e.moveRuleState&&(r.moveRuleState=e.moveRuleState),e.checksGiven&&(r.checksGiven=e.checksGiven);let o=math.getKeyFromCoords(t.startCoords);e.specialRights[o]&&(r.specialRightStart=!0),o=math.getKeyFromCoords(t.endCoords),e.specialRights[o]&&(r.specialRightEnd=!0)}t.rewindInfo=r}(e,o,f.index,{simulated:g}),(s||p)&&function(e,t,o){delete e.enpassant;let n=math.getKeyFromCoords(t);delete e.specialRights[n],n=math.getKeyFromCoords(o),delete e.specialRights[n]}(e,o.startCoords,o.endCoords),e.specialMoves[h]&&(v=e.specialMoves[h](e,f,o,{updateData:m,animate:d,updateProperties:p,simulated:g})),v||function(e,o,i,{updateData:r=!0,animate:a=!0,simulated:s=!1}={}){const c=gamefileutility.getPieceAtCoords(e,i.endCoords);c&&(i.captured=c.type);c&&s&&(i.rewindInfo.capturedIndex=c.index);c&&n(e,c,{updateData:r});t(e,o,i.endCoords,{updateData:r}),a&&animation.animatePiece(o.type,i.startCoords,i.endCoords,c)}(e,f,o,{updateData:m,recordMove:s,animate:d,simulated:g});const P=null!=o.captured;e.moveIndex++,s&&e.moves.push(o),p&&function(e,t,o){if(!e.gameRules.moveRule)return;o||t.startsWith("pawns")?e.moveRuleState=0:e.moveRuleState++}(e,f.type,P),a&&i(e,{pushClock:c,doGameOverChecks:l}),r(e,s),l?gamefileutility.updateGameConclusion(e,{concludeGameIfOver:u,simulated:g}):p&&wincondition.detectThreecheck(e),m&&(guinavigation.update_MoveButtons(),main.renderThisFrame())}function t(e,t,o,{updateData:n=!0}={}){e.ourPieces[t.type][t.index]=o,organizedlines.removeOrganizedPiece(e,t.coords),organizedlines.organizePiece(t.type,o,e),n&&piecesmodel.movebufferdata(e,t,o)}function o(e,t,o,n,{updateData:i=!0}={}){const r=e.ourPieces[t];if(null==n&&(n=r.undefineds[0]),null==n&&i)throw new Error("Cannot add a piece and update the data when there are no undefined placeholders remaining!");if(null==n)r.push(o);else{if(null!=gamefileutility.getPieceTypeAtCoords(e,o))throw new Error("Can't add a piece on top of another piece!");if(!(!1!==math.deleteValueFromOrganizedArray(e.ourPieces[t].undefineds,n)))throw new Error("Index to add a piece has an existing piece on it!");r[n]=o}if(organizedlines.organizePiece(t,o,e),!i)return;const a={type:t,index:n};piecesmodel.overwritebufferdata(e,a,o,t),organizedlines.areWeShortOnUndefineds(e)&&organizedlines.addMoreUndefineds(e,{log:!0})}function n(e,t,{updateData:o=!0}={}){const n=e.ourPieces[t.type];gamefileutility.deleteIndexFromPieceList(n,t.index),organizedlines.removeOrganizedPiece(e,t.coords),o&&piecesmodel.deletebufferdata(e,t)}function i(e,{pushClock:t=!0,doGameOverChecks:o=!0}={}){e.whosTurn=math.getOppositeColor(e.whosTurn),o&&guigameinfo.updateWhosTurn(e),t&&clock.push()}function r(e,t=!0){let o;const n=gamefileutility.getWhosTurnAtMoveIndex(e,e.moveIndex),i=math.getOppositeColor(n);e.gameRules.winConditions[i].includes("checkmate")&&(o=[]),e.inCheck=checkdetection.detectCheck(e,n,o),e.attackers=o||[],e.inCheck&&t&&movesscript.flagLastMoveAsCheck(e)}function a(e,t){if(!movesscript.areWeViewingLatestMove(e))return console.error("Cannot calculate Move object from shortmove when we're not viewing the most recently played move.");let o;try{o=formatconverter.ShortToLong_CompactMove(t)}catch(e){return console.error(e),void console.error(`Failed to calculate Move from shortmove because it's in an incorrect format: ${t}`)}const n=gamefileutility.getPieceAtCoords(e,o.startCoords);if(!n)return o;const i=legalmoves.calculate(e,n,{onlyCalcSpecials:!0}).individual;for(let e=0;e<i.length;e++){const t=i[e];if(math.areCoordsEqual(t,o.endCoords)){specialdetect.transferSpecialFlags_FromCoordsToMove(t,o);break}}return o}function s(e,{updateData:n=!0,removeMove:r=!0,animate:a=!0}={}){const s=movesscript.getMoveFromIndex(e.moves,e.moveIndex),c=math.trimWorBFromType(s.type);let l=!1;if(e.specialUndos[c]&&(l=e.specialUndos[c](e,s,{updateData:n,animate:a})),l||function(e,n,{updateData:i=!0,animate:r=!0}={}){const a=gamefileutility.getPieceAtCoords(e,n.endCoords);if(t(e,a,n.startCoords,{updateData:i}),n.captured){o(e,n.captured,n.endCoords,n.rewindInfo.capturedIndex,{updateData:i})}r&&animation.animatePiece(n.type,n.endCoords,n.startCoords)}(e,s,{updateData:n,animate:a}),e.inCheck=s.rewindInfo.inCheck,s.rewindInfo.attackers&&(e.attackers=s.rewindInfo.attackers),r){if(e.enpassant=s.rewindInfo.enpassant,e.moveRuleState=s.rewindInfo.moveRuleState,e.checksGiven=s.rewindInfo.checksGiven,s.rewindInfo.specialRightStart){const t=math.getKeyFromCoords(s.startCoords);e.specialRights[t]=!0}if(s.rewindInfo.specialRightEnd){const t=math.getKeyFromCoords(s.endCoords);e.specialRights[t]=!0}e.gameConclusion=!1}delete s.rewindInfo.capturedIndex,delete s.rewindInfo.pawnIndex,r&&movesscript.deleteLastMove(e.moves),e.moveIndex--,r&&i(e,{pushClock:!1,doGameOverChecks:!1}),n&&(guinavigation.update_MoveButtons(),main.renderThisFrame())}return Object.freeze({makeMove:e,movePiece:t,addPiece:o,deletePiece:n,makeAllMovesInGame:function(t,o){if(-1!==t.moveIndex)throw new Error("Cannot make all moves in game when we're not at the beginning.");for(let n=0;n<o.length;n++){const i=o[n],r=a(t,i);if(!r)throw new Error(`Cannot make all moves in game! There was a move in an invalid format: ${i}. Index: ${n}`);e(t,r,{pushClock:!1,updateData:!1,concludeGameIfOver:!1,doGameOverChecks:!1,animate:n===o.length-1})}0===o.length&&r(t,!1),gamefileutility.updateGameConclusion(t,{concludeGameIfOver:!1})},calculateMoveFromShortmove:a,forwardToFront:function(t,{flipTurn:o=!0,animateLastMove:n=!0,updateData:i=!0,updateProperties:r=!0,simulated:a=!1}={}){for(;;){const s=t.moveIndex+1;if(movesscript.isIndexOutOfRange(t.moves,s))break;const c=movesscript.getMoveFromIndex(t.moves,s),l=movesscript.isIndexTheLastMove(t.moves,s);e(t,c,{recordMove:!1,pushClock:!1,doGameOverChecks:!1,flipTurn:o,animate:n&&l,updateData:i,updateProperties:r,simulated:a})}a||guigameinfo.updateWhosTurn(t),i&&guinavigation.lockRewind()},rewindGameToIndex:function(e,t,{removeMove:o=!0,updateData:n=!0}={}){if(o&&!movesscript.areWeViewingLatestMove(e))return console.error("Cannot rewind game to index while deleting moves unless we start at the most recent move. forwardToFront() first.");if(e.moveIndex<t)return console.error("Cannot rewind game to index when we need to forward instead.");for(;e.moveIndex>t;)s(e,{animate:!1,updateData:n,removeMove:o});guigameinfo.updateWhosTurn(e),main.renderThisFrame()},rewindMove:s,simulateMove:function(t,o,n,{doGameOverChecks:i=!1}={}){e(t,o,{pushClock:!1,animate:!1,updateData:!1,simulated:!0,doGameOverChecks:i,updateProperties:i});const r={isCheck:i?t.inCheck:checkdetection.detectCheck(t,n,[]),gameConclusion:i?t.gameConclusion:void 0};return s(t,{updateData:!1,animate:!1}),r},stripSpecialMoveTagsFromCoords:function(e){return[e[0],e[1]]}})}(),movesets=Object.freeze({getPieceMovesets:function(e=1/0){if("number"!=typeof e)throw new Error("slideLimit gamerule is in an unsupported value.");return{pawns:function(){return{individual:[]}},knights:function(){return{individual:[[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]]}},hawks:function(){return{individual:[[-3,0],[-2,0],[2,0],[3,0],[0,-3],[0,-2],[0,2],[0,3],[-2,-2],[-2,2],[2,-2],[2,2],[-3,-3],[-3,3],[3,-3],[3,3]]}},kings:function(){return{individual:[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]]}},guards:function(){return{individual:[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1]]}},rooks:function(){return{individual:[],horizontal:[-e,e],vertical:[-e,e]}},bishops:function(){return{individual:[],diagonalUp:[-e,e],diagonalDown:[-e,e]}},queens:function(){return{individual:[],horizontal:[-e,e],vertical:[-e,e],diagonalUp:[-e,e],diagonalDown:[-e,e]}},royalQueens:function(){return{individual:[],horizontal:[-e,e],vertical:[-e,e],diagonalUp:[-e,e],diagonalDown:[-e,e]}},chancellors:function(){return{individual:[[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]],horizontal:[-e,e],vertical:[-e,e]}},archbishops:function(){return{individual:[[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]],diagonalUp:[-e,e],diagonalDown:[-e,e]}},amazons:function(){return{individual:[[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]],horizontal:[-e,e],vertical:[-e,e],diagonalUp:[-e,e],diagonalDown:[-e,e]}},camels:function(){return{individual:[[-3,1],[-1,3],[1,3],[3,1],[-3,-1],[-1,-3],[1,-3],[3,-1]]}},giraffes:function(){return{individual:[[-4,1],[-1,4],[1,4],[4,1],[-4,-1],[-1,-4],[1,-4],[4,-1]]}},zebras:function(){return{individual:[[-3,2],[-2,3],[2,3],[3,2],[-3,-2],[-2,-3],[2,-3],[3,-2]]}},centaurs:function(){return{individual:[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]]}},royalCentaurs:function(){return{individual:[[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-2,1],[-1,2],[1,2],[2,1],[-2,-1],[-1,-2],[1,-2],[2,-1]]}}}}});function Move(){console.error("This Move constructor should NEVER be called! It is purely for useful JSDoc dropdown info when working with the `Move` type."),this.type=void 0,this.startCoords=void 0,this.endCoords=void 0,this.captured=void 0,this.check=void 0,this.mate=void 0,this.rewindInfo={capturedIndex:void 0,pawnIndex:void 0,specialRightStart:void 0,specialRightEnd:void 0,enpassant:void 0,moveRuleState:void 0,checksGiven:void 0,inCheck:void 0,attackers:void 0},this.compact=void 0}const movesscript=function(){function e(){return game.getGamefile().mesh.locked?statustext.pleaseWaitForTask():n(game.getGamefile())?(main.renderThisFrame(),movepiece.rewindMove(game.getGamefile(),{removeMove:!1}),selection.unselectPiece(),guinavigation.update_MoveButtons(),void stats.showMoves()):stats.showMoves()}function t(){if(game.getGamefile().mesh.locked)return statustext.pleaseWaitForTask();if(!o(game.getGamefile()))return stats.showMoves();const e=function(){const e=game.getGamefile().moveIndex+1;return a(game.getGamefile().moves,e)}();movepiece.makeMove(game.getGamefile(),e,{flipTurn:!1,recordMove:!1,pushClock:!1,doGameOverChecks:!1,updateProperties:!1}),guinavigation.update_MoveButtons(),stats.showMoves()}function o(e){if(null==e)throw new Error("Cannot ask if incrementing moves is legal when there's no gamefile.");const t=e.moveIndex+1;return!i(e.moves,t)}function n(e){if(null==e)throw new Error("Cannot ask if decrementing moves is legal when there's no gamefile.");const t=e.moveIndex-1;return!i(e.moves,t)}function i(e,t){return t<-1||t>=e.length}function r(e){const t=e.length-1;if(!(t<0))return e[t]}function a(e,t){return i(e,t)?console.error("Cannot get next move when index overflow"):e[t]}function s(e,t){return t===e.length-1}return Object.freeze({update:function(){!function(){if(!input.isKeyDown("arrowleft"))return;if(guinavigation.isRewindButtonLocked())return;e()}(),function(){if(!input.isKeyDown("arrowright"))return;t()}()},rewindMove:e,forwardMove:t,isIncrementingLegal:o,isDecrementingLegal:n,isIndexOutOfRange:i,getLastMove:r,getCurrentMove:function(e){const t=e.moveIndex;if(!(t<0))return e.moves[t]},getMoveFromIndex:a,areWeViewingLatestMove:function(e){const t=e.moveIndex;return s(e.moves,t)},isIndexTheLastMove:s,getWhosTurnAtFront:function(e){let t=e.moves.length;return"black"===e.startSnapshot.turn&&t++,0===t%2?"white":"black"},getPlyCount:function(e){return e.length},hasPieceMoved:function(e,t){for(const o of e.moves)if(math.areCoordsEqual(o.endCoords,t))return!0;return!1},deleteLastMove:function(e){if(0===e.length)return console.error("Cannot delete last move when there are none");e.pop()},flagLastMoveAsCheck:function(e){if(0===e.moves.length)throw new Error("Cannot flag the game's last move as a 'check' when there are no moves.");r(e.moves).check=!0},flagLastMoveAsMate:function(e){if(0===e.moves.length)return;r(e.moves).mate=!0},areMovesIn2DFormat:function(e){return 0!==e.length&&Array.isArray(e[0])},convertMovesTo1DFormat:function(e,t){t.turn="white";const o=[];for(let n=0;n<e.length;n++){const i=e[n];for(let e=0;e<i.length;e++){const n=i[e];null===n?t.turn="black":o.push(n)}}return o},isGameResignable:function(e){return e.moves.length>1},getColorThatPlayedMoveIndex:function(e,t){if(-1===e)return console.error("Cannot get color that played move index when move index is -1.");const o=e%2==0?"white":"black";return t?math.getOppositeColor(o):o}})}(),onlinegame=function(){let e,t,o,n=!1,i=!1;const r={originalDocumentTitle:document.title,timeoutID:void 0,moveSound_timeoutID:void 0},a={timeUntilAFKSecs:40,timeUntilAFKSecs_Abortable:20,timerToLossFromAFK:2e4,timeoutID:void 0,timeWeLoseFromAFK:void 0,displayAFKTimeoutID:void 0,playStaccatoTimeoutID:void 0,timeOpponentLoseFromAFK:void 0,displayOpponentAFKTimeoutID:void 0},s={timeOpponentLoseFromDisconnect:void 0,displayOpponentDisconnectTimeoutID:void 0},c={time:!1,keyMinutes:[30,20,15,10,5,2,1,0],timeoutID:void 0};function l(){if(clearTimeout(a.timeoutID),!M()||game.getGamefile().gameConclusion)return;const e=movesscript.isGameResignable(game.getGamefile())?a.timeUntilAFKSecs:a.timeUntilAFKSecs_Abortable;a.timeoutID=setTimeout(d,1e3*e)}function u(){clearTimeout(a.timeoutID),clearTimeout(a.displayAFKTimeoutID),clearTimeout(a.playStaccatoTimeoutID),clearTimeout(a.displayOpponentAFKTimeoutID)}function d(){websocket.sendmessage("game","AFK"),a.timeWeLoseFromAFK=Date.now()+a.timerToLossFromAFK,sound.playSound_lowtime(),m(20),a.playStaccatoTimeoutID=setTimeout(p,1e4,"c3",10)}function m(e){const t=movesscript.isGameResignable(game.getGamefile())?"resigning":"aborting";statustext.showStatusForDuration(`You are AFK. Auto-${t} in ${e}...`,1e3);const o=e-1;if(0===o)return;const n=a.timeWeLoseFromAFK-Date.now()-1e3*o;a.displayAFKTimeoutID=setTimeout(m,n,o)}function p(e,t){if("c3"===e)sound.playSound_viola_c3();else{if("c4"!==e)return console.error("Invalid violin note");sound.playSound_violin_c4()}let o=t>5?t-1:t-.5;if(0===o)return;const n=o===Math.floor(o)?"c3":"c4",i=a.timeWeLoseFromAFK-Date.now()-1e3*o;a.playStaccatoTimeoutID=setTimeout(p,i,n,o)}function g(e){if(f(),!e)return console.error("Cannot display opponent is AFK when autoResignTime not specified");a.timeOpponentLoseFromAFK=e;const t=e-Date.now();h(Math.ceil(t/1e3))}function f(){clearTimeout(a.displayOpponentAFKTimeoutID),a.displayOpponentAFKTimeoutID=void 0}function h(e){const t=movesscript.isGameResignable(game.getGamefile())?"resigning":"aborting";statustext.showStatusForDuration(`Opponent is AFK. Auto-${t} in ${e}...`,1e3);const o=e-1;if(0===o)return;const n=a.timeOpponentLoseFromAFK-Date.now()-1e3*o;a.displayOpponentAFKTimeoutID=setTimeout(h,n,o)}function v({autoDisconnectResignTime:e,wasByChoice:t}={}){if(!e)return console.error("Cannot display opponent has disconnected when autoResignTime not specified");if(null==t)return console.error("Cannot display opponent has disconnected when wasByChoice not specified");f(),P(),s.timeOpponentLoseFromDisconnect=e;const o=e-Date.now();b(Math.ceil(o/1e3),t)}function P(){clearTimeout(s.displayOpponentDisconnectTimeoutID),s.displayOpponentDisconnectTimeoutID=void 0}function b(e,t){const o=t?"disconnected":"lost connection",n=movesscript.isGameResignable(game.getGamefile())?"resigning":"aborting";a.timeWeLoseFromAFK||statustext.showStatusForDuration(`Opponent has ${o}. Auto-${n} in ${e}...`,1e3);const i=e-1;if(0===i)return;const r=s.timeOpponentLoseFromDisconnect-Date.now()-1e3*i;s.displayOpponentDisconnectTimeoutID=setTimeout(b,r,i,t)}function y(e){if(!loadbalancer.isPageHidden())return document.title=r.originalDocumentTitle;document.title=e?"YOUR MOVE":r.originalDocumentTitle,r.timeoutID=setTimeout(y,1500,!e)}function w(){document.title=r.originalDocumentTitle,clearTimeout(r.timeoutID),r.timeoutID=void 0}function C(){if(!loadbalancer.isPageHidden())return;if(!movesscript.isGameResignable(game.getGamefile()))return;const e=1e3*a.timeUntilAFKSecs/2;r.moveSound_timeoutID=setTimeout((()=>{sound.playSound_move(0)}),e)}function k(){n&&websocket.sendmessage("game","resync",e,!1,(function(){i=!0}))}function T(e){const t={reason:e,opponentsMoveNumber:game.getGamefile().moves.length+1};websocket.sendmessage("game","report",t)}function S(){n=!1,e=void 0,t=void 0,o=void 0,i=!1,u(),r.timeoutID=void 0,a.timeoutID=void 0,a.timeWeLoseFromAFK=void 0,a.displayAFKTimeoutID=void 0,a.playStaccatoTimeoutID=void 0,a.displayOpponentAFKTimeoutID=void 0,a.timeOpponentLoseFromAFK=void 0,I(),w(),perspective.resetRotations()}function M(){return game.getGamefile().whosTurn===o}function E(){if(!n||!i)return;main.devBuild&&console.log("Sending our move..");const e=game.getGamefile(),t={move:movesscript.getLastMove(e.moves).compact,moveNumber:e.moves.length,gameConclusion:e.gameConclusion};websocket.sendmessage("game","submitmove",t,!0),l()}function B(e){if(c.time===e)return;I(),c.time=e;const t=e-Date.now(),o=Math.ceil(t/6e4);console.log(`Server has informed us it is restarting in ${o} minutes!`),x(o)}function x(e){if(0===e)return statustext.showStatus("Server restarting shortly...",!1,2),void(c.time=!1);const t=e>1?"s":"";let o;statustext.showStatus(`Server restarting in ${e} minute${t}...`,!1,2);for(const t of c.keyMinutes)if(t<e){o=t;break}const n=c.time-60*o*1e3-Date.now();c.timeoutID=setTimeout(x,n,o)}function I(){c.time=!1,clearTimeout(c.timeoutID),c.timeoutID=void 0}return Object.freeze({onmessage:function(e){switch(e.action){case"joingame":!function(e){const t=websocket.getSubs();t.invites=!1,t.game=!0,i=!0,guititle.close(),guiplay.close(),guiplay.startOnlineGame(e)}(e.value);break;case"move":!function(e){if(!n)return;const o={move:e.move,gameConclusion:e.gameConclusion},i=game.getGamefile(),r=i.moves.length+1;if(e.moveNumber!==r)return console.log(`We have desynced from the game. Resyncing... Expected opponent's move number: ${r}. Actual: ${e.moveNumber}. Opponent's whole move: ${JSON.stringify(o)}`),k();let a;try{a=formatconverter.ShortToLong_CompactMove(e.move)}catch(t){console.error(`Opponent's move is illegal because it isn't in the correct format. Reporting... Move: ${JSON.stringify(e.move)}`);return T("Incorrectly formatted.")}const s=legalmoves.isOpponentsMoveLegal(i,a,e.gameConclusion);!0!==s&&console.log(`Buddy made an illegal play: ${JSON.stringify(o)}`);if(!0!==s&&!t)return T(s);movepiece.forwardToFront(i,{flipTurn:!1,animateLastMove:!1,updateProperties:!1});const c=gamefileutility.getPieceAtCoords(i,a.startCoords),u=legalmoves.calculate(i,c),d=math.deepCopyObject(a.endCoords);legalmoves.checkIfMoveLegal(u,a.startCoords,d),a.type=c.type,specialdetect.transferSpecialFlags_FromCoordsToMove(d,a),movepiece.makeMove(i,a),clock.edit(e.timerWhite,e.timerBlack,e.timeNextPlayerLosesAt),i.gameConclusion&&gamefileutility.concludeGame(i);l(),f(),y(!0),C()}(e.value);break;case"clock":if(!n)return;const r=e.value;clock.edit(r.timerWhite,r.timerBlack,r.timeNextPlayerLosesAt);break;case"gameupdate":!function(e){if(!n)return;const i=game.getGamefile(),r=e.gameConclusion;if(!function(e,n,i){const r=e.moves.length===n.length+1,a=e.moves.length>0&&movesscript.getColorThatPlayedMoveIndex(e.moves.length-1,"black"===e.startSnapshot.turn)===o,s=0===n.length&&1===e.moves.length||e.moves.length>1&&n.length>0&&e.moves[e.moves.length-2].compact===n[n.length-1];if(!i&&r&&a&&s)return console.log("Sending our move again after resyncing.."),E();const c=e.moveIndex;movepiece.forwardToFront(e,{flipTurn:!1,animateLastMove:!1,updateProperties:!1});let u=!1;for(;e.moves.length>n.length;)movepiece.rewindMove(e,{animate:!1}),console.log("Rewound one move while resyncing to online game."),u=!0;let d=n.length-1;for(;-1!==d;){const t=e.moves[d];if(t){if(t.compact===n[d])break;movepiece.rewindMove(e,{animate:!1}),console.log("Rewound one INCORRECT move while resyncing to online game."),u=!0}d--}const m=math.getOppositeColor(o);for(;d<n.length-1;){d++;const o=n[d],r=movepiece.calculateMoveFromShortmove(e,o);if(movesscript.getColorThatPlayedMoveIndex(d,"black"===e.startSnapshot.turn)===m){const n=legalmoves.isOpponentsMoveLegal(e,r,i);if(!0!==n&&console.log(`Buddy made an illegal play: ${o} ${i}`),!0!==n&&!t)return T(n),!1;l(),f(),y(),C()}else w();const a=d===n.length-1;movepiece.makeMove(e,r,{doGameOverChecks:a,concludeGameIfOver:!1,animate:a}),console.log("Forwarded one move while resyncing to online game."),u=!0}u||movepiece.rewindGameToIndex(e,c,{removeMove:!1});return!0}(i,e.moves,r))return void f();guigameinfo.updateWhosTurn(i),e.autoAFKResignTime&&!M()?g(e.autoAFKResignTime):f();e.disconnect?v(e.disconnect):P();null!=e.serverRestartingAt?B(e.serverRestartingAt):I();i.gameConclusion=r,clock.edit(e.timerWhite,e.timerBlack,e.timeNextPlayerLosesAt),i.gameConclusion&&gamefileutility.concludeGame(i)}(e.value);break;case"unsub":websocket.getSubs().game=!1,i=!1;break;case"login":statustext.showStatus("You are not logged in. Please login to reconnect to this game.",!0,100),websocket.getSubs().game=!1,i=!1,clock.stop(),game.getGamefile().gameConclusion="limbo",selection.unselectPiece(),board.darkenColor();break;case"nogame":statustext.showStatus("Game no longer exists.",!1,1.5),websocket.getSubs().game=!1,i=!1,gamefileutility.concludeGame(game.getGamefile(),"aborted",{requestRemovalFromActiveGames:!1});break;case"leavegame":statustext.showStatus("Another window has connected."),websocket.getSubs().game=!1,i=!1,S(),game.unloadGame(),clock.reset(),guinavigation.close(),guititle.open();break;case"opponentafk":g(e.value?.autoAFKResignTime);break;case"opponentafkreturn":f(e.value);break;case"opponentdisconnect":v(e.value);break;case"opponentdisconnectreturn":P(e.value);break;case"serverrestart":B(e.value);break;default:statustext.showStatus(`Unknown action ${r.action} received from the server in the invites subscription!`,!0)}},areInOnlineGame:function(){return n},getIsPrivate:function(){return t},getOurColor:function(){return o},setInSyncFalse:function(){i=!1},setColorAndGameID:function(i){n=!0,o=i.youAreColor,e=i.id,t="private"===i.publicity},initOnlineGame:function(e){l(),e.autoAFKResignTime&&g(e.autoAFKResignTime),e.disconnect&&v(e.disconnect),M()&&(y(!0),C()),null!=e.serverRestartingAt&&B(e.serverRestartingAt),perspective.resetRotations()},closeOnlineGame:S,isItOurTurn:M,areWeColor:function(e){return e===o},sendMove:E,onMainMenuPress:function(){if(!n)return;const e=game.getGamefile();e.gameConclusion?websocket.getSubs().game&&(websocket.sendmessage("general","unsub","game"),websocket.getSubs().game=!1):movesscript.isGameResignable(e)?(websocket.getSubs().game=!1,i=!1,websocket.sendmessage("game","resign")):(websocket.getSubs().game=!1,i=!1,websocket.sendmessage("game","abort"))},getGameID:function(){return e},askServerIfWeAreInGame:async function(){await validation.waitUntilInitialRequestBack(),websocket.sendmessage("game","joingame",undefined,!0)},requestRemovalFromPlayersInActiveGames:function(){n&&websocket.sendmessage("game","removefromplayersinactivegames")},resyncToGame:k,update:function(){n&&function(){if(!input.atleast1InputThisFrame()||game.getGamefile().gameConclusion)return;a.timeWeLoseFromAFK&&(websocket.sendmessage("game","AFK-Return"),a.timeWeLoseFromAFK=void 0,clearTimeout(a.displayAFKTimeoutID),clearTimeout(a.playStaccatoTimeoutID),a.displayAFKTimeoutID=void 0,a.playStaccatoTimeoutID=void 0);l()}()},onLostConnection:function(){clearTimeout(a.displayOpponentAFKTimeoutID)},cancelAFKTimer:u,cancelFlashTabTimer:w,cancelMoveSound:function(){clearTimeout(r.moveSound_timeoutID),r.moveSound_timeoutID=void 0},resetServerRestarting:I,deleteCustomVariantOptions:function(){t&&localstorage.deleteItem(e)}})}(),options=function(){let e=!1,t=!0,o="default";const n=["default","halloween","thanksgiving","christmas"],i={default:{whiteTiles:[1,1,1,1],darkTiles:[.78,.78,.78,1],selectedPieceHighlightColor:[0,.5,.5,.3],legalMovesHighlightColor:[0,0,1,.35],lastMoveHighlightColor:[0,1,0,.25],checkHighlightColor:[1,0,0,.7],useColoredPieces:!1,whitePiecesColor:[1,1,1,1],blackPiecesColor:[1,1,1,1],neutralPiecesColor:[1,1,1,1]},halloween:{whiteTiles:[1,.65,.4,1],darkTiles:[1,.4,0,1],selectedPieceHighlightColor:[0,0,0,.5],legalMovesHighlightColor:[.6,0,1,.55],lastMoveHighlightColor:[.5,.2,0,.75],checkHighlightColor:[1,0,.5,.76],useColoredPieces:!0,whitePiecesColor:[.6,.5,.45,1],blackPiecesColor:[.8,0,1,1],neutralPiecesColor:[1,1,1,1]},thanksgiving:{whiteTiles:[239/255,225/255,199/255,1],darkTiles:[188/255,160/255,136/255,1],selectedPieceHighlightColor:[0,.5,.5,.3],legalMovesHighlightColor:[1,.2,0,.35],lastMoveHighlightColor:[.3,1,0,.35],checkHighlightColor:[1,0,0,.7],useColoredPieces:!1,whitePiecesColor:[1,1,1,1],blackPiecesColor:[1,1,1,1],neutralPiecesColor:[1,1,1,1]},christmas:{whiteTiles:[152/255,238/255,1,1],darkTiles:[0,199/255,238/255,1],selectedPieceHighlightColor:[0,.5,.5,.3],legalMovesHighlightColor:[0,0,1,.35],lastMoveHighlightColor:[0,0,.3,.35],checkHighlightColor:[1,0,0,.7],useColoredPieces:!0,whitePiecesColor:[.4,1,.4,1],blackPiecesColor:[1,.2,.2,1],neutralPiecesColor:[1,1,1,1]}};let r=!1,a=!1;function s(){t?(guinavigation.open(),guigameinfo.open()):guinavigation.close(),camera.updatePIXEL_HEIGHT_OF_NAVS()}function c(e){(function(e){return n.includes(e)})(o)||console.error(`Cannot change theme to invalid theme ${o}!`),o=e,board.updateTheme(),piecesmodel.regenModel(game.getGamefile(),l()),highlights.regenModel()}function l(){if(i[o].useColoredPieces)return{white:i[o].whitePiecesColor,black:i[o].blackPiecesColor,neutral:i[o].neutralPiecesColor}}return Object.freeze({isDebugModeOn:function(){return e},gnavigationVisible:function(){return t},setNavigationBar:function(e){t=e,s()},gtheme:function(){return o},themes:i,toggleDeveloperMode:function(){main.renderThisFrame(),e=!e,camera.onPositionChange(),perspective.initCrosshairModel(),piecesmodel.regenModel(game.getGamefile(),l()),statustext.showStatus("Toggled Debug Mode: "+(e?"On":"Off"))},toggleEM:function(){const e=onlinegame.areInOnlineGame()&&onlinegame.getIsPrivate()&&input.isKeyHeld("0");onlinegame.areInOnlineGame()&&!e||(main.renderThisFrame(),r=!r,statustext.showStatus("Toggled Edit Mode: "+(r?"On":"Off")))},toggleNavigationBar:function(){game.getGamefile()&&(t=!t,s())},getDefaultTiles:function(e){return e?i[o].whiteTiles:i[o].darkTiles},getDefaultLegalMoveHighlight:function(){return i[o].legalMovesHighlightColor},getDefaultSelectedPieceHighlight:function(){return i[o].selectedPieceHighlightColor},getDefaultLastMoveHighlightColor:function(){return i[o].lastMoveHighlightColor},getDefaultCheckHighlightColor:function(){return i[o].checkHighlightColor},setTheme:c,toggleChristmasTheme:function(){"christmas"===o?c("default"):"default"===o&&c("christmas")},getPieceRegenColorArgs:l,getColorOfType:function(e){const t=l();if(!t)return{r:1,g:1,b:1,a:1};const o=t[math.getPieceColorFromType(e)];return{r:o[0],g:o[1],b:o[2],a:o[3]}},areUsingColoredPieces:function(){return i[o].useColoredPieces},getEM:function(){return r},toggleFPS:function(){a=!a,a?stats.showFPS():stats.hideFPS()},isThemeDefault:function(){return"default"===o},disableEM:function(){r=!1},isFPSOn:function(){return a}})}(),organizedlines={initOrganizedPieceLists:function(e,{apphendUndefineds:t=!0}={}){if(!e.ourPieces)return console.error("Cannot init the organized lines before ourPieces is defined.");organizedlines.resetOrganizedLists(e),gamefileutility.forEachPieceInGame(e,organizedlines.organizePiece),organizedlines.initUndefineds(e),t&&organizedlines.apphendUndefineds(e)},resetOrganizedLists:function(e){e.piecesOrganizedByKey={},e.piecesOrganizedByRow={},e.piecesOrganizedByColumn={},e.piecesOrganizedByUpDiagonal={},e.piecesOrganizedByDownDiagonal={}},organizePiece:function(e,t,o){if(!t)return;const n={type:e,coords:t};let i=math.getKeyFromCoords(t);if(o.piecesOrganizedByKey[i])throw new Error(`While organizing a piece, there was already an existing piece there!! ${t}`);o.piecesOrganizedByKey[i]=e,i=t[1],o.piecesOrganizedByRow[i]||(o.piecesOrganizedByRow[i]=[]),o.piecesOrganizedByRow[i].push(n),i=t[0],o.piecesOrganizedByColumn[i]||(o.piecesOrganizedByColumn[i]=[]),o.piecesOrganizedByColumn[i].push(n),i=math.getUpDiagonalFromCoords(t),o.piecesOrganizedByUpDiagonal[i]||(o.piecesOrganizedByUpDiagonal[i]=[]),o.piecesOrganizedByUpDiagonal[i].push(n),i=math.getDownDiagonalFromCoords(t),o.piecesOrganizedByDownDiagonal[i]||(o.piecesOrganizedByDownDiagonal[i]=[]),o.piecesOrganizedByDownDiagonal[i].push(n)},removeOrganizedPiece:function(e,t){let o=math.getKeyFromCoords(t);if(!e.piecesOrganizedByKey[o])throw new Error(`No organized piece at coords ${t} to delete!`);function n(e,o){const n=e[o];for(let i=0;i<n.length;i++){const r=n[i].coords;if(r[0]===t[0]&&r[1]===t[1]){n.splice(i,1),0===n.length&&delete e[o];break}}}delete e.piecesOrganizedByKey[o],o=t[1],n(e.piecesOrganizedByRow,o),o=t[0],n(e.piecesOrganizedByColumn,o),o=math.getUpDiagonalFromCoords(t),n(e.piecesOrganizedByUpDiagonal,o),o=math.getDownDiagonalFromCoords(t),n(e.piecesOrganizedByDownDiagonal,o)},initUndefineds:function(e){pieces.forEachPieceType((function(t){e.ourPieces[t].undefineds=[]}))},apphendUndefineds:function(e){pieces.forEachPieceType((function(t){if(!organizedlines.isTypeATypeWereApphendingUndefineds(e,t))return;const o=e.ourPieces[t];for(let e=0;e<pieces.extraUndefineds;e++)organizedlines.insertUndefinedIntoList(o)}))},areWeShortOnUndefineds:function(e){let t=!1;return pieces.forEachPieceType((function(o){if(!organizedlines.isTypeATypeWereApphendingUndefineds(e,o))return;const n=e.ourPieces[o];0===n.undefineds.length&&(t=!0)})),t},addMoreUndefineds:function(e,{regenModel:t=!0,log:o=!1}={}){o&&console.log("Adding more placeholder undefined pieces."),pieces.forEachPieceType((function(t){if(!organizedlines.isTypeATypeWereApphendingUndefineds(e,t))return;const o=e.ourPieces[t];for(let e=o.undefineds.length;e<pieces.extraUndefineds;e++)organizedlines.insertUndefinedIntoList(o)})),t&&piecesmodel.regenModel(e,options.getPieceRegenColorArgs())},isTypeATypeWereApphendingUndefineds(e,t){if(!e.gameRules.promotionsAllowed)throw new Error("promotionsAllowed needs to be defined before apphending undefineds to the piece lists!");const o=math.getPieceColorFromType(t);if(!e.gameRules.promotionsAllowed[o])return!1;const n=math.trimWorBFromType(t);return e.gameRules.promotionsAllowed[o].includes(n)},insertUndefinedIntoList:function(e){const t=e.push(void 0)-1;e.undefineds.push(t)},buildKeyListFromState:function(e){const t={};return gamefileutility.forEachPieceInPiecesByType((function(e,o){const n=math.getKeyFromCoords(o);t[n]=e}),e),t},buildStateFromKeyList:function(e){const t=organizedlines.getEmptyTypeState();for(const o in e){const n=e[o],i=math.getCoordsFromKey(o);if(!t[n])return console.error(`Error when building state from key list. Type ${n} is undefined!`);t[n].push(i)}return t},getEmptyTypeState(){const e={};for(let t=0;t<pieces.white.length;t++)e[pieces.white[t]]=[],e[pieces.black[t]]=[];for(let t=0;t<pieces.neutral.length;t++)e[pieces.neutral[t]]=[];return e}},perspective=function(){let e=!1,t=0,o=0,n=!1;const i=2.5,r=18,a=[1,1,1,1];let s;function c(){e&&(main.renderThisFrame(),e=!1,main.enableForceRender(),guipause.callback_Resume(),guipause.gelement_perspective().textContent="Perspective: Off",l(),board.initDarkTilesModel(),piecesmodel.eraseRotatedModel(game.getGamefile()))}function l(){t=0,o="black"===onlinegame.getOurColor()?180:0,p(),camera.onPositionChange()}function u(){camera.canvas.requestPointerLock()}function d(){return document.pointerLockElement===camera.canvas||document.mozPointerLockElement===camera.canvas||document.webkitPointerLockElement===camera.canvas}function m(){if(!e)return;const t=camera.getPosition()[2],o=i*t/camera.getCanvasHeightVirtualPixels(),n=r*t/camera.getCanvasHeightVirtualPixels(),[c,l,u,d]=a,m=new Float32Array([-n,-o,c,l,u,d,-n,o,c,l,u,d,n,o,c,l,u,d,n,o,c,l,u,d,n,-o,c,l,u,d,-n,-o,c,l,u,d,-o,-n,c,l,u,d,-o,n,c,l,u,d,o,n,c,l,u,d,o,n,c,l,u,d,o,-n,c,l,u,d,-o,-n,c,l,u,d,-n,-o,c,l,u,d]);s=buffermodel.createModel_Colored(m,2,"TRIANGLES")}function p(){n=o>90&&o<270}return Object.freeze({getEnabled:function(){return e},getRotX:function(){return t},getRotZ:function(){return o},distToRenderBoard:1500,viewRange:1e3,getIsViewingBlackPerspective:function(){return n},toggle:function(){if(!input.isMouseSupported())return statustext.showStatus("Perspective mode is available on desktop!");e?c():function(){if(e)return console.error("Should not be enabling perspective when it is already enabled.");e=!0,guipause.gelement_perspective().textContent="Perspective: On",guipause.callback_Resume(),u(),board.initDarkTilesModel(),m(),piecesmodel.initRotatedPiecesModel(game.getGamefile()),statustext.showStatus("WASD to move. Space & shift to zoom.")}()},disable:c,resetRotations:l,relockMouse:function(){e&&(d()||guipause.areWePaused()||selection.isPawnCurrentlyPromoting()||u())},update:function(n,i){e&&d()&&(t+=.13*i,o+=.13*n,function(){t>0?t=0:t<-180&&(t=-180);o<0?o+=360:o>360&&(o-=360)}(),p(),camera.onPositionChange())},applyRotations:function(e){if(0===t&&0===o)return;const n=camera.getPosition();if(mat4.translate(e,e,n),t<0){const o=t*(Math.PI/180);mat4.rotate(e,e,o,[1,0,0])}const i=o*(Math.PI/180);mat4.rotate(e,e,i,[0,0,1]);const r=[-n[0],-n[1],-n[2]];mat4.translate(e,e,r)},isMouseLocked:d,renderCrosshair:function(){if(!e)return;if(main.videoMode)return;if(null==s)return console.error("Crosshair model is null but it should have been defined when toggling on perspective!");const t=camera.getViewMatrix();camera.initViewMatrix(!0),webgl.executeWithInverseBlending((()=>{s.render()})),camera.setViewMatrix(t)},unlockMouse:function(){e&&document.exitPointerLock()},isLookingUp:function(){return e&&t<=-90},initCrosshairModel:m})}(),pieces=function(){const e=["kingsW","giraffesW","camelsW","zebrasW","amazonsW","queensW","royalQueensW","hawksW","chancellorsW","archbishopsW","centaursW","royalCentaursW","knightsW","guardsW","rooksW","bishopsW","pawnsW"],t=["kingsB","giraffesB","camelsB","zebrasB","amazonsB","queensB","royalQueensB","hawksB","chancellorsB","archbishopsB","centaursB","royalCentaursB","knightsB","guardsB","rooksB","bishopsB","pawnsB"],o=["obstaclesN","voidsN"];let n,i;return Object.freeze({white:e,black:t,neutral:o,royals:["kings","royalQueens","royalCentaurs"],jumpingRoyals:["kings","royalCentaurs"],extraUndefineds:5,renderPiecesInGame:function(e){!function(e){if(null==e.mesh)return;if(null==e.mesh.model)return;if(movement.isScaleLess1Pixel_Virtual()&&!miniimage.isDisabled())return;!movement.isScaleLess1Pixel_Virtual()&&board.isOffsetOutOfRangeOfRegenRange(e.mesh.offset,piecesmodel.regenRange)&&piecesmodel.shiftPiecesModel(e);const t=movement.getBoardPos(),o=[-t[0]+e.mesh.offset[0],-t[1]+e.mesh.offset[1],0],n=movement.getBoardScale(),i=[n,n,1];let r;r=onlinegame.areWeColor("black")?perspective.getEnabled()&&!perspective.getIsViewingBlackPerspective()&&null!=e.mesh.rotatedModel?e.mesh.rotatedModel:e.mesh.model:perspective.getEnabled()&&perspective.getIsViewingBlackPerspective()&&null!=e.mesh.rotatedModel?e.mesh.rotatedModel:e.mesh.model;r.render(o,i)}(e),voids.render(e),miniimage.render()},renderGhostPiece:function(e,t){const o=options.getColorOfType(e);o.a*=.4;const n=bufferdata.getDataQuad_ColorTexture_FromCoordAndType(t,e,o);buffermodel.createModel_ColorTextured(new Float32Array(n),2,"TRIANGLES",pieces.getSpritesheet()).render()},forEachPieceType:function(n,{ignoreNeutrals:i=!1,ignoreVoids:r=!1}={}){for(let o=0;o<e.length;o++)n(t[o]),n(e[o]);if(!i)for(let e=0;e<o.length;e++){const t=o[e];r&&t.startsWith("voids")||n(t)}},forEachPieceType_Async:async function(n,{ignoreNeutrals:i=!1,ignoreVoids:r=!1}={}){for(let o=0;o<e.length;o++)await n(t[o]),await n(e[o]);if(!i)for(let e=0;e<o.length;e++){const t=o[e];r&&t.startsWith("voids")||await n(t)}},forEachPieceTypeOfColor:function(t,o){if("white"!==t&&"black"!==t)throw new Error(`Cannot iterate through each piece type of invalid color: ${t}!`);for(let n=0;n<e.length;n++)o(pieces[t][n])},initSpritesheet:function(){n=texture.loadTexture("spritesheet",{useMipmaps:!0})},getSpritesheet:function(){return n},initSpritesheetData:function(){const e=1/8;function t(e,t,o){return[(t-1)*e,1-o*e]}i={pieceWidth:e,pawnsW:t(e,1,1),pawnsB:t(e,2,1),knightsW:t(e,3,1),knightsB:t(e,4,1),bishopsW:t(e,5,1),bishopsB:t(e,6,1),rooksW:t(e,7,1),rooksB:t(e,8,1),queensW:t(e,1,2),queensB:t(e,2,2),kingsW:t(e,3,2),kingsB:t(e,4,2),chancellorsW:t(e,5,2),chancellorsB:t(e,6,2),archbishopsW:t(e,7,2),archbishopsB:t(e,8,2),amazonsW:t(e,1,3),amazonsB:t(e,2,3),guardsW:t(e,3,3),guardsB:t(e,4,3),hawksW:t(e,7,3),hawksB:t(e,8,3),camelsW:t(e,1,4),camelsB:t(e,2,4),giraffesW:t(e,3,4),giraffesB:t(e,4,4),zebrasW:t(e,5,4),zebrasB:t(e,6,4),knightridersW:t(e,7,4),knightridersB:t(e,8,4),unicornsW:t(e,1,5),unicornsB:t(e,2,5),evolvedUnicornsW:t(e,3,5),evolvedUnicornsB:t(e,4,5),rosesW:t(e,5,5),rosesB:t(e,6,5),centaursW:t(e,7,5),centaursB:t(e,8,5),royalCentaursW:t(e,1,6),royalCentaursB:t(e,2,6),royalQueensW:t(e,3,6),royalQueensB:t(e,4,6),kelpiesW:t(e,5,6),kelpiesB:t(e,6,6),dragonsW:t(e,7,6),dragonsB:t(e,8,6),drakonsW:t(e,1,7),drakonsB:t(e,2,7),air:t(e,3,7),obstaclesN:t(e,4,7),yellow:t(e,5,7)}},getSpritesheetDataPieceWidth:function(){return i.pieceWidth},getSpritesheetDataTexLocation:function(e){return i[e]}})}(),piecesmodel={strideWithTexture:4,strideWithColoredTexture:8,pointsPerSquare:6,regenRange:1e4,regenModel:async function(e,t,o){if(!e)return;if(e.mesh.isGenerating)return;e.mesh.locked++,e.mesh.isGenerating++,console.log("Regenerating pieces model."),e.mesh.offset=math.roundPointToNearestGridpoint(movement.getBoardPos(),piecesmodel.regenRange);const n=coin.getCoinCount(),i=gamefileutility.getPieceCount(game.getGamefile().ourPieces)+n,r=t?piecesmodel.strideWithColoredTexture:piecesmodel.strideWithTexture,a=r*piecesmodel.pointsPerSquare,s=i*a,c=null!=t,l={data64:new Float64Array(s),data32:new Float32Array(s),stride:r,model:void 0,usingColoredTextures:c},u=onlinegame.areInOnlineGame()&&onlinegame.areWeColor("black")?-1:1;let d=0;d=coin.appDat(e,d,l,c);let m=1e3,p=performance.now(),g=p+loadbalancer.getLongTaskTime(),f=0,h=0;async function v(){if(!(performance.now()>=g))return;const e=h/i;stats.updatePiecesMesh(e),await main.sleep(0),p=performance.now(),g=p+loadbalancer.getLongTaskTime()}return stats.showPiecesMesh(),await pieces.forEachPieceType_Async((async function(o){if(e.mesh.terminate)return;const n=game.getGamefile().ourPieces[o],{texStartX:i,texStartY:r,texEndX:s,texEndY:c}=bufferdata.getTexDataOfType(o,u);if(t){const e=math.getPieceColorFromType(o),n=t[e];var p=n[0],g=n[1],P=n[2],b=n[3]}for(let o=0;o<n.length;o++){const u=n[o];if(!u){d+=a;continue}const{startX:y,startY:w,endX:C,endY:k}=bufferdata.getCoordDataOfTile_WithOffset(e.mesh.offset,u),T=t?bufferdata.getDataQuad_ColorTexture(y,w,C,k,i,r,s,c,p,g,P,b):bufferdata.getDataQuad_Texture(y,w,C,k,i,r,s,c);for(let e=0;e<T.length;e++)l.data64[d]=T[e],l.data32[d]=T[e],d++;if(f++,h++,f>=m){if(f=0,await v(),e.mesh.terminate)return;main.gforceCalc()&&(m=1/0,main.sforceCalc(!1))}}}),{ignoreVoids:!0}),stats.hidePiecesMesh(),e.mesh.terminate?(console.log("Mesh generation terminated."),e.mesh.terminate=!1,e.mesh.locked--,void e.mesh.isGenerating--):(main.enableForceRender(),l.model=t?buffermodel.createModel_ColorTextured(l.data32,2,"TRIANGLES",pieces.getSpritesheet()):buffermodel.createModel_Textured(l.data32,2,"TRIANGLES",pieces.getSpritesheet()),math.copyPropertiesToObject(l,e.mesh),perspective.getEnabled()&&await piecesmodel.initRotatedPiecesModel(game.getGamefile(),!0),e.mesh.terminate?(e.mesh.terminate=!1,e.mesh.locked--,void e.mesh.isGenerating--):(voids.regenModel(e),o&&statustext.showStatus("Regenerated pieces.",!1,.5),main.renderThisFrame(),main.enableForceRender(),e.mesh.locked--,e.mesh.isGenerating--,void console.log("Done!")))},movebufferdata(e,t,o){if(!e.mesh.data64)throw new Error("Should not be moving piece data when data64 is not defined!");if(!e.mesh.data32)throw new Error("Should not be moving piece data when data32 is not defined!");let n=piecesmodel.getPieceIndexInData(e,t)*(e.mesh.stride*piecesmodel.pointsPerSquare);const{startX:i,startY:r,endX:a,endY:s}=bufferdata.getCoordDataOfTile_WithOffset(e.mesh.offset,o),c=e.mesh.stride;function l(e){e[n]=i,e[n+1]=r,e[n+1*c]=i,e[n+1*c+1]=s,e[n+2*c]=a,e[n+2*c+1]=r,e[n+3*c]=a,e[n+3*c+1]=r,e[n+4*c]=i,e[n+4*c+1]=s,e[n+5*c]=a,e[n+5*c+1]=s}l(e.mesh.data64),l(e.mesh.data32),perspective.getEnabled()&&(l(e.mesh.rotatedData64),l(e.mesh.rotatedData32));const u=5*c+2;e.mesh.model.updateBufferIndices(n,u),perspective.getEnabled()&&e.mesh.rotatedModel.updateBufferIndices(n,u)},deletebufferdata(e,t){if(!e.mesh.data64)throw new Error("Should not be deleting piece data when data64 is not defined!");if(!e.mesh.data32)throw new Error("Should not be deleting piece data when data32 is not defined!");const o=piecesmodel.getPieceIndexInData(e,t),n=e.mesh.stride*piecesmodel.pointsPerSquare,i=o*n;for(let t=0;t<n;t++){const o=i+t;e.mesh.data64[o]=0,e.mesh.data32[o]=0}if(perspective.getEnabled())for(let t=0;t<n;t++){const o=i+t;e.mesh.rotatedData64[o]=0,e.mesh.rotatedData32[o]=0}const r=n;e.mesh.model.updateBufferIndices(i,r),perspective.getEnabled()&&e.mesh.rotatedModel.updateBufferIndices(i,r)},overwritebufferdata(e,t,o,n){if(!e.mesh.data64)return console.error("Should not be overwriting piece data when data64 is not defined!");if(!e.mesh.data32)return console.error("Should not be overwriting piece data when data32 is not defined!");let i=piecesmodel.getPieceIndexInData(e,t)*(e.mesh.stride*piecesmodel.pointsPerSquare);const r=onlinegame.areInOnlineGame()&&onlinegame.areWeColor("black")?-1:1,{texStartX:a,texStartY:s,texEndX:c,texEndY:l}=bufferdata.getTexDataOfType(n,r),{startX:u,startY:d,endX:m,endY:p}=bufferdata.getCoordDataOfTile_WithOffset(e.mesh.offset,o);let g;if(e.mesh.usingColoredTextures){const e=options.getPieceRegenColorArgs()[math.getPieceColorFromType(n)],[t,o,i,r]=e;g=bufferdata.getDataQuad_ColorTexture(u,d,m,p,a,s,c,l,t,o,i,r)}else g=bufferdata.getDataQuad_Texture(u,d,m,p,a,s,c,l);for(let t=0;t<g.length;t++){const o=i+t;e.mesh.data64[o]=g[t],e.mesh.data32[o]=g[t]}if(perspective.getEnabled()){const t=e.mesh.usingColoredTextures?bufferdata.rotateDataColorTexture(g,r):bufferdata.rotateDataTexture(g,r);for(let o=0;o<t.length;o++){const n=i+o;e.mesh.rotatedData64[n]=t[o],e.mesh.rotatedData32[n]=t[o]}}const f=g.length;e.mesh.model.updateBufferIndices(i,f),perspective.getEnabled()&&e.mesh.rotatedModel.updateBufferIndices(i,f)},getPieceIndexInData:(e,t)=>gamefileutility.calcPieceIndexInAllPieces(e,t)+coin.getCoinCount(),printbufferdataOnCoords(e,t){const o=gamefileutility.getPieceAtCoords(e,t);o||console.log("No piece at these coords to retrieve data from!");const n=piecesmodel.getPieceIndexInData(e,o);printbufferdataOnIndex(n)},printbufferdataOnIndex(e,t){const o=e.mesh.stride*piecesmodel.pointsPerSquare;let n=t*o;for(a=0;a<o;a++){const t=n+a;console.log(e.mesh.data32[t])}},shiftPiecesModel:function(e){console.log("Shifting pieces model.."),main.renderThisFrame();const t=math.roundPointToNearestGridpoint(movement.getBoardPos(),piecesmodel.regenRange),o=e.mesh.offset[0]-t[0],n=e.mesh.offset[1]-t[1];e.mesh.offset=t,perspective.getEnabled()?function(){for(let t=0;t<e.mesh.data32.length;t+=e.mesh.stride)e.mesh.data64[t]+=o,e.mesh.data64[t+1]+=n,e.mesh.data32[t]=e.mesh.data64[t],e.mesh.data32[t+1]=e.mesh.data64[t+1],e.mesh.rotatedData64[t]+=o,e.mesh.rotatedData64[t+1]+=n,e.mesh.rotatedData32[t]=e.mesh.rotatedData64[t],e.mesh.rotatedData32[t+1]=e.mesh.rotatedData64[t+1];e.mesh.model=e.mesh.usingColoredTextures?buffermodel.createModel_ColorTextured(e.mesh.data32,2,"TRIANGLES",pieces.getSpritesheet()):buffermodel.createModel_Textured(e.mesh.data32,2,"TRIANGLES",pieces.getSpritesheet()),e.mesh.rotatedModel=e.mesh.usingColoredTextures?buffermodel.createModel_ColorTextured(e.mesh.rotatedData32,2,"TRIANGLES",pieces.getSpritesheet()):buffermodel.createModel_Textured(e.mesh.rotatedData32,2,"TRIANGLES",pieces.getSpritesheet())}():function(){for(let t=0;t<e.mesh.data32.length;t+=e.mesh.stride)e.mesh.data64[t]+=o,e.mesh.data64[t+1]+=n,e.mesh.data32[t]=e.mesh.data64[t],e.mesh.data32[t+1]=e.mesh.data64[t+1];e.mesh.model=e.mesh.usingColoredTextures?buffermodel.createModel_ColorTextured(e.mesh.data32,2,"TRIANGLES",pieces.getSpritesheet()):buffermodel.createModel_Textured(e.mesh.data32,2,"TRIANGLES",pieces.getSpritesheet())}(),voids.shiftModel(e,o,n)},initRotatedPiecesModel:async function(e,t=!1){if(null==e.mesh.model)return;if(e.mesh.isGenerating&&!t)return;e.mesh.locked++,e.mesh.isGenerating++,console.log("Rotating pieces model.."),main.renderThisFrame();const o=onlinegame.areInOnlineGame()&&onlinegame.areWeColor("black")?-pieces.getSpritesheetDataPieceWidth():pieces.getSpritesheetDataPieceWidth();e.mesh.rotatedData64=new Float64Array(e.mesh.data32.length),e.mesh.rotatedData32=new Float32Array(e.mesh.data32.length);const n=e.mesh.stride*piecesmodel.pointsPerSquare,i=coin.getCoinCount(),r=2*(gamefileutility.getPieceCount(game.getGamefile().ourPieces)+i);let a=1e3,s=performance.now(),c=s+loadbalancer.getLongTaskTime(),l=0,u=0;stats.showRotateMesh();const d=e.mesh.usingColoredTextures?async function(t,i){for(let r=0;r<e.mesh.data32.length;r+=n)if(i[r]=t[r],i[r+1]=t[r+1],i[r+2]=t[r+2]+o,i[r+3]=t[r+3]+o,i[r+4]=t[r+4],i[r+5]=t[r+5],i[r+6]=t[r+6],i[r+7]=t[r+7],i[r+8]=t[r+8],i[r+9]=t[r+9],i[r+10]=t[r+10]+o,i[r+11]=t[r+11]-o,i[r+12]=t[r+12],i[r+13]=t[r+13],i[r+14]=t[r+14],i[r+15]=t[r+15],i[r+16]=t[r+16],i[r+17]=t[r+17],i[r+18]=t[r+18]-o,i[r+19]=t[r+19]+o,i[r+20]=t[r+20],i[r+21]=t[r+21],i[r+22]=t[r+22],i[r+23]=t[r+23],i[r+24]=t[r+24],i[r+25]=t[r+25],i[r+26]=t[r+26]-o,i[r+27]=t[r+27]+o,i[r+28]=t[r+28],i[r+29]=t[r+29],i[r+30]=t[r+30],i[r+31]=t[r+31],i[r+32]=t[r+32],i[r+33]=t[r+33],i[r+34]=t[r+34]+o,i[r+35]=t[r+35]-o,i[r+36]=t[r+36],i[r+37]=t[r+37],i[r+38]=t[r+38],i[r+39]=t[r+39],i[r+40]=t[r+40],i[r+41]=t[r+41],i[r+42]=t[r+42]-o,i[r+43]=t[r+43]-o,i[r+44]=t[r+44],i[r+45]=t[r+45],i[r+46]=t[r+46],i[r+47]=t[r+47],l++,u++,l>=a){if(l=0,await m(),e.mesh.terminate)return;main.gforceCalc()&&(a=1/0,main.sforceCalc(!1))}}:async function(t,i){for(let r=0;r<e.mesh.data32.length;r+=n)if(i[r]=t[r],i[r+1]=t[r+1],i[r+2]=t[r+2]+o,i[r+3]=t[r+3]+o,i[r+4]=t[r+4],i[r+5]=t[r+5],i[r+6]=t[r+6]+o,i[r+7]=t[r+7]-o,i[r+8]=t[r+8],i[r+9]=t[r+9],i[r+10]=t[r+10]-o,i[r+11]=t[r+11]+o,i[r+12]=t[r+12],i[r+13]=t[r+13],i[r+14]=t[r+14]-o,i[r+15]=t[r+15]+o,i[r+16]=t[r+16],i[r+17]=t[r+17],i[r+18]=t[r+18]+o,i[r+19]=t[r+19]-o,i[r+20]=t[r+20],i[r+21]=t[r+21],i[r+22]=t[r+22]-o,i[r+23]=t[r+23]-o,l++,u++,l>=a){if(l=0,await m(),e.mesh.terminate)return;main.gforceCalc()&&(a=1/0,main.sforceCalc(!1))}};if(await d(e.mesh.data64,e.mesh.rotatedData64),e.mesh.terminate)return console.log("Mesh generation terminated."),stats.hideRotateMesh(),t||(e.mesh.terminate=!1),e.mesh.locked--,void e.mesh.isGenerating--;if(await d(e.mesh.data32,e.mesh.rotatedData32),e.mesh.terminate)return console.log("Mesh generation terminated."),stats.hideRotateMesh(),t||(e.mesh.terminate=!1),e.mesh.locked--,void e.mesh.isGenerating--;async function m(){if(!(performance.now()>=c))return;const e=u/r;stats.updateRotateMesh(e),await main.sleep(0),s=performance.now(),c=s+loadbalancer.getLongTaskTime()}stats.hideRotateMesh(),e.mesh.rotatedModel=e.mesh.usingColoredTextures?buffermodel.createModel_ColorTextured(e.mesh.rotatedData32,2,"TRIANGLES",pieces.getSpritesheet()):buffermodel.createModel_Textured(e.mesh.rotatedData32,2,"TRIANGLES",pieces.getSpritesheet()),e.mesh.locked--,e.mesh.isGenerating--,main.renderThisFrame()},eraseRotatedModel(e){null!=e?.mesh&&(delete e.mesh.rotatedData64,delete e.mesh.rotatedData32,delete e.mesh.rotatedModel)}},promotionlines={startEnd:[-3,12],thickness:.01,render:function(){if(!game.getGamefile().gameRules.promotionRanks)return;const e=promotionlines.initModel(),t=movement.getBoardPos(),o=[-t[0],-t[1],0],n=movement.getBoardScale(),i=[n,n,1];e.render(o,i)},initModel:function(){const e=promotionlines.startEnd[0]-board.gsquareCenter(),t=promotionlines.startEnd[1]+1-board.gsquareCenter(),o=game.getGamefile(),n=o.gameRules.promotionRanks[0]+1-board.gsquareCenter()-promotionlines.thickness,i=o.gameRules.promotionRanks[0]+1-board.gsquareCenter()+promotionlines.thickness,r=o.gameRules.promotionRanks[1]-board.gsquareCenter()-promotionlines.thickness,a=o.gameRules.promotionRanks[1]-board.gsquareCenter()+promotionlines.thickness,s=new Float32Array([e,n,0,0,0,1,e,i,0,0,0,1,t,n,0,0,0,1,t,n,0,0,0,1,e,i,0,0,0,1,t,i,0,0,0,1,e,r,0,0,0,1,e,a,0,0,0,1,t,r,0,0,0,1,t,r,0,0,0,1,e,a,0,0,0,1,t,a,0,0,0,1]);return buffermodel.createModel_Colored(s,2,"TRIANGLES")}},selection=function(){let e,t,o,n,i=!1,r=!1;function a(){return null!=e}function s(o,n,i){main.renderThisFrame(),e={type:o,index:n,coords:i},t=legalmoves.calculate(game.getGamefile(),e),highlights.regenModel()}function c(){e=void 0,t=void 0,r=!1,n=void 0,guipromotion.close(),main.renderThisFrame()}function l(t){const o=movepiece.stripSpecialMoveTagsFromCoords(t),n={type:e.type,startCoords:e.coords,endCoords:o};specialdetect.transferSpecialFlags_FromCoordsToMove(t,n);const i=formatconverter.LongToShort_CompactMove(n);n.compact=i,movepiece.makeMove(game.getGamefile(),n),onlinegame.sendMove(),c()}return Object.freeze({isAPieceSelected:a,getPieceSelected:function(){return e},unselectPiece:c,getLegalMovesOfSelectedPiece:function(){return t},isPawnCurrentlyPromoting:function(){return r},promoteToType:function(e){n=e},update:function(){const a=game.getGamefile();if(onlinegame.areInOnlineGame()&&!onlinegame.isItOurTurn(a))return;if(r)return void(n&&function(){const e=r;e.promotion=n,l(e),perspective.relockMouse()}());if(movement.isScaleLess1Pixel_Virtual()||transition.areWeTeleporting()||a.gameConclusion||guipause.areWePaused()||perspective.isLookingUp())return;let u=input.getTouchClickedTile();if(o=input.getTouchClicked()?[u.x,u.y]:input.getMouseClicked()?input.getMouseClickedTile():board.gtile_MouseOver_Int(),!o)return;if(function(){if(null==e)return void(i=!1);const n=game.getGamefile(),r=gamefileutility.getPieceTypeAtCoords(n,o),a=r&&math.getPieceColorFromType(e.type)===math.getPieceColorFromType(r),s=!a&&"voidsN"===r;i=legalmoves.checkIfMoveLegal(t,e.coords,o)||options.getEM()&&!s&&!a}(),!input.getMouseClicked()&&!input.getTouchClicked())return;const d=gamefileutility.getPieceTypeAtCoords(a,o);e?function(t,o){const n=game.getGamefile();e:if(o){if(math.getPieceColorFromType(e.type)!==math.getPieceColorFromType(o))break e;if(o&&math.areCoordsEqual(e.coords,t))main.renderThisFrame(),c();else if("voidsN"!==o){s(o,gamefileutility.getPieceIndexByTypeAndCoords(n,o,t),t)}return}if(!i)return;if(n.mesh.locked)return statustext.pleaseWaitForTask();if(specialdetect.isPawnPromotion(n,e.type,t)){const o=math.getPieceColorFromType(e.type);return guipromotion.open(o),void(r=t)}l(t)}(o,d):d&&function(e){const t=game.getGamefile(),n=math.getPieceColorFromType(e);if(!movesscript.areWeViewingLatestMove(t)&&(n===t.whosTurn||options.getEM()&&"voidsN"!==e))return movepiece.forwardToFront(t,{flipTurn:!1,updateProperties:!1});if(n!==t.whosTurn&&!options.getEM())return;if(options.getEM()&&"voidsN"===e)return;const i=gamefileutility.getPieceIndexByTypeAndCoords(t,e,o);s(e,i,o)}(d)},renderGhostPiece:function(){a()&&o&&i&&input.isMouseSupported()&&pieces.renderGhostPiece(e.type,o)}})}(),shaders=function(){const e={colorProgram:void 0,textureProgram:void 0,coloredTextureProgram:void 0,tintedTextureProgram:void 0};function t(e,t){const n=o(gl.VERTEX_SHADER,e),i=o(gl.FRAGMENT_SHADER,t),r=gl.createProgram();return gl.attachShader(r,n),gl.attachShader(r,i),gl.linkProgram(r),gl.getProgramParameter(r,gl.LINK_STATUS)?r:(alert(`Unable to initialize the shader program: ${gl.getProgramInfoLog(r)}`),null)}function o(e,t){const o=gl.createShader(e);if(gl.shaderSource(o,t),gl.compileShader(o),!gl.getShaderParameter(o,gl.COMPILE_STATUS)){const e=`An error occurred compiling the shaders: ${gl.getShaderInfoLog(o)}`;return alert(e),console.error(e),gl.deleteShader(o),null}return o}return Object.freeze({initPrograms:function(){e.colorProgram=function(){const e="",o=t(`\n            attribute vec4 aVertexPosition;\n            attribute vec4 aVertexColor;\n\n            uniform mat4 uWorldMatrix;\n            uniform mat4 uViewMatrix;\n            uniform mat4 uProjMatrix;\n\n            varying lowp vec4 vColor;\n\n            void main() {\n                gl_Position = uProjMatrix * uViewMatrix * uWorldMatrix * aVertexPosition;\n                vColor = aVertexColor;\n                ${e}\n            }\n        `,"\n            varying lowp vec4 vColor;\n\n            void main() {\n                gl_FragColor = vColor;\n            }\n        ");return{program:o,attribLocations:{vertexPosition:gl.getAttribLocation(o,"aVertexPosition"),vertexColor:gl.getAttribLocation(o,"aVertexColor")},uniformLocations:{projectionMatrix:gl.getUniformLocation(o,"uProjMatrix"),viewMatrix:gl.getUniformLocation(o,"uViewMatrix"),worldMatrix:gl.getUniformLocation(o,"uWorldMatrix")}}}(),e.textureProgram=function(){const e=t("\n            attribute vec4 aVertexPosition;\n            attribute vec2 aTextureCoord;\n\n            uniform mat4 uWorldMatrix;\n            uniform mat4 uViewMatrix;\n            uniform mat4 uProjMatrix;\n\n            varying lowp vec2 vTextureCoord;\n\n            void main(void) {\n                gl_Position = uProjMatrix * uViewMatrix * uWorldMatrix * aVertexPosition; // Original, no z-translating\n                vTextureCoord = aTextureCoord;\n            }\n        ","\n            varying lowp vec2 vTextureCoord;\n\n            uniform sampler2D uSampler;\n\n            void main(void) {\n                gl_FragColor = texture2D(uSampler, vTextureCoord);\n            }\n        ");return{program:e,attribLocations:{vertexPosition:gl.getAttribLocation(e,"aVertexPosition"),textureCoord:gl.getAttribLocation(e,"aTextureCoord")},uniformLocations:{projectionMatrix:gl.getUniformLocation(e,"uProjMatrix"),viewMatrix:gl.getUniformLocation(e,"uViewMatrix"),worldMatrix:gl.getUniformLocation(e,"uWorldMatrix"),uSampler:gl.getUniformLocation(e,"uSampler")}}}(),e.coloredTextureProgram=function(){const e=t("\n            attribute vec4 aVertexPosition;\n            attribute vec2 aTextureCoord;\n            attribute vec4 aVertexColor;\n\n            uniform mat4 uWorldMatrix;\n            uniform mat4 uViewMatrix;\n            uniform mat4 uProjMatrix;\n\n            varying lowp vec2 vTextureCoord;\n            varying lowp vec4 vColor;\n\n            void main(void) {\n                gl_Position = uProjMatrix * uViewMatrix * uWorldMatrix * aVertexPosition;\n                vTextureCoord = aTextureCoord;\n                vColor = aVertexColor;\n            }\n        ","\n            varying lowp vec2 vTextureCoord;\n            varying lowp vec4 vColor;\n\n            uniform sampler2D uSampler;\n\n            void main(void) {\n                gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;\n            }\n        ");return{program:e,attribLocations:{vertexPosition:gl.getAttribLocation(e,"aVertexPosition"),textureCoord:gl.getAttribLocation(e,"aTextureCoord"),vertexColor:gl.getAttribLocation(e,"aVertexColor")},uniformLocations:{projectionMatrix:gl.getUniformLocation(e,"uProjMatrix"),viewMatrix:gl.getUniformLocation(e,"uViewMatrix"),worldMatrix:gl.getUniformLocation(e,"uWorldMatrix"),uSampler:gl.getUniformLocation(e,"uSampler")}}}(),e.tintedTextureProgram=function(){const e=t("  \n            attribute vec4 aVertexPosition;\n            attribute vec2 aTextureCoord;\n\n            uniform mat4 uWorldMatrix;\n            uniform mat4 uViewMatrix;\n            uniform mat4 uProjMatrix;\n\n            varying lowp vec2 vTextureCoord;\n\n            void main(void) {\n                gl_Position = uProjMatrix * uViewMatrix * uWorldMatrix * aVertexPosition;\n                vTextureCoord = aTextureCoord;\n            }\n        ","\n            varying lowp vec2 vTextureCoord;\n\n            uniform lowp vec4 uVertexColor;\n            uniform sampler2D uSampler;\n\n            void main(void) {\n                gl_FragColor = texture2D(uSampler, vTextureCoord) * uVertexColor;\n            }\n        "),o={program:e,attribLocations:{vertexPosition:gl.getAttribLocation(e,"aVertexPosition"),textureCoord:gl.getAttribLocation(e,"aTextureCoord")},uniformLocations:{uVertexColor:gl.getUniformLocation(e,"uVertexColor"),projectionMatrix:gl.getUniformLocation(e,"uProjMatrix"),viewMatrix:gl.getUniformLocation(e,"uViewMatrix"),worldMatrix:gl.getUniformLocation(e,"uWorldMatrix"),uSampler:gl.getUniformLocation(e,"uSampler")}};gl.useProgram(o.program);const n=[1,1,1,1];return gl.uniform4fv(o.uniformLocations.uVertexColor,n),o}()},programs:e})}(),sound=function(){const e={gamestart:[0,2],move:[2,2.21],capture:[2.21,2.58],bell:[2.58,5.57],lowtime:[5.57,6.3],win:[6.3,8.3],draw:[8.3,10.31],loss:[10.31,12.32],drum1:[12.32,16.32],drum2:[16.32,19.57],tick:[19.57,25.32],ticking:[25.32,36.82],viola_staccato_c3:[36.82,38.82],violin_staccato_c4:[38.82,40.82],marimba_c2:[40.82,42.82],marimba_c2_soft:[42.82,44.82],base_staccato_c2:[44.82,46.82]};let t,o;const n=1e6,i=15,r=80,a=3.5,s=1.5;let c=0,l=35;function u(o,{volume:n=1,delay:i=0,offset:r=0,fadeInDuration:a,reverbVolume:s,reverbDuration:c}={}){if(!htmlscript.hasUserGesturedAtleastOnce())return;if(!t)throw new Error(`Can't play sound ${o} when audioContext isn't initialized yet! (Still loading)`);const l=function(t){const o=e[t];if(o)return o;throw new Error(`Cannot return sound stamp for strange new sound ${t}!`)}(o),u=r/1e3,m=l[0]+u,f=(h=l)[1]-h[0]-u;var h;if(f<0)return;const v=t.currentTime+i,P={source:void 0,sourceReverb:void 0,stop:()=>{P.source.stop(),P.sourceReverb&&P.sourceReverb.stop()},fadeOut:e=>{g(P.source,e),P.sourceReverb&&g(P.sourceReverb,e)}},b=d(n);if(b.start(v,m,f),P.source=b,!s)return w();if(null==c)return console.error("Need to specify a reverb duration.");const y=d(s,1,c);return y.start(v,m,f),P.sourceReverb=y,w();function w(){return null==a||(p(P.source,n,a),P.sourceReverb&&p(P.sourceReverb,s,a)),P}}function d(e,n=1,i){const r=t.createBufferSource();if(null==o)throw new Error("audioDecodedBuffer should never be undefined! This usually happens when soundspritesheet.mp3 starts loading but the document finishes loading in the middle of the audio loading.");r.buffer=o;const a=[],s=function(e,t){t>4&&(console.error(`Gain was DANGEROUSLY set to ${t}!!!! Resetting to 1.`),t=1);const o=e.createGain();return o.gain.value=t,o}(t,e);if(a.push(s),r.gainNode=s,null!=i){const e=function(e,t){var o=m(t);return new ConvolverNode(e,{buffer:o})}(t,i);a.push(e)}return r.playbackRate.value=n,function(e,t,o){let n=e;for(let e=0;e<o.length;e++){const t=o[e];n.connect(t),n=t}n.connect(t.destination)}(r,t,a),r}function m(e){const o=t.sampleRate,n=o*e,i=t.createBuffer(1,n,o),r=i.getChannelData(0);for(let e=0;e<n;e++)r[e]=(2*Math.random()-1)*Math.pow(1-e/n,2);return i}function p(e,o,n){if(!e?.gainNode)throw new Error("Source or gain node not provided");const i=t.currentTime;e.gainNode.gain.setValueAtTime(0,i),e.gainNode.gain.linearRampToValueAtTime(o,i+n/1e3)}function g(e,o){if(!e?.gainNode)throw new Error("Source or gain node not provided");const n=o/1e3,i=t.currentTime,r=i+n;e.gainNode.gain.setValueAtTime(e.gainNode.gain.value,i),e.gainNode.gain.linearRampToValueAtTime(0,r),setTimeout((()=>{e.stop()}),o)}function f(e){const t=(e-i)/(r-i);if(t<=0)return{reverbVolume:null,reverbDuration:null};if(t>=1)return{reverbVolume:a,reverbDuration:s};return{reverbVolume:a*t,reverbDuration:s}}return Object.freeze({getAudioContext:function(){return t},initAudioContext:function(e,n){t=e,o=n},playSound_gamestart:function(){return u("gamestart",{volume:.4})},playSound_move:async function(e,t){await async function(){const e=Date.now()-c;if(e>=l)return;const t=l-e;await main.sleep(t)}();const o=e>=n,i=t&&o?.3:t?.5:1,r=1*i;let{reverbVolume:a,reverbDuration:s}=f(e);if(a*=i,u("move",{volume:r,reverbVolume:a,reverbDuration:s}),o){u("bell",.6*i)}c=Date.now()},playSound_capture:function(e,t){const o=t&&e>=n?.3:t?.5:1,i=1*o;let{reverbVolume:r,reverbDuration:a}=f(e);if(r*=o,u("capture",{volume:i,reverbVolume:r,reverbDuration:a}),e>=n){u("bell",.6*o)}},playSound_lowtime:function(){return u("lowtime")},playSound_win:function(e){return u("win",{volume:.7,delay:e})},playSound_draw:function(e){return u("draw",{volume:.7,delay:e})},playSound_loss:function(e){return u("loss",{volume:.7,delay:e})},playSound_drum:function(){return u(`drum${Math.random()>.5?1:2}`,{volume:.7})},playSound_tick:function({volume:e,fadeInDuration:t,offset:o}={}){return u("tick",{volume:e,offset:o,fadeInDuration:t})},playSound_ticking:function({fadeInDuration:e,offset:t}={}){return u("ticking",{volume:.18,offset:t,fadeInDuration:e})},playSound_viola_c3:function({volume:e}={}){return u("viola_staccato_c3",{volume:e})},playSound_violin_c4:function(){return u("violin_staccato_c4",{volume:.9})},playSound_marimba:function(){return u(`marimba_c2${Math.random()>.15?"_soft":""}`,{volume:.4})},playSound_base:function(){return u("base_staccato_c2",{volume:.8})}})}(),specialdetect=function(){const e=["enpassant","promotion","castle"];function t(e,t,o,i){if(!n(e,t))return;const r=t[0],a=t[1],s=e.piecesOrganizedByRow[a];let c=!0,l=!0,u=-1/0,d=1/0;for(let e=0;e<s.length;e++){const t=s[e].coords;t[0]<r&&t[0]>u?u=t[0]:t[0]>r&&t[0]<d&&(d=t[0])}const m=r-u,p=d-r,g=[u,a],f=[d,a],h=isFinite(u)?math.getPieceColorFromType(gamefileutility.getPieceTypeAtCoords(e,g)):void 0,v=isFinite(d)?math.getPieceColorFromType(gamefileutility.getPieceTypeAtCoords(e,f)):void 0;if((u===-1/0||m<3||!n(e,g)||h!==o)&&(c=!1),(d===1/0||p<3||!n(e,f)||v!==o)&&(l=!1),!c&&!l)return;const P=math.getOppositeColor(o);if(e.gameRules.winConditions[P].includes("checkmate")){if(e.inCheck)return;const n=gamefileutility.getPieceAtCoords(e,t);if(c){const t=[r-1,a];checkdetection.doesMovePutInCheck(e,n,t,o)&&(c=!1)}if(l){const t=[r+1,a];checkdetection.doesMovePutInCheck(e,n,t,o)&&(l=!1)}}if(c){const e=[t[0]-2,t[1]];e.castle={dir:-1,coord:g},i.push(e)}if(l){const e=[t[0]+2,t[1]];e.castle={dir:1,coord:f},i.push(e)}}function o(e,t,o,i){const r="white"===o?1:-1,a=[t[0],t[1]+r];if(!gamefileutility.getPieceTypeAtCoords(e,a)){i.push(a);const o=[a[0],a[1]+r];!gamefileutility.getPieceTypeAtCoords(e,o)&&n(e,t)&&i.push(o)}const s=[[t[0]-1,t[1]+r],[t[0]+1,t[1]+r]];for(let t=0;t<2;t++){const n=s[t],r=gamefileutility.getPieceTypeAtCoords(e,n);if(!r)continue;o!==math.getPieceColorFromType(r)&&("voidsN"!==r&&i.push(n))}!function(e,t,o,n){if(!e.enpassant)return;const i=e.enpassant[0]-o[0],r="white"===n?1:-1;if(1!==Math.abs(i))return;if(o[1]+r!==e.enpassant[1])return;const a=[o[0]+i,o[1]+r];if(gamefileutility.getPieceTypeAtCoords(e,a))return console.error("We cannot capture onpassant onto a square with an existing piece! "+a);a.enpassant=-r,t.push(a)}(e,i,t,o)}function n(e,t){const o=math.getKeyFromCoords(t);return e.specialRights[o]}return Object.freeze({getAllSpecialMoves:function(){return e},getSpecialMoves:function(){return{kings:t,royalCentaurs:t,pawns:o}},isPawnPromotion:function(e,t,o){if(!t.startsWith("pawns"))return!1;if(!e.gameRules.promotionRanks)return!1;const n=math.getPieceColorFromType(t),i="white"===n?e.gameRules.promotionRanks[0]:"black"===n?e.gameRules.promotionRanks[1]:void 0;return o[1]===i},transferSpecialFlags_FromCoordsToMove:function(t,o){for(const n of e)t[n]&&(o[n]=math.deepCopyObject(t[n]))},transferSpecialFlags_FromMoveToCoords:function(t,o){for(const n of e)t[n]&&(o[n]=math.deepCopyObject(t[n]))},transferSpecialFlags_FromCoordsToCoords:function(t,o){for(const n of e)null!=t[n]&&(o[n]=math.deepCopyObject(t[n]))}})}(),specialmove={getFunctions:()=>({kings:specialmove.kings,royalCentaurs:specialmove.kings,pawns:specialmove.pawns}),kings(e,t,o,{updateData:n=!0,animate:i=!0,updateProperties:r=!0,simulated:a=!1}={}){const s=o.castle;if(!s)return!1;movepiece.movePiece(e,t,o.endCoords,{updateData:n});const c=gamefileutility.getPieceAtCoords(e,s.coord),l=[o.endCoords[0]-s.dir,o.endCoords[1]],u=math.getKeyFromCoords(c.coords);if(delete e.specialRights[u],movepiece.movePiece(e,c,l,{updateData:n}),i){animation.animatePiece(t.type,t.coords,o.endCoords);const e=!1;animation.animatePiece(c.type,c.coords,l,void 0,e)}return!0},pawns(e,t,o,{updateData:n=!0,animate:i=!0,updateProperties:r=!0,simulated:a=!1}={}){r&&specialmove.isPawnMoveADoublePush(t.coords,o.endCoords)&&(e.enpassant=specialmove.getEnPassantSquare(t.coords,o.endCoords));const s=o.enpassant,c=o.promotion;if(!s&&!c)return!1;let l=s?specialmove.getEnpassantCaptureCoords(o.endCoords,s):o.endCoords,u=gamefileutility.getPieceAtCoords(e,l);return u&&(o.captured=u.type),u&&a&&(o.rewindInfo.capturedIndex=u.index),u&&movepiece.deletePiece(e,u,{updateData:n}),c?(movepiece.deletePiece(e,t,{updateData:n}),movepiece.addPiece(e,c,o.endCoords,null,{updateData:n})):movepiece.movePiece(e,t,o.endCoords,{updateData:n}),i&&animation.animatePiece(t.type,t.coords,o.endCoords,u),!0},isPawnMoveADoublePush:(e,t)=>2===Math.abs(e[1]-t[1]),getEnPassantSquare(e,t){const o=(e[1]+t[1])/2;return[e[0],o]},getEnpassantCaptureCoords:(e,t)=>[e[0],e[1]+t]},specialundo={getFunctions:()=>({kings:specialundo.kings,royalCentaurs:specialundo.kings,pawns:specialundo.pawns}),kings(e,t,{updateData:o=!0,animate:n=!0}={}){const i=t.castle;if(!i)return!1;let r=gamefileutility.getPieceAtCoords(e,t.endCoords);movepiece.movePiece(e,r,t.startCoords,{updateData:o});const a=r.coords,s=[a[0]-i.dir,a[1]];if(r=gamefileutility.getPieceAtCoords(e,s),movepiece.movePiece(e,r,i.coord,{updateData:o}),!o){const t=math.getKeyFromCoords(i.coord);e.specialRights[t]=!0}if(n){animation.animatePiece(t.type,t.endCoords,t.startCoords);const e=!1;animation.animatePiece(r.type,s,i.coord,void 0,e)}return!0},pawns(e,t,{updateData:o=!0,animate:n=!0}={}){const i=t.enpassant,r=t.promotion,a=2===Math.abs(t.endCoords[1]-t.startCoords[1]);if(!i&&!r&&!a)return!1;const s=gamefileutility.getPieceAtCoords(e,t.endCoords);if(t.promotion){const n=math.getWorBFromType(s.type);movepiece.deletePiece(e,s,{updateData:o});const i="pawns"+n;movepiece.addPiece(e,i,t.startCoords,t.rewindInfo.pawnIndex,{updateData:o})}else movepiece.movePiece(e,s,t.startCoords,{updateData:o}),!o&&a&&delete e.enpassant;if(t.enpassant){const n=t.captured,i=[t.endCoords[0],t.endCoords[1]+t.enpassant];movepiece.addPiece(e,n,i,t.rewindInfo.capturedIndex,{updateData:o})}else if(t.captured){const n=t.captured;movepiece.addPiece(e,n,t.endCoords,t.rewindInfo.capturedIndex,{updateData:o})}return n&&animation.animatePiece(t.type,t.endCoords,t.startCoords),!0}},stats={element_Statuses:document.getElementById("stats"),elementStatusMoveLooking:document.getElementById("status-move-looking"),elementStatusFPS:document.getElementById("status-fps"),elementStatusPiecesMesh:document.getElementById("status-pieces-mesh"),elementStatusRotateMesh:document.getElementById("status-rotate-mesh"),elementStatusCoords:document.getElementById("status-coords"),elementStatusMoves:document.getElementById("status-moves"),visibilityWeight:0,showMoves(e=2.5){main.videoMode||(stats.visibilityWeight++,stats.setTextContentOfMoves(),setTimeout(stats.hideMoves,1e3*e),1===stats.visibilityWeight&&style.revealElement(stats.elementStatusMoves))},hideMoves(){stats.visibilityWeight--,0===stats.visibilityWeight&&style.hideElement(stats.elementStatusMoves)},setTextContentOfMoves(){const e=game.getGamefile().moveIndex+1,t=movesscript.getPlyCount(game.getGamefile().moves);stats.elementStatusMoves.textContent=`Move: ${e}/${t}`},updateStatsCSS(){stats.element_Statuses.style=`top: ${camera.getPIXEL_HEIGHT_OF_TOP_NAV()}px`},showPiecesMesh(){main.videoMode||style.revealElement(stats.elementStatusPiecesMesh)},updatePiecesMesh(e){const t=math.decimalToPercent(e);stats.elementStatusPiecesMesh.textContent=`Constructing mesh ${t}`},hidePiecesMesh(){style.hideElement(stats.elementStatusPiecesMesh)},showFPS(){main.videoMode||style.revealElement(stats.elementStatusFPS)},hideFPS(){style.hideElement(stats.elementStatusFPS)},updateFPS(e){if(!options.isFPSOn())return;const t=0|e;stats.elementStatusFPS.textContent=`FPS: ${t}`},showRotateMesh(){main.videoMode||style.revealElement(stats.elementStatusRotateMesh)},updateRotateMesh(e){const t=math.decimalToPercent(e);stats.elementStatusRotateMesh.textContent=`Rotating mesh ${t}`},hideRotateMesh(){style.hideElement(stats.elementStatusRotateMesh)},hideMoveLooking(){style.hideElement(stats.elementStatusMoveLooking)}},statustext=function(){const e=document.getElementById("statusmessage"),t=document.getElementById("statustext"),o=1e3,n=900,i=45;let r=0;function a(e,t,o=1){s(e,(n+e.length*i)*o,t)}function s(n,i,a){if(null==n)return console.error("Cannot show status of undefined text!!");r++,setTimeout((function(){1===r?(t.classList.add("fade-out-1s"),function(o){setTimeout((function(){r--,r>0||(e.classList.add("hidden"),t.classList.remove("fade-out-1s"))}),o)}(o)):r--}),i),t.textContent=n,t.classList.remove("fade-out-1s"),e.classList.remove("hidden"),a?(t.classList.remove("ok"),t.classList.add("error"),console.error(n)):(t.classList.remove("error"),t.classList.add("ok"))}return Object.freeze({showStatus:a,lostConnection:function(){a("Lost connection.")},pleaseWaitForTask:function(){a("Please wait a moment to perform this task.",!1,.5)},getLayerCount:function(){return r},showStatusForDuration:s})}(),style=function(){const e=document.getElementById("style");let t;function o(e,t){e.classList.add(t)}function n(e,t){e.classList.remove(t)}function i(e,t){n(e,t),o(e,t)}function r(e){o(e,"hidden")}function a(e){n(e,"hidden")}return Object.freeze({hideElement:r,revealElement:a,setNavStyle:function(o){t=o,e.innerHTML=t},fadeIn1s:function(e){a(e),i(e,"fade-in-2_3s"),e.fadeIn1sLayers?e.fadeIn1sLayers++:e.fadeIn1sLayers=1,setTimeout((()=>{e.fadeIn1sLayers--,e.fadeIn1sLayers>0||(delete e.fadeIn1sLayers,n(e,"fade-in-2_3s"))}),1e3)},fadeOut1s:function(e){a(e),i(e,"fade-out-2_3s"),e.fadeOut1sLayers?e.fadeOut1sLayers++:e.fadeOut1sLayers=1,setTimeout((()=>{e.fadeOut1sLayers--,e.fadeOut1sLayers>0||(delete e.fadeOut1sLayers,n(e,"fade-out-2_3s"),r(e))}),1e3)}})}(),texture=Object.freeze({loadTexture:function(e,{useMipmaps:t=!1}={}){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);const o=document.getElementById(e);if(null==o)return console.error(`Unable to find of document texture element with id '${e}'!`);const n=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,n);const i=gl.RGBA,r=gl.RGBA,a=gl.UNSIGNED_BYTE;gl.texImage2D(gl.TEXTURE_2D,0,i,r,a,o);const s=math.isPowerOfTwo(o.offsetWidth)&&math.isPowerOfTwo(o.offsetHeight);return!s&&t&&console.log(`Image ID ${e} dimensions is not a power of two! Unable to use mipmaps. Dimensions: ${o.offsetWidth}x${o.offsetHeight}`),t&&s?gl.generateMipmap(gl.TEXTURE_2D):(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST)),gl.bindTexture(gl.TEXTURE_2D,null),n}});!function(){const e=["tooltip-dl","tooltip-d","tooltip-dr"],t=e.map((e=>"."+e)),o=document.querySelectorAll(t.join(", "));let n,i=!1;function r(){i&&(n=void 0,i=!1,o.forEach((e=>{e.classList.remove("fast-transition")})))}input.isMouseSupported()&&o.forEach((t=>{const a=(s=t,e.find((e=>s.classList.contains(e)))||null);var s;let c,l,u=!1,d=!1,m=!1,p=!1;function g(){m=!0}function f(){clearTimeout(c),c=void 0}function h(){p||(t.classList.remove(a),p=!0,m=!1,r(),f())}function v(){clearTimeout(l),l=void 0}function P(){v(),l=setTimeout(b,2e3)}function b(){p&&!d&&(v(),t.classList.add(a),p=!1,u&&g())}t.addEventListener("mouseenter",(()=>{u=!0,clearTimeout(n),n=void 0,i?g():c=setTimeout(g,1e3)})),t.addEventListener("mouseleave",(function(){u=!1,d=!1,f(),b(),m&&(i||(i=!0,o.forEach((e=>{e.classList.add("fast-transition")}))),n=setTimeout(r,750)),m=!1})),t.addEventListener("mousedown",(function(){d=!0,h(),P()})),t.addEventListener("mouseup",(function(){d=!1,h(),P()}))}))}();const transition=function(){const e=[],t=20,o=600,n=70,i=1.3;let r;const a=90,s=800;let c,l,u,d,m,p,g,f,h,v,P,b,y,w,C,k=!1;function T(e,t,a){a||M({endCoords:movement.getBoardPos(),endScale:movement.getBoardScale(),isPanTel:!1}),C=t,d=movement.getBoardPos(),g=movement.getBoardScale(),m=e.endCoords,f=e.endScale,c=performance.now(),l=f<g,u=!1,l?(b=[0,0],y=math.convertCoordToWorldSpace(d,m,f)):(b=math.convertCoordToWorldSpace(m),y=[0,0]);const s=y[0]-b[0],p=y[1]-b[1];w=[s,p],h=Math.log(g),v=Math.log(f),P=v-h;const T=perspective.getEnabled()?i:1;r=o*T+Math.abs(P)*n*T,k=!0,movement.eraseMomentum()}function S(e,t,o,n=s){o||M({isPanTel:!0,endCoords:movement.getBoardPos()}),c=performance.now(),d=e,m=t;const i=movement.getBoardScale();g=i,f=i;const a=m[0]-d[0],l=m[1]-d[1];p=[a,l],r=n,k=!0,u=!0,movement.eraseMomentum()}function M(o){e.push(o),e.length>t&&e.shift()}return Object.freeze({areWeTeleporting:function(){return k},teleport:T,update:function(){if(!k)return;main.renderThisFrame();const e=performance.now()-c;if(e>=r)return movement.setBoardPos(m,"pidough"),movement.setBoardScale(f,"pidough"),void(C?T(C,void 0,!0):k=!1);let t=e/r;const o=-.5*Math.cos(Math.PI*t)+.5;u?function(e,t){const o=a/movement.getBoardScale();let n,i;if(Math.abs(p[0])>o||Math.abs(p[1])>o){const r=e<.5,a=r?1:-1,s=r?t:1-t;let c=p[0];const l=o/Math.abs(c);let u=p[1];const g=o/Math.abs(u);let f=l<g?l:g;c*=f,u*=f;const h=r?d:m,v=c*s*a,P=u*s*a;n=h[0]+v,i=h[1]+P}else{const e=(m[0]-d[0])*t,o=(m[1]-d[1])*t;n=d[0]+e,i=d[1]+o}movement.setBoardPos([n,i],"pidough")}(t,o):function(e){const t=h+P*e,o=Math.pow(Math.E,t);movement.setBoardScale(o,"pidough");const n=l?d:m,i=b[0]+w[0]*e,r=b[1]+w[1]*e,a=movement.getBoardScale(),s=n[0]-i/a,c=n[1]-r/a;movement.setBoardPos([s,c],"pidough")}(o)},telToPrevTel:function(){const t=e.pop();if(t)if(t.isPanTel)S(movement.getBoardPos(),t.endCoords,!0);else{const e={coords:t.endCoords,scale:t.endScale,boundingBox:math.getBoundingBoxOfBoard(t.endCoords,t.endScale,camera.getScreenBoundingBox())};area.initTelFromArea(e,!0)}},eraseTelHist:function(){e.length=0},panTel:S})}(),validation=function(){let e,t,o,n=!1,i=!0;const r=document.getElementById("loginlink"),a=document.getElementById("logintext"),s=document.getElementById("createaccountlink"),c=document.getElementById("createaccounttext");function l(){n=!0;let r=!1;fetch("/refresh").then((e=>(e.ok&&(r=!0),e.json()))).then((a=>{r?(e=d("token"),e?console.log("Logged in"):console.error("Response from the server did not include a token!"),o=a.member,u()):(console.log(`Server: ${a.message}`),i=!1),t=Date.now(),n=!1})).catch((e=>{console.error("Error occurred during refreshing of token:",e),t=Date.now(),n=!1}))}function u(){i?(r.setAttribute("href",`/member/${o.toLowerCase()}`),a.textContent="Profile",s.setAttribute("href","/logout"),c.textContent="Log Out"):(r.setAttribute("href","/login"),a.textContent="Log In",s.setAttribute("href","/createaccount"),c.textContent="Create Account")}function d(e){const t=document.cookie.split("; ");for(let o=0;o<t.length;o++){const n=t[o].split("=");if(n[0]===e)return n[1]}}return l(),Object.freeze({getAccessToken:async function(){for(;n;)await main.sleep(100);const o=Date.now()-t;return e&&o>89e4&&(e=void 0),(!e&&i||!i&&o>6012e5)&&await l(),e},getMember:function(){return o},getAllCookies:function(){return document.cookie},getCookieValue:d,deleteToken:function(){e=void 0,o=void 0,t=void 0,i=!1,document.cookie="token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",u()},areWeLoggedIn:function(){return i},waitUntilInitialRequestBack:async function(){for(;null==t;)await main.sleep(100)}})}(),variant=function(){const e=["Classical","Core","Standarch","Space Classic","CoaIP","Pawn Horde","Space","Obstocean","Abundance","Amazon Chandelier","Containment","Classical - Limit 7","CoaIP - Limit 7","Chess","Classical - KOTH","CoaIP - KOTH","Omega","Omega^2","Omega^3","Omega^4","Classical+","Pawndard","Knightline","Knighted Chess"],t=["Omega","Omega^2","Omega^3","Omega^4"];function o(e={}){const t=e.promotionRanks||(null===e.promotionRanks?null:[8,1]),o={promotionRanks:t,promotionsAllowed:e.promotionsAllowed||s(e.position,t),winConditions:e.winConditions||{white:["checkmate"],black:["checkmate"]},moveRule:e.moveRule||100};return null!=e.slideLimit&&(o.slideLimit=e.slideLimit),null===e.moveRule&&delete o.moveRule,o}function n(){return{white:["checkmate"],black:["checkmate"]}}function i({Variant:e,Date:t}){let o,n;switch(e){case"Classical":case"Classical - Limit 7":case"Classical - KOTH":return o="P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|R1,1+|R8,1+|r1,8+|r8,8+|N2,1|N7,1|n2,8|n7,8|B3,1|B6,1|b3,8|b6,8|Q4,1|q4,8|K5,1+|k5,8+",r({positionString:o});case"Core":return o="p-1,10+|p3,10+|p4,10+|p5,10+|p6,10+|p10,10+|p0,9+|p9,9+|n0,8|r1,8+|n2,8|b3,8|q4,8|k5,8+|b6,8|n7,8|r8,8+|n9,8|p-2,7+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p11,7+|p-3,6+|p12,6+|p1,5+|P2,5+|P7,5+|p8,5+|P1,4+|p2,4+|p7,4+|P8,4+|P-3,3+|P12,3+|P-2,2+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P11,2+|N0,1|R1,1+|N2,1|B3,1|Q4,1|K5,1+|B6,1|N7,1|R8,1+|N9,1|P0,0+|P9,0+|P-1,-1+|P3,-1+|P4,-1+|P5,-1+|P6,-1+|P10,-1+",r({positionString:o});case"Standarch":case"Standarch - 3 Check":return o="p4,11+|p5,11+|p1,10+|p2,10+|p3,10+|p6,10+|p7,10+|p8,10+|p0,9+|ar4,9|ch5,9|p9,9+|p0,8+|r1,8+|n2,8|b3,8|q4,8|k5,8+|b6,8|n7,8|r8,8+|p9,8+|p0,7+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p9,7+|P0,2+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P9,2+|P0,1+|R1,1+|N2,1|B3,1|Q4,1|K5,1+|B6,1|N7,1|R8,1+|P9,1+|P0,0+|AR4,0|CH5,0|P9,0+|P1,-1+|P2,-1+|P3,-1+|P6,-1+|P7,-1+|P8,-1+|P4,-2+|P5,-2+",r({positionString:o});case"Space Classic":return o=function(e){const t=e?math.getUTCTimestamp(e):e.now();return t<17090172e5?"p-3,15+|q4,15|p11,15+|p-4,14+|b4,14|p12,14+|p-5,13+|r2,13|b4,13|r6,13|p13,13+|p3,5+|p4,5+|p5,5+|n3,4|k4,4|n5,4|p-6,3+|p1,3+|p2,3+|p3,3+|p4,3+|p5,3+|p6,3+|p7,3+|p-8,2+|p-7,2+|p15,2+|p16,2+|p-9,1+|p17,1+|P-9,0+|P17,0+|P-8,-1+|P-7,-1+|P15,-1+|P16,-1+|P1,-2+|P2,-2+|P3,-2+|P4,-2+|P5,-2+|P6,-2+|P7,-2+|P14,-2+|N3,-3|K4,-3|N5,-3|P3,-4+|P4,-4+|P5,-4+|P-5,-12+|R2,-12|B4,-12|R6,-12|P13,-12+|P-4,-13+|B4,-13|P12,-13+|P-3,-14+|Q4,-14|P11,-14+":"p-3,18+|r2,18|b4,18|b5,18|r7,18|p12,18+|p-4,17+|p13,17+|p-5,16+|p14,16+|p3,9+|p4,9+|p5,9+|p6,9+|n3,8|k4,8|q5,8|n6,8|p-6,7+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p-8,6+|p-7,6+|p16,6+|p17,6+|p-9,5+|p18,5+|P-9,4+|P18,4+|P-8,3+|P-7,3+|P16,3+|P17,3+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P15,2+|N3,1|K4,1|Q5,1|N6,1|P3,0+|P4,0+|P5,0+|P6,0+|P-5,-7+|P14,-7+|P-4,-8+|P13,-8+|P-3,-9+|R2,-9|B4,-9|B5,-9|R7,-9|P12,-9+"}(t),r({positionString:o});case"CoaIP":case"CoaIP - Limit 7":case"CoaIP - KOTH":case"CoaIP - 3 Check":return o="P-2,1+|P-1,2+|P0,2+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P9,2+|P10,2+|P11,1+|P-4,-6+|P-3,-5+|P-2,-4+|P-1,-5+|P0,-6+|P9,-6+|P10,-5+|P11,-4+|P12,-5+|P13,-6+|p-2,8+|p-1,7+|p0,7+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p9,7+|p10,7+|p11,8+|p-4,15+|p-3,14+|p-2,13+|p-1,14+|p0,15+|p9,15+|p10,14+|p11,13+|p12,14+|p13,15+|HA-2,-6|HA11,-6|ha-2,15|ha11,15|R-1,1|R10,1|r-1,8|r10,8|CH0,1|CH9,1|ch0,8|ch9,8|GU1,1+|GU8,1+|gu1,8+|gu8,8+|N2,1|N7,1|n2,8|n7,8|B3,1|B6,1|b3,8|b6,8|Q4,1|q4,8|K5,1+|k5,8+",r({positionString:o});case"Pawn Horde":return o="k5,2+|q4,2|r1,2+|n7,2|n2,2|r8,2+|b3,2|b6,2|P2,-1+|P3,-1+|P6,-1+|P7,-1+|P1,-2+|P2,-2+|P4,-2+|P5,-2+|P6,-2+|P7,-2+|P8,-2+|P1,-3+|P2,-3+|P4,-3+|P5,-3+|P6,-3+|P7,-3+|P8,-3+|P1,-4+|P2,-4+|P4,-4+|P5,-4+|P6,-4+|P7,-4+|P8,-4+|P1,-5+|P2,-5+|P4,-5+|P5,-5+|P6,-5+|P7,-5+|P8,-5+|P1,-6+|P2,-6+|P4,-6+|P5,-6+|P6,-6+|P7,-6+|P8,-6+|P3,-2+|P3,-3+|P3,-4+|P3,-5+|P3,-6+|P1,-7+|P2,-7+|P3,-7+|P4,-7+|P5,-7+|P6,-7+|P7,-7+|P8,-7+|P0,-6+|P0,-7+|P9,-6+|P9,-7+|p9,2+|p1,1+|p2,1+|p3,1+|p4,1+|p5,1+|p6,1+|p7,1+|p8,1+|p0,2+",r({positionString:o});case"Space":return o="q4,31|ch4,23|p-12,18+|b4,18|p20,18+|p-11,17+|ar-10,17|p0,17+|b4,17|p8,17+|ar18,17|p19,17+|p-11,16+|p-10,16+|p-1,16+|p9,16+|p18,16+|p19,16+|p-1,15+|r0,15|ha4,15|r8,15|p9,15+|p3,6+|p4,6+|p5,6+|p2,5+|k4,5|p6,5+|n1,4|ce4,4|n7,4|p-10,3+|p-1,3+|p0,3+|p2,3+|p3,3+|p4,3+|p5,3+|p6,3+|p8,3+|p9,3+|p-12,2+|p-11,2+|p19,2+|p20,2+|p-13,1+|p21,1+|P-13,0+|P21,0+|P-12,-1+|P-11,-1+|P19,-1+|P20,-1+|P-1,-2+|P0,-2+|P2,-2+|P3,-2+|P4,-2+|P5,-2+|P6,-2+|P8,-2+|P9,-2+|P18,-2+|N1,-3|CE4,-3|N7,-3|P2,-4+|K4,-4|P6,-4+|P3,-5+|P4,-5+|P5,-5+|P-1,-14+|R0,-14|HA4,-14|R8,-14|P9,-14+|P-11,-15+|P-10,-15+|P-1,-15+|P9,-15+|P18,-15+|P19,-15+|P-11,-16+|AR-10,-16|P0,-16+|B4,-16|P8,-16+|AR18,-16|P19,-16+|P-12,-17+|B4,-17|P20,-17+|CH4,-22|Q4,-30",r({positionString:o});case"Obstocean":return o="vo-8,14|vo-7,14|vo-6,14|vo-5,14|vo-4,14|vo-3,14|vo-2,14|vo-1,14|vo0,14|vo1,14|vo2,14|vo3,14|vo4,14|vo5,14|vo6,14|vo7,14|vo8,14|vo9,14|vo10,14|vo11,14|vo12,14|vo13,14|vo14,14|vo15,14|vo16,14|vo17,14|vo-8,13|vo-7,13|vo-6,13|vo-5,13|vo-4,13|vo-3,13|vo-2,13|vo-1,13|vo0,13|vo1,13|vo2,13|vo3,13|vo4,13|vo5,13|vo6,13|vo7,13|vo8,13|vo9,13|vo10,13|vo11,13|vo12,13|vo13,13|vo14,13|vo15,13|vo16,13|vo17,13|vo-8,12|vo-7,12|ob-6,12|ob-5,12|ob-4,12|ob-3,12|ob-2,12|ob-1,12|ob0,12|ob1,12|ob2,12|ob3,12|ob4,12|ob5,12|ob6,12|ob7,12|ob8,12|ob9,12|ob10,12|ob11,12|ob12,12|ob13,12|ob14,12|ob15,12|vo16,12|vo17,12|vo-8,11|vo-7,11|ob-6,11|ob-5,11|ob-4,11|ob-3,11|ob-2,11|ob-1,11|ob0,11|ob1,11|ob2,11|ob3,11|ob4,11|ob5,11|ob6,11|ob7,11|ob8,11|ob9,11|ob10,11|ob11,11|ob12,11|ob13,11|ob14,11|ob15,11|vo16,11|vo17,11|vo-8,10|vo-7,10|ob-6,10|ob-5,10|ob-4,10|ob-3,10|ob-2,10|ob-1,10|ob0,10|ob1,10|ob2,10|ob3,10|ob4,10|ob5,10|ob6,10|ob7,10|ob8,10|ob9,10|ob10,10|ob11,10|ob12,10|ob13,10|ob14,10|ob15,10|vo16,10|vo17,10|vo-8,9|vo-7,9|ob-6,9|ob-5,9|ob-4,9|ob-3,9|ob-2,9|ob-1,9|ob0,9|ob1,9|ob2,9|ob3,9|ob4,9|ob5,9|ob6,9|ob7,9|ob8,9|ob9,9|ob10,9|ob11,9|ob12,9|ob13,9|ob14,9|ob15,9|vo16,9|vo17,9|vo-8,8|vo-7,8|ob-6,8|ob-5,8|ob-4,8|ob-3,8|ob-2,8|ob-1,8|ob0,8|r1,8+|n2,8|b3,8|q4,8|k5,8+|b6,8|n7,8|r8,8+|ob9,8|ob10,8|ob11,8|ob12,8|ob13,8|ob14,8|ob15,8|vo16,8|vo17,8|vo-8,7|vo-7,7|ob-6,7|ob-5,7|ob-4,7|ob-3,7|ob-2,7|ob-1,7|ob0,7|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|ob9,7|ob10,7|ob11,7|ob12,7|ob13,7|ob14,7|ob15,7|vo16,7|vo17,7|vo-8,6|vo-7,6|ob-6,6|ob-5,6|ob-4,6|ob-3,6|ob-2,6|ob-1,6|ob0,6|ob1,6|ob2,6|ob3,6|ob4,6|ob5,6|ob6,6|ob7,6|ob8,6|ob9,6|ob10,6|ob11,6|ob12,6|ob13,6|ob14,6|ob15,6|vo16,6|vo17,6|vo-8,5|vo-7,5|ob-6,5|ob-5,5|ob-4,5|ob-3,5|ob-2,5|ob-1,5|ob0,5|ob1,5|ob2,5|ob3,5|ob4,5|ob5,5|ob6,5|ob7,5|ob8,5|ob9,5|ob10,5|ob11,5|ob12,5|ob13,5|ob14,5|ob15,5|vo16,5|vo17,5|vo-8,4|vo-7,4|ob-6,4|ob-5,4|ob-4,4|ob-3,4|ob-2,4|ob-1,4|ob0,4|ob1,4|ob2,4|ob3,4|ob4,4|ob5,4|ob6,4|ob7,4|ob8,4|ob9,4|ob10,4|ob11,4|ob12,4|ob13,4|ob14,4|ob15,4|vo16,4|vo17,4|vo-8,3|vo-7,3|ob-6,3|ob-5,3|ob-4,3|ob-3,3|ob-2,3|ob-1,3|ob0,3|ob1,3|ob2,3|ob3,3|ob4,3|ob5,3|ob6,3|ob7,3|ob8,3|ob9,3|ob10,3|ob11,3|ob12,3|ob13,3|ob14,3|ob15,3|vo16,3|vo17,3|vo-8,2|vo-7,2|ob-6,2|ob-5,2|ob-4,2|ob-3,2|ob-2,2|ob-1,2|ob0,2|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|ob9,2|ob10,2|ob11,2|ob12,2|ob13,2|ob14,2|ob15,2|vo16,2|vo17,2|vo-8,1|vo-7,1|ob-6,1|ob-5,1|ob-4,1|ob-3,1|ob-2,1|ob-1,1|ob0,1|R1,1+|N2,1|B3,1|Q4,1|K5,1+|B6,1|N7,1|R8,1+|ob9,1|ob10,1|ob11,1|ob12,1|ob13,1|ob14,1|ob15,1|vo16,1|vo17,1|vo-8,0|vo-7,0|ob-6,0|ob-5,0|ob-4,0|ob-3,0|ob-2,0|ob-1,0|ob0,0|ob1,0|ob2,0|ob3,0|ob4,0|ob5,0|ob6,0|ob7,0|ob8,0|ob9,0|ob10,0|ob11,0|ob12,0|ob13,0|ob14,0|ob15,0|vo16,0|vo17,0|vo-8,-1|vo-7,-1|ob-6,-1|ob-5,-1|ob-4,-1|ob-3,-1|ob-2,-1|ob-1,-1|ob0,-1|ob1,-1|ob2,-1|ob3,-1|ob4,-1|ob5,-1|ob6,-1|ob7,-1|ob8,-1|ob9,-1|ob10,-1|ob11,-1|ob12,-1|ob13,-1|ob14,-1|ob15,-1|vo16,-1|vo17,-1|vo-8,-2|vo-7,-2|ob-6,-2|ob-5,-2|ob-4,-2|ob-3,-2|ob-2,-2|ob-1,-2|ob0,-2|ob1,-2|ob2,-2|ob3,-2|ob4,-2|ob5,-2|ob6,-2|ob7,-2|ob8,-2|ob9,-2|ob10,-2|ob11,-2|ob12,-2|ob13,-2|ob14,-2|ob15,-2|vo16,-2|vo17,-2|vo-8,-3|vo-7,-3|ob-6,-3|ob-5,-3|ob-4,-3|ob-3,-3|ob-2,-3|ob-1,-3|ob0,-3|ob1,-3|ob2,-3|ob3,-3|ob4,-3|ob5,-3|ob6,-3|ob7,-3|ob8,-3|ob9,-3|ob10,-3|ob11,-3|ob12,-3|ob13,-3|ob14,-3|ob15,-3|vo16,-3|vo17,-3|vo-8,-4|vo-7,-4|vo-6,-4|vo-5,-4|vo-4,-4|vo-3,-4|vo-2,-4|vo-1,-4|vo0,-4|vo1,-4|vo2,-4|vo3,-4|vo4,-4|vo5,-4|vo6,-4|vo7,-4|vo8,-4|vo9,-4|vo10,-4|vo11,-4|vo12,-4|vo13,-4|vo14,-4|vo15,-4|vo16,-4|vo17,-4|vo-8,-5|vo-7,-5|vo-6,-5|vo-5,-5|vo-4,-5|vo-3,-5|vo-2,-5|vo-1,-5|vo0,-5|vo1,-5|vo2,-5|vo3,-5|vo4,-5|vo5,-5|vo6,-5|vo7,-5|vo8,-5|vo9,-5|vo10,-5|vo11,-5|vo12,-5|vo13,-5|vo14,-5|vo15,-5|vo16,-5|vo17,-5",r({positionString:o});case"Abundance":return o="p-3,10+|ha-2,10|ha-1,10|r0,10|ha1,10|ha2,10|p3,10+|p-2,9+|p-1,9+|p1,9+|p2,9+|p-5,6+|gu-4,6|r-3,6+|b-2,6|b-1,6|k0,6+|b1,6|b2,6|r3,6+|gu4,6|p5,6+|p-4,5+|gu-3,5|n-1,5|q0,5|n1,5|gu3,5|p4,5+|p-3,4+|p-2,4+|gu-1,4|ch0,4|gu1,4|p2,4+|p3,4+|p-1,3+|p0,3+|p1,3+|P-1,-3+|P0,-3+|P1,-3+|P-3,-4+|P-2,-4+|GU-1,-4|CH0,-4|GU1,-4|P2,-4+|P3,-4+|P-4,-5+|GU-3,-5|N-1,-5|Q0,-5|N1,-5|GU3,-5|P4,-5+|P-5,-6+|GU-4,-6|R-3,-6+|B-2,-6|B-1,-6|K0,-6+|B1,-6|B2,-6|R3,-6+|GU4,-6|P5,-6+|P-2,-9+|P-1,-9+|P1,-9+|P2,-9+|P-3,-10+|HA-2,-10|HA-1,-10|R0,-10|HA1,-10|HA2,-10|P3,-10+",r({positionString:o});case"Amazon Chandelier":return o="p-1,26+|p1,26+|p-2,25+|p-1,25+|p0,25+|p1,25+|p2,25+|p-2,24+|p-1,24+|am0,24|p1,24+|p2,24+|p-2,23+|p-1,23+|p0,23+|p1,23+|p2,23+|p-2,22+|p-1,22+|p1,22+|p2,22+|p-5,21+|p-4,21+|p-3,21+|p-2,21+|p-1,21+|p1,21+|p2,21+|p3,21+|p4,21+|p5,21+|p-5,20+|q-4,20|p-3,20+|p-2,20+|p-1,20+|p1,20+|p2,20+|p3,20+|q4,20|p5,20+|p-5,19+|p-4,19+|p-3,19+|p-2,19+|p-1,19+|p1,19+|p2,19+|p3,19+|p4,19+|p5,19+|p-5,18+|p-3,18+|p-2,18+|p-1,18+|p1,18+|p2,18+|p3,18+|p5,18+|p-8,17+|p-5,17+|p-3,17+|p-2,17+|p-1,17+|p1,17+|p2,17+|p3,17+|p5,17+|p8,17+|p-11,16+|p-10,16+|gu-9,16|ha-8,16|p-7,16+|gu-6,16|p-5,16+|p-3,16+|p-2,16+|p-1,16+|p1,16+|p2,16+|p3,16+|p5,16+|gu6,16|p7,16+|ha8,16|gu9,16|p10,16+|p11,16+|p-11,15+|r-10,15|p-9,15+|p-8,15+|r-7,15|p-6,15+|p-5,15+|p-3,15+|p-2,15+|p-1,15+|p1,15+|p2,15+|p3,15+|p5,15+|p6,15+|r7,15|p8,15+|p9,15+|r10,15|p11,15+|gu-12,14|p-11,14+|p-10,14+|p-9,14+|p-8,14+|p-7,14+|p-6,14+|p-5,14+|p-3,14+|p-2,14+|p-1,14+|p1,14+|p2,14+|p3,14+|p5,14+|p6,14+|p7,14+|p8,14+|p9,14+|p10,14+|p11,14+|gu12,14|p-19,13+|p-17,13+|gu-16,13|p-14,13+|p-12,13+|p-11,13+|p-9,13+|p-8,13+|p-6,13+|p-5,13+|p-3,13+|p-2,13+|p-1,13+|p1,13+|p2,13+|p3,13+|p5,13+|p6,13+|p8,13+|p9,13+|p11,13+|p12,13+|p14,13+|gu16,13|p17,13+|p19,13+|p-19,12+|b-18,12|p-17,12+|gu-16,12|p-14,12+|b-13,12|p-12,12+|p-11,12+|p-9,12+|p-8,12+|p-6,12+|p-5,12+|p-3,12+|p-2,12+|p-1,12+|p1,12+|p2,12+|p3,12+|p5,12+|p6,12+|p8,12+|p9,12+|p11,12+|p12,12+|b13,12|p14,12+|gu16,12|p17,12+|b18,12|p19,12+|gu-20,11|p-19,11+|p-17,11+|p-14,11+|p-12,11+|p-11,11+|p-9,11+|p-8,11+|p-6,11+|p-5,11+|p-3,11+|p-2,11+|p-1,11+|p1,11+|p2,11+|p3,11+|p5,11+|p6,11+|p8,11+|p9,11+|p11,11+|p12,11+|p14,11+|p17,11+|p19,11+|gu20,11|ha-20,10|p-19,10+|p-17,10+|p-14,10+|p-12,10+|p-11,10+|p-9,10+|p-8,10+|p-6,10+|p-5,10+|p-3,10+|p-2,10+|p-1,10+|p1,10+|p2,10+|p3,10+|p5,10+|p6,10+|p8,10+|p9,10+|p11,10+|p12,10+|p14,10+|p17,10+|p19,10+|ha20,10|n-11,9|n11,9|n-10,7|gu-5,7|gu-4,7|gu4,7|gu5,7|n10,7|n-8,6|n8,6|n-6,5|n6,5|n-4,4|k0,4|n4,4|n-2,3|n2,3|n0,2|N0,-1|N-2,-2|N2,-2|N-4,-3|K0,-3|N4,-3|N-6,-4|N6,-4|N-8,-5|N8,-5|N-10,-6|GU-5,-6|GU-4,-6|GU4,-6|GU5,-6|N10,-6|N-11,-8|N11,-8|HA-20,-9|P-19,-9+|P-17,-9+|P-14,-9+|P-12,-9+|P-11,-9+|P-9,-9+|P-8,-9+|P-6,-9+|P-5,-9+|P-3,-9+|P-2,-9+|P-1,-9+|P1,-9+|P2,-9+|P3,-9+|P5,-9+|P6,-9+|P8,-9+|P9,-9+|P11,-9+|P12,-9+|P14,-9+|P17,-9+|P19,-9+|HA20,-9|GU-20,-10|P-19,-10+|P-17,-10+|P-14,-10+|P-12,-10+|P-11,-10+|P-9,-10+|P-8,-10+|P-6,-10+|P-5,-10+|P-3,-10+|P-2,-10+|P-1,-10+|P1,-10+|P2,-10+|P3,-10+|P5,-10+|P6,-10+|P8,-10+|P9,-10+|P11,-10+|P12,-10+|P14,-10+|P17,-10+|P19,-10+|GU20,-10|P-19,-11+|B-18,-11|P-17,-11+|GU-16,-11|P-14,-11+|B-13,-11|P-12,-11+|P-11,-11+|P-9,-11+|P-8,-11+|P-6,-11+|P-5,-11+|P-3,-11+|P-2,-11+|P-1,-11+|P1,-11+|P2,-11+|P3,-11+|P5,-11+|P6,-11+|P8,-11+|P9,-11+|P11,-11+|P12,-11+|B13,-11|P14,-11+|GU16,-11|P17,-11+|B18,-11|P19,-11+|P-19,-12+|P-17,-12+|GU-16,-12|P-14,-12+|P-12,-12+|P-11,-12+|P-9,-12+|P-8,-12+|P-6,-12+|P-5,-12+|P-3,-12+|P-2,-12+|P-1,-12+|P1,-12+|P2,-12+|P3,-12+|P5,-12+|P6,-12+|P8,-12+|P9,-12+|P11,-12+|P12,-12+|P14,-12+|GU16,-12|P17,-12+|P19,-12+|GU-12,-13|P-11,-13+|P-10,-13+|P-9,-13+|P-8,-13+|P-7,-13+|P-6,-13+|P-5,-13+|P-3,-13+|P-2,-13+|P-1,-13+|P1,-13+|P2,-13+|P3,-13+|P5,-13+|P6,-13+|P7,-13+|P8,-13+|P9,-13+|P10,-13+|P11,-13+|GU12,-13|P-11,-14+|R-10,-14|P-9,-14+|P-8,-14+|R-7,-14|P-6,-14+|P-5,-14+|P-3,-14+|P-2,-14+|P-1,-14+|P1,-14+|P2,-14+|P3,-14+|P5,-14+|P6,-14+|R7,-14|P8,-14+|P9,-14+|R10,-14|P11,-14+|P-11,-15+|P-10,-15+|GU-9,-15|HA-8,-15|P-7,-15+|GU-6,-15|P-5,-15+|P-3,-15+|P-2,-15+|P-1,-15+|P1,-15+|P2,-15+|P3,-15+|P5,-15+|GU6,-15|P7,-15+|HA8,-15|GU9,-15|P10,-15+|P11,-15+|P-8,-16+|P-5,-16+|P-3,-16+|P-2,-16+|P-1,-16+|P1,-16+|P2,-16+|P3,-16+|P5,-16+|P8,-16+|P-5,-17+|P-3,-17+|P-2,-17+|P-1,-17+|P1,-17+|P2,-17+|P3,-17+|P5,-17+|P-5,-18+|P-4,-18+|P-3,-18+|P-2,-18+|P-1,-18+|P1,-18+|P2,-18+|P3,-18+|P4,-18+|P5,-18+|P-5,-19+|Q-4,-19|P-3,-19+|P-2,-19+|P-1,-19+|P1,-19+|P2,-19+|P3,-19+|Q4,-19|P5,-19+|P-5,-20+|P-4,-20+|P-3,-20+|P-2,-20+|P-1,-20+|P1,-20+|P2,-20+|P3,-20+|P4,-20+|P5,-20+|P-2,-21+|P-1,-21+|P1,-21+|P2,-21+|P-2,-22+|P-1,-22+|P0,-22+|P1,-22+|P2,-22+|P-2,-23+|P-1,-23+|AM0,-23|P1,-23+|P2,-23+|P-2,-24+|P-1,-24+|P0,-24+|P1,-24+|P2,-24+|P-1,-25+|P1,-25+",r({positionString:o});case"Containment":return o="K5,-5|k5,14|Q4,-5|q4,14|HA1,-6|HA8,-6|ha1,15|ha8,15|CH-6,-6|CH15,-6|ch-6,15|ch15,15|AR-6,-5|AR15,-5|ar-6,14|ar15,14|N-1,0|N1,0|N2,0|N4,-1|N5,-1|N7,0|N8,0|N10,0|n-1,9|n1,9|n2,9|n4,10|n5,10|n7,9|n8,9|n10,9|GU-2,-2|GU1,-3|GU3,-4|GU6,-4|GU8,-3|GU11,-2|gu-2,11|gu1,12|gu3,13|gu6,13|gu8,12|gu11,11|R-5,-6|R-5,-5|R-4,-5|R-4,-6|R13,-6|R13,-5|R14,-5|R14,-6|r-5,15|r-5,14|r-4,14|r-4,15|r13,15|r13,14|r14,14|r14,15|B-5,-2|B-4,-3|B-3,-2|B12,-2|B13,-3|B14,-2|b-5,11|b-4,12|b-3,11|b12,11|b13,12|b14,11|P-9,-8+|P-9,-6+|P-9,-4+|P-9,-2+|P-9,0+|P-9,2+|P-9,4+|P-9,6+|P-9,8+|P-9,10+|P-9,12+|P-9,14+|P-9,16+|P-8,-7+|P-8,-5+|P-8,-3+|P-8,-1+|P-8,1+|P-8,3+|P-8,5+|P-8,7+|P-8,9+|P-8,11+|P-8,13+|P-8,15+|P-8,17+|P17,-8+|P17,-6+|P17,-4+|P17,-2+|P17,0+|P17,2+|P17,4+|P17,6+|P17,8+|P17,10+|P17,12+|P17,14+|P17,16+|P18,-7+|P18,-5+|P18,-3+|P18,-1+|P18,1+|P18,3+|P18,5+|P18,7+|P18,9+|P18,11+|P18,13+|P18,15+|P18,17+|P-7,-8+|P-5,-8+|P-3,-8+|P-1,-8+|P1,-8+|P3,-8+|P5,-8+|P7,-8+|P9,-8+|P11,-8+|P13,-8+|P15,-8+|P-6,-7+|P-4,-7+|P-2,-7+|P0,-7+|P2,-7+|P4,-7+|P6,-7+|P8,-7+|P10,-7+|P12,-7+|P14,-7+|P16,-7+|P-7,16+|P-5,16+|P-3,16+|P-1,16+|P1,16+|P3,16+|P5,16+|P7,16+|P9,16+|P11,16+|P13,16+|P15,16+|P-6,17+|P-4,17+|P-2,17+|P0,17+|P2,17+|P4,17+|P6,17+|P8,17+|P10,17+|P12,17+|P14,17+|P16,17+|P-7,-6+|P-7,-4+|P-7,-2+|P-6,-2+|P-6,-1+|P-5,-1+|P-5,0+|P-5,-4+|P-4,-4+|P-4,-2+|P-4,-1+|P-3,-6+|P-3,-5+|P-3,-1+|P-3,0+|P-2,0+|P-2,1+|P-1,1+|P-1,-4+|P0,-3+|P1,-2+|P0,-1+|P0,1+|P1,1+|P2,1+|P3,1+|P3,0+|P3,-3+|P3,-5+|P4,-4+|P4,1+|P5,1+|P5,-4+|P6,-5+|P6,-3+|P6,0+|P6,1+|P7,1+|P8,1+|P9,1+|P9,-1+|P8,-2+|P9,-3+|P10,-4+|P10,1+|P11,1+|P11,0+|P12,0+|P12,-1+|P12,-5+|P12,-6+|P13,-4+|P13,-2+|P13,-1+|P14,0+|P14,-1+|P14,-4+|P15,-2+|P15,-1+|P16,-1+|P16,-3+|P16,-5+|p-9,-7+|p-9,-5+|p-9,-3+|p-9,-1+|p-9,1+|p-9,3+|p-9,5+|p-9,7+|p-9,9+|p-9,11+|p-9,13+|p-9,15+|p-9,17+|p-8,-8+|p-8,-6+|p-8,-4+|p-8,-2+|p-8,0+|p-8,2+|p-8,4+|p-8,6+|p-8,8+|p-8,10+|p-8,12+|p-8,14+|p-8,16+|p17,-7+|p17,-5+|p17,-3+|p17,-1+|p17,1+|p17,3+|p17,5+|p17,7+|p17,9+|p17,11+|p17,13+|p17,15+|p17,17+|p18,-8+|p18,-6+|p18,-4+|p18,-2+|p18,0+|p18,2+|p18,4+|p18,6+|p18,8+|p18,10+|p18,12+|p18,14+|p18,16+|p-6,-8+|p-4,-8+|p-2,-8+|p0,-8+|p2,-8+|p4,-8+|p6,-8+|p8,-8+|p10,-8+|p12,-8+|p14,-8+|p16,-8+|p-7,-7+|p-5,-7+|p-3,-7+|p-1,-7+|p1,-7+|p3,-7+|p5,-7+|p7,-7+|p9,-7+|p11,-7+|p13,-7+|p15,-7+|p-6,16+|p-4,16+|p-2,16+|p0,16+|p2,16+|p4,16+|p6,16+|p8,16+|p10,16+|p12,16+|p14,16+|p16,16+|p-7,17+|p-5,17+|p-3,17+|p-1,17+|p1,17+|p3,17+|p5,17+|p7,17+|p9,17+|p11,17+|p13,17+|p15,17+|p-7,15+|p-7,13+|p-7,11+|p-6,11+|p-6,10+|p-5,10+|p-5,9+|p-5,13+|p-4,13+|p-4,11+|p-4,10+|p-3,15+|p-3,14+|p-3,10+|p-3,9+|p-2,9+|p-2,8+|p-1,8+|p-1,13+|p0,12+|p1,11+|p0,10+|p0,8+|p1,8+|p2,8+|p3,8+|p3,9+|p3,12+|p3,14+|p4,13+|p4,8+|p5,8+|p5,13+|p6,14+|p6,12+|p6,9+|p6,8+|p7,8+|p8,8+|p9,8+|p9,10+|p8,11+|p9,12+|p10,13+|p10,8+|p11,8+|p11,9+|p12,9+|p12,10+|p12,14+|p12,15+|p13,13+|p13,11+|p13,10+|p14,9+|p14,10+|p14,13+|p15,11+|p15,10+|p16,10+|p16,12+|p16,14+",r({positionString:o});case"Chess":return o="vo-1,10|vo0,10|vo1,10|vo2,10|vo3,10|vo4,10|vo5,10|vo6,10|vo7,10|vo8,10|vo9,10|vo10,10|vo-1,9|vo0,9|vo1,9|vo2,9|vo3,9|vo4,9|vo5,9|vo6,9|vo7,9|vo8,9|vo9,9|vo10,9|vo-1,8|vo0,8|r1,8+|n2,8|b3,8|q4,8|k5,8+|b6,8|n7,8|r8,8+|vo9,8|vo10,8|vo-1,7|vo0,7|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|vo9,7|vo10,7|vo-1,6|vo0,6|vo9,6|vo10,6|vo-1,5|vo0,5|vo9,5|vo10,5|vo-1,4|vo0,4|vo9,4|vo10,4|vo-1,3|vo0,3|vo9,3|vo10,3|vo-1,2|vo0,2|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|vo9,2|vo10,2|vo-1,1|vo0,1|R1,1+|N2,1|B3,1|Q4,1|K5,1+|B6,1|N7,1|R8,1+|vo9,1|vo10,1|vo-1,0|vo0,0|vo1,0|vo2,0|vo3,0|vo4,0|vo5,0|vo6,0|vo7,0|vo8,0|vo9,0|vo10,0|vo-1,-1|vo0,-1|vo1,-1|vo2,-1|vo3,-1|vo4,-1|vo5,-1|vo6,-1|vo7,-1|vo8,-1|vo9,-1|vo10,-1",r({positionString:o});case"Classical+":return o="p1,9+|p2,9+|p3,9+|p6,9+|p7,9+|p8,9+|p0,8+|r1,8+|n2,8|b3,8|q4,8|k5,8+|b6,8|n7,8|r8,8+|p9,8+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p3,5+|p6,5+|P3,4+|P6,4+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P0,1+|R1,1+|N2,1|B3,1|Q4,1|K5,1+|B6,1|N7,1|R8,1+|P9,1+|P1,0+|P2,0+|P3,0+|P6,0+|P7,0+|P8,0+",r({positionString:o});case"Pawndard":return o="b4,14|b5,14|r4,12|r5,12|p2,10+|p3,10+|p6,10+|p7,10+|p1,9+|p8,9+|p0,8+|n2,8|n3,8|k4,8+|q5,8|n6,8|n7,8|p9,8+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|P1,5+|p2,5+|P3,5+|p6,5+|P7,5+|p8,5+|p1,4+|P2,4+|p3,4+|P6,4+|p7,4+|P8,4+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P0,1+|N2,1|N3,1|Q4,1|K5,1+|N6,1|N7,1|P9,1+|P1,0+|P8,0+|P2,-1+|P3,-1+|P6,-1+|P7,-1+|R4,-3|R5,-3|B4,-5|B5,-5",r({positionString:o});case"Knightline":return o="k5,8+|n3,8|n4,8|n6,8|n7,8|p-5,7+|p-4,7+|p-3,7+|p-2,7+|p-1,7+|p0,7+|p1,7+|p2,7+|p3,7+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p9,7+|p10,7+|p11,7+|p12,7+|p13,7+|p14,7+|p15,7+|K5,1+|N3,1|N4,1|N6,1|N7,1|P-5,2+|P-4,2+|P-3,2+|P-2,2+|P-1,2+|P0,2+|P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|P9,2+|P10,2+|P11,2+|P12,2+|P13,2+|P14,2+|P15,2+",r({positionString:o});case"Knighted Chess":return o="P1,2+|P2,2+|P3,2+|P4,2+|P5,2+|P6,2+|P7,2+|P8,2+|p1,7+|p2,7+|p3,7+|P0,1+|P1,0+|P2,0+|P3,0+|P6,0+|P7,0+|P8,0+|P9,1+|p4,7+|p5,7+|p6,7+|p7,7+|p8,7+|p0,8+|p1,9+|p2,9+|p3,9+|p6,9+|p7,9+|p8,9+|p9,8+|CH1,1+|CH8,1+|ch1,8+|ch8,8+|N2,1|N7,1|n2,8|n7,8|AR3,1|AR6,1|ar3,8|ar6,8|AM4,1|am4,8|RC5,1+|rc5,8+",r({positionString:o});case"Omega":return o="r-2,4|r2,4|r-2,2|r2,2|r-2,0|r0,0|r2,0|k0,-1|R1,-2|P-2,-3|Q-1,-3|P2,-3|K0,-4",r({positionString:o});case"Omega^2":return o="K51,94|k46,80|Q30,148|Q32,148|Q29,3|q29,148|q24,98|q24,97|q24,92|q24,91|q24,86|q24,85|q24,80|q24,79|q46,78|q45,77|q46,77|q45,76|q46,76|q78,60|N15,84|n63,64|r53,96|r45,81|r46,81|r46,79|r47,79|r45,78|B27,152|B29,152|B27,151|B28,151|B30,151|B32,151|B27,150|B28,150|B29,150|B30,150|B31,150|B32,150|B32,149|B9,96|B11,96|B15,96|B20,96|B47,87|B43,86|B44,82|B50,82|B51,81|B8,79|B10,79|B8,78|B10,78|B14,78|B19,78|B49,77|B41,72|B43,72|B45,72|B47,72|B49,72|B51,72|B53,72|B68,72|B10,71|B14,71|B18,71|B20,71|B22,71|B24,71|B76,55|B78,55|B80,55|B82,55|B84,55|B27,20|B29,20|B29,4|b27,155|b29,155|b31,155|b32,154|b9,99|b11,99|b15,99|b20,97|b33,97|b24,96|b11,92|b13,92|b15,92|b19,92|b47,91|b48,91|b49,91|b50,91|b51,91|b24,90|b47,90|b49,90|b51,90|b48,89|b50,89|b51,89|b47,88|b49,88|b51,88|b37,87|b48,87|b50,87|b51,87|b19,86|b49,86|b51,86|b48,85|b50,85|b24,84|b49,84|b51,84|b9,83|b48,83|b50,83|b51,82|b18,80|b14,79|b24,78|b52,77|b53,77|b47,76|b49,76|b51,76|b52,76|b53,76|b66,76|b70,76|b45,75|b47,75|b49,75|b51,75|b53,75|b10,74|b14,74|b18,74|b20,74|b22,74|b24,74|b58,74|b75,71|b78,58|b80,58|b82,58|b84,58|b27,23|b29,23|P26,155|P28,155|P30,155|P32,155|P27,154|P29,154|P31,154|P33,154|P26,153|P28,153|P30,153|P32,153|P26,152|P28,152|P31,152|P33,152|P26,151|P29,151|P31,151|P33,151|P26,150|P33,150|P26,149|P27,149|P28,149|P29,149|P30,149|P31,149|P33,149|P31,148|P33,148|P26,147|P28,147|P30,147|P31,147|P32,147|P33,147|P15,146|P27,146|P29,146|P28,145|P25,111|P24,110|P23,109|P22,108|P21,107|P25,107|P20,106|P24,106|P19,105|P23,105|P20,104|P19,103|P25,103|P20,102|P24,102|P19,101|P23,101|P20,100|P4,99|P6,99|P8,99|P10,99|P12,99|P14,99|P16,99|P19,99|P3,98|P5,98|P7,98|P9,98|P11,98|P15,98|P20,98|P4,97|P6,97|P8,97|P10,97|P12,97|P14,97|P16,97|P19,97|P21,97|P32,97|P34,97|P3,96|P5,96|P8,96|P10,96|P12,96|P33,96|P35,96|P4,95|P6,95|P8,95|P9,95|P10,95|P11,95|P12,95|P14,95|P16,95|P19,95|P21,95|P32,95|P34,95|P36,95|P23,94|P33,94|P35,94|P37,94|P8,93|P9,93|P34,93|P36,93|P38,93|P4,92|P6,92|P8,92|P10,92|P12,92|P14,92|P16,92|P18,92|P20,92|P35,92|P37,92|P39,92|P3,91|P5,91|P7,91|P9,91|P11,91|P13,91|P15,91|P19,91|P21,91|P36,91|P38,91|P40,91|P4,90|P6,90|P8,90|P10,90|P12,90|P14,90|P16,90|P18,90|P20,90|P35,90|P39,90|P41,90|P3,89|P5,89|P7,89|P9,89|P11,89|P13,89|P15,89|P19,89|P21,89|P34,89|P40,89|P42,89|P4,88|P6,88|P8,88|P10,88|P12,88|P14,88|P16,88|P23,88|P33,88|P37,88|P41,88|P43,88|P46,88|P48,88|P3,87|P5,87|P7,87|P9,87|P11,87|P13,87|P15,87|P32,87|P36,87|P38,87|P42,87|P44,87|P4,86|P6,86|P8,86|P10,86|P12,86|P14,86|P18,86|P20,86|P31,86|P35,86|P37,86|P39,86|P42,86|P44,86|P46,86|P48,86|P3,85|P5,85|P7,85|P9,85|P11,85|P13,85|P15,85|P17,85|P19,85|P21,85|P32,85|P36,85|P38,85|P40,85|P42,85|P43,85|P44,85|P3,84|P5,84|P7,84|P9,84|P11,84|P13,84|P18,84|P20,84|P33,84|P37,84|P39,84|P42,84|P43,84|P44,84|P52,84|P4,83|P6,83|P8,83|P10,83|P12,83|P14,83|P16,83|P19,83|P21,83|P34,83|P38,83|P40,83|P42,83|P43,83|P44,83|P49,83|P51,83|P3,82|P5,82|P7,82|P9,82|P11,82|P13,82|P15,82|P23,82|P31,82|P35,82|P39,82|P42,82|P43,82|P52,82|P2,81|P4,81|P6,81|P8,81|P10,81|P12,81|P14,81|P32,81|P38,81|P40,81|P42,81|P43,81|P44,81|P49,81|P3,80|P5,80|P7,80|P9,80|P11,80|P17,80|P19,80|P21,80|P31,80|P33,80|P37,80|P39,80|P50,80|P52,80|P2,79|P4,79|P7,79|P9,79|P11,79|P13,79|P15,79|P18,79|P20,79|P32,79|P34,79|P36,79|P38,79|P40,79|P44,79|P3,78|P5,78|P7,78|P9,78|P11,78|P17,78|P21,78|P33,78|P35,78|P37,78|P39,78|P41,78|P43,78|P2,77|P4,77|P7,77|P8,77|P9,77|P10,77|P11,77|P13,77|P15,77|P18,77|P20,77|P34,77|P36,77|P38,77|P40,77|P42,77|P23,76|P35,76|P37,76|P39,76|P41,76|P65,76|P67,76|P69,76|P71,76|P7,75|P8,75|P36,75|P38,75|P40,75|P42,75|P64,75|P66,75|P70,75|P3,74|P5,74|P7,74|P9,74|P11,74|P13,74|P15,74|P17,74|P19,74|P21,74|P23,74|P25,74|P37,74|P39,74|P41,74|P57,74|P59,74|P63,74|P65,74|P67,74|P69,74|P71,74|P2,73|P4,73|P6,73|P8,73|P10,73|P14,73|P18,73|P20,73|P22,73|P24,73|P38,73|P40,73|P42,73|P44,73|P46,73|P48,73|P50,73|P52,73|P54,73|P58,73|P62,73|P64,73|P66,73|P70,73|P72,73|P3,72|P5,72|P7,72|P9,72|P11,72|P13,72|P15,72|P17,72|P19,72|P21,72|P23,72|P25,72|P39,72|P57,72|P59,72|P61,72|P63,72|P65,72|P71,72|P2,71|P4,71|P6,71|P8,71|P40,71|P42,71|P44,71|P46,71|P48,71|P50,71|P52,71|P54,71|P58,71|P62,71|P64,71|P66,71|P70,71|P72,71|P74,71|P76,71|P3,70|P5,70|P7,70|P9,70|P11,70|P13,70|P15,70|P17,70|P19,70|P21,70|P23,70|P25,70|P57,70|P59,70|P61,70|P63,70|P65,70|P71,70|P75,70|P77,70|P56,69|P58,69|P62,69|P64,69|P72,69|P74,69|P76,69|P78,69|P57,68|P59,68|P61,68|P63,68|P67,68|P69,68|P75,68|P77,68|P79,68|P56,67|P58,67|P62,67|P66,67|P70,67|P74,67|P76,67|P78,67|P80,67|P57,66|P59,66|P64,66|P67,66|P69,66|P71,66|P75,66|P77,66|P79,66|P81,66|P56,65|P59,65|P63,65|P66,65|P70,65|P76,65|P78,65|P80,65|P82,65|P57,64|P59,64|P62,64|P65,64|P67,64|P69,64|P71,64|P73,64|P77,64|P79,64|P81,64|P83,64|P56,63|P58,63|P66,63|P70,63|P74,63|P78,63|P80,63|P82,63|P84,63|P57,62|P59,62|P61,62|P63,62|P65,62|P67,62|P69,62|P71,62|P73,62|P75,62|P79,62|P81,62|P83,62|P85,62|P56,61|P58,61|P60,61|P62,61|P64,61|P66,61|P70,61|P74,61|P76,61|P82,61|P84,61|P57,60|P59,60|P61,60|P63,60|P65,60|P67,60|P69,60|P71,60|P73,60|P75,60|P80,60|P82,60|P56,59|P58,59|P60,59|P62,59|P64,59|P66,59|P70,59|P74,59|P57,58|P59,58|P61,58|P63,58|P65,58|P73,58|P75,58|P58,57|P60,57|P62,57|P64,57|P74,57|P73,56|P75,56|P77,56|P79,56|P81,56|P83,56|P85,56|P74,55|P75,54|P77,54|P79,54|P81,54|P83,54|P85,54|P26,23|P28,23|P30,23|P27,22|P29,22|P26,21|P28,21|P30,21|P26,19|P28,19|P30,19|P26,18|P30,18|P26,17|P30,17|P26,16|P28,16|P30,16|P26,15|P28,15|P30,15|P26,14|P28,14|P30,14|P26,13|P28,13|P30,13|P26,12|P28,12|P30,12|P26,11|P28,11|P30,11|P26,10|P28,10|P30,10|P26,9|P28,9|P30,9|P26,8|P28,8|P30,8|P26,7|P28,7|P30,7|P26,6|P28,6|P30,6|P26,5|P28,5|P30,5|P26,4|P28,4|P30,4|P26,3|P28,3|P30,3|P26,2|P27,2|P28,2|P29,2|P30,2|p26,156|p28,156|p30,156|p32,156|p33,155|p26,154|p28,154|p30,154|p31,153|p33,153|p15,147|p25,112|p24,111|p23,110|p22,109|p25,109|p21,108|p25,108|p20,107|p24,107|p19,106|p23,106|p20,105|p25,105|p19,104|p25,104|p20,103|p24,103|p19,102|p23,102|p20,101|p25,101|p4,100|p6,100|p8,100|p10,100|p12,100|p14,100|p16,100|p19,100|p24,100|p25,100|p3,99|p5,99|p7,99|p20,99|p23,99|p24,99|p25,99|p4,98|p6,98|p8,98|p10,98|p12,98|p14,98|p16,98|p19,98|p21,98|p23,98|p25,98|p32,98|p34,98|p3,97|p5,97|p15,97|p23,97|p25,97|p35,97|p4,96|p6,96|p14,96|p16,96|p19,96|p21,96|p23,96|p25,96|p32,96|p34,96|p36,96|p18,95|p23,95|p25,95|p33,95|p35,95|p37,95|p25,94|p34,94|p36,94|p38,94|p4,93|p6,93|p10,93|p12,93|p14,93|p16,93|p18,93|p20,93|p23,93|p24,93|p25,93|p35,93|p37,93|p39,93|p3,92|p5,92|p7,92|p9,92|p21,92|p23,92|p25,92|p36,92|p38,92|p40,92|p46,92|p47,92|p48,92|p49,92|p50,92|p51,92|p52,92|p4,91|p6,91|p8,91|p10,91|p12,91|p14,91|p16,91|p18,91|p20,91|p23,91|p25,91|p35,91|p39,91|p41,91|p46,91|p52,91|p3,90|p5,90|p7,90|p9,90|p11,90|p13,90|p15,90|p19,90|p21,90|p23,90|p25,90|p34,90|p40,90|p42,90|p46,90|p48,90|p50,90|p52,90|p4,89|p6,89|p8,89|p10,89|p12,89|p14,89|p16,89|p23,89|p25,89|p33,89|p37,89|p41,89|p43,89|p46,89|p52,89|p3,88|p5,88|p7,88|p9,88|p11,88|p13,88|p15,88|p25,88|p32,88|p36,88|p38,88|p42,88|p44,88|p50,88|p52,88|p4,87|p6,87|p8,87|p10,87|p12,87|p14,87|p18,87|p20,87|p23,87|p24,87|p25,87|p31,87|p35,87|p39,87|p46,87|p52,87|p3,86|p5,86|p7,86|p9,86|p11,86|p13,86|p15,86|p17,86|p21,86|p23,86|p25,86|p32,86|p36,86|p38,86|p40,86|p47,86|p50,86|p52,86|p18,85|p20,85|p23,85|p25,85|p33,85|p37,85|p39,85|p46,85|p47,85|p49,85|p52,85|p4,84|p6,84|p8,84|p10,84|p12,84|p14,84|p16,84|p19,84|p21,84|p23,84|p25,84|p34,84|p38,84|p40,84|p46,84|p47,84|p3,83|p5,83|p7,83|p11,83|p13,83|p15,83|p23,83|p25,83|p31,83|p35,83|p39,83|p46,83|p47,83|p52,83|p2,82|p4,82|p6,82|p8,82|p10,82|p12,82|p14,82|p25,82|p32,82|p38,82|p40,82|p46,82|p47,82|p49,82|p3,81|p5,81|p7,81|p9,81|p11,81|p13,81|p15,81|p17,81|p19,81|p21,81|p23,81|p24,81|p25,81|p31,81|p33,81|p37,81|p39,81|p47,81|p50,81|p52,81|p2,80|p4,80|p13,80|p15,80|p20,80|p23,80|p25,80|p32,80|p34,80|p36,80|p38,80|p40,80|p44,80|p47,80|p3,79|p5,79|p17,79|p19,79|p21,79|p23,79|p25,79|p33,79|p35,79|p37,79|p39,79|p41,79|p43,79|p45,79|p2,78|p4,78|p13,78|p15,78|p18,78|p20,78|p23,78|p25,78|p34,78|p36,78|p38,78|p40,78|p42,78|p44,78|p47,78|p49,78|p51,78|p52,78|p53,78|p54,78|p17,77|p23,77|p25,77|p35,77|p37,77|p39,77|p41,77|p44,77|p47,77|p48,77|p50,77|p51,77|p54,77|p65,77|p67,77|p69,77|p71,77|p25,76|p36,76|p38,76|p40,76|p42,76|p44,76|p48,76|p50,76|p54,76|p64,76|p3,75|p5,75|p9,75|p11,75|p13,75|p15,75|p17,75|p19,75|p21,75|p23,75|p25,75|p37,75|p39,75|p41,75|p44,75|p46,75|p48,75|p50,75|p52,75|p54,75|p57,75|p59,75|p63,75|p65,75|p67,75|p69,75|p71,75|p2,74|p4,74|p6,74|p8,74|p38,74|p40,74|p42,74|p44,74|p46,74|p48,74|p50,74|p52,74|p54,74|p62,74|p64,74|p66,74|p70,74|p72,74|p3,73|p5,73|p7,73|p9,73|p11,73|p13,73|p15,73|p17,73|p19,73|p21,73|p23,73|p25,73|p39,73|p41,73|p43,73|p45,73|p47,73|p49,73|p51,73|p53,73|p57,73|p59,73|p61,73|p63,73|p65,73|p71,73|p2,72|p4,72|p6,72|p8,72|p10,72|p14,72|p18,72|p20,72|p22,72|p24,72|p40,72|p42,72|p44,72|p46,72|p48,72|p50,72|p52,72|p54,72|p58,72|p62,72|p64,72|p66,72|p70,72|p72,72|p74,72|p76,72|p3,71|p5,71|p7,71|p9,71|p11,71|p13,71|p15,71|p17,71|p19,71|p21,71|p23,71|p25,71|p53,71|p57,71|p59,71|p61,71|p63,71|p65,71|p71,71|p77,71|p56,70|p58,70|p62,70|p64,70|p67,70|p69,70|p72,70|p74,70|p76,70|p78,70|p57,69|p59,69|p61,69|p63,69|p67,69|p69,69|p75,69|p77,69|p79,69|p56,68|p58,68|p62,68|p66,68|p70,68|p74,68|p76,68|p78,68|p80,68|p57,67|p59,67|p64,67|p67,67|p69,67|p71,67|p75,67|p77,67|p79,67|p81,67|p56,66|p63,66|p66,66|p70,66|p73,66|p76,66|p78,66|p80,66|p82,66|p57,65|p62,65|p65,65|p67,65|p69,65|p71,65|p73,65|p77,65|p79,65|p81,65|p83,65|p56,64|p58,64|p61,64|p66,64|p70,64|p74,64|p78,64|p80,64|p82,64|p84,64|p57,63|p59,63|p61,63|p63,63|p65,63|p67,63|p69,63|p71,63|p73,63|p75,63|p79,63|p81,63|p83,63|p85,63|p56,62|p58,62|p60,62|p62,62|p64,62|p66,62|p70,62|p74,62|p76,62|p80,62|p82,62|p84,62|p57,61|p59,61|p61,61|p63,61|p65,61|p67,61|p69,61|p71,61|p73,61|p75,61|p77,61|p78,61|p80,61|p56,60|p58,60|p60,60|p62,60|p64,60|p66,60|p70,60|p74,60|p77,60|p79,60|p57,59|p59,59|p61,59|p63,59|p65,59|p73,59|p75,59|p77,59|p78,59|p79,59|p80,59|p81,59|p82,59|p83,59|p84,59|p85,59|p58,58|p60,58|p62,58|p64,58|p74,58|p77,58|p79,58|p81,58|p83,58|p85,58|p73,57|p75,57|p77,57|p79,57|p81,57|p83,57|p85,57|p74,56|p76,56|p78,56|p80,56|p82,56|p84,56|p75,55|p77,55|p79,55|p81,55|p83,55|p85,55|p26,24|p28,24|p30,24|p26,22|p28,22|p30,22|p27,21|p29,21|p26,20|p28,20|p30,20|p28,17",r({positionString:o});case"Omega^3":return n=variantomega.genPositionOfOmegaCubed(),r({startingPosition:n,pawnDoublePush:!1,castleWith:null});case"Omega^4":return n=variantomega.genPositionOfOmegaFourth(),r({startingPosition:n,pawnDoublePush:!1,castleWith:null});default:throw new Error("Unknown variant.")}}function r({positionString:e,startingPosition:t,specialRights:o,pawnDoublePush:n,castleWith:i}){if(e){if(!t){const n=formatconverter.getStartingPositionAndSpecialRightsFromShortPosition(e);t=n.startingPosition,o=n.specialRights}}else if(t&&o)e=formatconverter.LongToShort_Position(t,o);else{if(!t)return console.error("Not enough information to calculate the positionString, position, and specialRights of variant.");o=formatconverter.generateSpecialRights(t,n,i),e=formatconverter.LongToShort_Position(t,o)}return{positionString:e,position:t,specialRights:o}}function a({Variant:e,Date:t=math.getUTCDateTime()},n){switch(n||(n=i({Variant:e}).position),e){case"Classical":case"Core":case"Standarch":return o({position:n});case"Space Classic":o({promotionRanks:math.getUTCTimestamp(t)<17090172e5?[4,-3]:void 0,position:n});case"CoaIP":return o({position:n});case"Pawn Horde":return o({winConditions:{white:["checkmate"],black:["allpiecescaptured"]},promotionRanks:[2,-7],position:n});case"Space":return o({promotionRanks:[4,-3],position:n});case"Obstocean":return o({position:n});case"Abundance":return o({promotionRanks:[6,-6],position:n});case"Amazon Chandelier":return o({promotionRanks:[10,-9],position:n});case"Containment":return o({promotionRanks:null,position:n});case"Classical - Limit 7":case"CoaIP - Limit 7":return o({slideLimit:7,position:n});case"Chess":return o({position:n});case"Classical - KOTH":case"CoaIP - KOTH":return o({winConditions:{white:["checkmate","koth"],black:["checkmate","koth"]},position:n});case"Classical+":case"Pawndard":return o({position:n});case"Knightline":return o({promotionsAllowed:{white:["knights","queens"],black:["knights","queens"]}});case"Knighted Chess":return o({position:n});case"Omega":case"Omega^2":case"Omega^3":return o({promotionRanks:null,moveRule:null,position:n});case"Omega^4":return o({promotionRanks:null,moveRule:null,winConditions:{white:["royalcapture"],black:["royalcapture"]},position:n});case"Standarch - 3 Check":case"CoaIP - 3 Check":return o({winConditions:{white:["checkmate","threecheck"],black:["checkmate","threecheck"]},position:n});default:throw new Error("Unknown variant.")}}function s(e,t){const o=math.deepCopyObject(pieces.royals);o.push("pawns");const n=[],i=[];if(!t)return{white:n,black:i};for(const r in e){const a=e[r];if(a.endsWith("N"))continue;const s=math.trimWorBFromType(a);o.includes(s)||(n.includes(s)||(null!=t[0]&&n.push(s),null!=t[1]&&i.push(s)))}return{white:n,black:i}}function c(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Classical"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}function l(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Standarch"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}function u(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"CoaIP"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}return Object.freeze({setupVariant:function(e,t,o){o?function(e,{Variant:t,Date:o},n){let r=n.positionString,a=n.startingPosition,s=n.specialRights;if(n.startingPosition)r=formatconverter.LongToShort_Position(n.startingPosition,n.specialRights);else{const e=i({Variant:t,Date:o});r=e.positionString,a=e.position,s=e.specialRights}e.startSnapshot={position:a,positionString:r,specialRights:s,turn:n.turn||"white",fullMove:n.fullMove||1},n.enpassant&&(e.startSnapshot.enpassant=n.enpassant);if(n.moveRule){const[t,o]=n.moveRule.split("/");e.startSnapshot.moveRuleState=Number(t),n.gameRules.moveRule=Number(o)}e.gameRules=n.gameRules}(e,t,o):function(e,{Variant:t,Date:o}){switch(t){case"Classical":case"Classical - Limit 7":case"Classical - KOTH":c(e,{Variant:t,Date:o});break;case"Core":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Core"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Standarch":case"Standarch - 3 Check":l(e,{Variant:t,Date:o});break;case"Space Classic":!function(e,{Variant:t,Date:o}){e.metadata.Date=o;const{position:n,positionString:r,specialRights:s}=i({Variant:"Space Classic",Date:o});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"CoaIP":case"CoaIP - Limit 7":case"CoaIP - KOTH":case"CoaIP - 3 Check":u(e,{Variant:t,Date:o});break;case"Pawn Horde":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Pawn Horde"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Space":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Space"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Obstocean":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Obstocean"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Abundance":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Abundance"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Amazon Chandelier":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Amazon Chandelier"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Containment":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Containment"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Chess":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Chess"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Classical+":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Classical+"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Pawndard":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Pawndard"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Knightline":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Knightline"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Knighted Chess":!function(e,{Variant:t,Date:o}){const{position:n,positionString:r,specialRights:s}=i({Variant:"Knighted Chess"});e.startSnapshot={position:n,positionString:r,specialRights:s,turn:"white"},e.gameRules=a({Variant:t,Date:o},n)}(e,{Variant:t,Date:o});break;case"Omega":variantomega.initOmega(e,{Variant:t,Date:o});break;case"Omega^2":variantomega.initOmegaSquared(e,{Variant:t,Date:o});break;case"Omega^3":variantomega.initOmegaCubed(e,{Variant:t,Date:o});break;case"Omega^4":variantomega.initOmegaFourth(e,{Variant:t,Date:o});break;default:throw new Error("Unknown variant.")}e.gameRules.moveRule&&(e.startSnapshot.moveRuleState=0);e.startSnapshot.fullMove=1}(e,t),function(e){e.pieceMovesets=movesets.getPieceMovesets(e.gameRules.slideLimit),e.specialDetects=specialdetect.getSpecialMoves(),e.specialMoves=specialmove.getFunctions(),e.specialUndos=specialundo.getFunctions(),e.vicinity=legalmoves.genVicinity(e)}(e)},getGameRules:o,getGameRulesOfVariant:a,getBareMinimumGameRules:function(){return{winConditions:{white:["checkmate"],black:["checkmate"]}}},getStartingPositionOfVariant:i,getDefaultWinConditions:n,isVariantAVariantWhereBlackStarts:function(e){return t.includes(e)},isVariantValid:function(t){return e.includes(t)},getPromotionsAllowed:s})}(),variantomega=Object.freeze({initOmega:function(e,{Variant:t,Date:o}){const{position:n,positionString:i,specialRights:r}=variant.getStartingPositionOfVariant({Variant:"Omega"});e.startSnapshot={position:n,positionString:i,specialRights:r,turn:"black"},e.gameRules=variant.getGameRulesOfVariant({Variant:t,Date:o},n)},initOmegaSquared:function(e,{Variant:t,Date:o}){const{position:n,positionString:i,specialRights:r}=variant.getStartingPositionOfVariant({Variant:"Omega^2"});e.startSnapshot={position:n,positionString:i,specialRights:r,turn:"black"},e.gameRules=variant.getGameRulesOfVariant({Variant:t,Date:o},n)},initOmegaCubed:function(e,{Variant:t,Date:o}){const{position:n,positionString:i,specialRights:r}=variant.getStartingPositionOfVariant({Variant:"Omega^3"});e.startSnapshot={position:n,positionString:i,specialRights:r,turn:"black"},e.gameRules=variant.getGameRulesOfVariant({Variant:t,Date:o},n)},initOmegaFourth:function(e,{Variant:t,Date:o}){const{position:n,positionString:i,specialRights:r}=variant.getStartingPositionOfVariant({Variant:"Omega^4"});e.startSnapshot={position:n,positionString:i,specialRights:r,turn:"black"},e.gameRules=variant.getGameRulesOfVariant({Variant:t,Date:o},n)},genPositionOfOmegaCubed:function(){const e=500,t={};return t[math.getKeyFromCoords([3,15])]="kingsW",t[math.getKeyFromCoords([4,13])]="rooksB",o(t,7,-500,e),o(t,8,-500,e),o(t,9,-500,e),t[math.getKeyFromCoords([9,10])]="bishopsW",function(e,t){const o=math.getKeyFromCoords(t);delete e[o]}(t,[9,11]),o(t,10,-500,e),t[math.getKeyFromCoords([10,12])]="kingsB",function(e,t,o,i,r){let a=o;for(let o=t;o<i;o+=3)n(e,o,a,r),a+=3}(t,11,8,e,e),t[math.getKeyFromCoords([11,6])]="bishopsW",o(t,11,-500,5),o(t,12,-500,7),t[math.getKeyFromCoords([12,8])]="pawnsB",t[math.getKeyFromCoords([13,9])]="pawnsB",t[math.getKeyFromCoords([13,8])]="pawnsW",t[math.getKeyFromCoords([13,6])]="bishopsB",t[math.getKeyFromCoords([14,10])]="pawnsB",t[math.getKeyFromCoords([14,9])]="pawnsW",t[math.getKeyFromCoords([14,6])]="pawnsB",t[math.getKeyFromCoords([14,5])]="pawnsB",t[math.getKeyFromCoords([14,4])]="pawnsW",function(e,t,o,n,i){let r=o;for(let o=t;o<n;o++)if(e[math.getKeyFromCoords([o,r])]="pawnsW",e[math.getKeyFromCoords([o,r+1])]="pawnsB",e[math.getKeyFromCoords([o,r+4])]="pawnsW",e[math.getKeyFromCoords([o,r+5])]="pawnsB",r++,r>i)return}(t,15,6,e,e),function(e,t){for(let o=t.left;o<=t.right;o++){let n=math.getKeyFromCoords([o,t.bottom]);e[n]="voidsN",n=math.getKeyFromCoords([o,t.top]),e[n]="voidsN"}for(let o=t.bottom;o<=t.top;o++){let n=math.getKeyFromCoords([t.left,o]);e[n]="voidsN",n=math.getKeyFromCoords([t.right,o]),e[n]="voidsN"}}(t,{left:-500,right:500,bottom:-500,top:500}),t["499,492"]="voidsN",t["7,-500"]="pawnsW",t["8,-500"]="pawnsW",t["9,-500"]="pawnsW",t["10,-500"]="pawnsW",t["11,-500"]="pawnsW",t["12,-500"]="pawnsW",t["6,-501"]="voidsN",t["7,-501"]="voidsN",t["8,-501"]="voidsN",t["9,-501"]="voidsN",t["10,-501"]="voidsN",t["11,-501"]="voidsN",t["12,-501"]="voidsN",t["13,-501"]="voidsN",t["497,-497"]="voidsN",t["498,-497"]="voidsN",t["499,-497"]="voidsN",t["497,-498"]="voidsN",t["497,-499"]="voidsN",t["498,-498"]="voidsN",t["499,-499"]="voidsN",t["498,-499"]="bishopsB",t;function o(e,t,o,n){if(!(n<o))for(let i=o;i<=n;i++){const o=[t,i];e[math.getKeyFromCoords(o)]="pawnsW"}}function n(e,t,n,i){e[math.getKeyFromCoords([t,n])]="bishopsW",e[math.getKeyFromCoords([t,n+1])]="pawnsW",e[math.getKeyFromCoords([t,n+2])]="bishopsW",e[math.getKeyFromCoords([t,n+4])]="bishopsW",e[math.getKeyFromCoords([t,n+6])]="bishopsW",o(e,t,n+8,i),e[math.getKeyFromCoords([t+1,n+1])]="bishopsW",e[math.getKeyFromCoords([t+1,n+3])]="bishopsW",e[math.getKeyFromCoords([t+1,n+5])]="bishopsW",n+7<=i&&(e[math.getKeyFromCoords([t+1,n+7])]="bishopsW"),n+8<=i&&(e[math.getKeyFromCoords([t+1,n+8])]="rooksB"),o(e,t+2,n+2,i),n+7<=i&&(e[math.getKeyFromCoords([t+2,n+7])]="pawnsB")}},genPositionOfOmegaFourth:function(){const e=500,t={"-14,17":"pawnsW","-14,18":"pawnsB","-13,14":"pawnsW","-13,15":"pawnsB","-13,16":"pawnsW","-13,17":"pawnsB","-13,20":"pawnsW","-13,21":"pawnsB","-13,22":"pawnsW","-13,23":"pawnsB","-13,24":"pawnsW","-13,25":"pawnsB","-13,26":"pawnsW","-13,27":"pawnsB","-12,16":"bishopsB","-12,25":"bishopsW","-11,14":"pawnsW","-11,15":"pawnsB","-11,16":"kingsB","-11,17":"pawnsB","-11,24":"pawnsW","-11,25":"kingsW","-11,26":"pawnsW","-11,27":"pawnsB","-10,16":"bishopsB","-10,25":"bishopsW","-9,14":"pawnsW","-9,15":"pawnsB","-9,16":"pawnsW","-9,17":"pawnsB","-9,18":"pawnsW","-9,19":"pawnsB","-9,20":"pawnsW","-9,21":"pawnsB","-9,22":"pawnsW","-9,23":"pawnsB","-9,24":"pawnsW","-9,25":"pawnsB","-9,26":"pawnsW","-9,27":"pawnsB"},o={"0,3":"pawnsW","0,4":"pawnsB","0,5":"pawnsW","0,6":"pawnsB","0,11":"pawnsW","0,12":"pawnsB","1,4":"bishopsW","1,12":"bishopsW","1,13":"rooksB","2,1":"pawnsW","2,2":"pawnsB","2,3":"pawnsW","2,4":"pawnsB","2,5":"pawnsW","2,6":"pawnsB","2,7":"pawnsW","2,8":"pawnsW","2,9":"pawnsW","2,10":"pawnsW","2,11":"pawnsW","2,12":"pawnsB","3,2":"bishopsW","3,4":"bishopsB","3,6":"pawnsW","3,7":"pawnsB","3,8":"bishopsW","3,9":"pawnsW","3,10":"bishopsW","3,12":"bishopsW","3,14":"bishopsW","4,1":"pawnsW","4,2":"pawnsB","4,3":"pawnsW","4,4":"pawnsB","4,7":"pawnsW","4,8":"pawnsB","4,9":"bishopsW","4,11":"bishopsW","4,13":"bishopsW","4,15":"bishopsW","4,16":"rooksB","5,4":"pawnsW","5,5":"pawnsB","5,8":"pawnsW","5,9":"pawnsB","5,10":"pawnsW","5,11":"pawnsW","5,12":"pawnsW","5,13":"pawnsW","5,14":"pawnsW","5,15":"pawnsB"};let n=Object.keys(o);for(const e of n)t[e]=o[e];return i(t,0,13,e),i(t,2,13,e),i(t,3,16,e),i(t,5,16,e),function(e,t,o,n,i){let r=o;for(let o=t;o<n;o+=3)a(e,o,r,i),r+=3}(t,6,3,503,e),t[math.getKeyFromCoords([0,-6])]="pawnsB",t[math.getKeyFromCoords([0,-7])]="pawnsW",function(e,t,o,n,i){let r=t,a=o,c=0;do{s(e,r,a,c),r+=7,a-=7,c++}while(r<n&&a>i)}(t,1,-7,e,-500),function(e,t,o,n,i){let r=t,a=o,s=0;do{l(e,r,a,s),r-=8,a-=8,s++}while(r>n&&a>i)}(t,-1,-7,-500,-500),function(e,t,o,n,i,r){for(let i=t;i<=n;i++)e[math.getKeyFromCoords([i,o])]="voidsN";for(let t=o;t>=i;t--)e[math.getKeyFromCoords([n,t])]="voidsN";let a=i;for(let t=n;t>=-3;t--){let o=math.getKeyFromCoords([t,a]);e[o]="voidsN",o=math.getKeyFromCoords([t,a-1]),e[o]="voidsN",a--}for(let n=o;n>=r;n--)e[math.getKeyFromCoords([t,n])]="voidsN";a=r;for(let o=t;o<=-4;o++){let t=math.getKeyFromCoords([o,a]);e[t]="voidsN",t=math.getKeyFromCoords([o,a-1]),e[t]="voidsN",a--}e["492,493"]="voidsN"}(t,-866,500,567,-426,-134),t;function i(e,t,o,n){if(!(n<o))for(let i=o;i<=n;i++){const o=[t,i];e[math.getKeyFromCoords(o)]="pawnsW"}}function r(e,t){delete e[math.getKeyFromCoords(t)]}function a(e,t,o,n){e[math.getKeyFromCoords([t,o])]="pawnsW",e[math.getKeyFromCoords([t,o+1])]="pawnsB",e[math.getKeyFromCoords([t,o+2])]="pawnsW",o+3<=n&&(e[math.getKeyFromCoords([t,o+3])]="pawnsB"),o+6<=n&&(e[math.getKeyFromCoords([t,o+6])]="pawnsW"),o+7<=n&&(e[math.getKeyFromCoords([t,o+7])]="pawnsB"),o+8<=n&&(e[math.getKeyFromCoords([t,o+8])]="bishopsW"),o+9<=n&&(e[math.getKeyFromCoords([t,o+9])]="pawnsW"),o+10<=n&&(e[math.getKeyFromCoords([t,o+10])]="bishopsW"),o+12<=n&&(e[math.getKeyFromCoords([t,o+12])]="bishopsW"),o+14<=n&&(e[math.getKeyFromCoords([t,o+14])]="bishopsW"),i(e,t,o+16,n),e[math.getKeyFromCoords([t+1,o+1])]="pawnsW",e[math.getKeyFromCoords([t+1,o+2])]="pawnsB",o+3<=n&&(e[math.getKeyFromCoords([t+1,o+3])]="pawnsW"),o+4<=n&&(e[math.getKeyFromCoords([t+1,o+4])]="pawnsB"),o+7<=n&&(e[math.getKeyFromCoords([t+1,o+7])]="pawnsW"),o+8<=n&&(e[math.getKeyFromCoords([t+1,o+8])]="pawnsB"),o+9<=n&&(e[math.getKeyFromCoords([t+1,o+9])]="bishopsW"),o+11<=n&&(e[math.getKeyFromCoords([t+1,o+11])]="bishopsW"),o+13<=n&&(e[math.getKeyFromCoords([t+1,o+13])]="bishopsW"),o+15<=n&&(e[math.getKeyFromCoords([t+1,o+15])]="bishopsW"),o+16<=n&&(e[math.getKeyFromCoords([t+1,o+16])]="rooksB"),e[math.getKeyFromCoords([t+2,o+2])]="pawnsW",o+3<=n&&(e[math.getKeyFromCoords([t+2,o+3])]="pawnsB"),o+4<=n&&(e[math.getKeyFromCoords([t+2,o+4])]="pawnsW"),o+5<=n&&(e[math.getKeyFromCoords([t+2,o+5])]="pawnsB"),o+8<=n&&(e[math.getKeyFromCoords([t+2,o+8])]="pawnsW"),o+9<=n&&(e[math.getKeyFromCoords([t+2,o+9])]="pawnsB"),o+10<=n&&(e[math.getKeyFromCoords([t+2,o+10])]="pawnsW"),o+11<=n&&(e[math.getKeyFromCoords([t+2,o+11])]="pawnsW"),o+12<=n&&(e[math.getKeyFromCoords([t+2,o+12])]="pawnsW"),o+13<=n&&(e[math.getKeyFromCoords([t+2,o+13])]="pawnsW"),o+14<=n&&(e[math.getKeyFromCoords([t+2,o+14])]="pawnsW"),o+15<=n&&(e[math.getKeyFromCoords([t+2,o+15])]="pawnsB"),i(e,t+2,o+16,n)}function s(e,t,o,n){e[math.getKeyFromCoords([t,o])]="pawnsB",e[math.getKeyFromCoords([t,o-1])]="pawnsW",e[math.getKeyFromCoords([t+1,o-1])]="pawnsB",e[math.getKeyFromCoords([t+1,o-2])]="pawnsW",e[math.getKeyFromCoords([t+2,o-2])]="pawnsB",e[math.getKeyFromCoords([t+2,o-3])]="pawnsW",o-3-t+3>-980&&(e[math.getKeyFromCoords([t+3,o-3])]="pawnsB"),o-4-t+3>-980&&(e[math.getKeyFromCoords([t+3,o-4])]="pawnsW"),o-5-t+4>-980&&(e[math.getKeyFromCoords([t+4,o-4])]="pawnsB"),o-3-t+4>-980&&(e[math.getKeyFromCoords([t+4,o-5])]="pawnsW"),o-4-t+5>-980&&(e[math.getKeyFromCoords([t+5,o-3])]="pawnsB"),o-4-t+5>-980&&(e[math.getKeyFromCoords([t+5,o-4])]="pawnsW"),o-2-t+6>-980&&(e[math.getKeyFromCoords([t+6,o-2])]="pawnsB"),o-3-t+6>-980&&(e[math.getKeyFromCoords([t+6,o-3])]="pawnsW"),o-1-t+7>-980&&(e[math.getKeyFromCoords([t+7,o-1])]="pawnsB"),o-2-t+7>-980&&(e[math.getKeyFromCoords([t+7,o-2])]="pawnsW"),o+1-t+7>-980&&(e[math.getKeyFromCoords([t+7,o+1])]="pawnsB"),o+0-t+7>-980&&(e[math.getKeyFromCoords([t+7,o+0])]="pawnsW"),o-2-t+8>-980&&(e[math.getKeyFromCoords([t+8,o-2])]="bishopsB"),o-6-t+6>-980&&(e[math.getKeyFromCoords([t+6,o-6])]="pawnsB"),o-7-t+6>-980&&(e[math.getKeyFromCoords([t+6,o-7])]="pawnsW"),o-5-t+7>-980&&(e[math.getKeyFromCoords([t+7,o-5])]="pawnsB"),o-6-t+7>-980&&(e[math.getKeyFromCoords([t+7,o-6])]="pawnsW"),o-4-t+8>-980&&(e[math.getKeyFromCoords([t+8,o-4])]="pawnsB"),o-5-t+8>-980&&(e[math.getKeyFromCoords([t+8,o-5])]="pawnsW"),o-3-t+9>-980&&(e[math.getKeyFromCoords([t+9,o-3])]="pawnsB"),o-4-t+9>-980&&(e[math.getKeyFromCoords([t+9,o-4])]="pawnsW");const i=n+2;let r=t+8,a=o+2;if(a-r>-990)for(let t=1;t<=i;t++)c(e,r,a,t===i),r+=1,a+=1;let s=t+4,l=o;for(let t=0;t<n;t++)e[math.getKeyFromCoords([s,l])]="pawnsW",s++,l++}function c(e,t,o,n){e[math.getKeyFromCoords([t,o])]="pawnsB",e[math.getKeyFromCoords([t,o-1])]="pawnsW",e[math.getKeyFromCoords([t,o-2])]="bishopsB",e[math.getKeyFromCoords([t+1,o-2])]="pawnsB",e[math.getKeyFromCoords([t+1,o-3])]="bishopsB",e[math.getKeyFromCoords([t+2,o-4])]="pawnsB",e[math.getKeyFromCoords([t+2,o-5])]="pawnsW",n&&(e[math.getKeyFromCoords([t+1,o-2])]="pawnsW",e[math.getKeyFromCoords([t+1,o-1])]="pawnsB",e[math.getKeyFromCoords([t+2,o-3])]="pawnsW",e[math.getKeyFromCoords([t+2,o-2])]="pawnsB")}function l(e,t,o,n){e[math.getKeyFromCoords([t,o])]="pawnsB",e[math.getKeyFromCoords([t,o-1])]="pawnsW",e[math.getKeyFromCoords([t-1,o-1])]="pawnsB",e[math.getKeyFromCoords([t-1,o-2])]="pawnsW",e[math.getKeyFromCoords([t-2,o-2])]="pawnsB",e[math.getKeyFromCoords([t-2,o-3])]="pawnsW",e[math.getKeyFromCoords([t-3,o-3])]="pawnsB",e[math.getKeyFromCoords([t-3,o-4])]="pawnsW",e[math.getKeyFromCoords([t-4,o-4])]="pawnsB",e[math.getKeyFromCoords([t-4,o-5])]="pawnsW";const i=n+1;let a=t-5,s=o-8;for(let t=1;t<=i;t++)u(e,a,s,t===i),a-=6,s+=6;r(e,[t-6,o-8]),r(e,[t-6,o-9]),r(e,[t-5,o-9]),r(e,[t-5,o-10])}function u(e,t,o,n){e[math.getKeyFromCoords([t,o-2])]="pawnsW",e[math.getKeyFromCoords([t,o-1])]="pawnsB",e[math.getKeyFromCoords([t-1,o-1])]="pawnsW",e[math.getKeyFromCoords([t-1,o+0])]="pawnsB",e[math.getKeyFromCoords([t-2,o+0])]="pawnsW",e[math.getKeyFromCoords([t-2,o+1])]="pawnsB",e[math.getKeyFromCoords([t-3,o+1])]="pawnsW",e[math.getKeyFromCoords([t-3,o+2])]="pawnsB",e[math.getKeyFromCoords([t-4,o+2])]="pawnsW",e[math.getKeyFromCoords([t-4,o+3])]="pawnsB",e[math.getKeyFromCoords([t-5,o+3])]="pawnsW",e[math.getKeyFromCoords([t-5,o+4])]="pawnsB",e[math.getKeyFromCoords([t,o+2])]="pawnsW",e[math.getKeyFromCoords([t,o+3])]="pawnsB",e[math.getKeyFromCoords([t-1,o+3])]="pawnsW",e[math.getKeyFromCoords([t-1,o+4])]="pawnsB",e[math.getKeyFromCoords([t-2,o+4])]="pawnsW",e[math.getKeyFromCoords([t-2,o+5])]="pawnsB",e[math.getKeyFromCoords([t-2,o+6])]="pawnsW",e[math.getKeyFromCoords([t-2,o+7])]="pawnsW",e[math.getKeyFromCoords([t-2,o+8])]="pawnsW",e[math.getKeyFromCoords([t-2,o+9])]="pawnsB",e[math.getKeyFromCoords([t-2,o+10])]="pawnsW",e[math.getKeyFromCoords([t-2,o+11])]="pawnsB",e[math.getKeyFromCoords([t-3,o+11])]="pawnsW",e[math.getKeyFromCoords([t-3,o+12])]="pawnsB",e[math.getKeyFromCoords([t-4,o+12])]="pawnsW",e[math.getKeyFromCoords([t-4,o+13])]="pawnsB",e[math.getKeyFromCoords([t-5,o+11])]="pawnsW",e[math.getKeyFromCoords([t-5,o+12])]="pawnsB",e[math.getKeyFromCoords([t-5,o+10])]="pawnsB",e[math.getKeyFromCoords([t-5,o+9])]="pawnsW",e[math.getKeyFromCoords([t-5,o+8])]="pawnsB",e[math.getKeyFromCoords([t-5,o+7])]="pawnsW",e[math.getKeyFromCoords([t-4,o+7])]="pawnsB",e[math.getKeyFromCoords([t-4,o+6])]="pawnsW",e[math.getKeyFromCoords([t-4,o+10])]="bishopsW",n&&(e[math.getKeyFromCoords([t-5,o+6])]="pawnsB",e[math.getKeyFromCoords([t-5,o+5])]="pawnsW")}}}),voids={color:[0,0,0,1],color_wireframe:[1,0,1,1],stride:6,pointsPerSquare_Wireframe:12,regenModel(e){const t=game.getGamefile().ourPieces.voidsN,o=voids.simplifyMesh(t),n=o.length,i=options.isDebugModeOn(),r=i?voids.pointsPerSquare_Wireframe:piecesmodel.pointsPerSquare,a=n*(voids.stride*r);e.voidMesh.data64=new Float64Array(a),e.voidMesh.data32=new Float32Array(a);let s=0;const c=e.voidMesh.data64,l=e.voidMesh.data32;for(let t=0;t<n;t++){const n=o[t],{startX:r,startY:a,endX:u,endY:d}=voids.getCoordDataOfRectangle(e,n),m=i?voids.color_wireframe:voids.color,p=(i?voids.getDataOfSquare_Wireframe:voids.getDataOfSquare)(r,a,u,d,m);for(let e=0;e<p.length;e++)c[s]=p[e],l[s]=p[e],s++}const u=i?"LINES":"TRIANGLES";e.voidMesh.model=buffermodel.createModel_Colored(l,2,u)},getCoordDataOfRectangle(e,{left:t,right:o,bottom:n,top:i}){const r=board.gsquareCenter(),a=t-r-e.mesh.offset[0],s=n-r-e.mesh.offset[1];return{startX:a,startY:s,endX:a+(o-t+1),endY:s+(i-n+1)}},getDataOfSquare(e,t,o,n,i){const[r,a,s,c]=i;return[e,t,r,a,s,c,e,n,r,a,s,c,o,t,r,a,s,c,o,t,r,a,s,c,e,n,r,a,s,c,o,n,r,a,s,c]},getDataOfSquare_Wireframe(e,t,o,n,i){const[r,a,s,c]=i;return[e,t,r,a,s,c,e,n,r,a,s,c,e,n,r,a,s,c,o,t,r,a,s,c,o,t,r,a,s,c,e,t,r,a,s,c,o,t,r,a,s,c,e,n,r,a,s,c,e,n,r,a,s,c,o,n,r,a,s,c,o,n,r,a,s,c,o,t,r,a,s,c]},shiftModel(e,t,o){const n=e.voidMesh.data64,i=e.voidMesh.data32;for(let e=0;e<i.length;e+=voids.stride)n[e]+=t,n[e+1]+=o,i[e]=n[e],i[e+1]=n[e+1];e.voidMesh.model.updateBuffer()},simplifyMesh(e){const t={};for(const o of e){t[math.getKeyFromCoords(o)]=!0}const o=[],n={};for(const i of e){const e=math.getKeyFromCoords(i);if(n[e])continue;n[e]=!0;let r=i[0],a=i[0],s=i[1],c=i[1],l=1,u=1,d=!0;for(;d;){let e=[],o=!0,i=r-1;for(let r=0;r<u;r++){const a=[i,s+r],c=math.getKeyFromCoords(a);if(!t[c]||n[c]){o=!1;break}e.push(c)}if(o){r=i,l++,e.forEach((e=>{n[e]=!0}));continue}e=[],o=!0,i=a+1;for(let r=0;r<u;r++){const a=[i,s+r],c=math.getKeyFromCoords(a);if(!t[c]||n[c]){o=!1;break}e.push(c)}if(o){a=i,l++,e.forEach((e=>{n[e]=!0}));continue}e=[],o=!0;let m=s-1;for(let i=0;i<l;i++){const a=[r+i,m],s=math.getKeyFromCoords(a);if(!t[s]||n[s]){o=!1;break}e.push(s)}if(o)s=m,u++,e.forEach((e=>{n[e]=!0}));else{e=[],o=!0,m=c+1;for(let i=0;i<l;i++){const a=[r+i,m],s=math.getKeyFromCoords(a);if(!t[s]||n[s]){o=!1;break}e.push(s)}o?(c=m,u++,e.forEach((e=>{n[e]=!0}))):d=!1}}const m={left:r,right:a,bottom:s,top:c};o.push(m)}return o},render(e){if(null==e.voidMesh.model)return;const t=movement.getBoardPos(),o=[-t[0]+e.mesh.offset[0],-t[1]+e.mesh.offset[1],0],n=movement.getBoardScale(),i=[n,n,1];e.voidMesh.model.render(o,i)}};let gl;const webgl=function(){let e=[.5,.5,.5];const t="LEQUAL";function o(){gl.clearColor(...e,1),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT)}function n(){gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}return Object.freeze({init:function(){if(gl||(gl=camera.canvas.getContext("webgl",{alpha:!1})),gl||(console.log("Browser doesn't support WebGL-1, falling back on experiment-webgl."),gl=canvas.getContext("experimental-webgl",{alpha:!1})),!gl)throw alert("Your browser does not support WebGL. This game requires that to function. Please update your browser."),new Error("WebGL not supported.");gl.clearDepth(1),o(),gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl[t]),gl.enable(gl.BLEND),n()},clearScreen:o,executeWithDepthFunc_ALWAYS:function(e){gl.depthFunc(gl.ALWAYS),e(),gl.depthFunc(gl[t])},executeWithInverseBlending:function(e){gl.blendFunc(gl.ONE_MINUS_DST_COLOR,gl.GL_ZERO),e(),n()},setClearColor:function(t){e=t},queryWebGLContextInfo:function(){console.log("WebGL Context Information:"),[{name:"MAX_TEXTURE_SIZE",desc:"Maximum texture size",guaranteed:64},{name:"MAX_CUBE_MAP_TEXTURE_SIZE",desc:"Maximum cube map texture size",guaranteed:16},{name:"MAX_RENDERBUFFER_SIZE",desc:"Maximum renderbuffer size",guaranteed:1},{name:"MAX_TEXTURE_IMAGE_UNITS",desc:"Maximum texture units for fragment shader",guaranteed:8},{name:"MAX_VERTEX_TEXTURE_IMAGE_UNITS",desc:"Maximum texture units for vertex shader",guaranteed:0},{name:"MAX_COMBINED_TEXTURE_IMAGE_UNITS",desc:"Maximum combined texture units",guaranteed:8},{name:"MAX_VERTEX_ATTRIBS",desc:"Maximum vertex attributes",guaranteed:8},{name:"MAX_VERTEX_UNIFORM_VECTORS",desc:"Maximum vertex uniform vectors",guaranteed:128},{name:"MAX_FRAGMENT_UNIFORM_VECTORS",desc:"Maximum fragment uniform vectors",guaranteed:16},{name:"MAX_VARYING_VECTORS",desc:"Maximum varying vectors",guaranteed:8},{name:"MAX_VIEWPORT_DIMS",desc:"Maximum viewport dimensions",guaranteed:[0,0]},{name:"ALIASED_POINT_SIZE_RANGE",desc:"Aliased point size range",guaranteed:[1,1]},{name:"ALIASED_LINE_WIDTH_RANGE",desc:"Aliased line width range",guaranteed:[1,1]},{name:"MAX_VERTEX_UNIFORM_COMPONENTS",desc:"Maximum vertex uniform components",guaranteed:1024},{name:"MAX_FRAGMENT_UNIFORM_COMPONENTS",desc:"Maximum fragment uniform components",guaranteed:1024},{name:"MAX_VERTEX_OUTPUT_COMPONENTS",desc:"Maximum vertex output components",guaranteed:64},{name:"MAX_FRAGMENT_INPUT_COMPONENTS",desc:"Maximum fragment input components",guaranteed:60},{name:"MAX_DRAW_BUFFERS",desc:"Maximum draw buffers",guaranteed:4},{name:"MAX_COLOR_ATTACHMENTS",desc:"Maximum color attachments",guaranteed:4},{name:"MAX_SAMPLES",desc:"Maximum samples",guaranteed:4}].forEach((e=>{const t=gl.getParameter(gl[e.name]);console.log(`${e.desc}:`,t,`(Guaranteed: ${e.guaranteed})`)}))}})}(),websocket=function(){let e,t=!1,o=!1,n=!1,i=!1;const r=1e4;let a;const s=["invites","game"],c={invites:!1,game:!1},l=5e3,u=1e4,d=l,m=5e3,p=5e3;let g={},f={};const h=[],v=!0,P=!1,b=!0,y=!1;async function w(){if(i)return!1;for(;t||e&&e.readyState!==WebSocket.OPEN;)main.devBuild&&console.log("Waiting for the socket to be established or closed.."),await main.sleep(100);if(e&&e.readyState===WebSocket.OPEN)return!0;t=!0;let o=await C();for(;!o&&!R();)n=!0,statustext.showStatusForDuration("No connection.",l),onlinegame.onLostConnection(),invites.clearIfOnPlayPage(),await main.sleep(l),o=await C();return o&&n&&statustext.showStatusForDuration("Reconnected.",1e3),n=!1,h.forEach((e=>{clearTimeout(e)})),t=!1,o}async function C(){return o=setTimeout(T,m),new Promise(((t,o)=>{let n=`wss://${window.location.hostname}`;"443"!==window.location.port&&(n+=`:${window.location.port}`);const i=new WebSocket(n);i.onopen=()=>{k(),e=i,t(!0)},i.onerror=e=>{k(),t(!1)},i.onmessage=M,i.onclose=E}))}function k(){clearTimeout(o),o=!1}function T(){n=!0,statustext.showStatusForDuration("No connection.",m),o=setTimeout(T,m)}function S(t){t&&delete g[t],e&&(console.log(`Renewing connection after we haven't received an echo for ${p} milliseconds...`),n=!0,statustext.showStatusForDuration("No connection.",m),e.close(1e3,"Connection closed by client. Renew."))}function M(e){let t;try{t=JSON.parse(e.data)}catch(e){return console.error("Error parsing incoming message as JSON:",e)}const o="echo"===t.action;if(b&&main.devBuild&&(o?y&&console.log(`Incoming message: ${JSON.stringify(t)}`):console.log(`Incoming message: ${JSON.stringify(t)}`)),o)return function(e){const t=e.value,o=g[t];clearTimeout(o),delete g[t]}(t);const n=t.sub;if(null==n)return console.error("Server should not be sending us socket data without subscription data! Message:"),console.log(t);switch(I("general","echo",t.id),function(e){if(null==e)return;if(!f[e])return;f[e](),delete f[e]}(t.replyto),n){case"general":!function(e,t){switch(e){case"notify":statustext.showStatus(t);break;case"error":statustext.showStatus(t,!0,2);break;case"print":console.log(t);break;case"printerror":console.error(t);break;case"renewconnection":break;case"gameversion":t!==main.GAME_VERSION&&function(e){if(null==e)throw new Error("Can't hard refresh with no expected version.");const t={timeLastHardRefreshed:Date.now(),expectedVersion:e},o=localstorage.loadItem("hardrefreshinfo");if(o?.expectedVersion===e)return o.sentNotSupported||I("general","feature-not-supported",`location.reload(true) failed to hard refresh. Server version: ${e}. Still running: ${main.GAME_VERSION}`),o.sentNotSupported=!0,void n(o);function n(e){localstorage.saveItem("hardrefreshinfo",e,math.getTotalMilliseconds({days:1}))}n(t),location.reload(!0)}(t);break;default:console.log(`We don't know how to treat this server action in general route: Action "${e}". Value: ${t}`)}}(t.action,t.value);break;case"invites":invites.onmessage(t);break;case"game":onlinegame.onmessage(t);break;default:return console.error("Unknown socket subscription received from the server! Message:"),console.log(t)}}function E(t){main.devBuild&&console.log("WebSocket connection closed:",t.code,t.reason);const o=void 0!==e;if(e=void 0,function(){const e=Object.keys(g);for(const t of e){const e=g[t];clearTimeout(e)}g={}}(),f={},onlinegame.setInSyncFalse(),1006===t.code)return void(o&&F());const i=t.reason.trim();switch(i){case"Connection expired":F();break;case"Connection closed by client":break;case"Connection closed by client. Renew.":console.log("Closed web socket successfully. Renewing now.."),F();break;case"Unable to identify client IP address":statustext.showStatus("Unable to identify IP. Report this bug to Naviary!",!0,100),invites.clearIfOnPlayPage();break;case"Authentication needed":statustext.showStatus("Online play disabled. Cookies not supported. Try a different browser."),invites.clearIfOnPlayPage();break;case"Logged out":validation.deleteToken(),F();break;case"Too Many Requests. Try again soon.":statustext.showStatusForDuration("Too many requests. Try again soon.",u),B(u);break;case"Message Too Big":statustext.showStatus("Message too big. This should never happen, please report this bug to Naviary!",!0,3),B(d);break;case"Too Many Sockets":statustext.showStatus("Too many sockets. This should never happen, please report this bug to Naviary!",!0,3),setTimeout(F,u);break;case"Origin Error":statustext.showStatus("Origin error. This should never happen, please report this bug to Naviary!",!0,3),invites.clearIfOnPlayPage(),B(u);break;case"No echo heard":n=!0,statustext.showStatusForDuration("No connection.",m),F();break;default:statustext.showStatus(`Connection closed unexpectedly. Server message: "${i}" Please report this to Naviary!`,!0,100),console.error("Unknown reason why the WebSocket connection was closed. Not reopening or resubscribing.")}}function B(e){if(null==e)return console.error("Cannot enter timeout for an undefined amount of time!");i||(i=!0,setTimeout(x,e),invites.clearIfOnPlayPage())}function x(){i=!1,F()}async function I(t,o,n,i,s){if(!await w())return s&&s(),!1;clearTimeout(a),R()&&(a=setTimeout(D,r));const c={route:t,action:o,value:n},l="echo"===o;return l||(c.id=math.generateNumbID(10)),v&&main.devBuild&&(l?P&&console.log(`Sending: ${JSON.stringify(c)}`):console.log(`Sending: ${JSON.stringify(c)}`)),l||(g[c.id]=setTimeout(S,p,c.id)),l||function(e,t){if(!t)return;f[e]=t}(c.id,s),!(!e||e.readyState!==WebSocket.OPEN)&&(e.send(JSON.stringify(c)),!0)}function D(){if(e)return e.readyState!==WebSocket.OPEN?console.error("Cannot close socket because it's not open! Yet socket is defined."):void e.close(1e3,"Connection closed by client")}function R(){for(const e of s)if(!0===c[e])return!1;return!0}async function F(){if(main.devBuild&&console.log("Resubbing all.."),R())return n=!1,console.log("No subs to sub to.");if(!await w())return!1;for(const e of s)if(!1!==c[e])switch(e){case"invites":await invites.subscribeToInvites(!0);break;case"game":onlinegame.resyncToGame();break;default:return console.error(`Cannot resub to all subs after an unexpected socket closure with strange sub ${e}!`)}}return window.addEventListener("pageshow",(function(e){e.persisted&&(console.log("Page was returned to using the back or forward button."),F())})),Object.freeze({closeSocket:D,sendmessage:I,unsubFromInvites:function(){if(invites.clear({recentUsersInLastList:!0}),!1===c.invites)return;c.invites=!1,math.generateNumbID(10),I("general","unsub","invites")},getSubs:function(){return c},addTimerIDToCancelOnNewSocket:function(e){h.push(e)}})}(),wincondition=function(){const e=["checkmate","royalcapture","allroyalscaptured","allpiecescaptured","threecheck","koth"],t=[...e,"stalemate","repetition","moverule"],o=[[4,4],[5,4],[4,5],[5,5]];function n(e){if(!i(e,"threecheck"))return!1;if(e.inCheck){if(null==e.checksGiven&&(e.checksGiven={white:0,black:0}),"white"===e.whosTurn)e.checksGiven.white++;else{if("black"!==e.whosTurn)throw new Error(`Whosturn is invalid when detecting threecheck! Value ${e.whosTurn}`);e.checksGiven.black++}if(3===e.checksGiven[e.whosTurn]){if("white"===e.whosTurn)return"black threecheck";if("black"===e.whosTurn)return"white threecheck";throw new Error("Cannot determine winning color by wincondition threecheck!")}}return!1}function i(e,t){const o=math.getOppositeColor(e.whosTurn);return e.gameRules.winConditions[o].includes(t)}function r(e){const t=movesscript.getLastMove(e.moves);if(!t)return!1;if(!t.captured)return!1;const o=math.trimWorBFromType(t.captured);return pieces.royals.includes(o)}return Object.freeze({validWinConditions:e,getGameConclusion:function(e){return function(e){if(!i(e,"allpiecescaptured"))return!1;const t=gamefileutility.getPieceCountOfColorFromPiecesByType(e.ourPieces,e.whosTurn);if(0===t){if("white"===e.whosTurn)return"black allpiecescaptured";if("black"===e.whosTurn)return"white allpiecescaptured";throw new Error("Cannot determine winning color by wincondition allpiecescaptured!")}return!1}(e)||function(e){if(!i(e,"royalcapture"))return!1;if(r(e)){if("white"===e.whosTurn)return"black royalcapture";if("black"===e.whosTurn)return"white royalcapture";throw new Error("Cannot determine winning color by wincondition royalcapture!")}return!1}(e)||function(e){if(!i(e,"allroyalscaptured"))return!1;if(!r(e))return!1;const t=gamefileutility.getCountOfTypesFromPiecesByType(e.ourPieces,pieces.royals,e.whosTurn);if(0===t){if("white"===e.whosTurn)return"black allroyalscaptured";if("black"===e.whosTurn)return"white allroyalscaptured";throw new Error("Cannot determine winning color by wincondition allroyalscaptured!")}return!1}(e)||n(e)||function(e){if(!i(e,"koth"))return!1;const t=movesscript.getLastMove(e.moves);if(!t)return!1;if(!t.type.startsWith("kings"))return!1;let n=!1;for(let t=0;t<o.length;t++){const i=o[t],r=gamefileutility.getPieceTypeAtCoords(e,i);if(r&&r.startsWith("kings")){n=!0;break}}if(n)return"white"===e.whosTurn?"black koth":"black"===e.whosTurn?"white koth":console.log("Cannot determine winning color by wincondition koth!");return!1}(e)||function(e){return!!e.gameRules.moveRule&&(e.moveRuleState===e.gameRules.moveRule&&"draw moverule")}(e)||checkdetection.detectCheckmateOrDraw(e)||!1},detectThreecheck:n,isOpponentUsingWinCondition:i,isGameConclusionDecisive:function(e){if(!1===e)throw new Error("Should not be checking if gameConclusion is decisive when game isn't over.");for(const o of t)if(e.includes(o))return!0;return!1},getVictorAndConditionFromGameConclusion:function(e){let[t,o]=e.split(" ");return"aborted"===t&&(o=t,t=void 0),{victor:t,condition:o}}})}();